<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover, minimal-ui" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>{{ title or 'Dashboard' }} • PharmaSight</title>
  <link rel="icon" type="image/png" href="/static/favicon.png" />
  <link rel="stylesheet" href="/static/styles.css?v=127" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <!-- Subtle SVG Filters for Refined Glass Effect -->
  <svg width="0" height="0" style="position: absolute; pointer-events: none;">
    <defs>
      <!-- Very subtle glass highlight gradient -->
      <linearGradient id="glass-highlight" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:rgba(255,255,255,0.2);stop-opacity:1" />
        <stop offset="50%" style="stop-color:rgba(255,255,255,0.05);stop-opacity:1" />
        <stop offset="100%" style="stop-color:rgba(255,255,255,0);stop-opacity:1" />
      </linearGradient>
    </defs>
  </svg>

  <!-- Loading Overlay Modal -->
  <div class="loading-overlay" id="loading-overlay" style="display: none;">
    <div class="loading-modal">
      <div class="loading-spinner-large"></div>
      <p class="loading-text-modal">Loading data...</p>
    </div>
  </div>

  <!-- Alert Modal -->
  <div class="styled-modal-overlay" id="alert-modal-overlay" style="display: none;">
    <div class="styled-modal">
      <div class="styled-modal-header">
        <h2 id="alert-modal-title">Alert</h2>
        <button class="styled-modal-close" id="alert-modal-close" type="button">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="styled-modal-body">
        <div class="styled-modal-icon" id="alert-modal-icon"></div>
        <p class="styled-modal-message" id="alert-modal-message"></p>
      </div>
      <div class="styled-modal-actions">
        <button class="btn-primary" id="alert-modal-ok">OK</button>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="styled-modal-overlay" id="confirm-modal-overlay" style="display: none;">
    <div class="styled-modal">
      <div class="styled-modal-header">
        <h2 id="confirm-modal-title">Confirm</h2>
        <button class="styled-modal-close" id="confirm-modal-close" type="button">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="styled-modal-body">
        <div class="styled-modal-icon" id="confirm-modal-icon"></div>
        <p class="styled-modal-message" id="confirm-modal-message"></p>
      </div>
      <div class="styled-modal-actions">
        <button class="btn-secondary" id="confirm-modal-cancel">Cancel</button>
        <button class="btn-primary" id="confirm-modal-ok">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Prompt Modal -->
  <div class="styled-modal-overlay" id="prompt-modal-overlay" style="display: none;">
    <div class="styled-modal">
      <div class="styled-modal-header">
        <h2 id="prompt-modal-title">Input Required</h2>
        <button class="styled-modal-close" id="prompt-modal-close" type="button">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="styled-modal-body">
        <div class="styled-modal-icon" id="prompt-modal-icon"></div>
        <p class="styled-modal-message" id="prompt-modal-message"></p>
        <div class="styled-modal-input-group">
          <input type="text" id="prompt-modal-input" class="styled-modal-input" placeholder="Enter value..." />
        </div>
      </div>
      <div class="styled-modal-actions">
        <button class="btn-secondary" id="prompt-modal-cancel">Cancel</button>
        <button class="btn-primary" id="prompt-modal-ok">OK</button>
      </div>
    </div>
  </div>

  <div class="app-layout">
    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <img src="/static/img/logo_light.png" alt="PharmaSight" class="sidebar-logo" />
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Navigation</div>
          <button class="nav-item active" data-tab="dashboard">
            <span class="nav-item-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
              </svg>
            </span>
            <span>Dashboard</span>
          </button>
          <button class="nav-item" data-tab="daily-summary">
            <span class="nav-item-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
            </span>
            <span>Daily Summary</span>
          </button>
          <button class="nav-item" data-tab="monthly-summary">
            <span class="nav-item-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
            </span>
            <span>Monthly Summary</span>
          </button>
          <button class="nav-item" data-tab="stock-management">
            <span class="nav-item-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                <line x1="12" y1="22.08" x2="12" y2="12"></line>
              </svg>
            </span>
            <span>Stock Management</span>
          </button>
          <button class="nav-item" data-tab="stock-queries">
            <span class="nav-item-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
            </span>
            <span>Stock Queries</span>
          </button>
          <button class="nav-item" data-tab="debtor-tools">
            <span class="nav-item-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
            </span>
            <span>Debtor Tools</span>
          </button>
          <button class="nav-item" data-tab="daily">
            <span class="nav-item-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 11H5a2 2 0 0 0-2 2v3c0 1.1.9 2 2 2h4m0-7h10a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2H9m0-7V9a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
              </svg>
            </span>
            <span>Daily Tracking</span>
          </button>
          <button class="nav-item" data-tab="targets">
            <span class="nav-item-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <circle cx="12" cy="12" r="6"></circle>
                <circle cx="12" cy="12" r="2"></circle>
              </svg>
            </span>
            <span>Targets</span>
          </button>
        </div>
        {% if is_charl %}
        <div class="nav-section">
          <div class="nav-section-title">Finances</div>
          <button class="nav-item" data-tab="chart-of-accounts">
            <span class="nav-item-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="2" x2="12" y2="22"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
              </svg>
            </span>
            <span>Chart of Accounts</span>
          </button>
          <button class="nav-item" data-tab="bank-accounts">
            <span class="nav-item-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                <line x1="1" y1="10" x2="23" y2="10"></line>
              </svg>
            </span>
            <span>Bank Accounts</span>
          </button>
          <button class="nav-item" data-tab="bank-imports">
            <span class="nav-item-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
            </span>
            <span>Bank Imports</span>
          </button>
          <button class="nav-item" data-tab="bank-rules">
            <span class="nav-item-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
            </span>
            <span>Bank Rules</span>
          </button>
          <button class="nav-item" data-tab="unmatched-transactions">
            <span class="nav-item-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
            </span>
            <span>Unmatched Transactions</span>
          </button>
        </div>
        {% endif %}
        </nav>

      <div class="sidebar-footer">
        {% if is_charl %}
        <a href="/admin" class="nav-item admin-nav-item" title="Admin Panel">
          <span class="nav-item-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
              <path d="M9 12l2 2 4-4"></path>
            </svg>
          </span>
          <span>Admin</span>
        </a>
        {% else %}
        <div class="nav-item admin-nav-item disabled" title="Admin access restricted">
          <span class="nav-item-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
              <path d="M9 12l2 2 4-4"></path>
            </svg>
          </span>
          <span>Admin</span>
        </div>
        {% endif %}
        <div class="user-info">
          <div class="user-avatar">{{ username[0]|upper if username else 'U' }}</div>
          <div class="user-details">
            <div class="user-name">{{ username }}</div>
            <div class="user-role">Administrator</div>
      </div>
          <a href="/" class="sign-out-btn" title="Sign out">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16,17 21,12 16,7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
          </a>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Top Bar -->
      <header class="top-bar">
        <button class="mobile-menu-btn" id="mobile-menu-btn">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>
        <div class="page-title-section">
          <h1 class="page-title" id="page-title">Dashboard</h1>
          <p class="page-subtitle" id="page-subtitle">Overview of your pharmacy performance</p>
        </div>
        <div class="top-bar-controls">
          <button class="pharmacy-picker-btn" id="pharmacy-picker-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 3h18v18H3z"></path>
              <path d="M3 9h18"></path>
              <path d="M9 21V9"></path>
            </svg>
            <span id="selected-pharmacy-display">Select Pharmacy</span>
          </button>
          <button class="group-view-toggle-btn" id="group-view-toggle-btn" title="Toggle Group View">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="7" height="7"></rect>
              <rect x="14" y="3" width="7" height="7"></rect>
              <rect x="14" y="14" width="7" height="7"></rect>
              <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
            <span>Group</span>
          </button>
          <label class="with-icon" id="month-control">
          <span>Month</span>
          <input class="control-lg" type="month" id="report-month" name="report_month" />
        </label>
          <button class="date-picker-btn" id="date-picker-btn" style="display: none;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <span id="selected-date-display">Today</span>
          </button>
    </div>
  </header>

      <!-- Content Area -->
      <main class="content-area">
        {% if error %}
        <div class="alert error">{{ error }}</div>
        {% endif %}

      <section id="tab-dashboard" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-dashboard">
        <div class="dashboard-container">
          <div class="section-heading-with-toggle">
            <h2 class="section-heading">Summary</h2>
            <div class="summary-view-toggle">
              <button class="summary-view-toggle-btn active" id="summary-view-monthly" data-view="monthly">
                <span>Monthly</span>
              </button>
              <button class="summary-view-toggle-btn" id="summary-view-daily" data-view="daily">
                <span>Daily</span>
              </button>
            </div>
          </div>
          
          <!-- Group View Cards Container -->
          <div class="group-view-container" id="group-view-container" style="display: none;">
            <div class="group-view-grid" id="group-view-grid">
              <!-- Cards will be generated here by JavaScript -->
            </div>
          </div>
          
          <!-- Single Pharmacy View -->
          <div class="single-pharmacy-view" id="single-pharmacy-view">
          <div class="dashboard-summary-layout">
            <!-- Main KPIs -->
            <div class="dashboard-card primary">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                  </svg>
                </span>
                <h3 id="dash-current-month-header">Current Month Turnover</h3>
              </div>
              <div class="card-value-row">
                <div class="card-value-wrapper">
                  <span class="card-value-currency" id="dash-current-turnover-currency">R</span>
                  <span class="card-value-amount" id="dash-current-turnover">—</span>
                </div>
                <div class="card-value-percentage" id="dash-current-turnover-percentage"></div>
              </div>
              <div class="card-comparison-text" id="dash-current-turnover-comparison">—</div>
            </div>

            <div class="dashboard-card metric-gp">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2v20M2 12h20"></path>
                    <circle cx="12" cy="12" r="10"></circle>
                  </svg>
                </span>
                <h3 id="dash-budget-month-header">MTD Target</h3>
              </div>
              <div class="card-value-row">
                <div class="card-value-wrapper">
                  <span class="card-value-currency" id="dash-budget-turnover-currency">R</span>
                  <span class="card-value-amount" id="dash-budget-turnover">—</span>
                </div>
                <div class="card-value-percentage" id="dash-budget-turnover-percentage"></div>
              </div>
              <div class="card-comparison-text" id="dash-budget-turnover-comparison">—</div>
            </div>

            <div class="dashboard-card metric-gp">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                  </svg>
                </span>
                <h3>GP</h3>
              </div>
              <div class="card-value-wrapper">
                <span class="card-value-currency" id="dash-gp-percent-currency">%</span>
                <span class="card-value-amount" id="dash-gp-percent">—</span>
              </div>
              <div class="card-comparison-text" id="dash-gp-value">—</div>
            </div>

            <div class="dashboard-card metric-basket">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                    <line x1="7" y1="7" x2="7.01" y2="7"></line>
                  </svg>
                </span>
                <h3>Basket</h3>
              </div>
              <div class="card-value-wrapper">
                <span class="card-value-currency" id="dash-basket-currency">R</span>
                <span class="card-value-amount" id="dash-basket-value">—</span>
              </div>
              <div class="card-comparison-text" id="dash-transaction-count">—</div>
            </div>
            </div>

          <!-- Combined Metrics Card for Mobile/Narrow Screens -->
          <div class="dashboard-card dashboard-combined-metrics-card">
            <!-- MTD Turnover Section -->
            <div class="combined-metric-section">
              <div class="combined-metric-header">
                <span class="combined-metric-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                  </svg>
                </span>
                <h3 id="mobile-dash-current-month-header">MTD Turnover</h3>
              </div>
              <div class="combined-metric-value-row">
                <div class="combined-metric-value">
                  <span class="card-value-amount" id="mobile-dash-current-turnover">—</span>
                </div>
                <div class="combined-metric-comparison combined-metric-percentage" id="mobile-dash-current-turnover-percentage"></div>
              </div>
              <div class="combined-metric-comparison" id="mobile-dash-current-turnover-comparison">—</div>
            </div>

            <!-- MTD Target Section -->
            <div class="combined-metric-section">
              <div class="combined-metric-header">
                <span class="combined-metric-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2v20M2 12h20"></path>
                    <circle cx="12" cy="12" r="10"></circle>
                  </svg>
                </span>
                <h3 id="mobile-dash-budget-month-header">MTD Target</h3>
              </div>
              <div class="combined-metric-value-row">
                <div class="combined-metric-value">
                  <span class="card-value-amount" id="mobile-dash-budget-turnover">—</span>
                </div>
                <div class="combined-metric-comparison combined-metric-percentage" id="mobile-dash-budget-turnover-percentage"></div>
              </div>
              <div class="combined-metric-comparison" id="mobile-dash-budget-turnover-comparison">—</div>
            </div>

            <!-- Purchases Section -->
            <div class="combined-metric-section">
              <div class="combined-metric-header">
                <span class="combined-metric-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                  </svg>
                </span>
                <h3>Purchases</h3>
              </div>
              <div class="combined-metric-value-row">
                <div class="combined-metric-value">
                  <span class="card-value-amount" id="mobile-dash-purchases-value">—</span>
                </div>
              </div>
              <div class="combined-metric-comparison" id="mobile-dash-purchases-comparison">—</div>
            </div>

            <!-- Purchase Budget Section -->
            <div class="combined-metric-section">
              <div class="combined-metric-header">
                <span class="combined-metric-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                  </svg>
                </span>
                <h3>Purchase Budget</h3>
              </div>
              <div class="combined-metric-value-row">
                <div class="combined-metric-value">
                  <span class="card-value-amount" id="mobile-dash-purchase-budget">—</span>
                </div>
                <div class="combined-metric-comparison combined-metric-percentage" id="mobile-dash-purchase-budget-percentage"></div>
              </div>
              <div class="combined-metric-comparison" id="mobile-dash-purchase-budget-comparison">—</div>
            </div>

            <!-- GP Section -->
            <div class="combined-metric-section">
              <div class="combined-metric-header">
                <span class="combined-metric-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                  </svg>
                </span>
                <h3>GP</h3>
              </div>
              <div class="combined-metric-value-row">
                <div class="combined-metric-value">
                  <span class="card-value-amount" id="mobile-dash-gp-percent">—</span>
                </div>
              </div>
              <div class="combined-metric-comparison" id="mobile-dash-gp-value">—</div>
            </div>

            <!-- Basket Section -->
            <div class="combined-metric-section">
              <div class="combined-metric-header">
                <span class="combined-metric-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                    <line x1="7" y1="7" x2="7.01" y2="7"></line>
                  </svg>
                </span>
                <h3>Basket</h3>
              </div>
              <div class="combined-metric-value-row">
                <div class="combined-metric-value">
                  <span class="card-value-amount" id="mobile-dash-basket-value">—</span>
                </div>
              </div>
              <div class="combined-metric-comparison" id="mobile-dash-transaction-count">—</div>
            </div>
          </div>
          </div>

          <!-- Spend Analytics Section -->
          <div id="spend-analytics-section">
          <h2 class="section-heading">Spend Analytics</h2>
          
          <!-- Purchases and Purchase Budget Cards -->
          <div class="spend-analytics-metric-cards">
            <div class="dashboard-card metric-purchases">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                  </svg>
                </span>
                <h3>Purchases</h3>
              </div>
              <div class="card-value-wrapper">
                <span class="card-value-currency" id="dash-purchases-value-currency">R</span>
                <span class="card-value-amount" id="dash-purchases-value">—</span>
              </div>
              <div class="card-comparison-text" id="dash-purchases-comparison">—</div>
            </div>

            <div class="dashboard-card metric-purchase-budget">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                  </svg>
                </span>
                <h3>Purchase Budget</h3>
              </div>
              <div class="card-value-row">
                <div class="card-value-wrapper">
                  <span class="card-value-currency" id="dash-purchase-budget-currency">R</span>
                  <span class="card-value-amount" id="dash-purchase-budget">—</span>
                </div>
                <div class="card-value-percentage" id="dash-purchase-budget-percentage"></div>
              </div>
              <div class="card-comparison-text" id="dash-purchase-budget-comparison">—</div>
            </div>
          </div>
          
          <div class="spend-analytics-container">
            <!-- Two cards side by side with pie charts -->
            <div class="dashboard-card spend-budget-card">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                  </svg>
                </span>
                <h3>Purchase vs Budget Spend</h3>
              </div>
              <div class="spend-budget-card-content">
                <div class="spend-budget-metrics">
                  <div class="spend-budget-metric-item">
                    <div class="spend-budget-metric-label">Purchases</div>
                    <div class="spend-budget-metric-value" id="spend-budget-purchases-value">—</div>
                  </div>
                  <div class="spend-budget-metric-item">
                    <div class="spend-budget-metric-label">Budget</div>
                    <div class="spend-budget-metric-value" id="spend-budget-budget-value">—</div>
                  </div>
                  <div class="spend-budget-metric-item">
                    <div class="spend-budget-metric-label" id="spend-budget-diff-label">Difference</div>
                    <div class="spend-budget-metric-value" id="spend-budget-diff-value">—</div>
                  </div>
                </div>
                <div class="spend-budget-chart-wrapper">
                  <svg class="spend-analytics-chart-svg" viewBox="0 0 120 120">
                    <defs>
                      <linearGradient id="pieGradientBudget" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#59BA47;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#7DD87A;stop-opacity:1" />
                      </linearGradient>
                    </defs>
                    <circle cx="60" cy="60" r="50" fill="none" stroke="#E5E7EB" stroke-width="20"/>
                    <circle cx="60" cy="60" r="50" fill="none" stroke="url(#pieGradientBudget)" stroke-width="20" stroke-dasharray="314" stroke-dashoffset="314" style="transition: stroke-dashoffset 1s ease; stroke-linecap: round;" class="chart-segment" id="spend-budget-chart-segment"/>
                  </svg>
                  <div class="chart-center-content">
                    <span class="chart-center-value" id="spend-budget-percentage">0%</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="dashboard-card spend-turnover-card">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                  </svg>
                </span>
                <h3>Purchase vs Turnover</h3>
              </div>
              <div class="spend-budget-card-content">
                <div class="spend-budget-metrics">
                  <div class="spend-budget-metric-item">
                    <div class="spend-budget-metric-label">Purchases</div>
                    <div class="spend-budget-metric-value" id="spend-turnover-purchases-value">—</div>
                  </div>
                  <div class="spend-budget-metric-item">
                    <div class="spend-budget-metric-label">Turnover</div>
                    <div class="spend-budget-metric-value" id="spend-turnover-turnover-value">—</div>
                  </div>
                  <div class="spend-budget-metric-item">
                    <div class="spend-budget-metric-label">% of Turnover</div>
                    <div class="spend-budget-metric-value" id="spend-turnover-percentage-value">—</div>
                  </div>
                </div>
                <div class="spend-budget-chart-wrapper">
                  <svg class="spend-analytics-chart-svg" viewBox="0 0 120 120">
                    <defs>
                      <linearGradient id="pieGradientTurnover" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#FF4509;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#FFA500;stop-opacity:1" />
                      </linearGradient>
                    </defs>
                    <circle cx="60" cy="60" r="50" fill="none" stroke="#E5E7EB" stroke-width="20"/>
                    <circle cx="60" cy="60" r="50" fill="none" stroke="url(#pieGradientTurnover)" stroke-width="20" stroke-dasharray="314" stroke-dashoffset="314" style="transition: stroke-dashoffset 1s ease; stroke-linecap: round;" class="chart-segment" id="spend-turnover-chart-segment"/>
                  </svg>
                  <div class="chart-center-content">
                    <span class="chart-center-value" id="spend-turnover-percentage">0%</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Chart card spanning all two columns -->
            <div class="dashboard-card" style="grid-column: span 2;">
              <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Purchase vs Spend Budget</h3>
                <button class="chart-toggle-btn" id="spend-chart-toggle" aria-label="Toggle chart">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 20px; height: 20px;">
                    <polyline points="18 15 12 9 6 15"></polyline>
                  </svg>
                </button>
              </div>
              <div class="chart-container" id="spend-chart-container" style="display: none;">
                <canvas id="spend-analytics-chart"></canvas>
                <div class="chart-legend">
                  <span class="legend-item legend-purchases"><i class="legend-line"></i> Purchases</span>
                  <span class="legend-item legend-budget"><i class="legend-line"></i> Spend Budget</span>
                </div>
                <div class="chart-tooltip" id="spend-analytics-tooltip" style="display:none;"></div>
              </div>
            </div>
            </div>
          </div>

          <!-- Section below dashboard grid -->
          <div class="dashboard-below-grid">
            <!-- Spend Analysis -->
            <div class="dashboard-card wide">
              <div class="card-header">
                <h3>Spend Analysis</h3>
              </div>
              <div class="spend-comparison">
                <div class="spend-item">
                  <div class="spend-label">Actual Spend Budget (75% of T/O)</div>
                  <div class="spend-value" id="dash-actual-spend">—</div>
                  <div class="spend-bar">
                    <div class="spend-fill actual" id="dash-actual-bar"></div>
                  </div>
                </div>
                <div class="spend-item">
                  <div class="spend-label">Purchases</div>
                  <div class="spend-value" id="dash-purchases">—</div>
                  <div class="spend-bar">
                    <div class="spend-fill purchases" id="dash-purchases-bar"></div>
                  </div>
                </div>
                <div class="spend-summary">
                  <div class="spend-diff" id="dash-spend-diff">—</div>
                </div>
              </div>
            </div>

            <!-- Performance Indicator -->
            <div class="dashboard-card performance">
              <div class="card-header">
                <h3>Target Performance</h3>
              </div>
              <div class="performance-circle">
                <svg class="progress-ring" viewBox="0 0 140 140" preserveAspectRatio="xMidYMid meet">
                  <circle class="progress-ring-bg" cx="70" cy="70" r="60"></circle>
                  <circle class="progress-ring-fill" cx="70" cy="70" r="60" id="dash-progress-circle"></circle>
                </svg>
                <div class="performance-text">
                  <div class="performance-value" id="dash-budget-performance">—</div>
                  <div class="performance-label">vs Budget</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <section id="tab-daily-summary" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-daily-summary" hidden>
        <div class="dashboard-container">
          <h2 class="section-heading">Summary</h2>
          <div class="daily-summary-layout">
            <!-- Daily Summary Cards -->
            <div class="dashboard-card metric-turnover">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                  </svg>
                </span>
                <h3>Turnover</h3>
                <span class="card-arrow">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="3" y="3" width="4" height="18"></rect>
                    <rect x="10" y="8" width="4" height="13"></rect>
                    <rect x="17" y="12" width="4" height="9"></rect>
                  </svg>
                </span>
              </div>
              <div class="card-value-wrapper">
                <span class="card-value-currency" id="daily-turnover-currency">R</span>
                <span class="card-value-amount" id="daily-turnover">—</span>
              </div>
              <div class="card-comparison-simple" id="daily-turnover-comparison-simple">—</div>
            </div>

            <div class="dashboard-card metric-gp">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                  </svg>
                </span>
                <h3>GP%</h3>
                <div class="gp-toggle-container">
                  <button class="gp-toggle-btn" id="daily-gp-toggle" data-mode="full">
                    <span class="gp-toggle-label">Full</span>
                  </button>
                </div>
                <span class="card-arrow">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="3" y="3" width="4" height="18"></rect>
                    <rect x="10" y="8" width="4" height="13"></rect>
                    <rect x="17" y="12" width="4" height="9"></rect>
                  </svg>
                </span>
              </div>
              <div class="card-value-wrapper">
                <span class="card-value-currency" id="daily-gp-percent-currency">%</span>
                <span class="card-value-amount" id="daily-gp-percent">—</span>
              </div>
              <div class="card-comparison-simple" id="daily-gp-value">—</div>
              <div class="card-comparison-simple gp-split-view" id="daily-gp-split" style="display: none;">
                <div class="gp-split-line" id="daily-gp-dispensary">—</div>
                <div class="gp-split-line" id="daily-gp-frontshop">—</div>
              </div>
            </div>

            <div class="dashboard-card metric-purchases">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                  </svg>
                </span>
                <h3>Purchases</h3>
                <span class="card-arrow">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="3" y="3" width="4" height="18"></rect>
                    <rect x="10" y="8" width="4" height="13"></rect>
                    <rect x="17" y="12" width="4" height="9"></rect>
                  </svg>
                </span>
              </div>
              <div class="card-value-wrapper">
                <span class="card-value-currency" id="daily-purchases-currency">R</span>
                <span class="card-value-amount" id="daily-purchases">—</span>
              </div>
              <div class="card-comparison-simple" id="daily-cost-of-sales">—</div>
            </div>

            <div class="dashboard-card metric-basket">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                    <line x1="7" y1="7" x2="7.01" y2="7"></line>
                  </svg>
                </span>
                <h3>Basket</h3>
                <span class="card-arrow">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="3" y="3" width="4" height="18"></rect>
                    <rect x="10" y="8" width="4" height="13"></rect>
                    <rect x="17" y="12" width="4" height="9"></rect>
                  </svg>
                </span>
              </div>
              <div class="card-value-wrapper">
                <span class="card-value-currency" id="daily-basket-currency">R</span>
                <span class="card-value-amount" id="daily-basket-value">—</span>
              </div>
              <div class="card-comparison-simple" id="daily-transaction-count">—</div>
            </div>
          
          <!-- Combined Metrics Card for Mobile -->
          <div class="dashboard-card combined-metrics-card">
            <!-- Turnover Section -->
            <div class="combined-metric-section">
              <div class="combined-metric-header">
                <span class="combined-metric-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                  </svg>
                </span>
                <h3>Turnover</h3>
                <span class="card-arrow">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="3" y="3" width="4" height="18"></rect>
                    <rect x="10" y="8" width="4" height="13"></rect>
                    <rect x="17" y="12" width="4" height="9"></rect>
                  </svg>
                </span>
              </div>
              <div class="combined-metric-value-row">
                <div class="combined-metric-value">
                  <span class="card-value-currency">R</span>
                  <span class="card-value-amount" id="mobile-daily-turnover">—</span>
                </div>
                <div class="combined-metric-comparison" id="mobile-daily-turnover-comparison">—</div>
              </div>
            </div>
            
            <!-- GP% Section -->
            <div class="combined-metric-section">
              <div class="combined-metric-header">
                <span class="combined-metric-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                  </svg>
                </span>
                <h3>GP%</h3>
                <div class="gp-toggle-container">
                  <button class="gp-toggle-btn" id="mobile-daily-gp-toggle" data-mode="full">
                    <span class="gp-toggle-label">Full</span>
                  </button>
                </div>
                <span class="card-arrow">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="3" y="3" width="4" height="18"></rect>
                    <rect x="10" y="8" width="4" height="13"></rect>
                    <rect x="17" y="12" width="4" height="9"></rect>
                  </svg>
                </span>
              </div>
              <div class="combined-metric-value-row">
                <div class="combined-metric-value">
                  <span class="card-value-amount" id="mobile-daily-gp-percent">—</span>
                </div>
                <div class="combined-metric-comparison" id="mobile-daily-gp-value">—</div>
              </div>
              <div class="combined-metric-comparison gp-split-view" id="mobile-daily-gp-split" style="display: none;">
                <div class="gp-split-line" id="mobile-daily-gp-dispensary">—</div>
                <div class="gp-split-line" id="mobile-daily-gp-frontshop">—</div>
              </div>
            </div>
            
            <!-- Purchases Section -->
            <div class="combined-metric-section">
              <div class="combined-metric-header">
                <span class="combined-metric-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                  </svg>
                </span>
                <h3>Purchases</h3>
                <span class="card-arrow">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="3" y="3" width="4" height="18"></rect>
                    <rect x="10" y="8" width="4" height="13"></rect>
                    <rect x="17" y="12" width="4" height="9"></rect>
                  </svg>
                </span>
              </div>
              <div class="combined-metric-value-row">
                <div class="combined-metric-value">
                  <span class="card-value-currency">R</span>
                  <span class="card-value-amount" id="mobile-daily-purchases">—</span>
                </div>
                <div class="combined-metric-comparison" id="mobile-daily-cost-of-sales">—</div>
              </div>
            </div>
            
            <!-- Basket Section -->
            <div class="combined-metric-section">
              <div class="combined-metric-header">
                <span class="combined-metric-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                    <line x1="7" y1="7" x2="7.01" y2="7"></line>
                  </svg>
                </span>
                <h3>Basket</h3>
                <span class="card-arrow">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="3" y="3" width="4" height="18"></rect>
                    <rect x="10" y="8" width="4" height="13"></rect>
                    <rect x="17" y="12" width="4" height="9"></rect>
                  </svg>
                </span>
              </div>
              <div class="combined-metric-value-row">
                <div class="combined-metric-value">
                  <span class="card-value-currency">R</span>
                  <span class="card-value-amount" id="mobile-daily-basket-value">—</span>
                </div>
                <div class="combined-metric-comparison" id="mobile-daily-transaction-count">—</div>
              </div>
            </div>
          </div>
          
          <!-- Dispensary Summary Section Wrapper -->
          <div class="dispensary-summary-section">
            <h2 class="section-heading dispensary-summary-heading">Dispensary Summary</h2>
            
            <!-- Dispensary Cards Container -->
            <div class="dispensary-cards-container">
            <!-- Split Card -->
            <div class="dashboard-card metric-split">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                    <path d="M2 17l10 5 10-5"></path>
                    <path d="M2 12l10 5 10-5"></path>
                  </svg>
                </span>
                <h3>Split</h3>
              </div>
              
              <div class="dispensary-content-wrapper">
                <div class="split-content-wrapper">
                  <!-- Dispensary Value -->
                  <div class="split-list-item">
                    <div class="dispensary-list-label dispensary-label-dispensary">Dispensary</div>
                    <div class="dispensary-list-value-wrapper">
                      <span class="dispensary-list-currency">R</span>
                      <span class="dispensary-list-value" id="dispensary-value">—</span>
                    </div>
                  </div>
                  
                  <!-- Front Shop Value -->
                  <div class="split-list-item">
                    <div class="dispensary-list-label dispensary-label-frontshop">Front Shop</div>
                    <div class="dispensary-list-value-wrapper">
                      <span class="dispensary-list-currency">R</span>
                      <span class="dispensary-list-value" id="frontshop-value">—</span>
                    </div>
                  </div>
                </div>
                
                <!-- Chart Container -->
                <div class="dispensary-chart-container">
                  <svg class="dispensary-chart-svg" viewBox="0 0 120 120">
                    <defs>
                      <linearGradient id="pieGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#FF4509;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#FFA500;stop-opacity:1" />
                      </linearGradient>
                    </defs>
                    <circle cx="60" cy="60" r="50" fill="none" stroke="#E5E7EB" stroke-width="20"/>
                    <circle cx="60" cy="60" r="50" fill="none" stroke="url(#pieGradient)" stroke-width="20" stroke-dasharray="314" stroke-dashoffset="314" style="transition: stroke-dashoffset 1s ease; stroke-linecap: round;" class="chart-segment"/>
                  </svg>
                  <div class="chart-center-content">
                    <span class="chart-center-value" id="dispensary-percentage">0%</span>
                  </div>
                </div>
              </div>
              
              <!-- Scripts Section (hidden on large screens, shown on small screens) -->
              <div class="scripts-section-mobile">
                <div class="scripts-header">
                  <span class="scripts-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                      <polyline points="14,2 14,8 20,8"></polyline>
                      <line x1="16" y1="13" x2="8" y2="13"></line>
                      <line x1="16" y1="17" x2="8" y2="17"></line>
                      <polyline points="10,9 9,9 8,9"></polyline>
                    </svg>
                  </span>
                  <h4>Scripts</h4>
                </div>
                
                <div class="scripts-content-wrapper">
                  <!-- Avg Script Value -->
                  <div class="scripts-list-item">
                    <div class="dispensary-list-label dispensary-label-avg">Avg Script</div>
                    <div class="dispensary-list-value-wrapper">
                      <span class="dispensary-list-currency">R</span>
                      <span class="dispensary-list-value" id="dispensary-avg-script-mobile">—</span>
                    </div>
                  </div>
                  
                  <!-- Scripts Count -->
                  <div class="scripts-list-item">
                    <div class="dispensary-list-label dispensary-label-scripts">Scripts</div>
                    <div class="dispensary-list-value" id="dispensary-scripts-mobile">—</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Scripts Card (hidden on small screens) -->
            <div class="dashboard-card metric-scripts">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14,2 14,8 20,8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10,9 9,9 8,9"></polyline>
                  </svg>
                </span>
                <h3>Scripts</h3>
              </div>
              
              <div class="scripts-content-wrapper">
                <!-- Avg Script Value -->
                <div class="scripts-list-item">
                  <div class="dispensary-list-label dispensary-label-avg">Avg Script</div>
                  <div class="dispensary-list-value-wrapper">
                    <span class="dispensary-list-currency">R</span>
                    <span class="dispensary-list-value" id="dispensary-avg-script">—</span>
                  </div>
                </div>
                
                <!-- Scripts Count -->
                <div class="scripts-list-item">
                  <div class="dispensary-list-label dispensary-label-scripts">Scripts</div>
                  <div class="dispensary-list-value" id="dispensary-scripts">—</div>
                </div>
              </div>
            </div>
            </div>
          </div>
          
          <!-- Stock Summary Section -->
          <div class="stock-summary-section">
            <h2 class="section-heading dispensary-summary-heading">Stock Summary</h2>
            
            <!-- Stock Cards Container -->
            <div class="dispensary-cards-container">
              <!-- First Stock Card -->
              <div class="dashboard-card metric-split">
                <div class="card-header with-icon">
                  <span class="card-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                      <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                    </svg>
                  </span>
                  <h3>Best Sellers</h3>
                  <span class="card-arrow" id="best-sellers-chart-btn" style="cursor: pointer;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="8" y1="6" x2="21" y2="6"></line>
                      <line x1="8" y1="12" x2="21" y2="12"></line>
                      <line x1="8" y1="18" x2="21" y2="18"></line>
                      <line x1="3" y1="6" x2="3.01" y2="6"></line>
                      <line x1="3" y1="12" x2="3.01" y2="12"></line>
                      <line x1="3" y1="18" x2="3.01" y2="18"></line>
                    </svg>
                  </span>
                </div>
                
                <div class="best-sellers-content" id="best-sellers-list">
                  <!-- Best sellers will be loaded dynamically -->
                  <div class="best-seller-item">
                    <div class="best-seller-details">
                      <div class="best-seller-name">Loading...</div>
                      <div class="best-seller-code">—</div>
                    </div>
                    <div class="best-seller-stats">
                      <div class="best-seller-qty">—</div>
                      <div class="best-seller-gp">—</div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Second Stock Card - Worst GP Products -->
              <div class="dashboard-card metric-scripts">
                <div class="card-header with-icon">
                  <span class="card-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                      <line x1="12" y1="9" x2="12" y2="13"></line>
                      <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                  </span>
                  <h3>Low GP Products</h3>
                  <span class="card-arrow" id="worst-gp-list-btn" style="cursor: pointer;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="8" y1="6" x2="21" y2="6"></line>
                      <line x1="8" y1="12" x2="21" y2="12"></line>
                      <line x1="8" y1="18" x2="21" y2="18"></line>
                      <line x1="3" y1="6" x2="3.01" y2="6"></line>
                      <line x1="3" y1="12" x2="3.01" y2="12"></line>
                      <line x1="3" y1="18" x2="3.01" y2="18"></line>
                    </svg>
                  </span>
                </div>
                
                <div class="best-sellers-content" id="worst-gp-list">
                  <!-- Worst GP products will be loaded dynamically -->
                  <div class="best-seller-item">
                    <div class="best-seller-details">
                      <div class="best-seller-name">Loading...</div>
                      <div class="best-seller-code">—</div>
                    </div>
                    <div class="best-seller-stats">
                      <div class="best-seller-qty">—</div>
                      <div class="best-seller-gp">—</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <section id="tab-monthly-summary" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-monthly-summary" hidden>
        <div class="dashboard-container">
          <h2 class="section-heading">Monthly Summary</h2>
          <div class="daily-summary-layout">
            <!-- Monthly Summary Cards -->
            <div class="dashboard-card metric-turnover">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                  </svg>
                </span>
                <h3>Turnover</h3>
                <span class="card-arrow">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="3" y="3" width="4" height="18"></rect>
                    <rect x="10" y="8" width="4" height="13"></rect>
                    <rect x="17" y="12" width="4" height="9"></rect>
                  </svg>
                </span>
              </div>
              <div class="card-value-wrapper">
                <span class="card-value-currency" id="monthly-turnover-currency">R</span>
                <span class="card-value-amount" id="monthly-turnover">—</span>
              </div>
              <div class="card-comparison-simple" id="monthly-turnover-comparison-simple">—</div>
            </div>

            <div class="dashboard-card metric-gp">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                  </svg>
                </span>
                <h3>GP%</h3>
                <div class="gp-toggle-container">
                  <button class="gp-toggle-btn" id="monthly-gp-toggle" data-mode="full">
                    <span class="gp-toggle-label">Full</span>
                  </button>
                </div>
                <span class="card-arrow">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="3" y="3" width="4" height="18"></rect>
                    <rect x="10" y="8" width="4" height="13"></rect>
                    <rect x="17" y="12" width="4" height="9"></rect>
                  </svg>
                </span>
              </div>
              <div class="card-value-wrapper">
                <span class="card-value-currency" id="monthly-gp-percent-currency">%</span>
                <span class="card-value-amount" id="monthly-gp-percent">—</span>
              </div>
              <div class="card-comparison-simple" id="monthly-gp-value">—</div>
              <div class="card-comparison-simple gp-split-view" id="monthly-gp-split" style="display: none;">
                <div class="gp-split-line" id="monthly-gp-dispensary">—</div>
                <div class="gp-split-line" id="monthly-gp-frontshop">—</div>
              </div>
            </div>

            <div class="dashboard-card metric-purchases">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                  </svg>
                </span>
                <h3>Purchases</h3>
                <span class="card-arrow">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="3" y="3" width="4" height="18"></rect>
                    <rect x="10" y="8" width="4" height="13"></rect>
                    <rect x="17" y="12" width="4" height="9"></rect>
                  </svg>
                </span>
              </div>
              <div class="card-value-wrapper">
                <span class="card-value-currency" id="monthly-purchases-currency">R</span>
                <span class="card-value-amount" id="monthly-purchases">—</span>
              </div>
              <div class="card-comparison-simple" id="monthly-cost-of-sales">—</div>
            </div>

            <div class="dashboard-card metric-basket">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                    <line x1="7" y1="7" x2="7.01" y2="7"></line>
                  </svg>
                </span>
                <h3>Basket</h3>
                <span class="card-arrow">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="3" y="3" width="4" height="18"></rect>
                    <rect x="10" y="8" width="4" height="13"></rect>
                    <rect x="17" y="12" width="4" height="9"></rect>
                  </svg>
                </span>
              </div>
              <div class="card-value-wrapper">
                <span class="card-value-currency" id="monthly-basket-currency">R</span>
                <span class="card-value-amount" id="monthly-basket-value">—</span>
              </div>
              <div class="card-comparison-simple" id="monthly-transaction-count">—</div>
            </div>
          
          <!-- Combined Metrics Card for Mobile -->
          <div class="dashboard-card combined-metrics-card">
            <!-- Turnover Section -->
            <div class="combined-metric-section">
              <div class="combined-metric-header">
                <span class="combined-metric-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                  </svg>
                </span>
                <h3>Turnover</h3>
                <span class="card-arrow">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="3" y="3" width="4" height="18"></rect>
                    <rect x="10" y="8" width="4" height="13"></rect>
                    <rect x="17" y="12" width="4" height="9"></rect>
                  </svg>
                </span>
              </div>
              <div class="combined-metric-value-row">
                <div class="combined-metric-value">
                  <span class="card-value-currency">R</span>
                  <span class="card-value-amount" id="mobile-monthly-turnover">—</span>
                </div>
                <div class="combined-metric-comparison" id="mobile-monthly-turnover-comparison">—</div>
              </div>
            </div>
            
            <!-- GP% Section -->
            <div class="combined-metric-section">
              <div class="combined-metric-header">
                <span class="combined-metric-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                  </svg>
                </span>
                <h3>GP%</h3>
                <div class="gp-toggle-container">
                  <button class="gp-toggle-btn" id="mobile-monthly-gp-toggle" data-mode="full">
                    <span class="gp-toggle-label">Full</span>
                  </button>
                </div>
                <span class="card-arrow">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="3" y="3" width="4" height="18"></rect>
                    <rect x="10" y="8" width="4" height="13"></rect>
                    <rect x="17" y="12" width="4" height="9"></rect>
                  </svg>
                </span>
              </div>
              <div class="combined-metric-value-row">
                <div class="combined-metric-value">
                  <span class="card-value-amount" id="mobile-monthly-gp-percent">—</span>
                </div>
                <div class="combined-metric-comparison" id="mobile-monthly-gp-value">—</div>
              </div>
              <div class="combined-metric-comparison gp-split-view" id="mobile-monthly-gp-split" style="display: none;">
                <div class="gp-split-line" id="mobile-monthly-gp-dispensary">—</div>
                <div class="gp-split-line" id="mobile-monthly-gp-frontshop">—</div>
              </div>
            </div>
            
            <!-- Purchases Section -->
            <div class="combined-metric-section">
              <div class="combined-metric-header">
                <span class="combined-metric-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                  </svg>
                </span>
                <h3>Purchases</h3>
                <span class="card-arrow">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="3" y="3" width="4" height="18"></rect>
                    <rect x="10" y="8" width="4" height="13"></rect>
                    <rect x="17" y="12" width="4" height="9"></rect>
                  </svg>
                </span>
              </div>
              <div class="combined-metric-value-row">
                <div class="combined-metric-value">
                  <span class="card-value-currency">R</span>
                  <span class="card-value-amount" id="mobile-monthly-purchases">—</span>
                </div>
                <div class="combined-metric-comparison" id="mobile-monthly-cost-of-sales">—</div>
              </div>
            </div>
            
            <!-- Basket Section -->
            <div class="combined-metric-section">
              <div class="combined-metric-header">
                <span class="combined-metric-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                    <line x1="7" y1="7" x2="7.01" y2="7"></line>
                  </svg>
                </span>
                <h3>Basket</h3>
                <span class="card-arrow">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="3" y="3" width="4" height="18"></rect>
                    <rect x="10" y="8" width="4" height="13"></rect>
                    <rect x="17" y="12" width="4" height="9"></rect>
                  </svg>
                </span>
              </div>
              <div class="combined-metric-value-row">
                <div class="combined-metric-value">
                  <span class="card-value-currency">R</span>
                  <span class="card-value-amount" id="mobile-monthly-basket-value">—</span>
                </div>
                <div class="combined-metric-comparison" id="mobile-monthly-transaction-count">—</div>
              </div>
            </div>
          </div>
          
          <!-- Dispensary Summary Section Wrapper -->
          <div class="dispensary-summary-section">
            <h2 class="section-heading dispensary-summary-heading">Dispensary Summary</h2>
            
            <!-- Dispensary Cards Container -->
            <div class="dispensary-cards-container">
            <!-- Split Card -->
            <div class="dashboard-card metric-split">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                    <path d="M2 17l10 5 10-5"></path>
                    <path d="M2 12l10 5 10-5"></path>
                  </svg>
                </span>
                <h3>Split</h3>
              </div>
              
              <div class="dispensary-content-wrapper">
                <div class="split-content-wrapper">
                  <!-- Dispensary Value -->
                  <div class="split-list-item">
                    <div class="dispensary-list-label dispensary-label-dispensary">Dispensary</div>
                    <div class="dispensary-list-value-wrapper">
                      <span class="dispensary-list-currency">R</span>
                      <span class="dispensary-list-value" id="monthly-dispensary-value">—</span>
                    </div>
                  </div>
                  
                  <!-- Front Shop Value -->
                  <div class="split-list-item">
                    <div class="dispensary-list-label dispensary-label-frontshop">Front Shop</div>
                    <div class="dispensary-list-value-wrapper">
                      <span class="dispensary-list-currency">R</span>
                      <span class="dispensary-list-value" id="monthly-frontshop-value">—</span>
                    </div>
                  </div>
                </div>
                
                <!-- Chart Container -->
                <div class="dispensary-chart-container">
                  <svg class="dispensary-chart-svg" viewBox="0 0 120 120">
                    <defs>
                      <linearGradient id="pieGradientMonthly" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#FF4509;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#FFA500;stop-opacity:1" />
                      </linearGradient>
                    </defs>
                    <circle cx="60" cy="60" r="50" fill="none" stroke="#E5E7EB" stroke-width="20"/>
                    <circle cx="60" cy="60" r="50" fill="none" stroke="url(#pieGradientMonthly)" stroke-width="20" stroke-dasharray="314" stroke-dashoffset="314" style="transition: stroke-dashoffset 1s ease; stroke-linecap: round;" class="chart-segment" id="monthly-chart-segment"/>
                  </svg>
                  <div class="chart-center-content">
                    <span class="chart-center-value" id="monthly-dispensary-percentage">0%</span>
                  </div>
                </div>
              </div>
              
              <!-- Scripts Section (hidden on large screens, shown on small screens) -->
              <div class="scripts-section-mobile">
                <div class="scripts-header">
                  <span class="scripts-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                      <polyline points="14,2 14,8 20,8"></polyline>
                      <line x1="16" y1="13" x2="8" y2="13"></line>
                      <line x1="16" y1="17" x2="8" y2="17"></line>
                      <polyline points="10,9 9,9 8,9"></polyline>
                    </svg>
                  </span>
                  <h4>Scripts</h4>
                </div>
                
                <div class="scripts-content-wrapper">
                  <!-- Avg Script Value -->
                  <div class="scripts-list-item">
                    <div class="dispensary-list-label dispensary-label-avg">Avg Script</div>
                    <div class="dispensary-list-value-wrapper">
                      <span class="dispensary-list-currency">R</span>
                      <span class="dispensary-list-value" id="monthly-dispensary-avg-script-mobile">—</span>
                    </div>
                  </div>
                  
                  <!-- Scripts Count -->
                  <div class="scripts-list-item">
                    <div class="dispensary-list-label dispensary-label-scripts">Scripts</div>
                    <div class="dispensary-list-value" id="monthly-dispensary-scripts-mobile">—</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Scripts Card (hidden on small screens) -->
            <div class="dashboard-card metric-scripts">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14,2 14,8 20,8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10,9 9,9 8,9"></polyline>
                  </svg>
                </span>
                <h3>Scripts</h3>
              </div>
              
              <div class="scripts-content-wrapper">
                <!-- Avg Script Value -->
                <div class="scripts-list-item">
                  <div class="dispensary-list-label dispensary-label-avg">Avg Script</div>
                  <div class="dispensary-list-value-wrapper">
                    <span class="dispensary-list-currency">R</span>
                    <span class="dispensary-list-value" id="monthly-dispensary-avg-script">—</span>
                  </div>
                </div>
                
                <!-- Scripts Count -->
                <div class="scripts-list-item">
                  <div class="dispensary-list-label dispensary-label-scripts">Scripts</div>
                  <div class="dispensary-list-value" id="monthly-dispensary-scripts">—</div>
                </div>
              </div>
            </div>
            </div>
          </div>
          
          <!-- Stock Summary Section -->
          <div class="stock-summary-section">
            <h2 class="section-heading dispensary-summary-heading">Stock Summary</h2>
            
            <!-- Stock Cards Container -->
            <div class="dispensary-cards-container">
              <!-- First Stock Card -->
              <div class="dashboard-card metric-split">
                <div class="card-header with-icon">
                  <span class="card-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                      <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                    </svg>
                  </span>
                  <h3>Best Sellers</h3>
                  <span class="card-arrow" id="monthly-best-sellers-chart-btn" style="cursor: pointer;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="8" y1="6" x2="21" y2="6"></line>
                      <line x1="8" y1="12" x2="21" y2="12"></line>
                      <line x1="8" y1="18" x2="21" y2="18"></line>
                      <line x1="3" y1="6" x2="3.01" y2="6"></line>
                      <line x1="3" y1="12" x2="3.01" y2="12"></line>
                      <line x1="3" y1="18" x2="3.01" y2="18"></line>
                    </svg>
                  </span>
                </div>
                
                <div class="best-sellers-content" id="monthly-best-sellers-list">
                  <!-- Best sellers will be loaded dynamically -->
                  <div class="best-seller-item">
                    <div class="best-seller-details">
                      <div class="best-seller-name">Loading...</div>
                      <div class="best-seller-code">—</div>
                    </div>
                    <div class="best-seller-stats">
                      <div class="best-seller-qty">—</div>
                      <div class="best-seller-gp">—</div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Second Stock Card - Worst GP Products -->
              <div class="dashboard-card metric-scripts">
                <div class="card-header with-icon">
                  <span class="card-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                      <line x1="12" y1="9" x2="12" y2="13"></line>
                      <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                  </span>
                  <h3>Low GP Products</h3>
                  <span class="card-arrow" id="monthly-worst-gp-list-btn" style="cursor: pointer;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="8" y1="6" x2="21" y2="6"></line>
                      <line x1="8" y1="12" x2="21" y2="12"></line>
                      <line x1="8" y1="18" x2="21" y2="18"></line>
                      <line x1="3" y1="6" x2="3.01" y2="6"></line>
                      <line x1="3" y1="12" x2="3.01" y2="12"></line>
                      <line x1="3" y1="18" x2="3.01" y2="18"></line>
                    </svg>
                  </span>
                </div>
                
                <div class="best-sellers-content" id="monthly-worst-gp-list">
                  <!-- Worst GP products will be loaded dynamically -->
                  <div class="best-seller-item">
                    <div class="best-seller-details">
                      <div class="best-seller-name">Loading...</div>
                      <div class="best-seller-code">—</div>
                    </div>
                    <div class="best-seller-stats">
                      <div class="best-seller-qty">—</div>
                      <div class="best-seller-gp">—</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="tab-daily" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-daily" hidden>
        <div class="table-wrap">
          <table class="data-table" id="days-table">
            <thead>
              <tr>
                <th style="width: 5%"><span class="full-header">Day</span><span class="short-header">Date</span></th>
                <th style="width: 13%"><span class="full-header">Date</span></th>
                <th class="num">Budget T/O</th>
                <th class="num">Actual T/O</th>
                <th class="num">GP%</th>
                <th class="num">GP Value</th>
                <th class="num">Budget Spend (75% of T/O)</th>
                <th class="num">Actual Spend (75% of T/O)</th>
                <th class="num">Purchases</th>
                <th class="num">Purchases %</th>
                <th class="num">Purchase Budget Left</th>
                <th class="num soh">Stock on Hand</th>
              </tr>
            </thead>
            <tbody id="days-tbody">
              <tr><td colspan="12" class="muted center">Loading…</td></tr>
            </tbody>
            <tfoot>
              <tr class="total">
                <td>Total</td>
                <td></td>
                <td class="num" id="days-total-budget-to">—</td>
                <td class="num" id="days-total-turnover">—</td>
                <td class="num" id="days-total-gppct">—</td>
                <td class="num" id="days-total-gp">—</td>
                <td class="num" id="days-total-budget-spend">—</td>
                <td class="num" id="days-total-actual-spend">—</td>
                <td class="num" id="days-total-purchases">—</td>
                <td class="num" id="days-total-purchases-pct">—</td>
                <td class="num"></td>
                <td class="num"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </section>

      <section id="tab-targets" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-targets" hidden>
        <div class="targets-toolbar">
          <div class="targets-controls-group">
            <label for="growth-percent" class="targets-label">Growth %</label>
            <input class="targets-input" type="number" id="growth-percent" value="0" step="1" min="-100" max="1000" />
            <button class="btn btn-primary btn-sm targets-btn" id="apply-growth" type="button">Apply to Targets</button>
          </div>
          <button class="btn btn-primary btn-sm targets-btn" id="save-targets" type="button">Save Targets</button>
        </div>
        <div class="table-wrap">
          <table class="data-table" id="targets-table">
            <thead>
              <tr>
                <th style="width: 5%"><span class="full-header">Day</span><span class="short-header">Date</span></th>
                <th style="width: 15%"><span class="full-header">Date</span></th>
                <th class="num" style="width: 18%">Prev Year T/O</th>
                <th class="num" style="width: 15%">% Growth</th>
                <th class="num" style="width: 18%">Target T/O</th>
              </tr>
            </thead>
            <tbody id="targets-tbody">
              <tr><td colspan="5" class="muted center">Select a month above to load targets…</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <section id="tab-stock-management" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-stock-management" hidden>
        <div class="stock-management-container">
          <!-- Purchases Section -->
          <div class="purchases-section" style="margin-top: 0;">
            <h2 class="section-heading dispensary-summary-heading">Purchases</h2>
            
            <!-- Budget Cards Container -->
            <div class="dispensary-cards-container">
              <!-- Full Month Budget Card -->
              <div class="dashboard-card metric-split">
                <div class="card-header with-icon">
                  <span class="card-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                      <line x1="1" y1="10" x2="23" y2="10"></line>
                    </svg>
                  </span>
                  <h3>Budget</h3>
                </div>
                
                <div class="dispensary-content-wrapper">
                  <div class="split-content-wrapper">
                    <!-- Purchases Value -->
                    <div class="split-list-item">
                      <div class="dispensary-list-label dispensary-label-dispensary">Purchases</div>
                      <div class="dispensary-list-value-wrapper">
                        <span class="dispensary-list-currency">R</span>
                        <span class="dispensary-list-value" id="stock-purchases-value">—</span>
                      </div>
                    </div>
                    
                    <!-- Budget Value -->
                    <div class="split-list-item">
                      <div class="dispensary-list-label dispensary-label-frontshop">Budget</div>
                      <div class="dispensary-list-value-wrapper">
                        <span class="dispensary-list-currency">R</span>
                        <span class="dispensary-list-value" id="stock-budget-value">—</span>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Chart Container -->
                  <div class="dispensary-chart-container">
                    <svg class="dispensary-chart-svg" viewBox="0 0 120 120">
                      <defs>
                        <linearGradient id="budgetPieGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                          <stop offset="0%" style="stop-color:#10B981;stop-opacity:1" />
                          <stop offset="100%" style="stop-color:#34D399;stop-opacity:1" />
                        </linearGradient>
                      </defs>
                      <circle cx="60" cy="60" r="50" fill="none" stroke="#E5E7EB" stroke-width="20"/>
                      <circle cx="60" cy="60" r="50" fill="none" stroke="url(#budgetPieGradient)" stroke-width="20" stroke-dasharray="314" stroke-dashoffset="314" style="transition: stroke-dashoffset 1s ease; stroke-linecap: round;" class="chart-segment" id="stock-budget-chart-segment"/>
                    </svg>
                    <div class="chart-center-content">
                      <span class="chart-center-value" id="stock-budget-percentage">0%</span>
                      <span class="chart-center-label">USED</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- MTD Budget Card -->
              <div class="dashboard-card metric-scripts">
                <div class="card-header with-icon">
                  <span class="card-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                      <line x1="1" y1="10" x2="23" y2="10"></line>
                    </svg>
                  </span>
                  <h3>MTD Budget</h3>
                </div>
                
                <div class="dispensary-content-wrapper">
                  <div class="split-content-wrapper">
                    <!-- Purchases Value -->
                    <div class="split-list-item">
                      <div class="dispensary-list-label dispensary-label-dispensary">Purchases</div>
                      <div class="dispensary-list-value-wrapper">
                        <span class="dispensary-list-currency">R</span>
                        <span class="dispensary-list-value" id="stock-mtd-purchases-value">—</span>
                      </div>
                    </div>
                    
                    <!-- MTD Budget Value -->
                    <div class="split-list-item">
                      <div class="dispensary-list-label dispensary-label-frontshop">MTD Budget</div>
                      <div class="dispensary-list-value-wrapper">
                        <span class="dispensary-list-currency">R</span>
                        <span class="dispensary-list-value" id="stock-mtd-budget-value">—</span>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Chart Container -->
                  <div class="dispensary-chart-container">
                    <svg class="dispensary-chart-svg" viewBox="0 0 120 120">
                      <defs>
                        <linearGradient id="mtdBudgetPieGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                          <stop offset="0%" style="stop-color:#8B5CF6;stop-opacity:1" />
                          <stop offset="100%" style="stop-color:#A78BFA;stop-opacity:1" />
                        </linearGradient>
                      </defs>
                      <circle cx="60" cy="60" r="50" fill="none" stroke="#E5E7EB" stroke-width="20"/>
                      <circle cx="60" cy="60" r="50" fill="none" stroke="url(#mtdBudgetPieGradient)" stroke-width="20" stroke-dasharray="314" stroke-dashoffset="314" style="transition: stroke-dashoffset 1s ease; stroke-linecap: round;" class="chart-segment" id="stock-mtd-budget-chart-segment"/>
                    </svg>
                    <div class="chart-center-content">
                      <span class="chart-center-value" id="stock-mtd-budget-percentage">0%</span>
                      <span class="chart-center-label">USED</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Stock Overview Cards -->
          <div class="section-heading-with-actions" style="margin-top: 2rem;">
            <h2 class="section-heading">Stock Overview</h2>
          </div>

          <!-- Combined Metrics Card for Mobile -->
          <div class="dashboard-card combined-metrics-card">
            <!-- Stock Value Section -->
            <div class="combined-metric-section">
              <div class="combined-metric-header">
                <span class="combined-metric-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                  </svg>
                </span>
                <h3>Stock Value</h3>
              </div>
              <div class="combined-metric-value-row">
                <div class="combined-metric-value">
                  <span class="card-value-currency">R</span>
                  <span class="card-value-amount" id="mobile-stock-value">—</span>
                </div>
                <div class="combined-metric-comparison" id="mobile-stock-value-comparison">—</div>
              </div>
            </div>
            
            <!-- Days Section -->
            <div class="combined-metric-section">
              <div class="combined-metric-header">
                <span class="combined-metric-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                  </svg>
                </span>
                <h3>Days</h3>
              </div>
              <div class="combined-metric-value-row">
                <div class="combined-metric-value">
                  <span class="card-value-amount" id="mobile-stock-days">—</span>
                </div>
                <div class="combined-metric-comparison" id="mobile-stock-days-comparison">—</div>
              </div>
            </div>
            
            <!-- Cost of Sales Section -->
            <div class="combined-metric-section">
              <div class="combined-metric-header">
                <span class="combined-metric-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                  </svg>
                </span>
                <h3>Cost of Sales</h3>
              </div>
              <div class="combined-metric-value-row">
                <div class="combined-metric-value">
                  <span class="card-value-currency">R</span>
                  <span class="card-value-amount" id="mobile-stock-cos">—</span>
                </div>
                <div class="combined-metric-comparison" id="mobile-stock-cos-comparison">—</div>
              </div>
            </div>
            
            <!-- MTD GP Section -->
            <div class="combined-metric-section">
              <div class="combined-metric-header">
                <span class="combined-metric-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                  </svg>
                </span>
                <h3>MTD GP</h3>
              </div>
              <div class="combined-metric-value-row">
                <div class="combined-metric-value">
                  <span class="card-value-currency">%</span>
                  <span class="card-value-amount" id="mobile-stock-mtd-gp">—</span>
                </div>
                <div class="combined-metric-comparison" id="mobile-stock-mtd-gp-value">—</div>
              </div>
            </div>
          </div>

          <!-- Stock KPI Cards -->
          <div class="daily-summary-layout">
            <div class="dashboard-card metric-turnover">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                  </svg>
                </span>
                <h3>Stock Value</h3>
              </div>
              <div class="card-value-wrapper">
                <span class="card-value-currency" id="stock-value-currency">R</span>
                <span class="card-value-amount" id="stock-value">—</span>
              </div>
              <div class="card-comparison-simple" id="stock-value-comparison">—</div>
            </div>

            <div class="dashboard-card metric-basket">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                  </svg>
                </span>
                <h3>Days</h3>
              </div>
              <div class="card-value-wrapper">
                <span class="card-value-amount" id="stock-days">—</span>
              </div>
              <div class="card-comparison-simple" id="stock-days-comparison">—</div>
            </div>

            <div class="dashboard-card metric-purchases">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                  </svg>
                </span>
                <h3>Cost of Sales</h3>
              </div>
              <div class="card-value-wrapper">
                <span class="card-value-currency" id="stock-cos-currency">R</span>
                <span class="card-value-amount" id="stock-cos">—</span>
              </div>
              <div class="card-comparison-simple" id="stock-cos-comparison">—</div>
            </div>

            <div class="dashboard-card metric-gp">
              <div class="card-header with-icon">
                <span class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                  </svg>
                </span>
                <h3>MTD GP</h3>
              </div>
              <div class="card-value-wrapper">
                <span class="card-value-currency" id="stock-mtd-gp-currency">%</span>
                <span class="card-value-amount" id="stock-mtd-gp">—</span>
              </div>
              <div class="card-comparison-simple" id="stock-mtd-gp-value">—</div>
            </div>
          </div>

          <!-- Stock Summary Section -->
          <div class="stock-summary-section" style="margin-top: 2rem;">
            <h2 class="section-heading dispensary-summary-heading">Stock Summary</h2>
            
            <!-- Stock Cards Container -->
            <div class="dispensary-cards-container">
              <!-- First Stock Card - Best Sellers -->
              <div class="dashboard-card metric-split">
                <div class="card-header with-icon">
                  <span class="card-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                      <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                    </svg>
                  </span>
                  <h3>Best Sellers</h3>
                  <span class="card-arrow" id="stock-best-sellers-chart-btn" style="cursor: pointer;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="8" y1="6" x2="21" y2="6"></line>
                      <line x1="8" y1="12" x2="21" y2="12"></line>
                      <line x1="8" y1="18" x2="21" y2="18"></line>
                      <line x1="3" y1="6" x2="3.01" y2="6"></line>
                      <line x1="3" y1="12" x2="3.01" y2="12"></line>
                      <line x1="3" y1="18" x2="3.01" y2="18"></line>
                    </svg>
                  </span>
                </div>
                
                <div class="best-sellers-content" id="stock-best-sellers-list">
                  <!-- Best sellers will be loaded dynamically -->
                  <div class="best-seller-item">
                    <div class="best-seller-details">
                      <div class="best-seller-name">Loading...</div>
                      <div class="best-seller-code">—</div>
                    </div>
                    <div class="best-seller-stats">
                      <div class="best-seller-qty">—</div>
                      <div class="best-seller-gp">—</div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Second Stock Card - Low GP Products -->
              <div class="dashboard-card metric-scripts">
                <div class="card-header with-icon">
                  <span class="card-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                      <line x1="12" y1="9" x2="12" y2="13"></line>
                      <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                  </span>
                  <h3>Low GP Products</h3>
                  <span class="card-arrow" id="stock-worst-gp-list-btn" style="cursor: pointer;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="8" y1="6" x2="21" y2="6"></line>
                      <line x1="8" y1="12" x2="21" y2="12"></line>
                      <line x1="8" y1="18" x2="21" y2="18"></line>
                      <line x1="3" y1="6" x2="3.01" y2="6"></line>
                      <line x1="3" y1="12" x2="3.01" y2="12"></line>
                      <line x1="3" y1="18" x2="3.01" y2="18"></line>
                    </svg>
                  </span>
                </div>
                
                <div class="best-sellers-content" id="stock-worst-gp-list">
                  <!-- Worst GP products will be loaded dynamically -->
                  <div class="best-seller-item">
                    <div class="best-seller-details">
                      <div class="best-seller-name">Loading...</div>
                      <div class="best-seller-code">—</div>
                    </div>
                    <div class="best-seller-stats">
                      <div class="best-seller-qty">—</div>
                      <div class="best-seller-gp">—</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="tab-debtor-tools" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-debtor-tools" hidden>
        <div class="debtor-tools-container">
          <!-- Summary Panel -->
          <div class="debtor-section" id="debtor-statistics-section">
            <h2 class="section-heading">Summary</h2>
            <div class="dashboard-summary-layout debtor-summary-layout">
              <!-- Left Column - Three Cards Stacked -->
              <div class="debtor-overview-cards">
                <!-- Total Outstanding Card - Orange Gradient -->
                <div class="dashboard-card primary">
                  <div class="card-header with-icon">
                    <span class="card-icon">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="1" x2="12" y2="23"></line>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                      </svg>
                    </span>
                    <h3>Total Outstanding</h3>
                  </div>
                  <div class="card-value-wrapper">
                    <span class="card-value-currency">R</span>
                    <span class="card-value-amount" id="debtor-total-outstanding">0.00</span>
                  </div>
                </div>

                <!-- Total Accounts Card -->
                <div class="dashboard-card metric-gp">
                  <div class="card-header with-icon">
                    <span class="card-icon">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                      </svg>
                    </span>
                    <h3>Total Accounts</h3>
                  </div>
                  <div class="card-value-wrapper">
                    <span class="card-value-currency"></span>
                    <span class="card-value-amount" id="debtor-total-accounts">0</span>
                  </div>
                </div>

                <!-- Current Card -->
                <div class="dashboard-card metric-turnover">
                  <div class="card-header with-icon">
                    <span class="card-icon">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                      </svg>
                    </span>
                    <h3>Current</h3>
                  </div>
                  <div class="card-value-wrapper">
                    <span class="card-value-currency">R</span>
                    <span class="card-value-amount" id="debtor-current-value">0.00</span>
                  </div>
                </div>
              </div>

              <!-- Right Column - Ageing Buckets Card -->
              <div class="dashboard-card metric-basket debtor-ageing-card">
                <div class="card-header with-icon">
                  <span class="card-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                      <line x1="16" y1="2" x2="16" y2="6"></line>
                      <line x1="8" y1="2" x2="8" y2="6"></line>
                      <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                  </span>
                  <h3>Ageing Buckets</h3>
                </div>
                <div class="debtor-ageing-list" id="debtor-ageing-list">
                  <!-- Ageing buckets will be populated dynamically -->
                </div>
              </div>
            </div>
          </div>

          <!-- Filter Panel -->
          <div class="debtor-section" id="debtor-filters-section">
            <h2 class="section-heading">Filters</h2>
            <div class="dashboard-card">
              <div class="debtor-filters-container">
                <!-- Minimum Balance - Full Width at Top -->
                <div class="debtor-balance-filter">
                  <label class="debtor-filter-label">
                    <span>Minimum Balance for 60+ Day Arrears</span>
                    <div class="debtor-balance-slider-container">
                      <input type="range" id="debtor-min-balance" min="0" max="2000" step="10" value="100" class="debtor-balance-slider" />
                      <span id="debtor-min-balance-value" class="debtor-balance-value">R 100</span>
                    </div>
                  </label>
                </div>

                <!-- Ageing Buckets - Row Below -->
                <div class="debtor-ageing-buckets-filter">
                  <label class="debtor-filter-label">
                    <span>Ageing Buckets</span>
                    <div class="debtor-checkbox-group" id="debtor-ageing-buckets">
                      <label class="checkbox-label"><input type="checkbox" value="current" checked /> Current</label>
                      <label class="checkbox-label"><input type="checkbox" value="d30" checked /> 30D</label>
                      <label class="checkbox-label"><input type="checkbox" value="d60" checked /> 60D</label>
                      <label class="checkbox-label"><input type="checkbox" value="d90" checked /> 90D</label>
                      <label class="checkbox-label"><input type="checkbox" value="d120" checked /> 120D</label>
                      <label class="checkbox-label"><input type="checkbox" value="d150" checked /> 150D</label>
                      <label class="checkbox-label"><input type="checkbox" value="d180" checked /> 180D</label>
                    </div>
                  </label>
                </div>

                <!-- Contact Filters - Row Below -->
                <div class="debtor-contact-filters">
                  <label class="debtor-filter-label">
                    <span>Contact Filters</span>
                    <div class="debtor-checkbox-group">
                      <label class="checkbox-label"><input type="checkbox" id="debtor-has-email" /> Only show accounts with email</label>
                      <label class="checkbox-label"><input type="checkbox" id="debtor-has-phone" /> Only show accounts with phone</label>
                    </div>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Communication Panel -->
          <div class="debtor-section" id="debtor-communication-section">
            <div class="debtor-message-group">
              <button type="button" class="debtor-collapsible-header" id="debtor-send-reminders-toggle">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="debtor-collapsible-icon">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
                <h2 class="section-heading" style="margin: 0; display: inline;">Send Reminders</h2>
                <span class="debtor-collapsible-hint">Click to open and configure reminders</span>
              </button>
              <div class="debtor-collapsible-content" id="debtor-send-reminders-content" style="display: none;">
            <div class="debtor-communication-panel">
              <div class="debtor-selection-info">
                <span id="debtor-selected-count">0</span> debtors selected
              </div>
              
              <!-- Message Previews -->
              <div class="debtor-message-config">
                <!-- Email Preview (Collapsible) -->
                <div class="debtor-message-group">
                  <button type="button" class="debtor-collapsible-header" id="debtor-email-preview-toggle">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="debtor-collapsible-icon">
                      <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-left: 4px;">
                      <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                      <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                    <span>Preview Email</span>
                    <span class="debtor-collapsible-hint">Click to see what the email will look like</span>
                  </button>
                  <div class="debtor-collapsible-content" id="debtor-email-preview-content" style="display: none;">
                    <div class="debtor-preview-container">
                      <div class="debtor-preview-email">
                        <div class="debtor-preview-email-header">
                          <div class="debtor-preview-email-subject" id="debtor-preview-email-subject">Loading preview...</div>
                        </div>
                        <div class="debtor-preview-email-body" id="debtor-preview-email-body">Loading preview...</div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- SMS Preview (Collapsible) -->
                <div class="debtor-message-group">
                  <button type="button" class="debtor-collapsible-header" id="debtor-sms-preview-toggle">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="debtor-collapsible-icon">
                      <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-left: 4px;">
                      <path d="M22 2L11 13"></path>
                      <path d="M22 2l-7 20-4-9-9-4 20-7z"></path>
                    </svg>
                    <span>Preview SMS</span>
                    <span class="debtor-collapsible-hint">Click to see what the SMS will look like</span>
                  </button>
                  <div class="debtor-collapsible-content" id="debtor-sms-preview-content" style="display: none;">
                    <div class="debtor-preview-container">
                      <div class="debtor-preview-sms" id="debtor-preview-sms">Loading preview...</div>
                      <div class="debtor-preview-sms-charcount">
                        <span id="debtor-preview-sms-charcount">0</span> characters
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Template Variables (Collapsible) -->
                <div class="debtor-message-group">
                  <button type="button" class="debtor-collapsible-header" id="debtor-template-vars-toggle">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="debtor-collapsible-icon">
                      <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                    <span>Template Variables (Optional)</span>
                    <span class="debtor-collapsible-hint">Click to customize - defaults will be used if not changed</span>
                  </button>
                  <div class="debtor-collapsible-content" id="debtor-template-vars-content" style="display: none;">
                    <div class="debtor-template-vars-grid">
                      <div class="debtor-template-var-field">
                        <label for="debtor-var-bank-name" class="debtor-field-label">Bank Name:</label>
                        <input type="text" id="debtor-var-bank-name" class="debtor-message-input-small" placeholder="e.g., ABSA" />
                      </div>
                      <div class="debtor-template-var-field">
                        <label for="debtor-var-account-number" class="debtor-field-label">Account Number:</label>
                        <input type="text" id="debtor-var-account-number" class="debtor-message-input-small" placeholder="e.g., 409 0014 954" />
                      </div>
                      <div class="debtor-template-var-field">
                        <label for="debtor-var-pharmacy-email" class="debtor-field-label">Pharmacy Email:</label>
                        <input type="email" id="debtor-var-pharmacy-email" class="debtor-message-input-small" placeholder="e.g., info@pharmacy.com" />
                      </div>
                      <div class="debtor-template-var-field">
                        <label for="debtor-var-pharmacy-phone" class="debtor-field-label">Pharmacy Phone:</label>
                        <input type="text" id="debtor-var-pharmacy-phone" class="debtor-message-input-small" placeholder="e.g., 058 863 2801" />
                      </div>
                    </div>
                    <div class="debtor-message-hint">These variables will override pharmacy defaults. Leave empty to use defaults from the database.</div>
                  </div>
                </div>
              </div>
              
              <div class="debtor-communication-buttons">
                <button id="debtor-send-email" class="btn-primary" disabled>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                    <polyline points="22,6 12,13 2,6"></polyline>
                  </svg>
                  Send Email
                </button>
                <button id="debtor-send-sms" class="btn-primary" disabled>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 2L11 13"></path>
                    <path d="M22 2l-7 20-4-9-9-4 20-7z"></path>
                  </svg>
                  Send SMS
                </button>
                <button id="debtor-download-csv" class="btn-secondary">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  Download CSV
                </button>
                <button id="debtor-download-pdf" class="btn-secondary">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  Download PDF
                </button>
              </div>
              <div id="debtor-communication-status" class="debtor-communication-status"></div>
                </div>
            </div>
          </div>

          <!-- Debtor Table -->
          <div class="debtor-section" id="debtor-table-section">
            <h2 class="section-heading">Debtors</h2>
            <div class="debtor-table-search-container">
              <label class="debtor-filter-label">
                <span>Search</span>
                <input type="text" id="debtor-search" class="debtor-search-input" placeholder="Search accounts, names, emails, or phones..." />
              </label>
            </div>
            <div class="debtor-table-container">
              <div id="debtor-table-loading" class="debtor-loading" style="display: none;">
                <div class="spinner"></div>
                <span>Loading debtors...</span>
              </div>
              <div id="debtor-table-error" class="debtor-error" style="display: none;"></div>
              <div class="debtor-table-wrapper">
                <table class="debtor-table" id="debtor-table">
                  <thead>
                    <tr>
                      <th>
                        <input type="checkbox" id="debtor-select-all" />
                      </th>
                      <th class="debtor-sortable" data-column="acc_no">Account <span class="sort-icon">↕</span></th>
                      <th class="debtor-sortable" data-column="name">Name <span class="sort-icon">↕</span></th>
                      <th class="debtor-sortable" data-column="current">Current <span class="sort-icon">↕</span></th>
                      <th class="debtor-sortable" data-column="d30">30D <span class="sort-icon">↕</span></th>
                      <th class="debtor-sortable" data-column="d60">60D <span class="sort-icon">↕</span></th>
                      <th class="debtor-sortable" data-column="d90">90D <span class="sort-icon">↕</span></th>
                      <th class="debtor-sortable" data-column="d120">120D <span class="sort-icon">↕</span></th>
                      <th class="debtor-sortable" data-column="d150">150D <span class="sort-icon">↕</span></th>
                      <th class="debtor-sortable" data-column="d180">180D <span class="sort-icon">↕</span></th>
                      <th class="debtor-sortable" data-column="balance">Balance <span class="sort-icon">↕</span></th>
                      <th class="debtor-sortable" data-column="email">Email <span class="sort-icon">↕</span></th>
                      <th class="debtor-sortable" data-column="phone">Phone <span class="sort-icon">↕</span></th>
                    </tr>
                  </thead>
                  <tbody id="debtor-table-body">
                    <!-- Debtors will be populated dynamically -->
                  </tbody>
                </table>
              </div>
              <div class="debtor-pagination" id="debtor-pagination" style="display: none;">
                <button id="debtor-prev-page" class="btn-secondary btn-sm" disabled>Previous</button>
                <span id="debtor-page-info">Page 1 of 1</span>
                <button id="debtor-next-page" class="btn-secondary btn-sm" disabled>Next</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="tab-chart-of-accounts" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-chart-of-accounts" hidden>
        <div class="admin-container">
          <div class="admin-section">
            <div class="admin-section-header">
              <h2>Chart of Accounts</h2>
              <div style="display: flex; gap: 12px; align-items: center;">
                <select id="coa-type-filter" class="form-control" style="width: auto; min-width: 150px;">
                  <option value="">All Types</option>
                  <option value="Income">Income</option>
                  <option value="Expense">Expense</option>
                  <option value="Asset">Asset</option>
                  <option value="Liability">Liability</option>
                  <option value="Equity">Equity</option>
                </select>
                <button class="btn btn-primary" id="coa-add-btn">Add Account</button>
                <button class="btn btn-secondary" id="coa-refresh-btn">Refresh</button>
              </div>
            </div>
            <div class="admin-table-container">
              <table class="admin-table" id="coa-table">
                <thead>
                  <tr>
                    <th style="cursor: pointer;" id="coa-sort-code">
                      Code
                      <span class="sort-indicator" id="coa-sort-code-indicator">▼</span>
                    </th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Category</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="coa-table-body">
                  <tr>
                    <td colspan="6" class="loading-cell">Loading accounts...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section id="tab-bank-accounts" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-bank-accounts" hidden>
        <div class="admin-container">
          <div class="admin-section">
            <div class="admin-section-header">
              <h2>Bank Accounts</h2>
              <div style="display: flex; gap: 12px; align-items: center;">
                <button class="btn btn-primary" id="bank-accounts-add-btn" disabled>Add Bank Account</button>
                <button class="btn btn-secondary" id="bank-accounts-refresh-btn">Refresh</button>
              </div>
            </div>
            <div class="admin-table-container">
              <table class="admin-table" id="bank-accounts-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Bank Name</th>
                    <th>Account Number</th>
                    <th>Branch Code</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="bank-accounts-table-body">
                  <tr>
                    <td colspan="6" class="empty-cell">Please select a pharmacy from the top selector to view bank accounts</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section id="tab-bank-imports" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-bank-imports" hidden>
        <div class="admin-container">
          <!-- Upload Section -->
          <div class="admin-section">
            <div class="admin-section-header">
              <h2>Import Bank Statement</h2>
            </div>
            <div style="padding: 20px;">
              <div style="display: flex; flex-direction: column; gap: 20px; max-width: 800px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: start;">
                  <div class="form-group" style="margin-bottom: 0; display: flex; flex-direction: column;">
                    <label for="bank-imports-account-btn" style="margin-bottom: 8px;">Bank Account *</label>
                    <button type="button" id="bank-imports-account-btn" class="bank-account-picker-btn" style="width: 100%; justify-content: space-between;">
                      <span id="bank-imports-account-display">Select Bank Account</span>
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                      </svg>
                    </button>
                    <input type="hidden" id="bank-imports-account-id" />
                    <small style="color: var(--textMuted); margin-top: 4px; display: block; min-height: 16px;">Please select a pharmacy from the top selector first</small>
                  </div>
                  <div class="form-group" style="margin-bottom: 0; display: flex; flex-direction: column;">
                    <label for="bank-imports-file-input" style="margin-bottom: 8px;">CSV File *</label>
                    <input type="file" id="bank-imports-file-input" accept=".csv" class="form-control" style="padding: 8px;" />
                    <small id="bank-imports-file-name" style="color: var(--textMuted); margin-top: 4px; display: block; font-size: 12px; min-height: 16px;"></small>
                  </div>
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                  <button class="btn btn-primary btn-sm" id="bank-imports-preview-btn" disabled>Preview Import</button>
                  <button class="btn btn-secondary btn-sm" id="bank-imports-cancel-btn" style="display: none;">Cancel</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Preview Section -->
          <div class="admin-section" id="bank-imports-preview-section" style="display: none; width: 100%; max-width: 100%;">
            <div class="admin-section-header">
              <h2>Preview</h2>
            </div>
            <div style="padding: 20px;">
              <!-- Summary Card -->
              <div id="bank-imports-summary-card" style="background: var(--bgSecondary); border: 1px solid var(--surfaceBorder); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                <h3 style="margin: 0 0 12px 0; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--textMuted);">Summary</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                  <div>
                    <div style="font-size: 9px; color: var(--textMuted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Transaction Count</div>
                    <div style="font-size: 11px; font-weight: 600;" id="preview-transaction-count">-</div>
                  </div>
                  <div>
                    <div style="font-size: 9px; color: var(--textMuted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Total In</div>
                    <div style="font-size: 11px; font-weight: 600; color: var(--statusSuccess);" id="preview-total-in">-</div>
                  </div>
                  <div>
                    <div style="font-size: 9px; color: var(--textMuted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Total Out</div>
                    <div style="font-size: 11px; font-weight: 600; color: var(--statusError);" id="preview-total-out">-</div>
                  </div>
                  <div>
                    <div style="font-size: 9px; color: var(--textMuted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Period</div>
                    <div style="font-size: 11px; font-weight: 500;" id="preview-period">-</div>
                  </div>
                </div>
              </div>

              <!-- Errors Warning -->
              <div id="bank-imports-errors-warning" style="display: none; background: var(--statusWarningLight); border: 1px solid var(--statusWarning); border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--statusWarning);">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                  </svg>
                  <span id="bank-imports-errors-message"></span>
                </div>
              </div>

              <!-- Sample Table -->
              <div style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 12px 0; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--textMuted);">Sample Transactions (first 20 rows)</h3>
                <div class="admin-table-container">
                  <table class="admin-table" id="bank-imports-preview-table" style="font-size: 11px;">
                    <thead>
                      <tr>
                        <th style="font-size: 9px;">Row</th>
                        <th style="font-size: 9px;">Date</th>
                        <th style="font-size: 9px;">Description</th>
                        <th style="font-size: 9px;">Reference</th>
                        <th style="font-size: 9px;">Amount</th>
                      </tr>
                    </thead>
                    <tbody id="bank-imports-preview-table-body" style="font-size: 11px;">
                      <tr>
                        <td colspan="5" class="loading-cell">Loading preview...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Errors Table -->
              <div id="bank-imports-errors-section" style="display: none;">
                <h3 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--statusError);">Errors</h3>
                <div class="admin-table-container">
                  <table class="admin-table" id="bank-imports-errors-table">
                    <thead>
                      <tr>
                        <th>Row Number</th>
                        <th>Error</th>
                      </tr>
                    </thead>
                    <tbody id="bank-imports-errors-table-body">
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Confirm Button -->
              <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button class="btn btn-primary" id="bank-imports-confirm-btn">Confirm Import</button>
                <button class="btn btn-secondary" id="bank-imports-preview-cancel-btn">Cancel</button>
              </div>
            </div>
          </div>

          <!-- Past Imports Section -->
          <div class="admin-section">
            <div class="admin-section-header">
              <h2>Past Imports</h2>
              <button class="btn btn-secondary" id="bank-imports-refresh-history-btn">Refresh</button>
            </div>
            <div class="admin-table-container">
              <table class="admin-table" id="bank-imports-history-table">
                <thead>
                  <tr>
                    <th>Period</th>
                    <th>Bank Account</th>
                    <th>Transaction Count</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="bank-imports-history-table-body">
                  <tr>
                    <td colspan="5" class="empty-cell">Please select a pharmacy from the top selector to view import history</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Bank Rules Screen -->
      <section id="tab-bank-rules" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-bank-rules" hidden>
        <div class="admin-container" style="max-width: 100%; width: 100%;">
          <div class="admin-section" style="max-width: 100%; width: 100%;">
            <div class="admin-section-header">
              <h2>Bank Rules</h2>
              <div style="display: flex; gap: 12px; align-items: center;">
                <button class="btn btn-primary" id="bank-rules-new-btn" disabled>+ New Rule</button>
                <button class="btn btn-secondary" id="bank-rules-refresh-btn">Refresh</button>
              </div>
            </div>

            <!-- Filters -->
            <div style="padding: 16px 20px; border-bottom: 1px solid var(--borderColor); display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
              <div style="flex: 1; min-width: 200px;">
                <input type="text" id="bank-rules-search" class="form-control" placeholder="Search by name / description" style="width: 100%;" />
              </div>
              <div style="min-width: 150px;">
                <select id="bank-rules-type-filter" class="form-control">
                  <option value="">All Types</option>
                  <option value="receive">Receive</option>
                  <option value="spend">Spend</option>
                  <option value="transfer">Transfer</option>
                </select>
              </div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="bank-rules-show-inactive" />
                <label for="bank-rules-show-inactive" style="margin: 0; cursor: pointer;">Show inactive</label>
              </div>
            </div>

            <!-- Rules Table -->
            <div class="admin-table-container">
              <table class="admin-table" id="bank-rules-table">
                <thead>
                  <tr>
                    <th style="cursor: pointer;" id="bank-rules-sort-priority">
                      Priority <span class="sort-indicator" id="bank-rules-sort-priority-indicator">▼</span>
                    </th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Conditions (summary)</th>
                    <th>Allocate (summary)</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="bank-rules-table-body">
                  <tr>
                    <td colspan="7" class="empty-cell">Please select a pharmacy from the top selector to view bank rules</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Unmatched Transactions Screen -->
      <section id="tab-unmatched-transactions" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-unmatched-transactions" hidden>
        <div class="admin-container" style="max-width: 100%; width: 100%;">
          <!-- Reconciliation Summary Widget -->
          <div class="admin-section reconciliation-summary-widget" style="max-width: 100%; width: 100%;">
            <div class="reconciliation-summary-content">
              <div class="reconciliation-card reconciliation-card-green">
                <div class="reconciliation-card-label">Reconciled</div>
                <div class="reconciliation-card-value" id="reconciled-count">-</div>
              </div>
              <div class="reconciliation-card reconciliation-card-orange">
                <div class="reconciliation-card-label">Unmatched</div>
                <div class="reconciliation-card-value" id="unmatched-count">-</div>
              </div>
              <div class="reconciliation-difference-box">
                <div class="reconciliation-difference-label">Difference</div>
                <div class="reconciliation-difference-value" id="reconciliation-difference">-</div>
              </div>
              <button class="btn btn-primary" id="reconciliation-goto-unmatched-btn" style="align-self: center;">Go To Unmatched Transactions</button>
            </div>
          </div>

          <!-- Stationary Card: Action Buttons -->
          <div class="admin-section unmatched-actions-card" style="max-width: 100%; width: 100%;">
            <div class="admin-section-header">
              <h2>Unmatched Transactions</h2>
              <div style="display: flex; gap: 12px; align-items: center;">
                <button class="btn btn-primary" id="unmatched-apply-rules-btn" disabled>Apply Rules</button>
                <button class="btn btn-primary" id="unmatched-manual-classify-all-btn" disabled>Manual Classify All</button>
                <button class="btn btn-secondary" id="unmatched-refresh-btn">Refresh</button>
              </div>
            </div>
          </div>

          <!-- Scrollable Card: Transaction List -->
          <div class="admin-section unmatched-transactions-card" style="max-width: 100%; width: 100%;">

            <!-- Transactions Table -->
            <div class="admin-table-container">
              <table class="admin-table" id="unmatched-transactions-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Account</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="unmatched-transactions-table-body">
                  <tr>
                    <td colspan="6" class="empty-cell">Please select a pharmacy from the top selector to view unmatched transactions</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section id="tab-stock-queries" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-stock-queries" hidden>
        <div class="stock-management-container">
          <div class="section-heading-with-actions">
            <h2 class="section-heading" style="display: flex; align-items: center; gap: 8px; cursor: pointer;" id="stock-lookup-toggle">
              <button class="chart-toggle-btn" style="margin: 0; padding: 0;" aria-label="Toggle Stock Lookup">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </button>
              Stock Lookup
            </h2>
          </div>
          
          <!-- Search Input -->
          <div class="stock-search-container" id="stock-lookup-content">
            <div class="stock-search-input-wrapper">
              <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
              <input 
                type="text" 
                id="stock-search-input" 
                class="stock-search-input" 
                placeholder="Search by product name or code..."
                autocomplete="off"
              />
              <div id="stock-search-loading" class="search-loading" style="display: none;">
                <div class="spinner"></div>
              </div>
            </div>
            <div id="stock-search-error" class="search-error" style="display: none;"></div>
          </div>
          
          <!-- Search Results -->
          <div id="stock-search-results" class="stock-search-results" style="display: none;">
            <div class="search-results-header">
              <span id="stock-results-count" class="results-count"></span>
            </div>
            <div id="stock-results-list" class="stock-results-list"></div>
          </div>
          
          <!-- Stock Insights Section -->
          <div class="stock-insights-section">
            <div class="stock-insights-header" style="display: flex; align-items: center; gap: 8px; cursor: pointer;" id="overstocked-toggle">
              <button class="chart-toggle-btn collapsed" style="margin: 0; padding: 0;" aria-label="Toggle Over Stocked">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transform: rotate(-90deg);">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </button>
              <h3 class="stock-insights-title" style="margin: 0;">Over Stocked</h3>
            </div>
            
            <!-- Content Wrapper -->
            <div id="overstocked-content" style="display: none;">
              <!-- Filters -->
              <div class="stock-insights-filters">
                <div class="stock-insights-filter-group">
                  <label class="stock-insights-filter-label">Days Threshold:</label>
                  <div class="custom-dropdown" data-dropdown="days">
                    <button class="custom-dropdown-button" type="button">
                      <span class="custom-dropdown-text">30+ days</span>
                      <svg class="custom-dropdown-arrow" width="12" height="8" viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M1 1L6 6L11 1"></path>
                      </svg>
                    </button>
                    <div class="custom-dropdown-menu">
                      <button class="custom-dropdown-item" data-value="7">7+ days</button>
                      <button class="custom-dropdown-item" data-value="14">14+ days</button>
                      <button class="custom-dropdown-item" data-value="21">21+ days</button>
                      <button class="custom-dropdown-item active" data-value="30">30+ days</button>
                    </div>
                  </div>
                </div>
                
                <div class="stock-insights-filter-group">
                  <label class="stock-insights-filter-label">Category:</label>
                  <div class="custom-dropdown" data-dropdown="category">
                    <button class="custom-dropdown-button" type="button">
                      <span class="custom-dropdown-text">All Categories</span>
                      <svg class="custom-dropdown-arrow" width="12" height="8" viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M1 1L6 6L11 1"></path>
                      </svg>
                    </button>
                    <div class="custom-dropdown-menu">
                      <button class="custom-dropdown-item active" data-value="all">All Categories</button>
                      <button class="custom-dropdown-item" data-value="dispensary">Dispensary</button>
                      <button class="custom-dropdown-item" data-value="self-medication">Self-Medication</button>
                      <button class="custom-dropdown-item" data-value="git">GIT</button>
                      <button class="custom-dropdown-item" data-value="vitamins">Vitamins</button>
                      <button class="custom-dropdown-item" data-value="first-aid">First Aid</button>
                      <button class="custom-dropdown-item" data-value="sports">Sports</button>
                      <button class="custom-dropdown-item" data-value="health-foods">Health Foods</button>
                      <button class="custom-dropdown-item" data-value="beauty">Beauty</button>
                      <button class="custom-dropdown-item" data-value="bath-body">Bath & Body</button>
                      <button class="custom-dropdown-item" data-value="baby">Baby</button>
                      <button class="custom-dropdown-item" data-value="gifts">Gifts</button>
                      <button class="custom-dropdown-item" data-value="other">Other</button>
                    </div>
                  </div>
                </div>
                
                <div class="stock-insights-filter-group">
                  <label class="stock-insights-filter-label">Min Value:</label>
                  <div class="custom-dropdown" data-dropdown="value">
                    <button class="custom-dropdown-button" type="button">
                      <span class="custom-dropdown-text">R 100+</span>
                      <svg class="custom-dropdown-arrow" width="12" height="8" viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M1 1L6 6L11 1"></path>
                      </svg>
                    </button>
                    <div class="custom-dropdown-menu">
                      <button class="custom-dropdown-item" data-value="10">R 10+</button>
                      <button class="custom-dropdown-item active" data-value="100">R 100+</button>
                      <button class="custom-dropdown-item" data-value="200">R 200+</button>
                      <button class="custom-dropdown-item" data-value="300">R 300+</button>
                      <button class="custom-dropdown-item" data-value="400">R 400+</button>
                      <button class="custom-dropdown-item" data-value="500">R 500+</button>
                      <button class="custom-dropdown-item" data-value="600">R 600+</button>
                      <button class="custom-dropdown-item" data-value="700">R 700+</button>
                      <button class="custom-dropdown-item" data-value="800">R 800+</button>
                      <button class="custom-dropdown-item" data-value="900">R 900+</button>
                      <button class="custom-dropdown-item" data-value="1000">R 1000+</button>
                    </div>
                  </div>
                </div>
                
                <button id="overstocked-load-btn" class="stock-insights-load-btn">
                  Load Over Stocked Products
                </button>
              </div>
              
              <!-- Loading State -->
              <div id="overstocked-loading" class="stock-insights-loading-simple" style="display: none;">
                <div class="spinner"></div>
                <span>Loading...</span>
              </div>
              
              <!-- Error State -->
              <div id="overstocked-error" class="search-error" style="display: none;"></div>
              
              <!-- Results -->
              <div id="overstocked-results" class="stock-search-results" style="display: none;">
                <div class="search-results-header">
                  <span id="overstocked-results-count" class="results-count"></span>
                </div>
                <div id="overstocked-results-list" class="stock-results-list"></div>
              </div>
            </div>
          </div>
          
          <!-- Negative Stock Section -->
          <div class="stock-insights-section" style="margin-top: 48px;">
            <div class="stock-insights-header" style="display: flex; align-items: center; gap: 8px; cursor: pointer;" id="negativestock-toggle">
              <button class="chart-toggle-btn collapsed" style="margin: 0; padding: 0;" aria-label="Toggle Negative Stock">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transform: rotate(-90deg);">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </button>
              <h3 class="stock-insights-title" style="margin: 0;">Negative Stock</h3>
            </div>
            
            <!-- Content Wrapper -->
            <div id="negativestock-content" style="display: none;">
              <!-- Button Container -->
              <div class="stock-insights-filters" style="justify-content: flex-end;">
                <button id="negativestock-load-btn" class="stock-insights-load-btn">
                  Load Negative Stock Products
                </button>
                <button class="btn-secondary btn-sm btn-compact" id="download-negative-stock-pdf" disabled style="display: flex; align-items: center; justify-content: center; gap: 6px; opacity: 0.5; cursor: not-allowed;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  PDF
                </button>
              </div>
              
              <!-- Loading State -->
              <div id="negativestock-loading" class="stock-insights-loading-simple" style="display: none;">
                <div class="spinner"></div>
                <span>Loading...</span>
              </div>
              
              <!-- Error State -->
              <div id="negativestock-error" class="search-error" style="display: none;"></div>
              
              <!-- Results -->
              <div id="negativestock-results" class="stock-search-results" style="display: none;">
                <div class="search-results-header">
                  <span id="negativestock-results-count" class="results-count"></span>
                </div>
                <div id="negativestock-results-list" class="stock-results-list"></div>
              </div>
            </div>
          </div>
        </div>
      </section>
  </main>
    </div>
  </div>

  <!-- Sidebar Overlay for Mobile -->
  <div class="sidebar-overlay" id="sidebar-overlay"></div>

  <!-- Metric Detail Modal -->
  <div class="metric-modal-overlay" id="metric-modal-overlay">
    <div class="metric-modal" id="metric-modal">
      <div class="metric-modal-header">
        <div class="metric-modal-title-section">
          <div class="metric-modal-title-row">
            <h1 class="metric-modal-title" id="metric-modal-title">Turnover</h1>
            <!-- Purchases Toggle (only visible for purchases modal) -->
            <div class="purchases-toggle" id="purchases-toggle" style="display: none;">
              <button class="toggle-button active" data-chart="sales" id="toggle-sales">
                Sales
              </button>
              <button class="toggle-button" data-chart="cos" id="toggle-cos">
                CoS
              </button>
            </div>
          </div>
        </div>
        <button class="metric-modal-close" id="metric-modal-close">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      
      <div class="metric-modal-content">
        <canvas id="metric-trend-chart"></canvas>
      </div>
    </div>
  </div>

  <!-- Pharmacy Contact Details Modal -->
  <div class="pharmacy-contact-modal-overlay" id="pharmacy-contact-modal-overlay">
    <div class="pharmacy-contact-modal">
      <div class="pharmacy-contact-modal-header">
        <h2>Pharmacy Contact Details Required</h2>
        <button class="pharmacy-contact-modal-close" id="pharmacy-contact-modal-close" type="button">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="pharmacy-contact-modal-body">
        <p class="pharmacy-contact-modal-message">Please provide your pharmacy contact and banking details before sending emails or SMS. This information will be stored locally in your browser session only.</p>
        <form id="pharmacy-contact-form">
          <div class="form-group">
            <label for="modal-pharmacy-phone">Phone Number <span style="color: var(--error);">*</span></label>
            <input type="text" id="modal-pharmacy-phone" class="pharmacy-contact-input" placeholder="e.g., 058 863 2801" required />
          </div>
          <div class="form-group">
            <label for="modal-pharmacy-email">Email Address <span style="color: var(--error);">*</span></label>
            <input type="email" id="modal-pharmacy-email" class="pharmacy-contact-input" placeholder="e.g., info@pharmacy.com" required />
          </div>
          <div class="form-group">
            <label for="modal-pharmacy-bank-name">Bank Name <span style="color: var(--error);">*</span></label>
            <input type="text" id="modal-pharmacy-bank-name" class="pharmacy-contact-input" placeholder="e.g., ABSA" required />
          </div>
          <div class="form-group">
            <label for="modal-pharmacy-account-number">Account Number <span style="color: var(--error);">*</span></label>
            <input type="text" id="modal-pharmacy-account-number" class="pharmacy-contact-input" placeholder="e.g., 409 0014 954" required />
          </div>
          <div class="pharmacy-contact-modal-actions">
            <button type="submit" class="btn-primary">Save Details</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Custom Date Picker Modal -->
  <div class="date-picker-modal-overlay" id="date-picker-modal-overlay">
    <div class="date-picker-modal">
      <div class="date-picker-header">
        <button class="date-picker-nav" id="date-picker-prev-month">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15,18 9,12 15,6"></polyline>
          </svg>
        </button>
        <h3 class="date-picker-month" id="date-picker-month">October 2025</h3>
        <button class="date-picker-nav" id="date-picker-next-month">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="9,18 15,12 9,6"></polyline>
          </svg>
        </button>
      </div>
      <div class="date-picker-weekdays">
        <div class="weekday">Sun</div>
        <div class="weekday">Mon</div>
        <div class="weekday">Tue</div>
        <div class="weekday">Wed</div>
        <div class="weekday">Thu</div>
        <div class="weekday">Fri</div>
        <div class="weekday">Sat</div>
      </div>
      <div class="date-picker-days" id="date-picker-days">
        <!-- Days will be populated by JavaScript -->
      </div>
      <div class="date-picker-footer">
        <button class="btn-secondary" id="date-picker-today">Today</button>
        <button class="btn-primary" id="date-picker-close">Done</button>
      </div>
    </div>
  </div>

  <!-- Best Sellers List Modal (modeled on Worst GP Modal) -->
  <div class="metric-modal-overlay worst-gp" id="best-sellers-list-modal-overlay">
    <div class="metric-modal" id="best-sellers-list-modal">
      <div class="metric-modal-header">
        <div class="metric-modal-title-section">
          <div class="metric-modal-title-row">
            <h1 class="metric-modal-title" id="best-sellers-modal-title">Top 20 Best Sellers</h1>
            <span class="metric-modal-subtitle" id="best-sellers-modal-dates"></span>
          </div>
        </div>
        <button class="metric-modal-close" id="best-sellers-list-close">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      
      <div class="metric-modal-content">
        <div id="best-sellers-list-content" class="worst-gp-list-container">
          <!-- List will be loaded dynamically -->
        </div>
      </div>
    </div>
  </div>

  <!-- Worst GP List Modal (using metric modal styling) -->
  <div class="metric-modal-overlay worst-gp" id="worst-gp-list-modal-overlay">
    <div class="metric-modal" id="worst-gp-list-modal">
      <div class="metric-modal-header">
        <div class="metric-modal-title-section">
          <div class="metric-modal-title-row">
            <h1 class="metric-modal-title" id="worst-gp-modal-title">Low GP Products</h1>
            <span class="metric-modal-subtitle" id="worst-gp-modal-dates"></span>
          </div>
        </div>
        <button class="metric-modal-close" id="worst-gp-list-close">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      
      <div class="worst-gp-threshold-controls">
        <label for="gp-threshold-input">Show products with GP% below:</label>
        <div class="threshold-controls-row">
          <div class="threshold-input-group">
            <input type="number" id="gp-threshold-input" min="0" max="100" step="1" value="20" />
            <span class="threshold-percent">%</span>
            <button class="btn-primary btn-sm btn-compact" id="apply-gp-threshold">Apply</button>
            <button class="btn-secondary btn-sm btn-compact" id="sep-btn">SEP</button>
            <button class="btn-primary btn-sm btn-compact" id="no-sep-btn">NO SEP</button>
          </div>
          <button class="btn-secondary btn-sm btn-compact" id="download-gp-list">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            PDF
          </button>
        </div>
        <span class="threshold-count" id="gp-threshold-count">Loading...</span>
      </div>
      
      <div class="metric-modal-content">
        <div id="worst-gp-list-content" class="worst-gp-list-container">
          <!-- List will be loaded dynamically -->
        </div>
      </div>
    </div>
  </div>

  <!-- Custom Pharmacy Picker Modal -->
  <div class="pharmacy-picker-modal-overlay" id="pharmacy-picker-modal-overlay">
    <div class="pharmacy-picker-modal">
      <div class="pharmacy-picker-header">
        <h3>Select Pharmacy</h3>
      </div>
      <div class="pharmacy-picker-list" id="pharmacy-picker-list">
        {% for p in pharmacies %}
        <button class="pharmacy-option" data-pharmacy-id="{{ p.pharmacy_id }}" data-pharmacy-name="{{ p.pharmacy_name or p.name }}">
          <span class="pharmacy-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 3h18v18H3z"></path>
              <path d="M3 9h18"></path>
              <path d="M9 21V9"></path>
            </svg>
          </span>
          <span>{{ p.pharmacy_name or p.name }}</span>
        </button>
        {% endfor %}
      </div>
      <div class="pharmacy-picker-footer">
        <button class="btn-primary" id="pharmacy-picker-close">Done</button>
      </div>
    </div>
  </div>

  <!-- Bank Account Picker Modal -->
  <div class="bank-account-picker-modal-overlay" id="bank-account-picker-modal-overlay">
    <div class="bank-account-picker-modal">
      <div class="bank-account-picker-header">
        <h3>Select Bank Account</h3>
      </div>
      <div class="bank-account-picker-list" id="bank-account-picker-list">
        <!-- Bank accounts will be populated here -->
      </div>
      <div class="bank-account-picker-footer">
        <button class="btn-primary" id="bank-account-picker-close">Done</button>
      </div>
    </div>
  </div>
  <script>
    (function() {
      var monthEl = document.getElementById('report-month');
      var selectedDate = null; // Will store the selected date as YYYY-MM-DD
      var selectedPharmacyId = null; // Will store the selected pharmacy ID
      var selectedPharmacyName = null; // Will store the selected pharmacy name
      var PHARMACY_CONTACT_STORAGE_PREFIX = 'pharmacy_contact_details_';
      var summaryViewMode = 'monthly'; // 'monthly' or 'daily' - default is monthly
      var gpViewMode = 'full'; // 'full' or 'split' - default is full
      var tbodyEl = document.getElementById('days-tbody');
      var totalBudgetToEl = document.getElementById('days-total-budget-to');
      var totalTurnEl = document.getElementById('days-total-turnover');
      var totalGpPctEl = document.getElementById('days-total-gppct');
      var totalGpEl = document.getElementById('days-total-gp');
      var totalBudgetSpendEl = document.getElementById('days-total-budget-spend');
      var totalActualSpendEl = document.getElementById('days-total-actual-spend');
      var totalPurchasesEl = document.getElementById('days-total-purchases');
      var totalPurchasesPctEl = document.getElementById('days-total-purchases-pct');

      var targetsTbodyEl = document.getElementById('targets-tbody');
      var growthInputEl = document.getElementById('growth-percent');
      var applyGrowthBtn = document.getElementById('apply-growth');
      var saveTargetsBtn = document.getElementById('save-targets');

      // Loading overlay management
      var loadingOverlay = document.getElementById('loading-overlay');
      var loadingCount = 0; // Track multiple concurrent loads

      function showLoadingOverlay() {
        loadingCount++;
        if (loadingOverlay) {
          loadingOverlay.style.display = 'flex';
        }
      }

      function hideLoadingOverlay() {
        loadingCount--;
        if (loadingCount <= 0) {
          loadingCount = 0; // Prevent negative values
          if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
          }
        }
      }

      // Intercept fetch calls to automatically show/hide loading overlay
      var originalFetch = window.fetch;
      window.fetch = function() {
        var args = arguments;
        var url = '';
        
        // Extract URL from different argument types
        if (typeof args[0] === 'string') {
          url = args[0];
        } else if (args[0] && typeof args[0] === 'object') {
          url = args[0].url || args[0].href || '';
        }
        
        // Only show loading for API calls, not for static assets
        var isApiCall = url && (url.startsWith('/api/') || url.includes('/api/'));
        
        // Exclude stock query endpoints from showing loading modal
        // These endpoints are used on the stock-queries screen and have their own loading indicators
        var isStockQueryEndpoint = false;
        if (isApiCall && url) {
          // Check if this is a stock query related endpoint
          // Match patterns: /api/products/search, /api/products/{code}/stock, /api/products/{code}/sales
          // /api/negative-stock, /api/stock-value
          isStockQueryEndpoint = (
            url.indexOf('/api/products/search') !== -1 ||
            (url.indexOf('/api/products/') !== -1 && url.indexOf('/stock') !== -1) ||
            (url.indexOf('/api/products/') !== -1 && url.indexOf('/sales') !== -1) ||
            url.indexOf('/api/negative-stock') !== -1 ||
            url.indexOf('/api/stock-value') !== -1
          );
        }
        
        // Show loading overlay only for API calls that are NOT stock query endpoints
        if (isApiCall && !isStockQueryEndpoint) {
          showLoadingOverlay();
        }
        
        return originalFetch.apply(this, args)
          .then(function(response) {
            if (isApiCall && !isStockQueryEndpoint) {
              // Small delay to prevent flickering on fast responses
              setTimeout(hideLoadingOverlay, 150);
            }
            return response;
          })
          .catch(function(error) {
            if (isApiCall && !isStockQueryEndpoint) {
              setTimeout(hideLoadingOverlay, 150);
            }
            throw error;
          });
      };

      clearAllPharmacyContactDetails();

      // Styled Modal Functions (replace native alert, confirm, prompt)
      function showStyledAlert(message, type, title) {
        type = type || 'info';
        title = title || (type === 'error' ? 'Error' : type === 'success' ? 'Success' : type === 'warning' ? 'Warning' : 'Information');
        
        var overlay = document.getElementById('alert-modal-overlay');
        var iconEl = document.getElementById('alert-modal-icon');
        var titleEl = document.getElementById('alert-modal-title');
        var messageEl = document.getElementById('alert-modal-message');
        var okBtn = document.getElementById('alert-modal-ok');
        var closeBtn = document.getElementById('alert-modal-close');
        
        // Set icon based on type
        iconEl.className = 'styled-modal-icon ' + type;
        var iconSvg = '';
        if (type === 'success') {
          iconSvg = '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>';
        } else if (type === 'error') {
          iconSvg = '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';
        } else if (type === 'warning') {
          iconSvg = '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>';
        } else {
          iconSvg = '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>';
        }
        iconEl.innerHTML = iconSvg;
        
        titleEl.textContent = title;
        messageEl.textContent = message;
        
        overlay.style.display = 'flex';
        
        return new Promise(function(resolve) {
          function close() {
            overlay.style.display = 'none';
            resolve();
          }
          
          okBtn.onclick = close;
          closeBtn.onclick = close;
          
          // Close on overlay click (outside modal)
          overlay.onclick = function(e) {
            if (e.target === overlay) {
              close();
            }
          };
          
          // Close on Escape key
          var escapeHandler = function(e) {
            if (e.key === 'Escape') {
              close();
              document.removeEventListener('keydown', escapeHandler);
            }
          };
          document.addEventListener('keydown', escapeHandler);
        });
      }
      
      function showStyledConfirm(message, title) {
        title = title || 'Confirm';
        
        var overlay = document.getElementById('confirm-modal-overlay');
        var iconEl = document.getElementById('confirm-modal-icon');
        var titleEl = document.getElementById('confirm-modal-title');
        var messageEl = document.getElementById('confirm-modal-message');
        var okBtn = document.getElementById('confirm-modal-ok');
        var cancelBtn = document.getElementById('confirm-modal-cancel');
        var closeBtn = document.getElementById('confirm-modal-close');
        
        iconEl.className = 'styled-modal-icon confirm';
        iconEl.innerHTML = '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';
        
        titleEl.textContent = title;
        messageEl.textContent = message;
        
        overlay.style.display = 'flex';
        
        return new Promise(function(resolve) {
          function close(result) {
            overlay.style.display = 'none';
            resolve(result);
          }
          
          okBtn.onclick = function() { close(true); };
          cancelBtn.onclick = function() { close(false); };
          closeBtn.onclick = function() { close(false); };
          
          overlay.onclick = function(e) {
            if (e.target === overlay) {
              close(false);
            }
          };
          
          var escapeHandler = function(e) {
            if (e.key === 'Escape') {
              close(false);
              document.removeEventListener('keydown', escapeHandler);
            }
          };
          document.addEventListener('keydown', escapeHandler);
        });
      }
      
      function showStyledPrompt(message, defaultValue, title) {
        title = title || 'Input Required';
        defaultValue = defaultValue || '';
        
        var overlay = document.getElementById('prompt-modal-overlay');
        var iconEl = document.getElementById('prompt-modal-icon');
        var titleEl = document.getElementById('prompt-modal-title');
        var messageEl = document.getElementById('prompt-modal-message');
        var inputEl = document.getElementById('prompt-modal-input');
        var okBtn = document.getElementById('prompt-modal-ok');
        var cancelBtn = document.getElementById('prompt-modal-cancel');
        var closeBtn = document.getElementById('prompt-modal-close');
        
        iconEl.className = 'styled-modal-icon info';
        iconEl.innerHTML = '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>';
        
        titleEl.textContent = title;
        messageEl.textContent = message;
        inputEl.value = defaultValue;
        
        overlay.style.display = 'flex';
        
        // Focus input after modal is shown
        setTimeout(function() {
          inputEl.focus();
          inputEl.select();
        }, 100);
        
        return new Promise(function(resolve) {
          function close(result) {
            overlay.style.display = 'none';
            resolve(result);
          }
          
          function handleOk() {
            close(inputEl.value);
          }
          
          okBtn.onclick = handleOk;
          cancelBtn.onclick = function() { close(null); };
          closeBtn.onclick = function() { close(null); };
          
          inputEl.onkeydown = function(e) {
            if (e.key === 'Enter') {
              e.preventDefault();
              handleOk();
            } else if (e.key === 'Escape') {
              e.preventDefault();
              close(null);
            }
          };
          
          overlay.onclick = function(e) {
            if (e.target === overlay) {
              close(null);
            }
          };
          
          var escapeHandler = function(e) {
            if (e.key === 'Escape') {
              close(null);
              document.removeEventListener('keydown', escapeHandler);
            }
          };
          document.addEventListener('keydown', escapeHandler);
        });
      }
      
      // Replace native alert, confirm, prompt
      window.alert = function(message) {
        return showStyledAlert(message, 'info');
      };
      
      window.confirm = function(message) {
        return showStyledConfirm(message);
      };
      
      window.prompt = function(message, defaultValue) {
        return showStyledPrompt(message, defaultValue);
      };
      
      // Expose modal functions globally for use in other script blocks
      window.showStyledAlert = showStyledAlert;
      window.showStyledConfirm = showStyledConfirm;
      window.showStyledPrompt = showStyledPrompt;

      function getYesterdayDate() {
        var d = new Date();
        d.setDate(d.getDate() - 1);
        var year = d.getFullYear();
        var month = String(d.getMonth() + 1).padStart(2, '0');
        var day = String(d.getDate()).padStart(2, '0');
        return year + '-' + month + '-' + day;
      }

      function initDefaults() {
        if (monthEl && !monthEl.value) {
          var d = new Date();
          var m = String(d.getMonth() + 1).padStart(2, '0');
          monthEl.value = d.getFullYear() + '-' + m;
        }
        
        // Initialize selected date to yesterday (for accurate MTD data)
        if (!selectedDate) {
          selectedDate = getYesterdayDate();
          updateDateDisplay();
        }
      }

      // Sidebar Navigation
      function bindNavigation() {
        var navItems = document.querySelectorAll('.nav-item');
        var pageTitleEl = document.getElementById('page-title');
        var pageSubtitleEl = document.getElementById('page-subtitle');
        var sidebar = document.getElementById('sidebar');
        var overlay = document.getElementById('sidebar-overlay');
        var mobileMenuBtn = document.getElementById('mobile-menu-btn');

        // Page titles and subtitles
        var pageTitles = {
          'dashboard': { title: 'Dashboard', subtitle: 'Overview of your pharmacy performance' },
          'daily-summary': { title: 'Daily Dashboard', subtitle: 'Detailed daily metrics and performance' },
          'monthly-summary': { title: 'Monthly Dashboard', subtitle: 'Month-to-date metrics and performance' },
          'daily': { title: 'Daily Tracking', subtitle: 'Detailed daily turnover and metrics' },
          'targets': { title: 'Targets', subtitle: 'Set and manage monthly targets' },
          'stock-management': { title: 'Stock Management', subtitle: 'Monitor stock levels and product performance' },
          'stock-queries': { title: 'Stock Queries', subtitle: 'Query and analyze stock data' },
          'debtor-tools': { title: 'Debtor Tools', subtitle: 'Manage and track debtor accounts' },
          'chart-of-accounts': { title: 'Chart of Accounts', subtitle: 'Manage financial accounts' },
          'bank-accounts': { title: 'Bank Accounts', subtitle: 'Manage bank accounts per pharmacy' },
          'bank-imports': { title: 'Bank Imports', subtitle: 'Import bank statements and manage imports' },
          'bank-rules': { title: 'Bank Rules', subtitle: 'Create and manage auto-categorization rules' },
          'unmatched-transactions': { title: 'Unmatched Transactions', subtitle: 'Review and classify unmatched bank statement lines' }
        };

        
        navItems.forEach(function(btn) {
          btn.addEventListener('click', function(e) {
            var target = btn.getAttribute('data-tab');
            if (!target) return; // Skip if no data-tab (e.g., admin link)
            
            e.preventDefault();
            e.stopPropagation();
            
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(function(b){
              b.classList.remove('active');
            });
            btn.classList.add('active');
            
            // Update page title
            if (pageTitles[target]) {
              if (pageTitleEl) pageTitleEl.textContent = pageTitles[target].title;
              if (pageSubtitleEl) pageSubtitleEl.textContent = pageTitles[target].subtitle;
            }
            
            // Hide all panels
            var allPanels = document.querySelectorAll('.tab-panel');
            allPanels.forEach(function(panel) {
              panel.hidden = true;
              panel.style.display = 'none';
            });
            
            // Show target panel
            var targetPanel = document.getElementById('tab-' + target);
            if (targetPanel) {
              targetPanel.hidden = false;
              targetPanel.style.display = 'block';
            }
            
            // Toggle controls
            var monthControl = document.getElementById('month-control');
            var datePickerBtn = document.getElementById('date-picker-btn');
            var showDatePicker = target === 'daily-summary' || target === 'monthly-summary' || target === 'dashboard' || target === 'daily' || target === 'targets' || target === 'stock-management' || target === 'stock-queries' || target === 'debtor-tools';
            var hideAllDateControls = target === 'chart-of-accounts' || target === 'bank-accounts' || target === 'bank-imports' || target === 'bank-rules' || target === 'unmatched-transactions'; // Management screens don't need date/month pickers
            
            if (monthControl && datePickerBtn) {
              if (hideAllDateControls) {
                monthControl.style.display = 'none';
                datePickerBtn.style.display = 'none';
              } else if (showDatePicker) {
                monthControl.style.display = 'none';
                datePickerBtn.style.display = 'flex';
              } else {
                monthControl.style.display = 'flex';
                datePickerBtn.style.display = 'none';
              }
            }
            
            // Show/hide group view button - only on dashboard screen
            var groupViewToggleBtn = document.getElementById('group-view-toggle-btn');
            if (groupViewToggleBtn) {
              if (target === 'dashboard') {
                groupViewToggleBtn.style.display = 'flex';
              } else {
                groupViewToggleBtn.style.display = 'none';
                // If group view is active when switching away from dashboard, disable it
                if (groupViewEnabled) {
                  groupViewToggleBtn.click();
                }
              }
            }
            
            // Load data for the target section
            if (target === 'targets') {
              buildTargetsTable();
            } else if (target === 'dashboard') {
              loadDashboard();
            } else if (target === 'daily-summary') {
              loadDailySummary();
            } else if (target === 'monthly-summary') {
              loadMonthlySummary();
            } else if (target === 'stock-management') {
              loadStockManagement();
            } else if (target === 'stock-queries') {
              loadStockQueries();
              loadStockInsights();
            } else if (target === 'debtor-tools') {
              loadDebtorTools();
            } else if (target === 'unmatched-transactions') {
              loadReconciliationSummary(selectedPharmacyId);
              loadUnmatchedTransactions(selectedPharmacyId);
            }
            
            // Close sidebar after 0.25 seconds on mobile screens
            var isMobile = window.innerWidth <= 768;
            if (isMobile && sidebar) {
              setTimeout(function() {
                sidebar.classList.remove('open');
                if (overlay) overlay.classList.remove('active');
                sidebar.style.transform = 'translateX(-120%)';
                if (overlay) overlay.style.display = 'none';
              }, 250);
            }
          });
        });

        // Mobile menu toggle
        if (mobileMenuBtn) {
          mobileMenuBtn.addEventListener('click', function() {
            var isOpening = !sidebar.classList.contains('open');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
            
            // Clear inline styles when opening
            if (isOpening) {
              sidebar.style.transform = '';
              overlay.style.display = '';
            } else {
              sidebar.style.transform = 'translateX(-120%)';
              overlay.style.display = 'none';
            }
          });
        }

        // Close sidebar when clicking overlay
        if (overlay) {
          overlay.addEventListener('click', function() {
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
            sidebar.style.transform = 'translateX(-120%)';
            overlay.style.display = 'none';
          });
        }
      }

      async function loadDays() {
        if (!monthEl || !selectedPharmacyId) return;
        var month = monthEl.value;
        var pid = selectedPharmacyId;
        if (!month || !pid) return;
        tbodyEl.innerHTML = '<tr><td colspan="12" class="muted center">Loading…</td></tr>';
        totalBudgetToEl.textContent = '—';
        totalTurnEl.textContent = '—';
        totalGpPctEl.textContent = '—';
        totalGpEl.textContent = '—';
        totalBudgetSpendEl.textContent = '—';
        totalActualSpendEl.textContent = '—';
        totalPurchasesEl.textContent = '—';
        totalPurchasesPctEl.textContent = '—';
        try {
          const resp = await fetch(`/api/days?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(month)}`);
          if (!resp.ok) throw new Error('Failed to fetch');
          const data = await resp.json();
          renderDays(Array.isArray(data) ? data : []);
        } catch (e) {
          tbodyEl.innerHTML = '<tr><td colspan="12" class="alert error">Failed to load daily turnovers.</td></tr>';
        }
      }

      function fmtNum(val) {
        return Number(val || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }
      
      function fmtMoney(val) {
        const num = Math.round(Number(val || 0));
        return 'R' + num.toLocaleString('en-ZA', { useGrouping: true }).replace(/,/g, ' ');
      }
      
      function fmtMoneyAmount(val) {
        const num = Math.round(Number(val || 0));
        return num.toLocaleString('en-ZA', { useGrouping: true }).replace(/,/g, ' ');
      }
      function fmtPct(val) {
        if (val === null || val === undefined || isNaN(val)) return '—';
        return Number(val).toFixed(0) + '%';
      }

      // Local date formatter YYYY-MM-DD (avoids UTC shift of toISOString)
      function formatYmdLocal(d) {
        var y = d.getFullYear();
        var m = String(d.getMonth() + 1).padStart(2, '0');
        var day = String(d.getDate()).padStart(2, '0');
        return y + '-' + m + '-' + day;
      }

      function renderDays(rows) {
        if (!monthEl || !monthEl.value) {
          tbodyEl.innerHTML = '<tr><td colspan="12" class="muted center">Select a month to view data.</td></tr>';
          return;
        }

        // Parse the selected month to get year and month
        var ym = monthEl.value; // YYYY-MM
        var parts = ym.split('-');
        if (parts.length !== 2) return;
        var year = parseInt(parts[0], 10);
        var monthIndex = parseInt(parts[1], 10) - 1; // 0-based
        var daysInMonth = new Date(year, monthIndex + 1, 0).getDate();

        // Create a map of existing data by date
        const dataMap = {};
        rows.forEach(r => {
          dataMap[r.business_date] = r;
        });

        // Generate complete month structure
        const normalized = [];
        for (var d = 1; d <= daysInMonth; d++) {
          const jsDate = new Date(year, monthIndex, d);
          const dateStr = formatYmdLocal(jsDate);
          const weekdayIdx = jsDate.getDay(); // 0 Sun .. 6 Sat
          const isWeekend = (weekdayIdx === 0 || weekdayIdx === 6);
          const weekday = jsDate.toLocaleDateString(undefined, { weekday: 'short' });
          const label = jsDate.toLocaleDateString(undefined, { day: 'numeric', month: 'long' });

          // Get actual data if available, otherwise use defaults
          const r = dataMap[dateStr] || {};
          const turn = Number(r.turnover || 0);
          const gpVal = Number(r.gp_value || 0);
          const gpPct = (r.gp_pct !== undefined && r.gp_pct !== null) ? Number(r.gp_pct) : (turn ? (gpVal / turn) * 100 : null);
          const closingStock = Number(r.closing_stock || 0);
          const budgetTurn = Number(r.budget_turnover || r.budget_to || r.budget || 0);
          const budgetSpendVal = budgetTurn ? budgetTurn * 0.75 : null;
          const actualSpendVal = turn ? turn * 0.75 : 0;
          const purchasesVal = Number(r.purchases || r.daily_purchases || r.purchases_value || 0);

          normalized.push({ 
            d: jsDate, weekday, label, isWeekend, turn, gpVal, gpPct, closingStock, 
            budgetTurn, budgetSpendVal, actualSpendVal, purchasesVal, dateStr,
            hasData: !!dataMap[dateStr] // Track if we have actual data for this day
          });
        }

        // Load saved targets and merge with normalized data
        loadTargetsForDailyTable(normalized).then(() => {
          // Second pass: compute totals with updated budget values
          let totalBudgetTo = 0;
          let totalTurn = 0;
          let totalGp = 0;
          let totalBudgetSpend = 0;
          let totalActualSpend = 0;
          let totalPurchases = 0;
                      for (const n of normalized) {
              if (typeof n.budgetTurn === 'number') totalBudgetTo += n.budgetTurn;
              totalTurn += n.turn;
              totalGp += n.gpVal;
              if (typeof n.budgetSpendVal === 'number') totalBudgetSpend += n.budgetSpendVal;
              totalActualSpend += n.actualSpendVal;
              totalPurchases += n.purchasesVal;
            }

          // Third pass: render with running tally
                      let runningLeft = totalBudgetSpend;
            const tr = normalized.map(n => {
              let pbLeft = '—';
              let pbClass = '';
              if (totalBudgetSpend > 0) {
                runningLeft = runningLeft - n.purchasesVal;
                pbLeft = fmtNum(runningLeft);
                pbClass = runningLeft >= 0 ? 'positive' : 'negative';
              }

              // Add a visual indicator for days without actual data
              const rowClass = n.isWeekend ? 'weekend' : (n.hasData ? '' : 'no-data');
              
              // Calculate purchases percentage
              const purchasesPct = n.turn && n.purchasesVal ? (n.purchasesVal / n.turn) * 100 : null;
              const purchasesPctDisplay = purchasesPct !== null ? fmtPct(purchasesPct) : '—';
              
              // Format abbreviated date for collapsed state
              const shortMonth = n.d.toLocaleDateString(undefined, { month: 'short' });
              const shortDay = n.d.getDate();
              const shortDate = `${n.weekday} ${shortMonth} ${shortDay}`;
              
              return `<tr class="${rowClass}">`
                     + `<td class="weekday"><span class="full-date">${n.weekday}</span><span class="short-date">${shortDate}</span></td>`
                     + `<td class="date">${n.label}</td>`
                     + `<td class="num budget-to">${n.budgetTurn ? fmtNum(n.budgetTurn) : '—'}</td>`
                     + `<td class=\"num actual-to\">${n.turn ? fmtNum(n.turn) : (n.hasData ? fmtNum(0) : '—')}</td>`
                     + `<td class="num">${n.hasData ? fmtPct(n.gpPct) : '—'}</td>`
                     + `<td class="num">${n.turn ? fmtNum(n.gpVal) : (n.hasData ? fmtNum(0) : '—')}</td>`
                     + `<td class="num budget-spend">${n.budgetSpendVal !== null ? fmtNum(n.budgetSpendVal) : '—'}</td>`
                     + `<td class="num">${n.turn ? fmtNum(n.actualSpendVal) : (n.hasData ? fmtNum(0) : '—')}</td>`
                     + `<td class="num">${n.purchasesVal ? fmtNum(n.purchasesVal) : (n.hasData ? fmtNum(0) : '—')}</td>`
                     + `<td class="num">${purchasesPctDisplay}</td>`
                     + `<td class="num purchase-budget-left ${pbClass}">${pbLeft}</td>`
                     + `<td class="num soh">${n.closingStock ? fmtNum(n.closingStock) : (n.hasData ? fmtNum(0) : '—')}</td>`
                     + `</tr>`;
          }).join('');
          tbodyEl.innerHTML = tr;
          totalBudgetToEl.textContent = totalBudgetTo ? fmtNum(totalBudgetTo) : '—';
          totalTurnEl.textContent = fmtNum(totalTurn);
          totalGpEl.textContent = fmtNum(totalGp);
          const overallPct = totalTurn ? (totalGp / totalTurn) * 100 : null;
          totalGpPctEl.textContent = fmtPct(overallPct);
          totalBudgetSpendEl.textContent = totalBudgetSpend ? fmtNum(totalBudgetSpend) : '—';
          totalActualSpendEl.textContent = fmtNum(totalActualSpend);
          totalPurchasesEl.textContent = fmtNum(totalPurchases);
          
          // Calculate total purchases percentage
          const totalPurchasesPct = totalTurn ? (totalPurchases / totalTurn) * 100 : null;
          totalPurchasesPctEl.textContent = totalPurchasesPct !== null ? fmtPct(totalPurchasesPct) : '—';
        });
      }

      async function loadTargetsForDailyTable(normalizedRows) {
        if (!monthEl || !selectedPharmacyId) return;
        var month = monthEl.value;
        var pid = selectedPharmacyId;
        if (!month || !pid) return;

        try {
          const targetsResp = await fetch(`/api/targets?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(month)}`);
          if (targetsResp.ok) {
            const targetsData = await targetsResp.json();
            if (targetsData.targets && Array.isArray(targetsData.targets)) {
              // Create a map of date -> target value for quick lookup
              const targetsMap = {};
              targetsData.targets.forEach(function(target) {
                targetsMap[target.date] = Number(target.value);
              });

              // Update normalized rows with target values
              normalizedRows.forEach(function(row) {
                const targetValue = targetsMap[row.dateStr];
                if (targetValue) {
                  row.budgetTurn = targetValue;
                  row.budgetSpendVal = targetValue * 0.75;
                }
              });
            }
          }
        } catch (e) {
          console.log('Could not load targets for daily table:', e);
        }
      }

      function monthName(idx) {
        return new Date(2000, idx, 1).toLocaleString(undefined, { month: 'long' });
      }

      function addDays(dateObj, days) {
        var d = new Date(dateObj.getTime());
        d.setDate(d.getDate() + days);
        return d;
      }

      async function buildTargetsTable() {
        if (!targetsTbodyEl || !monthEl || !monthEl.value) return;
        var ym = monthEl.value; // YYYY-MM
        var parts = ym.split('-');
        if (parts.length !== 2) return;
        var year = parseInt(parts[0], 10);
        var monthIndex = parseInt(parts[1], 10) - 1; // 0-based
        var daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
        var pid = selectedPharmacyId;

        // Build row shells and collect required previous-year comparable dates (364 days earlier)
        var rows = [];
        var prevDates = [];
        for (var d = 1; d <= daysInMonth; d++) {
          var jsDate = new Date(year, monthIndex, d);
          var weekday = jsDate.toLocaleDateString(undefined, { weekday: 'short' });
          var dateLabel = jsDate.toLocaleDateString(undefined, { day: 'numeric', month: 'long' });
          var shortMonth = jsDate.toLocaleDateString(undefined, { month: 'short' });
          var shortDay = jsDate.getDate();
          var shortDate = weekday + ' ' + shortMonth + ' ' + shortDay;
          var ymddate = formatYmdLocal(jsDate);
          var prevComparable = addDays(jsDate, -364); // keeps weekday alignment
          var prevYmd = formatYmdLocal(prevComparable);
          prevDates.push(prevYmd);
          rows.push(
            '<tr data-date="' + ymddate + '" data-prev="' + prevYmd + '">'
            + '<td class="weekday"><span class="full-date">' + weekday + '</span><span class="short-date">' + shortDate + '</span></td>'
            + '<td class="date">' + dateLabel + '</td>'
            + '<td class="num prev-yoY">—</td>'
            + '<td class="num">'
              + '<input type="number" inputmode="decimal" step="0.01" placeholder="0.00" '
              + 'name="growth_' + ymddate + '" class="growth-input" style="width: 100px;" />'
            + '</td>'
            + '<td class="num">'
              + '<input type="number" inputmode="decimal" step="0.01" min="0" placeholder="0.00" '
              + 'name="target_' + ymddate + '" class="target-input" style="width: 140px;" />'
            + '</td>'
            + '</tr>'
          );
        }
        targetsTbodyEl.innerHTML = rows.join('');

        // Group needed previous dates by month and fetch monthly data via /api/days
        if (!pid) return;
        var monthsNeeded = Array.from(new Set(prevDates.map(function(d){ return d.slice(0,7); })));
        var maps = {};
        await Promise.all(monthsNeeded.map(async function(monthStr){
          try {
            const resp = await fetch(`/api/days?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(monthStr)}`);
            if (!resp.ok) return;
            const data = await resp.json();
            if (Array.isArray(data)) {
              data.forEach(function(rec){
                maps[rec.business_date] = rec;
              });
            }
          } catch (e) {}
        }));

        // Populate previous year turnovers
        Array.from(targetsTbodyEl.querySelectorAll('tr')).forEach(function(tr){
          var prev = tr.getAttribute('data-prev');
          var cell = tr.querySelector('.prev-yoY');
          var rec = maps[prev];
          var turn = rec ? Number(rec.turnover || 0) : null;
          cell.textContent = (turn === null || isNaN(turn)) ? '—' : fmtNum(turn);
        });

        // Load saved target values and calculate growth %
        try {
          const targetsResp = await fetch(`/api/targets?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(ym)}`);
          if (targetsResp.ok) {
            const targetsData = await targetsResp.json();
            if (targetsData.targets && Array.isArray(targetsData.targets)) {
              targetsData.targets.forEach(function(target) {
                var targetRow = targetsTbodyEl.querySelector(`tr[data-date="${target.date}"]`);
                if (targetRow) {
                  var targetInput = targetRow.querySelector('input[name^="target_"]');
                  var growthInput = targetRow.querySelector('input[name^="growth_"]');
                  var prevCell = targetRow.querySelector('.prev-yoY');
                  
                  if (targetInput && target.value) {
                    var targetValue = Number(target.value);
                    targetInput.value = targetValue.toFixed(2);
                    
                    // Calculate and display growth % if we have previous year data
                    if (growthInput && prevCell) {
                      var prevText = prevCell.textContent || '';
                      var prevNum = Number(prevText.replace(/[^0-9.\-]/g, ''));
                      if (!isNaN(prevNum) && prevNum > 0) {
                        var growthPct = ((targetValue / prevNum) - 1) * 100;
                        growthInput.value = growthPct.toFixed(2);
                      }
                    }
                  }
                }
              });
            }
          }
        } catch (e) {
          console.log('Could not load saved targets:', e);
        }
        
        // Bind event listeners for bidirectional calculations (only once)
        if (!targetsTbodyEl._listenersBound) {
          bindTargetsInputListeners();
          targetsTbodyEl._listenersBound = true;
        }
      }
      
      function bindTargetsInputListeners() {
        if (!targetsTbodyEl) return;
        
        // When growth % changes, calculate target turnover
        targetsTbodyEl.addEventListener('input', function(e) {
          if (e.target.classList.contains('growth-input')) {
            var growthInput = e.target;
            var row = growthInput.closest('tr');
            if (!row) return;
            
            var prevCell = row.querySelector('.prev-yoY');
            var targetInput = row.querySelector('.target-input');
            if (!prevCell || !targetInput) return;
            
            var growthPct = parseFloat(growthInput.value);
            if (isNaN(growthPct)) return;
            
            var prevText = prevCell.textContent || '';
            var prevNum = Number(prevText.replace(/[^0-9.\-]/g, ''));
            if (!isNaN(prevNum) && prevNum > 0) {
              var multiplier = 1 + (growthPct / 100);
              var targetValue = prevNum * multiplier;
              targetInput.value = targetValue.toFixed(2);
            }
          }
          
          // When target turnover changes, calculate growth %
          if (e.target.classList.contains('target-input')) {
            var targetInput = e.target;
            var row = targetInput.closest('tr');
            if (!row) return;
            
            var prevCell = row.querySelector('.prev-yoY');
            var growthInput = row.querySelector('.growth-input');
            if (!prevCell || !growthInput) return;
            
            var targetValue = parseFloat(targetInput.value);
            if (isNaN(targetValue) || targetValue <= 0) {
              growthInput.value = '';
              return;
            }
            
            var prevText = prevCell.textContent || '';
            var prevNum = Number(prevText.replace(/[^0-9.\-]/g, ''));
            if (!isNaN(prevNum) && prevNum > 0) {
              var growthPct = ((targetValue / prevNum) - 1) * 100;
              growthInput.value = growthPct.toFixed(2);
            } else {
              growthInput.value = '';
            }
          }
        });
      }

      function applyGrowth() {
        var pct = parseFloat(growthInputEl && growthInputEl.value ? growthInputEl.value : '0');
        if (isNaN(pct)) pct = 0;
        var multiplier = 1 + (pct / 100);
        Array.from((targetsTbodyEl || document.createElement('tbody')).querySelectorAll('tr')).forEach(function(tr){
          var prevCell = tr.querySelector('.prev-yoY');
          var targetInput = tr.querySelector('input[name^="target_"]');
          var growthInput = tr.querySelector('input[name^="growth_"]');
          if (!prevCell || !targetInput) return;
          var text = prevCell.textContent || '';
          var num = Number(text.replace(/[^0-9.\-]/g, ''));
          if (!isNaN(num) && num > 0) {
            var target = num * multiplier;
            targetInput.value = target.toFixed(2);
            // Also populate the growth % column
            if (growthInput) {
              growthInput.value = pct.toFixed(2);
            }
          }
        });
      }

      async function saveTargets() {
        if (!monthEl || !selectedPharmacyId) return;
        var month = monthEl.value;
        var pid = selectedPharmacyId;
        if (!month || !pid) return;

        var targets = {};
        Array.from(targetsTbodyEl.querySelectorAll('tr')).forEach(function(tr){
          var date = tr.getAttribute('data-date');
          var input = tr.querySelector('input[name^="target_"]');
          if (!input) return;
          var targetValue = input.value;
          if (targetValue && !isNaN(Number(targetValue))) {
            targets[date] = Number(targetValue);
          }
        });

        if (Object.keys(targets).length === 0) {
          showStyledAlert('No target values to save.', 'warning', 'No Targets');
          return;
        }

        try {
          const resp = await fetch(`/api/targets?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(month)}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(targets),
          });
          if (!resp.ok) {
            const error = await resp.json();
            throw new Error(error.message || 'Failed to save targets');
          }
          showStyledAlert('Targets saved successfully!', 'success', 'Success');
          // Don't reload the table - keep the values visible in the inputs
        } catch (e) {
          showStyledAlert('Failed to save targets: ' + e.message, 'error', 'Error');
        }
      }

      // Stock Management Functions
      async function loadStockManagement() {
        console.log('loadStockManagement called');
        if (!selectedPharmacyId) {
          console.log('Missing selectedPharmacyId');
          return;
        }
        
        try {
          // Use selectedDate (defaults to yesterday) for all queries
          var dateToUse = selectedDate || getYesterdayDate();
          console.log('loadStockManagement - dateToUse:', dateToUse);
          
          // Load stock overview data (includes stock value from database)
          console.log('Calling loadStockOverview...');
          await loadStockOverview(dateToUse);
          console.log('loadStockOverview completed');
          
          // Load budget data (purchases vs budget)
          console.log('Calling loadBudgetData...');
          await loadBudgetData(dateToUse);
          console.log('loadBudgetData completed');
          
          // Load top movers (use current month for better context)
          var today = new Date();
          var monthStart = formatYmdLocal(new Date(today.getFullYear(), today.getMonth(), 1));
          var monthEnd = formatYmdLocal(today);
          await loadTopMovers(monthStart, monthEnd);
          
          // Load low GP products (use current month)
          await loadLowGpProducts(monthStart, monthEnd);
        } catch (e) {
          console.error('Failed to load stock management data:', e);
          console.error('Error stack:', e.stack);
        }
      }
      
      // Stock Queries / Stock Lookup Functions
      var stockSearchTimeout = null;
      var stockSearchResults = [];
      var stockExpandedProducts = new Set();
      var stockProductDetails = {};
      
      function initStockQueries() {
        var searchInput = document.getElementById('stock-search-input');
        if (!searchInput) return;
        
        // Don't search on initial load - wait for at least 3 characters
        
        // Debounced search on input
        searchInput.addEventListener('input', function(e) {
          var query = e.target.value.trim();
          
          // Clear previous timeout
          if (stockSearchTimeout) {
            clearTimeout(stockSearchTimeout);
          }
          
          // Set new timeout (300ms debounce)
          stockSearchTimeout = setTimeout(function() {
            performStockSearch(query);
          }, 300);
        });
      }
      
      async function performStockSearch(query) {
        var pid = selectedPharmacyId;
        if (!pid) {
          stockSearchResults = [];
          renderStockSearchResults();
          return;
        }
        
        var searchInput = document.getElementById('stock-search-input');
        var loadingEl = document.getElementById('stock-search-loading');
        var errorEl = document.getElementById('stock-search-error');
        var resultsEl = document.getElementById('stock-search-results');
        
        // Require at least 3 characters before showing results
        if (!query || query.length < 3) {
          stockSearchResults = [];
          if (loadingEl) loadingEl.style.display = 'none';
          if (errorEl) {
            errorEl.style.display = 'none';
            errorEl.textContent = '';
          }
          if (resultsEl) resultsEl.style.display = 'none';
          return;
        }
        
        if (loadingEl) loadingEl.style.display = 'flex';
        if (errorEl) {
          errorEl.style.display = 'none';
          errorEl.textContent = '';
        }
        
        try {
          var url = `/api/products/search?query=${encodeURIComponent(query)}&page=1&page_size=200`;
          var resp = await fetch(url);
          
          if (!resp.ok) {
            throw new Error('Failed to fetch products: ' + resp.status);
          }
          
          var data = await resp.json();
          
          // Handle multiple response structures
          var items = [];
          if (Array.isArray(data)) {
            items = data;
          } else if (data.items && Array.isArray(data.items)) {
            items = data.items;
          } else if (data.products && Array.isArray(data.products)) {
            items = data.products;
          } else if (data.data && Array.isArray(data.data)) {
            items = data.data;
          }
          
          // Sort results (priority-based)
          var searchLower = query.toLowerCase();
          var sortedItems = items.sort(function(a, b) {
            var aStockCode = (a.product_code || a.stock_code || a.code || a.sku || '').toLowerCase();
            var aDescription = (a.description || a.product_name || a.name || a.title || '').toLowerCase();
            var bStockCode = (b.product_code || b.stock_code || b.code || b.sku || '').toLowerCase();
            var bDescription = (b.description || b.product_name || b.name || b.title || '').toLowerCase();
            
            // Priority 1: Exact stock code match
            if (aStockCode === searchLower && bStockCode !== searchLower) return -1;
            if (bStockCode === searchLower && aStockCode !== searchLower) return 1;
            
            // Priority 2: Exact description match
            if (aDescription === searchLower && bDescription !== searchLower) return -1;
            if (bDescription === searchLower && aDescription !== searchLower) return 1;
            
            // Priority 3: Stock code starts with search term
            if (aStockCode.startsWith(searchLower) && !bStockCode.startsWith(searchLower)) return -1;
            if (bStockCode.startsWith(searchLower) && !aStockCode.startsWith(searchLower)) return 1;
            
            // Priority 4: Description starts with search term
            if (aDescription.startsWith(searchLower) && !bDescription.startsWith(searchLower)) return -1;
            if (bDescription.startsWith(searchLower) && !aDescription.startsWith(searchLower)) return 1;
            
            // Priority 5: Sort by description length (shorter first)
            return aDescription.length - bDescription.length;
          });
          
          stockSearchResults = sortedItems;
          renderStockSearchResults();
          
        } catch (e) {
          console.error('Stock search error:', e);
          if (errorEl) {
            errorEl.textContent = 'Failed to search products: ' + e.message;
            errorEl.style.display = 'block';
          }
          stockSearchResults = [];
          renderStockSearchResults();
        } finally {
          if (loadingEl) loadingEl.style.display = 'none';
        }
      }
      
      function renderStockSearchResults() {
        var resultsEl = document.getElementById('stock-search-results');
        var resultsListEl = document.getElementById('stock-results-list');
        var resultsCountEl = document.getElementById('stock-results-count');
        
        if (!resultsEl || !resultsListEl) return;
        
        if (stockSearchResults.length === 0) {
          resultsEl.style.display = 'none';
          return;
        }
        
        resultsEl.style.display = 'block';
        
        if (resultsCountEl) {
          var count = stockSearchResults.length;
          resultsCountEl.textContent = 'Found ' + count + ' product' + (count === 1 ? '' : 's');
        }
        
        // Clear previous results
        resultsListEl.innerHTML = '';
        
        // Render each result
        stockSearchResults.forEach(function(item, index) {
          var productCode = item.product_code || item.stock_code || item.code || item.sku || 'N/A';
          var productName = item.description || item.product_name || item.name || item.title || 'Unknown Product';
          var productId = item.id || index;
          var expandedKey = productId + '-' + productCode;
          var isExpanded = stockExpandedProducts.has(expandedKey);
          
          var resultItem = document.createElement('div');
          resultItem.className = 'stock-result-item';
          
          var itemContent = document.createElement('div');
          itemContent.className = 'stock-result-item-content';
          
          var itemInfo = document.createElement('div');
          itemInfo.className = 'stock-result-item-info';
          
          var itemName = document.createElement('div');
          itemName.className = 'stock-result-item-name';
          itemName.textContent = productName;
          
          var itemCode = document.createElement('div');
          itemCode.className = 'stock-result-item-code';
          itemCode.textContent = productCode;
          
          itemInfo.appendChild(itemName);
          itemInfo.appendChild(itemCode);
          
          var expandArrow = document.createElement('div');
          expandArrow.className = 'stock-expand-arrow' + (isExpanded ? ' expanded' : '');
          expandArrow.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>';
          
          itemContent.appendChild(itemInfo);
          itemContent.appendChild(expandArrow);
          
          resultItem.appendChild(itemContent);
          
          // Add click handler
          itemContent.addEventListener('click', function() {
            toggleStockProductDetails(productId, productCode, item);
          });
          
          // Add expanded details if applicable
          if (isExpanded) {
            var detailsContainer = createStockProductDetails(productId, productCode);
            if (detailsContainer) {
              resultItem.appendChild(detailsContainer);
            }
          }
          
          resultsListEl.appendChild(resultItem);
        });
      }
      
      async function toggleStockProductDetails(productId, productCode, item) {
        var expandedKey = productId + '-' + productCode;
        
        if (stockExpandedProducts.has(expandedKey)) {
          // Collapse
          stockExpandedProducts.delete(expandedKey);
          delete stockProductDetails[expandedKey];
          renderStockSearchResults();
        } else {
          // Expand
          stockExpandedProducts.add(expandedKey);
          
          // Show loading state for quick data
          stockProductDetails[expandedKey] = { 
            loading: true, 
            data: null, 
            error: null,
            chartLoading: true,
            onHand: 0
          };
          renderStockSearchResults();
          
          // Fetch SOH and sales details in parallel
          var pid = selectedPharmacyId;
          var dateStr = selectedDate || getYesterdayDate();
          
          console.log('[DEBUG] Fetching SOH for:', { productCode, pid, dateStr });
          
          var [sohData, details] = await Promise.all([
            fetch(`/api/products/${encodeURIComponent(productCode)}/stock?pharmacy_id=${pid}&date=${dateStr}`)
              .then(async function(r) {
                if (!r.ok) {
                  console.error('[ERROR] SOH API error:', r.status, r.statusText);
                  return { on_hand: 0, error: r.status };
                }
                var data = await r.json();
                console.log('[DEBUG] SOH API response:', data);
                return data;
              })
              .catch(function(e) {
                console.error('[ERROR] SOH fetch failed:', e);
                return { on_hand: 0, error: e.message };
              }),
            fetchStockProductDetails(productCode, false, 0)
          ]);
          
          var onHand = Number(sohData.on_hand || 0);
          console.log('[DEBUG] Extracted SOH value:', onHand, 'from response:', sohData);
          
          // Update details with SOH
          if (details && details.summary) {
            details.summary.on_hand = onHand;
          }
          
          // Update with quick data, keep chart loading
          stockProductDetails[expandedKey] = {
            loading: false,
            data: details,
            error: details ? null : 'No sales data for selected period',
            chartLoading: true,
            onHand: onHand
          };
          renderStockSearchResults();
          
          // Now fetch monthly data separately
          var monthlyData = await fetchStockMonthlyData(productCode, selectedPharmacyId, selectedDate || getYesterdayDate());
          
          // Update with monthly data
          if (stockProductDetails[expandedKey] && stockProductDetails[expandedKey].data) {
            stockProductDetails[expandedKey].data.monthly = monthlyData;
            stockProductDetails[expandedKey].chartLoading = false;
            renderStockSearchResults();
          }
        }
      }
      
      async function fetchStockProductDetails(productCode, includeMonthly, onHand) {
        var pid = selectedPharmacyId;
        if (!pid) return null;
        
        // includeMonthly defaults to true for backward compatibility
        if (includeMonthly === undefined) includeMonthly = true;
        if (onHand === undefined) onHand = 0;
        
        try {
          // Default to last 3 months for daily breakdown
          var endDate = selectedDate || getYesterdayDate();
          var endDateObj = new Date(endDate + 'T00:00:00');
          var startDateObj = new Date(endDateObj);
          startDateObj.setMonth(startDateObj.getMonth() - 3); // 3 months back
          var startDate = formatYmdLocal(startDateObj);
          
          var url = `/api/products/${encodeURIComponent(productCode)}/sales?from_date=${startDate}&to_date=${endDate}&pharmacy_id=${pid}`;
          var resp = await fetch(url);
          
          if (!resp.ok) {
            return null;
          }
          
          var raw = await resp.json();
          
          // Parse daily data
          var daily = [];
          if (Array.isArray(raw.daily)) {
            daily = raw.daily;
          } else if (Array.isArray(raw.items)) {
            daily = raw.items;
          } else if (Array.isArray(raw)) {
            daily = raw;
          }
          
          // Extract summary fields (with fallbacks)
          var totalQty = raw.summary && raw.summary.total_qty_sold !== undefined ? raw.summary.total_qty_sold : (raw.total_qty_sold || 0);
          var totalSales = raw.summary && raw.summary.total_sales_value !== undefined ? raw.summary.total_sales_value : (raw.total_sales_value || 0);
          var totalCost = raw.summary && raw.summary.total_cost_of_sales !== undefined ? raw.summary.total_cost_of_sales : (raw.total_cost_of_sales || 0);
          var totalGp = raw.summary && raw.summary.total_gp_value !== undefined ? raw.summary.total_gp_value : (raw.total_gp_value || 0);
          var avgGpPct = raw.summary && raw.summary.avg_gp_percentage !== undefined ? raw.summary.avg_gp_percentage : (raw.avg_gp_percentage || 0);
          
          // Compute missing values from daily data if needed
          if (totalQty == null || totalQty === 0) {
            totalQty = daily.reduce(function(sum, d) {
              return sum + (Number(d.qty_sold || d.quantity || 0) || 0);
            }, 0);
          }
          if (totalSales == null || totalSales === 0) {
            totalSales = daily.reduce(function(sum, d) {
              return sum + (Number(d.sales_val || d.sales_value || 0) || 0);
            }, 0);
          }
          if (totalCost == null || totalCost === 0) {
            totalCost = daily.reduce(function(sum, d) {
              return sum + (Number(d.cost_of_sales || d.cost || 0) || 0);
            }, 0);
          }
          if (totalGp == null || totalGp === 0) {
            totalGp = daily.reduce(function(sum, d) {
              return sum + (Number(d.gp_value || d.gp || 0) || 0);
            }, 0);
          }
          
          // Calculate average GP% if missing
          if (avgGpPct == null || avgGpPct === 0) {
            avgGpPct = totalSales > 0 ? (totalGp / totalSales) * 100 : 0;
          }
          
          // Calculate 180-day average
          var avg180 = await computeStockAvgQtyOverDays(productCode, pid, 180, endDate);
          
          var result = {
            summary: {
              total_qty_sold: Number(totalQty) || 0,
              total_sales_value: Number(totalSales) || 0,
              total_cost_of_sales: Number(totalCost) || 0,
              total_gp_value: Number(totalGp) || 0,
              avg_gp_percentage: Number(Math.round((avgGpPct + Number.EPSILON) * 100) / 100) || 0,
              on_hand: Number(onHand) || 0
            },
            daily: daily,
            avg_180d_qty: Number(avg180) || 0
          };
          
          // Only fetch monthly data if requested
          if (includeMonthly) {
            result.monthly = await fetchStockMonthlyData(productCode, pid, endDate);
          }
          
          return result;
        } catch (e) {
          console.error('Error fetching product details:', e);
          return null;
        }
      }
      
      async function fetchStockMonthlyData(productCode, pid, endDate) {
        try {
          // Calculate 12 months back from end date
          var endDateObj = new Date(endDate + 'T00:00:00');
          var monthlyData = [];
          
          for (var i = 11; i >= 0; i--) {
            var monthDate = new Date(endDateObj);
            monthDate.setMonth(monthDate.getMonth() - i);
            
            // Get first and last day of that month
            var year = monthDate.getFullYear();
            var month = monthDate.getMonth();
            var firstDay = new Date(year, month, 1);
            var lastDay = new Date(year, month + 1, 0);
            
            // Don't fetch future months
            if (lastDay > endDateObj) {
              lastDay = endDateObj;
            }
            
            var fromStr = formatYmdLocal(firstDay);
            var toStr = formatYmdLocal(lastDay);
            
            var monthlyQty = 0;
            
            try {
              var url = `/api/products/${encodeURIComponent(productCode)}/sales?from_date=${fromStr}&to_date=${toStr}&pharmacy_id=${pid}`;
              var resp = await fetch(url);
              
              if (resp.ok) {
                var data = await resp.json();
                
                // Try to get from summary first
                if (data.summary && data.summary.total_qty_sold !== undefined) {
                  monthlyQty = Number(data.summary.total_qty_sold) || 0;
                } else if (data.total_qty_sold !== undefined) {
                  monthlyQty = Number(data.total_qty_sold) || 0;
                } else {
                  // Calculate from daily data
                  var dailyArr = [];
                  if (Array.isArray(data.daily)) {
                    dailyArr = data.daily;
                  } else if (Array.isArray(data.items)) {
                    dailyArr = data.items;
                  } else if (Array.isArray(data)) {
                    dailyArr = data;
                  }
                  
                  monthlyQty = dailyArr.reduce(function(sum, d) {
                    return sum + (Number(d.qty_sold || d.quantity || 0) || 0);
                  }, 0);
                }
              }
            } catch (e) {
              // If fetch fails, keep qty as 0
              console.log('Failed to fetch month data:', e);
            }
            
            // Format month as MM/YY (e.g., "11/25" for November 2025)
            var monthNum = month + 1; // JavaScript months are 0-indexed
            var yearShort = year.toString().slice(-2); // Last 2 digits of year
            var monthLabel = String(monthNum).padStart(2, '0') + '/' + yearShort;
            
            monthlyData.push({
              month: monthLabel,
              qty: monthlyQty
            });
          }
          
          return monthlyData;
        } catch (e) {
          console.error('Error fetching monthly data:', e);
          return [];
        }
      }
      
      async function computeStockAvgQtyOverDays(productCode, pid, numDays, endDate) {
        try {
          var endDateObj = new Date(endDate + 'T00:00:00');
          var startDateObj = new Date(endDateObj);
          startDateObj.setDate(startDateObj.getDate() - (numDays - 1));
          var fromStr = formatYmdLocal(startDateObj);
          var toStr = endDate;
          
          var url = `/api/products/${encodeURIComponent(productCode)}/sales?from_date=${fromStr}&to_date=${toStr}&pharmacy_id=${pid}`;
          var resp = await fetch(url);
          
          if (resp.ok) {
            var data = await resp.json();
            var dailyArr = [];
            if (Array.isArray(data.daily)) {
              dailyArr = data.daily;
            } else if (Array.isArray(data.items)) {
              dailyArr = data.items;
            } else if (Array.isArray(data)) {
              dailyArr = data;
            }
            
            var totalFromDaily = dailyArr.reduce(function(sum, d) {
              return sum + (Number(d.qty_sold || d.quantity || 0) || 0);
            }, 0);
            var summaryQty = Number((data.summary && data.summary.total_qty_sold) || data.total_qty_sold || 0);
            var pickedTotal = (dailyArr.length > 0 ? totalFromDaily : 0) || summaryQty || 0;
            
            if (pickedTotal > 0) {
              return pickedTotal / numDays;
            }
          }
          
          return 0;
        } catch (e) {
          return 0;
        }
      }
      
      function createStockProductDetails(productId, productCode) {
        var expandedKey = productId + '-' + productCode;
        var details = stockProductDetails[expandedKey];
        
        if (!details) return null;
        
        var container = document.createElement('div');
        container.className = 'stock-product-details-container';
        
        if (details.loading) {
          container.innerHTML = '<div class="stock-details-loading">Loading details...</div>';
          return container;
        }
        
        if (details.error) {
          container.innerHTML = '<div class="stock-details-error">' + details.error + '</div>';
          return container;
        }
        
        if (!details.data) {
          container.innerHTML = '<div class="stock-details-error">No data available</div>';
          return container;
        }
        
        var data = details.data;
        var summary = data.summary || {};
        var daily = Array.isArray(data.daily) ? data.daily : (Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []));
        
        var detailsContent = document.createElement('div');
        detailsContent.className = 'stock-details-content';
        
        // Create wrapper for chart and summary grid (side by side on large screens)
        var chartSummaryWrapper = document.createElement('div');
        chartSummaryWrapper.className = 'stock-chart-summary-wrapper';
        
        // Summary Grid (left side - 50%)
        var summaryGrid = document.createElement('div');
        summaryGrid.className = 'stock-details-summary-grid';
        
        // SOH (Stock on Hand)
        var sohItem = document.createElement('div');
        sohItem.className = 'stock-summary-card soh-card';
        sohItem.innerHTML = '<div class="stock-summary-label">SOH</div><div class="stock-summary-value">' + Number(summary.on_hand || 0).toFixed(1) + '</div>';
        
        // Unit Price (Sales per unit)
        var qtyForCalc = Number(summary.total_qty_sold) || 0;
        var unitPrice = qtyForCalc > 0 ? (Number(summary.total_sales_value) || 0) / qtyForCalc : 0;
        var salesItem = document.createElement('div');
        salesItem.className = 'stock-summary-card sales-card';
        salesItem.innerHTML = '<div class="stock-summary-label">Unit Price</div><div class="stock-summary-value">R ' + unitPrice.toFixed(2) + '</div>';
        
        // Daily Avg
        var dailyAvgItem = document.createElement('div');
        dailyAvgItem.className = 'stock-summary-card daily-avg-card';
        dailyAvgItem.innerHTML = '<div class="stock-summary-label">Daily Avg</div><div class="stock-summary-value">' + Number(data.avg_180d_qty || 0).toFixed(1) + '</div>';
        
        // GP%
        var gpItem = document.createElement('div');
        gpItem.className = 'stock-summary-card gp-card';
        gpItem.innerHTML = '<div class="stock-summary-label">GP%</div><div class="stock-summary-value">' + Number(summary.avg_gp_percentage || 0).toFixed(2) + '%</div>';
        
        // Unit Cost (Cost per unit)
        var unitCost = qtyForCalc > 0 ? (Number(summary.total_cost_of_sales) || 0) / qtyForCalc : 0;
        var costItem = document.createElement('div');
        costItem.className = 'stock-summary-card cost-card';
        costItem.innerHTML = '<div class="stock-summary-label">Unit Cost</div><div class="stock-summary-value">R ' + unitCost.toFixed(2) + '</div>';
        
        // Month Avg
        var monthAvgItem = document.createElement('div');
        monthAvgItem.className = 'stock-summary-card month-avg-card';
        monthAvgItem.innerHTML = '<div class="stock-summary-label">Mnth Avg</div><div class="stock-summary-value">' + (Number(data.avg_180d_qty || 0) * 30).toFixed(1) + '</div>';
        
        summaryGrid.appendChild(sohItem);
        summaryGrid.appendChild(salesItem);
        summaryGrid.appendChild(dailyAvgItem);
        summaryGrid.appendChild(gpItem);
        summaryGrid.appendChild(costItem);
        summaryGrid.appendChild(monthAvgItem);
        
        chartSummaryWrapper.appendChild(summaryGrid);
        
        // Bar chart (right side - 50%)
        var chartLoading = details.chartLoading === true;
        if (chartLoading) {
          var loadingChart = createStockBarChartLoading();
          if (loadingChart) {
            chartSummaryWrapper.appendChild(loadingChart);
          }
        } else if (data.monthly && Array.isArray(data.monthly) && data.monthly.length > 0) {
          var chartContainer = createStockBarChart(data.monthly);
          if (chartContainer) {
            chartSummaryWrapper.appendChild(chartContainer);
          }
        }
        
        detailsContent.appendChild(chartSummaryWrapper);
        
        // Daily breakdown (first 14 days)
        if (daily.length > 0) {
          var dailyContainer = document.createElement('div');
          dailyContainer.className = 'stock-daily-breakdown';
          dailyContainer.style.marginTop = '12px';
          
          daily.slice(0, 14).forEach(function(detail) {
            var detailItem = document.createElement('div');
            detailItem.className = 'stock-detail-item';
            var date = detail.date || detail.business_date || 'Date';
            var qty = Number(detail.qty_sold || detail.quantity || 0);
            detailItem.innerHTML = '<div class="stock-detail-label">' + date + '</div><div class="stock-detail-value">' + qty + '</div>';
            dailyContainer.appendChild(detailItem);
          });
          
          detailsContent.appendChild(dailyContainer);
        }
        
        container.appendChild(detailsContent);
        return container;
      }
      
      function createStockBarChartLoading() {
        // Create the orange gradient card with loading state
        var card = document.createElement('div');
        card.className = 'stock-monthly-chart-card';
        
        // Create header with icon and title
        var header = document.createElement('div');
        header.className = 'stock-chart-header';
        
        var iconWrapper = document.createElement('span');
        iconWrapper.className = 'stock-chart-icon';
        iconWrapper.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="4" height="18"></rect><rect x="10" y="8" width="4" height="13"></rect><rect x="17" y="12" width="4" height="9"></rect></svg>';
        
        var title = document.createElement('h3');
        title.className = 'stock-chart-title';
        title.textContent = 'Monthly Sales';
        
        header.appendChild(iconWrapper);
        header.appendChild(title);
        
        // Create loading message with spinner
        var loadingWrapper = document.createElement('div');
        loadingWrapper.className = 'stock-chart-loading';
        loadingWrapper.style.height = '100px';
        loadingWrapper.style.display = 'flex';
        loadingWrapper.style.alignItems = 'center';
        loadingWrapper.style.justifyContent = 'center';
        loadingWrapper.style.gap = '12px';
        
        var spinner = document.createElement('div');
        spinner.className = 'stock-chart-spinner';
        spinner.style.width = '20px';
        spinner.style.height = '20px';
        spinner.style.border = '3px solid rgba(255, 255, 255, 0.3)';
        spinner.style.borderTopColor = '#FFFFFF';
        spinner.style.borderRadius = '50%';
        spinner.style.animation = 'spin 0.8s linear infinite';
        
        var loadingText = document.createElement('span');
        loadingText.style.color = 'rgba(255, 255, 255, 0.9)';
        loadingText.style.fontSize = '14px';
        loadingText.style.fontWeight = '500';
        loadingText.textContent = 'Loading Data...';
        
        loadingWrapper.appendChild(spinner);
        loadingWrapper.appendChild(loadingText);
        
        card.appendChild(header);
        card.appendChild(loadingWrapper);
        return card;
      }
      
      function createStockBarChart(monthlyData) {
        if (!monthlyData || monthlyData.length === 0) return null;
        
        // Create the orange gradient card
        var card = document.createElement('div');
        card.className = 'stock-monthly-chart-card';
        
        // Create header with icon and title
        var header = document.createElement('div');
        header.className = 'stock-chart-header';
        
        var iconWrapper = document.createElement('span');
        iconWrapper.className = 'stock-chart-icon';
        iconWrapper.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="4" height="18"></rect><rect x="10" y="8" width="4" height="13"></rect><rect x="17" y="12" width="4" height="9"></rect></svg>';
        
        var title = document.createElement('h3');
        title.className = 'stock-chart-title';
        title.textContent = 'Monthly Sales';
        
        header.appendChild(iconWrapper);
        header.appendChild(title);
        
        // Create chart wrapper
        var chartWrapper = document.createElement('div');
        chartWrapper.className = 'stock-bar-chart-wrapper';
        
        // Find max value for scaling
        var maxQty = Math.max.apply(null, monthlyData.map(function(d) { return d.qty || 0; }));
        if (maxQty === 0) maxQty = 1; // Avoid division by zero
        
        monthlyData.forEach(function(monthData) {
          var barGroup = document.createElement('div');
          barGroup.className = 'stock-bar-group';
          
          // Bar container first
          var barContainer = document.createElement('div');
          barContainer.className = 'stock-bar-container';
          
          var bar = document.createElement('div');
          bar.className = 'stock-bar';
          var heightPercent = maxQty > 0 ? (monthData.qty / maxQty) * 100 : 0;
          bar.style.height = heightPercent + '%';
          bar.style.minHeight = monthData.qty > 0 ? '3px' : '0';
          
          // Tooltip
          var tooltip = document.createElement('div');
          tooltip.className = 'stock-bar-tooltip';
          tooltip.textContent = monthData.qty;
          
          barContainer.appendChild(bar);
          barContainer.appendChild(tooltip);
          barGroup.appendChild(barContainer);
          
          // Label below the bar - show MM/YY format (e.g., "11/25")
          var label = document.createElement('div');
          label.className = 'stock-bar-label';
          label.textContent = monthData.month; // Already formatted as MM/YY
          
          barGroup.appendChild(label);
          
          // Add touch event handlers for mobile tooltips
          (function(group) {
            var touchTimeout = null;
            group.addEventListener('touchstart', function(e) {
              e.preventDefault();
              group.classList.add('touched');
              // Hide tooltip after 2 seconds
              clearTimeout(touchTimeout);
              touchTimeout = setTimeout(function() {
                group.classList.remove('touched');
              }, 2000);
            });
            
            group.addEventListener('touchend', function(e) {
              e.preventDefault();
              // Keep tooltip visible briefly
              clearTimeout(touchTimeout);
              touchTimeout = setTimeout(function() {
                group.classList.remove('touched');
              }, 2000);
            });
          })(barGroup);
          
          chartWrapper.appendChild(barGroup);
        });
        
        card.appendChild(header);
        card.appendChild(chartWrapper);
        return card;
      }
      
      function loadStockQueries() {
        initStockQueries();
      }
      
      // Stock Insights / Over Stocked Functions
      var overStockedResults = [];
      
      // Department category mapping function
      function getDepartmentCategory(departmentCode) {
        if (!departmentCode) return 'other';
        var code = departmentCode.toUpperCase();
        
        // PDST = Dispensary (prescription drugs)
        if (code.startsWith('PDST')) return 'dispensary';
        
        // PDOB = Self-Medication
        if (code.startsWith('PDOB')) return 'self-medication';
        
        // GIT codes
        if (code.startsWith('GIT') || code.includes('GIT')) return 'git';
        
        // Vitamins
        if (code.includes('VIT') || code.includes('VITAMIN')) return 'vitamins';
        
        // First Aid
        if (code.includes('FIRST') || code.includes('AID') || code.includes('FA')) return 'first-aid';
        
        // Sports
        if (code.includes('SPORT')) return 'sports';
        
        // Health Foods
        if (code.includes('HEALTH') || code.includes('FOOD')) return 'health-foods';
        
        // Beauty
        if (code.includes('BEAUTY') || code.includes('COSMETIC')) return 'beauty';
        
        // Bath & Body
        if (code.includes('BATH') || code.includes('BODY')) return 'bath-body';
        
        // Baby
        if (code.includes('BABY') || code.includes('INFANT')) return 'baby';
        
        // Gifts
        if (code.includes('GIFT')) return 'gifts';
        
        return 'other';
      }
      
      function initStockInsights() {
        // Initialize custom dropdowns
        initCustomDropdowns();
        
        // Initialize load button
        var loadBtn = document.getElementById('overstocked-load-btn');
        if (loadBtn) {
          loadBtn.addEventListener('click', function() {
            loadOverStocked();
          });
        }
        
        // Initialize negative stock load button
        var negativeStockLoadBtn = document.getElementById('negativestock-load-btn');
        if (negativeStockLoadBtn) {
          negativeStockLoadBtn.addEventListener('click', function() {
            loadNegativeStock();
          });
        }
      }
      
      function initCustomDropdowns() {
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
          var dropdowns = document.querySelectorAll('.custom-dropdown');
          dropdowns.forEach(function(dropdown) {
            if (!dropdown.contains(e.target)) {
              dropdown.classList.remove('open');
            }
          });
        });
        
        // Initialize each dropdown
        var dropdowns = document.querySelectorAll('.custom-dropdown');
        dropdowns.forEach(function(dropdown) {
          var button = dropdown.querySelector('.custom-dropdown-button');
          var menu = dropdown.querySelector('.custom-dropdown-menu');
          var items = menu.querySelectorAll('.custom-dropdown-item');
          
          // Toggle dropdown on button click
          button.addEventListener('click', function(e) {
            e.stopPropagation();
            var isOpen = dropdown.classList.contains('open');
            
            // Close all other dropdowns
            document.querySelectorAll('.custom-dropdown').forEach(function(d) {
              if (d !== dropdown) {
                d.classList.remove('open');
              }
            });
            
            // Toggle this dropdown
            dropdown.classList.toggle('open', !isOpen);
          });
          
          // Handle item selection
          items.forEach(function(item) {
            item.addEventListener('click', function(e) {
              e.stopPropagation();
              
              // Remove active class from all items
              items.forEach(function(i) {
                i.classList.remove('active');
              });
              
              // Add active class to selected item
              item.classList.add('active');
              
              // Update button text
              var text = item.textContent.trim();
              var textEl = button.querySelector('.custom-dropdown-text');
              if (textEl) {
                textEl.textContent = text;
              }
              
              // Close dropdown
              dropdown.classList.remove('open');
            });
          });
        });
      }
      
      function getCustomDropdownValue(dropdownType) {
        var dropdown = document.querySelector('.custom-dropdown[data-dropdown="' + dropdownType + '"]');
        if (!dropdown) return null;
        
        var activeItem = dropdown.querySelector('.custom-dropdown-item.active');
        if (!activeItem) return null;
        
        return activeItem.getAttribute('data-value');
      }
      
      async function loadOverStocked() {
        var pid = selectedPharmacyId;
        if (!pid) {
          showOverStockedError('Please select a pharmacy');
          return;
        }
        
        var loadingEl = document.getElementById('overstocked-loading');
        var errorEl = document.getElementById('overstocked-error');
        var resultsEl = document.getElementById('overstocked-results');
        
        var daysThreshold = parseInt(getCustomDropdownValue('days')) || 30;
        var categoryValue = getCustomDropdownValue('category') || 'all';
        var minValue = parseInt(getCustomDropdownValue('value')) || 100;
        
        // Show loading
        if (loadingEl) loadingEl.style.display = 'flex';
        if (errorEl) errorEl.style.display = 'none';
        if (resultsEl) resultsEl.style.display = 'none';
        
        try {
          // Step 1: Fetch stock activity data
          var dateStr = selectedDate || getYesterdayDate();
          var stockActivityUrl = `/api/best-sellers?pid=${pid}&date=${dateStr}&limit=100`;
          var stockResp = await fetch(stockActivityUrl);
          
          if (!stockResp.ok) {
            throw new Error('Failed to fetch stock activity: ' + stockResp.status);
          }
          
          var stockData = await stockResp.json();
          var items = [];
          if (Array.isArray(stockData)) {
            items = stockData;
          } else if (stockData.best_sellers && Array.isArray(stockData.best_sellers)) {
            items = stockData.best_sellers;
          } else if (stockData.items && Array.isArray(stockData.items)) {
            items = stockData.items;
          }
          
          // Step 2: Build usage map from 180d averages
          var usageMap = {};
          
          // Primary: Fetch bulk usage data
          var usageRes = await fetch(`/api/pharmacies/${pid}/usage/top-180d?limit=200`);
          if (usageRes.ok) {
            var usageJson = await usageRes.json();
            var usageArr = Array.isArray(usageJson) ? usageJson : (usageJson.items || []);
            
            usageArr.forEach(function(u) {
              if (u && u.product_code && typeof u.avg_qty_180d === 'number') {
                usageMap[u.product_code] = u.avg_qty_180d;
              }
            });
          }
          
          // Step 3: Fetch missing product usage individually
          var missingCodes = Array.from(new Set(
            items
              .map(function(p) { return p.product_code || p.stock_code || p.code; })
              .filter(function(c) { return c && usageMap[c] === undefined; })
          ));
          
          if (missingCodes.length > 0) {
            var perProductResults = await Promise.allSettled(
              missingCodes.map(function(code) {
                return fetch(`/api/pharmacies/${pid}/usage/product/${encodeURIComponent(code)}`)
                  .then(function(r) { return r.ok ? r.json() : null; });
              })
            );
            
            perProductResults.forEach(function(res, idx) {
              if (res.status === 'fulfilled' && res.value && typeof res.value.avg_qty_180d === 'number') {
                usageMap[missingCodes[idx]] = res.value.avg_qty_180d;
              }
            });
          }
          
          // Step 4: Fetch monthly sales data for current month
          var dateObj = new Date(dateStr + 'T00:00:00');
          var currentYear = dateObj.getFullYear();
          var currentMonth = dateObj.getMonth();
          var monthStart = new Date(currentYear, currentMonth, 1);
          var monthEnd = dateObj;
          var monthStartStr = formatYmdLocal(monthStart);
          var monthEndStr = formatYmdLocal(monthEnd);
          
          // Fetch monthly sales for all products in parallel
          var monthlySalesPromises = items.map(function(product) {
            var code = product.product_code || product.stock_code || product.code || '';
            if (!code) return Promise.resolve({ code: code, monthlyQty: 0 });
            
            return fetch(`/api/products/${encodeURIComponent(code)}/sales?from_date=${monthStartStr}&to_date=${monthEndStr}&pharmacy_id=${pid}`)
              .then(function(r) {
                if (!r.ok) return { code: code, monthlyQty: 0 };
                return r.json().then(function(data) {
                  var monthlyQty = 0;
                  if (data.summary && data.summary.total_qty_sold !== undefined) {
                    monthlyQty = Number(data.summary.total_qty_sold) || 0;
                  } else if (data.total_qty_sold !== undefined) {
                    monthlyQty = Number(data.total_qty_sold) || 0;
                  } else {
                    var dailyArr = [];
                    if (Array.isArray(data.daily)) {
                      dailyArr = data.daily;
                    } else if (Array.isArray(data.items)) {
                      dailyArr = data.items;
                    } else if (Array.isArray(data)) {
                      dailyArr = data;
                    }
                    monthlyQty = dailyArr.reduce(function(sum, d) {
                      return sum + (Number(d.qty_sold || d.quantity || 0) || 0);
                    }, 0);
                  }
                  return { code: code, monthlyQty: monthlyQty };
                });
              })
              .catch(function(e) {
                console.log('Failed to fetch monthly sales for ' + code + ':', e);
                return { code: code, monthlyQty: 0 };
              });
          });
          
          var monthlySalesResults = await Promise.all(monthlySalesPromises);
          var monthlySalesMap = {};
          monthlySalesResults.forEach(function(result) {
            monthlySalesMap[result.code] = result.monthlyQty;
          });
          
          // Step 5: Calculate days of stock and process data
          var processedData = items.map(function(product) {
            var code = product.product_code || product.stock_code || product.code || '';
            
            // Extract stock on hand
            var onHandRaw = product.on_hand !== undefined ? product.on_hand : (product.currentSOH !== undefined ? product.currentSOH : 0);
            var onHand = Number(onHandRaw);
            
            // Get 180-day average daily usage
            var avg180 = usageMap[code] || 0;
            var avgDailyUsage = typeof avg180 === 'number' && isFinite(avg180) ? avg180 : 0;
            var avgMonthlyUsage = avgDailyUsage * 30;
            
            // Get monthly qty sold
            var monthlyQtySold = monthlySalesMap[code] || 0;
            
            // Calculate unit cost from daily sales data
            var qtySold = Number(product.qty_sold || product.sales_qty || 0);
            var costOfSales = Number(product.cost_of_sales || 0);
            var unitCost = qtySold > 0 ? costOfSales / qtySold : 0;
            
            // Calculate days of stock
            var days = (avgDailyUsage > 0.1) 
              ? (onHand / avgDailyUsage) 
              : 0;
            
            // Round SOH to 1 decimal place
            var roundedSOH = isFinite(onHand) ? Math.round(onHand * 10) / 10 : 0;
            
            return {
              ...product,
              currentSOH: roundedSOH,
              daysOfStock: Math.min(Math.round(days), 45),
              costPerUnit: unitCost,
              departmentCode: product.department_code || product.departmentCode || '',
              description: product.description || product.productName || product.name || 'Unknown Product',
              stock_code: code,
              avgDailyUsage: avgDailyUsage,
              avgMonthlyUsage: avgMonthlyUsage,
              monthlyQtySold: monthlyQtySold
            };
          });
          
          // Step 6: Filter by days threshold
          processedData = processedData.filter(function(product) {
            return (product.daysOfStock || 0) >= daysThreshold;
          });
          
          // Step 7: Apply category and value filters
          processedData = processedData.filter(function(product) {
            // Category filter
            if (categoryValue !== 'all') {
              var category = getDepartmentCategory(product.departmentCode || '');
              if (category !== categoryValue) return false;
            }
            
            // Value filter
            var stockValue = (product.costPerUnit || 0) * (product.currentSOH || 0);
            var meetsThreshold = stockValue >= minValue;
            
            // Special case: PDST products always included
            var isPDST = (product.departmentCode || '').toUpperCase().startsWith('PDST');
            if (isPDST) return true;
            
            return meetsThreshold;
          });
          
          // Step 8: Sort by days of stock (descending)
          processedData = processedData.sort(function(a, b) {
            return (b.daysOfStock || 0) - (a.daysOfStock || 0);
          });
          
          // Step 9: Limit to 200 items
          if (processedData.length > 200) {
            processedData = processedData.slice(0, 200);
          }
          
          overStockedResults = processedData;
          renderOverStockedResults();
          
        } catch (e) {
          console.error('Over Stocked error:', e);
          showOverStockedError('Failed to load over stocked products: ' + e.message);
          overStockedResults = [];
          renderOverStockedResults();
        } finally {
          if (loadingEl) loadingEl.style.display = 'none';
        }
      }
      
      function showOverStockedError(message) {
        var errorEl = document.getElementById('overstocked-error');
        if (errorEl) {
          errorEl.textContent = message;
          errorEl.style.display = 'block';
        }
      }
      
      function renderOverStockedResults() {
        var resultsEl = document.getElementById('overstocked-results');
        var resultsListEl = document.getElementById('overstocked-results-list');
        var resultsCountEl = document.getElementById('overstocked-results-count');
        
        if (!resultsEl || !resultsListEl) return;
        
        if (overStockedResults.length === 0) {
          resultsEl.style.display = 'none';
          return;
        }
        
        resultsEl.style.display = 'block';
        
        if (resultsCountEl) {
          var count = overStockedResults.length;
          resultsCountEl.textContent = 'Found ' + count + ' over stocked product' + (count === 1 ? '' : 's');
        }
        
        // Clear previous results
        resultsListEl.innerHTML = '';
        
        // Render each result
        overStockedResults.forEach(function(product) {
          var productCode = product.stock_code || product.product_code || product.code || 'N/A';
          var productName = product.description || product.productName || product.name || 'Unknown Product';
          
          var resultItem = document.createElement('div');
          resultItem.className = 'stock-result-item';
          
          var itemContent = document.createElement('div');
          itemContent.className = 'stock-result-item-content';
          
          var itemInfo = document.createElement('div');
          itemInfo.className = 'stock-result-item-info';
          
          var itemName = document.createElement('div');
          itemName.className = 'stock-result-item-name';
          itemName.textContent = productName;
          
          var itemCode = document.createElement('div');
          itemCode.className = 'stock-result-item-code';
          itemCode.textContent = productCode;
          
          itemInfo.appendChild(itemName);
          itemInfo.appendChild(itemCode);
          
          itemContent.appendChild(itemInfo);
          resultItem.appendChild(itemContent);
          
          // Add Over Stocked metrics in colored cards (matching Stock Lookup style)
          var metricsContainer = document.createElement('div');
          metricsContainer.className = 'stock-product-details-container';
          
          var metricsGrid = document.createElement('div');
          metricsGrid.className = 'stock-details-summary-grid';
          metricsGrid.style.marginTop = '12px';
          
          // Days card (orange)
          var daysCard = document.createElement('div');
          daysCard.className = 'stock-summary-card daily-avg-card';
          var daysValue = product.daysOfStock >= 45 ? '45+' : product.daysOfStock.toString();
          daysCard.innerHTML = '<div class="stock-summary-label">Days</div><div class="stock-summary-value">' + daysValue + '</div>';
          
          // SOH card (orange - same as SOH)
          var sohCard = document.createElement('div');
          sohCard.className = 'stock-summary-card soh-card';
          sohCard.innerHTML = '<div class="stock-summary-label">SOH</div><div class="stock-summary-value">' + 
            (product.currentSOH ? product.currentSOH.toFixed(1) : '0.0') + '</div>';
          
          // VALUE card (green - similar to GP)
          var stockValue = (product.costPerUnit || 0) * (product.currentSOH || 0);
          var valueCard = document.createElement('div');
          valueCard.className = 'stock-summary-card gp-card';
          valueCard.innerHTML = '<div class="stock-summary-label">Value</div><div class="stock-summary-value">R ' + 
            (stockValue ? stockValue.toLocaleString('en-ZA', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00') + '</div>';
          
          // Daily Avg card (orange - same as daily-avg-card)
          var dailyAvgCard = document.createElement('div');
          dailyAvgCard.className = 'stock-summary-card daily-avg-card';
          dailyAvgCard.innerHTML = '<div class="stock-summary-label">Daily Avg</div><div class="stock-summary-value">' + 
            (product.avgDailyUsage ? product.avgDailyUsage.toFixed(1) : '0.0') + '</div>';
          
          // Monthly Avg card (purple - same as month-avg-card)
          var monthlyAvgCard = document.createElement('div');
          monthlyAvgCard.className = 'stock-summary-card month-avg-card';
          monthlyAvgCard.innerHTML = '<div class="stock-summary-label">Mnth Avg</div><div class="stock-summary-value">' + 
            (product.avgMonthlyUsage ? product.avgMonthlyUsage.toFixed(1) : '0.0') + '</div>';
          
          // Monthly Qty Sold card (orange - using sales-card)
          var monthlyQtyCard = document.createElement('div');
          monthlyQtyCard.className = 'stock-summary-card sales-card';
          monthlyQtyCard.innerHTML = '<div class="stock-summary-label">Mnth Qty</div><div class="stock-summary-value">' + 
            (product.monthlyQtySold ? product.monthlyQtySold.toFixed(1) : '0.0') + '</div>';
          
          metricsGrid.appendChild(daysCard);
          metricsGrid.appendChild(sohCard);
          metricsGrid.appendChild(valueCard);
          metricsGrid.appendChild(dailyAvgCard);
          metricsGrid.appendChild(monthlyAvgCard);
          metricsGrid.appendChild(monthlyQtyCard);
          
          metricsContainer.appendChild(metricsGrid);
          resultItem.appendChild(metricsContainer);
          
          resultsListEl.appendChild(resultItem);
        });
      }
      
      var negativeStockResults = [];
      
      async function loadNegativeStock() {
        var pid = selectedPharmacyId;
        if (!pid) {
          showNegativeStockError('Please select a pharmacy');
          return;
        }
        
        var loadingEl = document.getElementById('negativestock-loading');
        var errorEl = document.getElementById('negativestock-error');
        var resultsEl = document.getElementById('negativestock-results');
        var downloadBtn = document.getElementById('download-negative-stock-pdf');
        
        // Show loading and disable download button
        if (loadingEl) loadingEl.style.display = 'flex';
        if (errorEl) errorEl.style.display = 'none';
        if (resultsEl) resultsEl.style.display = 'none';
        if (downloadBtn) {
          downloadBtn.disabled = true;
          downloadBtn.style.opacity = '0.5';
          downloadBtn.style.cursor = 'not-allowed';
        }
        
        try {
          // Fetch negative stock data from dedicated endpoint
          var dateStr = selectedDate || getYesterdayDate();
          var negativeStockUrl = `/api/negative-stock?pid=${pid}&date=${dateStr}&limit=200`;
          var stockResp = await fetch(negativeStockUrl);
          
          if (!stockResp.ok) {
            throw new Error('Failed to fetch negative stock: ' + stockResp.status);
          }
          
          var stockData = await stockResp.json();
          var items = [];
          if (Array.isArray(stockData)) {
            items = stockData;
          } else if (stockData.items && Array.isArray(stockData.items)) {
            items = stockData.items;
          }
          
          // Normalize data - extract SOH from various field names
          var normalizedItems = items.map(function(product) {
            var onHandRaw = product.current_soh !== undefined ? product.current_soh :
                           (product.currentSOH !== undefined ? product.currentSOH :
                           (product.on_hand !== undefined ? product.on_hand :
                           (product.soh !== undefined ? product.soh :
                           (product.stock_on_hand !== undefined ? product.stock_on_hand : 0))));
            
            // Create normalized product object
            var normalized = {};
            // Copy all existing properties
            for (var key in product) {
              if (product.hasOwnProperty(key)) {
                normalized[key] = product[key];
              }
            }
            // Override with normalized fields
            normalized.description = product.description || product.productName || product.name || 'Unknown Product';
            normalized.product_code = product.product_code || product.stock_code || product.code || 'N/A';
            normalized.current_soh = Number(onHandRaw);
            
            return normalized;
          });
          
          // API already filters and sorts by most negative first, so we can use directly
          // Display all negative stock items
          negativeStockResults = normalizedItems;
          renderNegativeStockResults();
          
        } catch (e) {
          console.error('Negative Stock error:', e);
          showNegativeStockError('Failed to load negative stock products: ' + e.message);
          negativeStockResults = [];
          renderNegativeStockResults();
        } finally {
          if (loadingEl) loadingEl.style.display = 'none';
        }
      }
      
      function showNegativeStockError(message) {
        var errorEl = document.getElementById('negativestock-error');
        if (errorEl) {
          errorEl.textContent = message;
          errorEl.style.display = 'block';
        }
      }
      
      function renderNegativeStockResults() {
        var resultsEl = document.getElementById('negativestock-results');
        var resultsListEl = document.getElementById('negativestock-results-list');
        var resultsCountEl = document.getElementById('negativestock-results-count');
        var downloadBtn = document.getElementById('download-negative-stock-pdf');
        
        if (!resultsEl || !resultsListEl) return;
        
        // Enable/disable download button based on results
        if (downloadBtn) {
          if (negativeStockResults.length === 0) {
            downloadBtn.disabled = true;
            downloadBtn.style.opacity = '0.5';
            downloadBtn.style.cursor = 'not-allowed';
          } else {
            downloadBtn.disabled = false;
            downloadBtn.style.opacity = '1';
            downloadBtn.style.cursor = 'pointer';
          }
        }
        
        if (negativeStockResults.length === 0) {
          resultsEl.style.display = 'none';
          return;
        }
        
        resultsEl.style.display = 'block';
        
        if (resultsCountEl) {
          var count = negativeStockResults.length;
          resultsCountEl.textContent = 'Found ' + count + ' product' + (count === 1 ? '' : 's') + ' with negative stock';
        }
        
        // Clear previous results
        resultsListEl.innerHTML = '';
        
        // Render each result
        negativeStockResults.forEach(function(product) {
          var productCode = product.product_code || product.stock_code || product.code || 'N/A';
          var productName = product.description || product.productName || product.name || 'Unknown Product';
          var onHand = product.current_soh !== undefined ? product.current_soh : 0;
          
          var resultItem = document.createElement('div');
          resultItem.className = 'stock-result-item';
          
          var itemContent = document.createElement('div');
          itemContent.className = 'stock-result-item-content';
          itemContent.style.display = 'flex';
          itemContent.style.alignItems = 'center';
          itemContent.style.justifyContent = 'space-between';
          itemContent.style.gap = '16px';
          
          var itemInfo = document.createElement('div');
          itemInfo.className = 'stock-result-item-info';
          itemInfo.style.flex = '1';
          
          var itemName = document.createElement('div');
          itemName.className = 'stock-result-item-name';
          itemName.textContent = productName;
          
          var itemCode = document.createElement('div');
          itemCode.className = 'stock-result-item-code';
          itemCode.textContent = productCode;
          
          itemInfo.appendChild(itemName);
          itemInfo.appendChild(itemCode);
          
          itemContent.appendChild(itemInfo);
          
          // Compact SOH card (red/warning color for negative) - inline on the right
          var sohCard = document.createElement('div');
          sohCard.style.backgroundColor = '#fee2e2';
          sohCard.style.border = 'none';
          sohCard.style.borderRadius = '8px';
          sohCard.style.padding = '8px 16px';
          sohCard.style.display = 'flex';
          sohCard.style.flexDirection = 'column';
          sohCard.style.alignItems = 'center';
          sohCard.style.justifyContent = 'center';
          sohCard.style.minWidth = '80px';
          sohCard.style.flexShrink = '0';
          sohCard.innerHTML = '<div style="font-size: 11px; font-weight: 600; color: #991b1b; margin-bottom: 2px;">SOH</div><div style="font-size: 16px; font-weight: 700; color: #dc2626;">' + 
            (onHand ? onHand.toFixed(1) : '0.0') + '</div>';
          
          itemContent.appendChild(sohCard);
          resultItem.appendChild(itemContent);
          
          resultsListEl.appendChild(resultItem);
        });
      }
      
      function downloadNegativeStockPDF() {
        var downloadBtn = document.getElementById('download-negative-stock-pdf');
        if (downloadBtn && downloadBtn.disabled) {
          return;
        }
        
        if (negativeStockResults.length === 0) {
          showStyledAlert('No data to download', 'warning', 'No Data');
          return;
        }
        
        // Create PDF using jsPDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const dateToUse = selectedDate || new Date().toISOString().split('T')[0];
        
        // Add title
        const pharmacyName = selectedPharmacyName || 'Unknown Pharmacy';
        doc.setFontSize(16);
        doc.text(`${pharmacyName} - Negative Stock Report`, 14, 15);
        
        doc.setFontSize(10);
        doc.text(`Date: ${dateToUse}`, 14, 22);
        doc.text(`Total Products: ${negativeStockResults.length}`, 14, 28);
        
        // Add table headers
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        let yPos = 40;
        doc.text('Product Name', 14, yPos);
        doc.text('Product Code', 110, yPos);
        doc.text('SOH', 175, yPos);
        
        // Add line under headers
        doc.line(14, yPos + 2, 195, yPos + 2);
        
        // Add data rows
        doc.setFont(undefined, 'normal');
        yPos += 8;
        
        negativeStockResults.forEach(function(product, index) {
          const productCode = product.product_code || product.stock_code || product.code || 'N/A';
          const productName = product.description || product.productName || product.name || 'Unknown Product';
          const onHand = product.current_soh !== undefined ? product.current_soh : 0;
          
          // Check if we need a new page
          if (yPos > 280) {
            doc.addPage();
            yPos = 15;
            // Re-add headers on new page
            doc.setFont(undefined, 'bold');
            doc.text('Product Name', 14, yPos);
            doc.text('Product Code', 110, yPos);
            doc.text('SOH', 175, yPos);
            doc.line(14, yPos + 2, 195, yPos + 2);
            doc.setFont(undefined, 'normal');
            yPos += 8;
          }
          
          doc.text(productName.substring(0, 50), 14, yPos); // Truncate long names
          doc.text(productCode, 110, yPos);
          doc.text(onHand.toFixed(1), 175, yPos);
          
          yPos += 6;
        });
        
        // Save the PDF
        doc.save(`negative-stock-${dateToUse}.pdf`);
      }
      
      function toggleSection(toggleId, contentId) {
        var toggle = document.getElementById(toggleId);
        var content = document.getElementById(contentId);
        var button = toggle ? toggle.querySelector('.chart-toggle-btn') : null;
        var svg = button ? button.querySelector('svg') : null;
        
        if (!content) return;
        
        var isCollapsed = content.style.display === 'none';
        
        if (isCollapsed) {
          content.style.display = 'block';
          if (button) button.classList.remove('collapsed');
          if (svg) svg.style.transform = 'rotate(0deg)'; // Point down when expanded
        } else {
          content.style.display = 'none';
          if (button) button.classList.add('collapsed');
          if (svg) svg.style.transform = 'rotate(-90deg)'; // Point right when collapsed
        }
      }
      
      function initSectionToggles() {
        // Stock Lookup - open by default
        var stockLookupToggle = document.getElementById('stock-lookup-toggle');
        var stockLookupContent = document.getElementById('stock-lookup-content');
        if (stockLookupToggle && stockLookupContent) {
          stockLookupContent.style.display = 'block'; // Open by default
          stockLookupToggle.addEventListener('click', function() {
            toggleSection('stock-lookup-toggle', 'stock-lookup-content');
          });
        }
        
        // Over Stocked - collapsed by default
        var overstockedToggle = document.getElementById('overstocked-toggle');
        var overstockedContent = document.getElementById('overstocked-content');
        if (overstockedToggle && overstockedContent) {
          overstockedContent.style.display = 'none'; // Collapsed by default
          overstockedToggle.addEventListener('click', function() {
            toggleSection('overstocked-toggle', 'overstocked-content');
          });
        }
        
        // Negative Stock - collapsed by default
        var negativestockToggle = document.getElementById('negativestock-toggle');
        var negativestockContent = document.getElementById('negativestock-content');
        if (negativestockToggle && negativestockContent) {
          negativestockContent.style.display = 'none'; // Collapsed by default
          negativestockToggle.addEventListener('click', function() {
            toggleSection('negativestock-toggle', 'negativestock-content');
          });
        }
      }
      
      function loadStockInsights() {
        initStockInsights();
        initSectionToggles();
        
        // Initialize negative stock PDF download button
        var downloadBtn = document.getElementById('download-negative-stock-pdf');
        if (downloadBtn) {
          downloadBtn.addEventListener('click', function() {
            downloadNegativeStockPDF();
          });
        }
      }
      
      async function loadBudgetData(date) {
        console.log('loadBudgetData called with date:', date);
        var pid = selectedPharmacyId;
        if (!pid) {
          console.log('Missing selectedPharmacyId in loadBudgetData');
          return;
        }
        
        try {
          // Calculate month key for MTD data
          var dateObj = new Date(date + 'T00:00:00');
          var selYear = dateObj.getFullYear();
          var selMonthIdx = dateObj.getMonth();
          var mtdDay = dateObj.getDate();
          var monthKey = selYear + '-' + String(selMonthIdx + 1).padStart(2, '0');
          var throughDate = date;
          
          console.log('Budget calculation - monthKey:', monthKey, 'throughDate:', throughDate, 'mtdDay:', mtdDay);
          
          // 1. Get MTD purchases from /api/mtd
          var purchases = 0;
          try {
            const mtdUrl = `/api/mtd?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(monthKey)}&through=${encodeURIComponent(throughDate)}`;
            console.log('Fetching MTD purchases:', mtdUrl);
            const mtdResp = await fetch(mtdUrl);
            console.log('MTD response status:', mtdResp.status);
            if (mtdResp.ok) {
              const mtdData = await mtdResp.json();
              purchases = Number(mtdData.purchases || 0);
              console.log('MTD purchases:', purchases);
            }
          } catch (e) {
            console.error('Failed to fetch MTD data for budget:', e);
          }
          
          // 2. Get budget from /api/targets
          // Calculate both FULL MONTH and MTD budgets
          var budget = 0; // Full month budget
          var mtdBudget = 0; // MTD budget (up to current day)
          try {
            const targetsUrl = `/api/targets?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(monthKey)}`;
            console.log('Fetching targets budget:', targetsUrl);
            const targetsResp = await fetch(targetsUrl);
            console.log('Targets response status:', targetsResp.status);
            if (targetsResp.ok) {
              const targetsData = await targetsResp.json();
              
              // Try to get purchase_budget directly
              budget = Number(targetsData.purchase_budget || 0);
              console.log('Targets purchase_budget from API:', budget);
              
              // Calculate from turnover targets (75% of turnover)
              if (targetsData.targets && Array.isArray(targetsData.targets)) {
                var cutoffDateStr = monthKey + '-' + String(mtdDay).padStart(2, '0');
                
                // Full month budget
                var turnoverTargetFullMonth = targetsData.targets.reduce(function(sum, t) {
                  return sum + Number(t.value || 0);
                }, 0);
                
                // MTD budget (only up to current day)
                var turnoverTargetMTD = targetsData.targets.reduce(function(sum, t) {
                  var tDate = t.date;
                  if (!tDate) return sum;
                  if (tDate <= cutoffDateStr) {
                    return sum + Number(t.value || 0);
                  }
                  return sum;
                }, 0);
                
                if (budget === 0 && turnoverTargetFullMonth > 0) {
                  budget = turnoverTargetFullMonth * 0.75;
                  console.log('Calculated FULL MONTH budget from turnover targets:', turnoverTargetFullMonth, '→ purchase budget:', budget);
                }
                
                if (turnoverTargetMTD > 0) {
                  mtdBudget = turnoverTargetMTD * 0.75;
                  console.log('Calculated MTD budget from turnover targets:', turnoverTargetMTD, '→ MTD purchase budget:', mtdBudget);
                } else {
                  console.log('No MTD turnover targets found for calculation');
                }
              } else {
                console.log('No turnover targets found for calculation');
              }
            }
          } catch (e) {
            console.error('Failed to fetch targets data for budget:', e);
          }
          
          // 3. If no budget assigned, calculate 6% growth from previous year
          if (budget === 0) {
            console.log('No budget assigned, calculating 6% growth from previous year');
            try {
              // Calculate previous year month and through date
              var prevYear = selYear - 1;
              var prevYearMonthKey = prevYear + '-' + String(selMonthIdx + 1).padStart(2, '0');
              
              // Calculate previous year's MTD day (handle month length differences)
              var prevYearDate = new Date(prevYear, selMonthIdx, 1);
              var prevYearMonthDays = new Date(prevYearDate.getFullYear(), prevYearDate.getMonth() + 1, 0).getDate();
              var prevYearMTDDay = Math.min(mtdDay, prevYearMonthDays);
              var prevYearThroughDate = prevYear + '-' + String(selMonthIdx + 1).padStart(2, '0') + '-' + String(prevYearMTDDay).padStart(2, '0');
              
              console.log('Fetching previous year MTD - monthKey:', prevYearMonthKey, 'throughDate:', prevYearThroughDate);
              
              // Fetch previous year MTD purchases
              const prevYearMtdUrl = `/api/mtd?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(prevYearMonthKey)}&through=${encodeURIComponent(prevYearThroughDate)}`;
              const prevYearMtdResp = await fetch(prevYearMtdUrl);
              console.log('Previous year MTD response status:', prevYearMtdResp.status);
              if (prevYearMtdResp.ok) {
                const prevYearMtdData = await prevYearMtdResp.json();
                var prevYearPurchases = Number(prevYearMtdData.purchases || 0);
                console.log('Previous year purchases:', prevYearPurchases);
                
                // Calculate 6% growth: previous year purchases * 1.06
                if (prevYearPurchases > 0) {
                  budget = prevYearPurchases * 1.06;
                  console.log('Calculated budget (6% growth):', budget);
                } else {
                  console.log('Previous year purchases is 0, cannot calculate budget');
                }
              } else {
                console.log('Failed to fetch previous year MTD data, status:', prevYearMtdResp.status);
              }
            } catch (e) {
              console.error('Failed to fetch previous year data for budget calculation:', e);
            }
          }
          
          console.log('Final full month budget:', budget, 'MTD budget:', mtdBudget, 'purchases:', purchases);
          
          // 4. Calculate budget used percentages for both cards (what percentage of budget has been used)
          
          // Full Month Card
          var budgetRemaining = budget - purchases;
          var percentageUsed = budget > 0 ? (purchases / budget) * 100 : 0;
          percentageUsed = Math.max(0, Math.min(100, percentageUsed));
          
          // MTD Card
          var mtdBudgetRemaining = mtdBudget - purchases;
          var mtdPercentageUsed = mtdBudget > 0 ? (purchases / mtdBudget) * 100 : 0;
          mtdPercentageUsed = Math.max(0, Math.min(100, mtdPercentageUsed));
          
          console.log('Full month - used:', percentageUsed + '%', 'remaining:', budgetRemaining);
          console.log('MTD - used:', mtdPercentageUsed + '%', 'remaining:', mtdBudgetRemaining);
          
          // 5. Update Full Month Budget Card UI
          var purchasesEl = document.getElementById('stock-purchases-value');
          var budgetEl = document.getElementById('stock-budget-value');
          var percentageEl = document.getElementById('stock-budget-percentage');
          
          if (purchasesEl) {
            purchasesEl.textContent = purchases > 0 ? fmtMoneyAmount(purchases) : '—';
          } else {
            console.error('stock-purchases-value element not found');
          }
          
          if (budgetEl) {
            budgetEl.textContent = budget > 0 ? fmtMoneyAmount(budget) : '—';
          } else {
            console.error('stock-budget-value element not found');
          }
          
          if (percentageEl) {
            percentageEl.textContent = percentageUsed.toFixed(0) + '%';
          } else {
            console.error('stock-budget-percentage element not found');
          }
          
          // 6. Update Full Month pie chart (showing percentage used)
          var chartSegment = document.getElementById('stock-budget-chart-segment');
          if (chartSegment) {
            var circumference = 314; // 2 * PI * radius (50)
            var offset = circumference - (percentageUsed / 100 * circumference);
            chartSegment.style.strokeDashoffset = offset;
            console.log('Updated full month chart segment offset (used):', offset);
          } else {
            console.error('stock-budget-chart-segment element not found');
          }
          
          // 7. Update MTD Budget Card UI
          var mtdPurchasesEl = document.getElementById('stock-mtd-purchases-value');
          var mtdBudgetEl = document.getElementById('stock-mtd-budget-value');
          var mtdPercentageEl = document.getElementById('stock-mtd-budget-percentage');
          
          if (mtdPurchasesEl) {
            mtdPurchasesEl.textContent = purchases > 0 ? fmtMoneyAmount(purchases) : '—';
          } else {
            console.error('stock-mtd-purchases-value element not found');
          }
          
          if (mtdBudgetEl) {
            mtdBudgetEl.textContent = mtdBudget > 0 ? fmtMoneyAmount(mtdBudget) : '—';
          } else {
            console.error('stock-mtd-budget-value element not found');
          }
          
          if (mtdPercentageEl) {
            mtdPercentageEl.textContent = mtdPercentageUsed.toFixed(0) + '%';
          } else {
            console.error('stock-mtd-budget-percentage element not found');
          }
          
          // 8. Update MTD pie chart (showing percentage used)
          var mtdChartSegment = document.getElementById('stock-mtd-budget-chart-segment');
          if (mtdChartSegment) {
            var mtdCircumference = 314; // 2 * PI * radius (50)
            var mtdOffset = mtdCircumference - (mtdPercentageUsed / 100 * mtdCircumference);
            mtdChartSegment.style.strokeDashoffset = mtdOffset;
            console.log('Updated MTD chart segment offset (used):', mtdOffset);
          } else {
            console.error('stock-mtd-budget-chart-segment element not found');
          }
          
        } catch (e) {
          console.error('Failed to load budget data:', e);
          // Full month card
          var purchasesEl = document.getElementById('stock-purchases-value');
          var budgetEl = document.getElementById('stock-budget-value');
          var percentageEl = document.getElementById('stock-budget-percentage');
          if (purchasesEl) purchasesEl.textContent = '—';
          if (budgetEl) budgetEl.textContent = '—';
          if (percentageEl) percentageEl.textContent = '—';
          
          // MTD card
          var mtdPurchasesEl = document.getElementById('stock-mtd-purchases-value');
          var mtdBudgetEl = document.getElementById('stock-mtd-budget-value');
          var mtdPercentageEl = document.getElementById('stock-mtd-budget-percentage');
          if (mtdPurchasesEl) mtdPurchasesEl.textContent = '—';
          if (mtdBudgetEl) mtdBudgetEl.textContent = '—';
          if (mtdPercentageEl) mtdPercentageEl.textContent = '—';
        }
      }
      
      async function loadStockOverview(date) {
        var pid = selectedPharmacyId;
        if (!pid) return;
        
        try {
          // 1. Fetch stock value using /days endpoint (closing_stock)
          const stockValueResp = await fetch(`/api/stock-value?pid=${encodeURIComponent(pid)}&date=${encodeURIComponent(date)}`);
          var currentStockValue = 0;
          var openingStockValue = 0;
          var stockChange = 0;
          var stockChangePercent = 0;
          
          if (stockValueResp.ok) {
            const stockData = await stockValueResp.json();
            currentStockValue = Number(stockData.current_stock_value || 0);
            openingStockValue = Number(stockData.opening_stock_value || 0);
            stockChange = Number(stockData.stock_change || 0);
            stockChangePercent = Number(stockData.stock_change_percent || 0);
          }
          
          // 2. Get daily sales data for the selected date (for fallback values)
          const dailySalesResp = await fetch(`/api/days?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(date.slice(0, 7))}`);
          var dailySalesRecord = null;
          if (dailySalesResp.ok) {
            const dailySalesData = await dailySalesResp.json();
            if (Array.isArray(dailySalesData)) {
              dailySalesRecord = dailySalesData.find(function(d) {
                return d.business_date === date || d.date === date;
              }) || dailySalesData[0] || null;
            }
          }
          
          // Extract initial values from daily data (fallbacks)
          var costOfSales = Number(dailySalesRecord?.cost_of_sales || 0);
          var purchases = Number(dailySalesRecord?.purchases || 0);
          var gpValue = Number(dailySalesRecord?.gp_value || 0);
          var gpPercent = Number(dailySalesRecord?.gp_pct || 0);
          
          // 3. Calculate MTD month key and through date
          var dateObj = new Date(date + 'T00:00:00');
          var monthKey = dateObj.getFullYear() + '-' + String(dateObj.getMonth() + 1).padStart(2, '0');
          var throughDate = date;
          
          // 4. Get MTD aggregates
          var mtdData = null;
          try {
            const mtdResp = await fetch(`/api/mtd?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(monthKey)}&through=${encodeURIComponent(throughDate)}`);
            if (mtdResp.ok) {
              mtdData = await mtdResp.json();
            }
          } catch (e) {
            console.error('Failed to fetch MTD data:', e);
          }
          
          // Override with MTD values (authoritative)
          var finalCostOfSales = (mtdData && mtdData.cost_of_sales !== undefined) 
            ? Number(mtdData.cost_of_sales || 0) 
            : costOfSales;
          
          var finalPurchases = (mtdData && mtdData.purchases !== undefined) 
            ? Number(mtdData.purchases || 0) 
            : purchases;
          
          var finalGpValue = (mtdData && mtdData.gp_value !== undefined) 
            ? Number(mtdData.gp_value || 0) 
            : gpValue;
          
          // 5. Calculate GP Percentage from MTD totals
          // Formula: GP% = (gp_value / (turnover - type_r_sales)) * 100
          var typeRSales = Number(mtdData?.type_r_sales || 0);
          var turnover = Number(mtdData?.turnover || 0);
          var finalGpPercent = 0;
          
          if (turnover > 0) {
            var denominator = turnover - typeRSales;
            finalGpPercent = denominator > 0 ? (finalGpValue / denominator) * 100 : 0;
          } else if (gpPercent > 0) {
            // Fallback to daily GP% if MTD not available
            finalGpPercent = gpPercent;
          }
          
          // 6. Calculate Days of Inventory
          // Fetch last 30 days of turnover data
          var dateForCalc = new Date(date + 'T00:00:00');
          var last30Start = new Date(dateForCalc);
          last30Start.setDate(last30Start.getDate() - 29); // 30 days including today
          var last30StartStr = formatYmdLocal(last30Start);
          var last30EndStr = date;
          
          var daysOfInventory = 0;
          try {
            // Get last 30 days data - may span two months
            var startMonth = last30StartStr.slice(0, 7);
            var endMonth = last30EndStr.slice(0, 7);
            var monthsToFetch = [startMonth];
            
            // If range spans two months, fetch both
            if (startMonth !== endMonth) {
              monthsToFetch.push(endMonth);
            }
            
            // Fetch all required months
            var all30DayData = [];
            for (var i = 0; i < monthsToFetch.length; i++) {
              var monthResp = await fetch(`/api/days?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(monthsToFetch[i])}`);
              if (monthResp.ok) {
                var monthData = await monthResp.json();
                if (Array.isArray(monthData)) {
                  all30DayData = all30DayData.concat(monthData);
                }
              }
            }
            
            // Filter to only include dates within the 30-day range
            var filtered30Days = all30DayData.filter(function(day) {
              var dayDate = day.business_date || day.date;
              return dayDate >= last30StartStr && dayDate <= last30EndStr;
            });
            
            // Calculate average daily turnover
            var totalTurnover = filtered30Days.reduce(function(acc, day) {
              return acc + (Number(day.turnover) || 0);
            }, 0);
            
            var avgDailyTurnover = filtered30Days.length > 0 ? totalTurnover / filtered30Days.length : 0;
            
            // Calculate days of inventory
            // Formula: Days of Inventory = Current Stock Value / Average Daily Turnover
            if (avgDailyTurnover > 0) {
              daysOfInventory = currentStockValue / avgDailyTurnover;
            }
          } catch (e) {
            console.error('Failed to calculate days of inventory:', e);
          }
          
              // Update UI - Stock Value card
              document.getElementById('stock-value').textContent = currentStockValue > 0 ? fmtMoneyAmount(currentStockValue) : '—';
              
              // Show stock change in the comparison text
              var stockChangeText = '—';
              if (stockChange !== 0) {
                var changeSymbol = stockChange > 0 ? '+' : '';
                stockChangeText = `${changeSymbol}R ${fmtMoneyAmount(Math.abs(stockChange))} (${stockChangePercent.toFixed(1)}%) from opening`;
              } else if (openingStockValue > 0) {
                stockChangeText = 'No change from opening';
              }
              document.getElementById('stock-value-comparison').textContent = stockChangeText;
              
              // Update UI - Days card
              document.getElementById('stock-days').textContent = daysOfInventory > 0 ? daysOfInventory.toFixed(1) : '—';
              document.getElementById('stock-days-comparison').textContent = daysOfInventory > 0 ? 'Days of inventory left' : '—';
              
              // Update UI - Cost of Sales card
              document.getElementById('stock-cos').textContent = finalCostOfSales > 0 ? fmtMoneyAmount(finalCostOfSales) : '—';
              var cosComparisonText = '—';
              if (finalPurchases > 0) {
                cosComparisonText = 'Purchases: R ' + fmtMoneyAmount(finalPurchases);
              }
              document.getElementById('stock-cos-comparison').textContent = cosComparisonText;
              
              // Update UI - MTD GP card
              document.getElementById('stock-mtd-gp').textContent = finalGpPercent > 0 ? finalGpPercent.toFixed(1) : '—';
              var gpComparisonText = '—';
              if (finalGpValue > 0) {
                gpComparisonText = 'GP: R ' + fmtMoneyAmount(finalGpValue);
              }
              document.getElementById('stock-mtd-gp-value').textContent = gpComparisonText;
              
              // Update Mobile Combined Card
              var mobileStockValue = document.getElementById('mobile-stock-value');
              var mobileStockValueComparison = document.getElementById('mobile-stock-value-comparison');
              var mobileStockDays = document.getElementById('mobile-stock-days');
              var mobileStockDaysComparison = document.getElementById('mobile-stock-days-comparison');
              var mobileStockCos = document.getElementById('mobile-stock-cos');
              var mobileStockCosComparison = document.getElementById('mobile-stock-cos-comparison');
              var mobileStockMtdGp = document.getElementById('mobile-stock-mtd-gp');
              var mobileStockMtdGpValue = document.getElementById('mobile-stock-mtd-gp-value');
              
              if (mobileStockValue) {
                mobileStockValue.textContent = currentStockValue > 0 ? fmtMoneyAmount(currentStockValue) : '—';
              }
              if (mobileStockValueComparison) {
                mobileStockValueComparison.textContent = stockChangeText;
              }
              if (mobileStockDays) {
                mobileStockDays.textContent = daysOfInventory > 0 ? daysOfInventory.toFixed(1) : '—';
              }
              if (mobileStockDaysComparison) {
                mobileStockDaysComparison.textContent = daysOfInventory > 0 ? 'Days of inventory left' : '—';
              }
              if (mobileStockCos) {
                mobileStockCos.textContent = finalCostOfSales > 0 ? fmtMoneyAmount(finalCostOfSales) : '—';
              }
              if (mobileStockCosComparison) {
                mobileStockCosComparison.textContent = cosComparisonText;
              }
              if (mobileStockMtdGp) {
                mobileStockMtdGp.textContent = finalGpPercent > 0 ? finalGpPercent.toFixed(1) : '—';
              }
              if (mobileStockMtdGpValue) {
                mobileStockMtdGpValue.textContent = gpComparisonText;
              }
          
        } catch (e) {
          console.error('Failed to load stock overview:', e);
          // Set error states for desktop cards
          ['stock-value', 'stock-days', 'stock-cos', 'stock-mtd-gp'].forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.textContent = '—';
          });
          ['stock-value-comparison', 'stock-days-comparison', 'stock-cos-comparison', 'stock-mtd-gp-value'].forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.textContent = '—';
          });
          // Set error states for mobile combined card
          ['mobile-stock-value', 'mobile-stock-days', 'mobile-stock-cos', 'mobile-stock-mtd-gp'].forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.textContent = '—';
          });
          ['mobile-stock-value-comparison', 'mobile-stock-days-comparison', 'mobile-stock-cos-comparison', 'mobile-stock-mtd-gp-value'].forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.textContent = '—';
          });
        }
      }
      
      async function loadTopMovers(fromDate, toDate) {
        var pid = selectedPharmacyId;
        if (!pid) return;
        
        var container = document.getElementById('stock-best-sellers-list');
        if (!container) return;
        
        try {
          const url = `/api/best-sellers?pid=${encodeURIComponent(pid)}&from_date=${encodeURIComponent(fromDate)}&to_date=${encodeURIComponent(toDate)}&limit=20`;
          const resp = await fetch(url);
          
          if (!resp.ok) {
            throw new Error('Failed to fetch top movers');
          }
          
          const data = await resp.json();
          
          // Handle different possible response structures
          let bestSellers = [];
          if (Array.isArray(data)) {
            bestSellers = data;
          } else if (data.best_sellers) {
            bestSellers = data.best_sellers;
          } else if (data.stock_activity) {
            bestSellers = data.stock_activity;
          } else if (data.items) {
            bestSellers = data.items;
          } else if (data.data && Array.isArray(data.data)) {
            bestSellers = data.data;
          }
          
          if (bestSellers.length === 0) {
            container.innerHTML = '<div class="best-seller-item"><div class="best-seller-details"><div class="best-seller-name">No stock activity data for this period</div><div class="best-seller-code">Try selecting a different date</div></div></div>';
            return;
          }
          
          // Render best sellers (top 5)
          container.innerHTML = bestSellers.slice(0, 5).map(function(item) {
            const productName = item.product_description || item.description || item.product_name || item.name || 'Unknown Product';
            const productCode = item.product_code || item.nappi_code || item.code || '';
            const quantity = item.qty_sold || item.quantity_sold || item.qty || item.quantity || item.total_quantity || item.units_sold || 0;
            const gpPercent = item.gp_pct || item.gp_percent || item.margin_pct || 0;
            
            return `
            <div class="best-seller-item">
              <div class="best-seller-details">
                <div class="best-seller-name">${escapeHtml(productName)}</div>
                <div class="best-seller-code">${escapeHtml(productCode)}</div>
              </div>
              <div class="best-seller-stats">
                <div class="best-seller-qty">${quantity} units</div>
                <div class="best-seller-gp">${gpPercent.toFixed(1)}% GP</div>
              </div>
            </div>
            `;
          }).join('');
        } catch (e) {
          console.error('Failed to load top movers:', e);
          container.innerHTML = '<div class="best-seller-item"><div class="best-seller-details"><div class="best-seller-name">Error loading data</div></div></div>';
        }
      }
      
      async function loadLowGpProducts(fromDate, toDate) {
        var pid = selectedPharmacyId;
        if (!pid) return;
        
        var container = document.getElementById('stock-worst-gp-list');
        if (!container) return;
        
        try {
          const url = `/api/worst-gp?pid=${encodeURIComponent(pid)}&from_date=${encodeURIComponent(fromDate)}&to_date=${encodeURIComponent(toDate)}&threshold=20&limit=50&exclude_pdst=true`;
          const resp = await fetch(url);
          
          if (!resp.ok) {
            throw new Error('Failed to fetch low GP products');
          }
          
          const data = await resp.json();
          
          // Handle different possible response structures
          let worstGPProducts = [];
          if (Array.isArray(data)) {
            worstGPProducts = data;
          } else if (data.worst_gp_products) {
            worstGPProducts = data.worst_gp_products;
          } else if (data.low_gp_products) {
            worstGPProducts = data.low_gp_products;
          } else if (data.items) {
            worstGPProducts = data.items;
          } else if (data.data && Array.isArray(data.data)) {
            worstGPProducts = data.data;
          }
          
          if (worstGPProducts.length === 0) {
            container.innerHTML = '<div class="best-seller-item"><div class="best-seller-details"><div class="best-seller-name">No low GP data for this period</div><div class="best-seller-code">Try selecting a different date</div></div></div>';
            return;
          }
          
          // Render worst GP products (top 5)
          container.innerHTML = worstGPProducts.slice(0, 5).map(function(item) {
            const productName = item.product_name || item.product_description || item.description || item.name || 'Unknown Product';
            const productCode = item.nappi_code || item.product_code || item.code || '';
            const quantity = item.quantity_sold || item.qty_sold || item.qty || item.quantity || item.total_quantity || item.units_sold || 0;
            const gpPercent = item.gp_percent || item.gp_pct || item.margin_pct || 0;
            
            return `
            <div class="best-seller-item">
              <div class="best-seller-details">
                <div class="best-seller-name">${escapeHtml(productName)}</div>
                <div class="best-seller-code">${escapeHtml(productCode)}</div>
              </div>
              <div class="best-seller-stats">
                <div class="best-seller-gp" style="color: #e74c3c; font-size: 17px; font-weight: 700;">${gpPercent.toFixed(1)}%</div>
                <div class="best-seller-qty" style="color: var(--textMuted); font-size: 11px; font-weight: 500;">${quantity} units</div>
              </div>
            </div>
            `;
          }).join('');
        } catch (e) {
          console.error('Failed to load low GP products:', e);
          container.innerHTML = '<div class="best-seller-item"><div class="best-seller-details"><div class="best-seller-name">Error loading data</div></div></div>';
        }
      }

      async function loadBestSellers() {
        console.log('loadBestSellers called');
        if (!selectedPharmacyId) {
          console.log('Missing selectedPharmacyId');
          return;
        }
        
        // Use selectedDate if available (from daily/monthly summary), otherwise use current date
        var dateToUse = selectedDate || new Date().toISOString().split('T')[0];
        var pid = selectedPharmacyId;
        
        // Check if we're on monthly summary tab
        const monthlySummaryTab = document.getElementById('tab-monthly-summary');
        const isMonthlyView = monthlySummaryTab && !monthlySummaryTab.hidden;
        
        // Determine which container to update
        const bestSellersContainer = isMonthlyView 
          ? document.getElementById('monthly-best-sellers-list')
          : document.getElementById('best-sellers-list');
        
        if (!bestSellersContainer) {
          console.error('best-sellers-list container not found');
          return;
        }
        
        try {
          let url;
          if (isMonthlyView) {
            // For monthly view, use date range from 1st of month to selected date
            const fromDate = dateToUse.slice(0, 8) + '01'; // First day of month
            const toDate = dateToUse;
            url = `/api/best-sellers?pid=${encodeURIComponent(pid)}&from_date=${encodeURIComponent(fromDate)}&to_date=${encodeURIComponent(toDate)}`;
            console.log('Loading best sellers (MONTHLY) for pid:', pid, 'from:', fromDate, 'to:', toDate);
          } else {
            // For daily view, use single date
            url = `/api/best-sellers?pid=${encodeURIComponent(pid)}&date=${encodeURIComponent(dateToUse)}`;
            console.log('Loading best sellers (DAILY) for pid:', pid, 'date:', dateToUse);
          }
          
          console.log('Fetching:', url);
          const resp = await fetch(url);
          console.log('Response status:', resp.status);
          const data = resp.ok ? await resp.json() : {best_sellers: []};
          console.log('Best sellers RAW data:', JSON.stringify(data, null, 2));
          
          // Handle different possible response structures
          let bestSellers = [];
          if (Array.isArray(data)) {
            // Data is directly an array
            bestSellers = data;
          } else if (data.best_sellers) {
            bestSellers = data.best_sellers;
          } else if (data.stock_activity) {
            bestSellers = data.stock_activity;
          } else if (data.items) {
            bestSellers = data.items;
          } else if (data.data && Array.isArray(data.data)) {
            bestSellers = data.data;
          }
          
          console.log('Best sellers array:', bestSellers, 'length:', bestSellers.length);
          
          if (bestSellers.length === 0) {
            bestSellersContainer.innerHTML = '<div class="best-seller-item"><div class="best-seller-details"><div class="best-seller-name">No stock activity data for this period</div><div class="best-seller-code">Try selecting a different date</div></div></div>';
            return;
          }
          
          // Render best sellers
          bestSellersContainer.innerHTML = bestSellers.slice(0, 5).map(item => {
            console.log('Rendering item:', item);
            const productName = item.product_description || item.description || item.product_name || item.name || 'Unknown Product';
            const productCode = item.product_code || item.code || '';
            const quantity = item.qty_sold || item.quantity_sold || item.qty || item.quantity || item.total_quantity || item.units_sold || 0;
            const gpPercent = item.gp_pct || item.gp_percent || item.margin_pct || 0;
            
            return `
            <div class="best-seller-item">
              <div class="best-seller-details">
                <div class="best-seller-name">${escapeHtml(productName)}</div>
                <div class="best-seller-code">${escapeHtml(productCode)}</div>
              </div>
              <div class="best-seller-stats">
                <div class="best-seller-qty">${quantity} units</div>
                <div class="best-seller-gp">${gpPercent.toFixed(1)}% GP</div>
              </div>
            </div>
            `;
          }).join('');
        } catch (e) {
          console.error('Failed to load best sellers:', e);
          bestSellersContainer.innerHTML = '<div class="best-seller-item"><div class="best-seller-details"><div class="best-seller-name">Error loading data</div></div></div>';
        }
      }
      
      async function loadWorstGP() {
        // Check if we're on monthly summary tab
        const monthlySummaryTab = document.getElementById('tab-monthly-summary');
        const isMonthlyView = monthlySummaryTab && !monthlySummaryTab.hidden;
        
        // Determine which container to update
        const worstGPContainer = isMonthlyView 
          ? document.getElementById('monthly-worst-gp-list')
          : document.getElementById('worst-gp-list');
        
        if (!worstGPContainer || !selectedPharmacyId) return;
        
        // Use selectedDate or fall back to today
        var dateToUse = selectedDate || new Date().toISOString().split('T')[0];
        var pid = selectedPharmacyId;
        
        if (!dateToUse) {
          worstGPContainer.innerHTML = '<div class="best-seller-item"><div class="best-seller-details"><div class="best-seller-name">No date selected</div></div></div>';
          return;
        }
        
        try {
          let url;
          if (isMonthlyView) {
            // For monthly view, use date range from 1st of month to selected date
            const fromDate = dateToUse.slice(0, 8) + '01'; // First day of month
            const toDate = dateToUse;
            url = `/api/worst-gp?pid=${encodeURIComponent(pid)}&from_date=${encodeURIComponent(fromDate)}&to_date=${encodeURIComponent(toDate)}&threshold=20&limit=50&exclude_pdst=true`;
            console.log('Fetching worst GP (MONTHLY) for pid:', pid, 'from:', fromDate, 'to:', toDate);
          } else {
            // For daily view, use date range with same from_date and to_date (today only)
            url = `/api/worst-gp?pid=${encodeURIComponent(pid)}&from_date=${encodeURIComponent(dateToUse)}&to_date=${encodeURIComponent(dateToUse)}&threshold=20&limit=50&exclude_pdst=true`;
            console.log('Fetching worst GP (DAILY) for pid:', pid, 'date:', dateToUse);
          }
          
          console.log('Fetching worst GP:', url);
          const resp = await fetch(url);
          console.log('Worst GP response status:', resp.status);
          const data = resp.ok ? await resp.json() : {worst_gp_products: []};
          console.log('Worst GP RAW data:', JSON.stringify(data, null, 2));
          
          // Handle different possible response structures
          let worstGPProducts = [];
          if (Array.isArray(data)) {
            // Data is directly an array
            worstGPProducts = data;
          } else if (data.worst_gp_products) {
            worstGPProducts = data.worst_gp_products;
          } else if (data.low_gp_products) {
            worstGPProducts = data.low_gp_products;
          } else if (data.items) {
            worstGPProducts = data.items;
          } else if (data.data && Array.isArray(data.data)) {
            worstGPProducts = data.data;
          }
          
          console.log('Worst GP array received:', worstGPProducts, 'length:', worstGPProducts.length);
          
          // No client-side filtering needed - backend already excludes PDST/KSAA when exclude_pdst=true is passed
          
          if (worstGPProducts.length === 0) {
            worstGPContainer.innerHTML = '<div class="best-seller-item"><div class="best-seller-details"><div class="best-seller-name">No low GP data for this period</div><div class="best-seller-code">Try selecting a different date</div></div></div>';
            return;
          }
          
          // Render worst GP products (top 5)
          worstGPContainer.innerHTML = worstGPProducts.slice(0, 5).map(item => {
            console.log('Rendering worst GP item:', item);
            // Use correct field names from the API response (with fallbacks for older endpoints)
            const productName = item.product_name || item.product_description || item.description || item.name || 'Unknown Product';
            const productCode = item.nappi_code || item.product_code || item.code || '';
            const quantity = item.quantity_sold || item.qty_sold || item.qty || item.quantity || item.total_quantity || item.units_sold || 0;
            const gpPercent = item.gp_percent || item.gp_pct || item.margin_pct || 0;
            
            return `
            <div class="best-seller-item">
              <div class="best-seller-details">
                <div class="best-seller-name">${escapeHtml(productName)}</div>
                <div class="best-seller-code">${escapeHtml(productCode)}</div>
              </div>
              <div class="best-seller-stats">
                <div class="best-seller-gp" style="color: #e74c3c; font-size: 17px; font-weight: 700;">${gpPercent.toFixed(1)}%</div>
                <div class="best-seller-qty" style="color: var(--textMuted); font-size: 11px; font-weight: 500;">${quantity} units</div>
              </div>
            </div>
            `;
          }).join('');
        } catch (e) {
          console.error('Failed to load worst GP products:', e);
          worstGPContainer.innerHTML = '<div class="best-seller-item"><div class="best-seller-details"><div class="best-seller-name">Error loading data</div></div></div>';
        }
      }
      
      function formatPrice(price) {
        return Number(price || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }
      
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      async function loadDashboard() {
        if (!selectedDate || !selectedPharmacyId) return;
        var month = selectedDate.slice(0, 7); // Extract YYYY-MM from YYYY-MM-DD
        var pid = selectedPharmacyId;
        if (!month || !pid) return;

        try {
          console.log('loadDashboard called with summaryViewMode:', summaryViewMode);
          if (summaryViewMode === 'daily') {
            console.log('Loading DAILY view for date:', selectedDate);
            // DAILY VIEW: Get data for the selected date only (same weekday as daily summary)
            const currentResp = await fetch(`/api/days?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(month)}`);
            const currentData = currentResp.ok ? await currentResp.json() : [];
            
            // Find the selected date in current month data
            const selectedDayData = currentData.find(d => d.business_date === selectedDate) || null;
            console.log('Selected day data:', selectedDayData);
            
            // Get previous year's corresponding weekday data (same as daily summary screen)
            let prevYearDayData = null;
            if (selectedDate) {
              prevYearDayData = await getPreviousYearWeekdayData(selectedDate, pid);
              console.log('Previous year weekday data:', prevYearDayData);
            }
            
            // Get targets data for the selected date
            const targetsResp = await fetch(`/api/targets?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(month)}`);
            const targetsData = targetsResp.ok ? await targetsResp.json() : {targets: []};
            const selectedDayTarget = (targetsData.targets || []).find(t => t.date === selectedDate) || null;
            console.log('Selected day target:', selectedDayTarget);
            
            // Update dashboard with daily data
            updateDashboardDaily(selectedDayData, prevYearDayData, selectedDayTarget, selectedDate);
            
            // For daily view, GP and Basket are calculated from the single day's data
            updateDashboardGpAndBasketDaily(selectedDayData);
            
            // Load purchases cumulative chart (still uses monthly data)
            // For daily view, we don't have prevYearData for the whole month, so pass null
            loadPurchasesCumulativeChart(currentData, month, targetsData.targets, null);
            
            // Load best sellers and worst GP products for the selected date
            loadBestSellers();
            loadWorstGP();
          } else {
            console.log('Loading MONTHLY (MTD) view');
            // MONTHLY VIEW (default): Get MTD data
            const currentResp = await fetch(`/api/days?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(month)}`);
            const currentData = currentResp.ok ? await currentResp.json() : [];
            
            // Get previous month data
            const [year, monthNum] = month.split('-');
            const prevMonth = monthNum === '01' ? `${parseInt(year)-1}-12` : `${year}-${String(parseInt(monthNum)-1).padStart(2,'0')}`;
            const prevMonthResp = await fetch(`/api/days?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(prevMonth)}`);
            const prevMonthData = prevMonthResp.ok ? await prevMonthResp.json() : [];
            
            // Get previous year same month data
            const prevYearMonth = `${parseInt(year)-1}-${monthNum}`;
            const prevYearResp = await fetch(`/api/days?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(prevYearMonth)}`);
            const prevYearData = prevYearResp.ok ? await prevYearResp.json() : [];
            
            // Get targets data
            const targetsResp = await fetch(`/api/targets?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(month)}`);
            const targetsData = targetsResp.ok ? await targetsResp.json() : {targets: []};
            
            // Get aggregated MTD data (for GP and Basket) using selectedDate (defaults to yesterday)
            // This ensures we show accurate MTD data up to the previous day, not incomplete today's data
            const throughDate = selectedDate; // Use selectedDate (yesterday by default) for accurate MTD
            const mtdAggResp = await fetch(`/api/mtd?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(month)}&through=${encodeURIComponent(throughDate)}`);
            const mtdAgg = mtdAggResp.ok ? await mtdAggResp.json() : null;
            
            updateDashboard(currentData, prevMonthData, prevYearData, targetsData.targets, month);
            // Update GP and Basket cards from aggregated MTD data
            updateDashboardGpAndBasket(mtdAgg);
            
            // Load purchases cumulative chart using existing daily data and targets for budget overlay
            loadPurchasesCumulativeChart(currentData, month, targetsData.targets, prevYearData);
            
            // Load best sellers and worst GP products
            loadBestSellers();
            loadWorstGP();
          }
        } catch (e) {
          console.error('Failed to load dashboard data:', e);
        }
      }

      // Populate GP/Basket cards on the dashboard using the aggregated MTD API (same as monthly)
      function updateDashboardGpAndBasket(mtdData) {
        try {
          if (!mtdData) {
            ['dash-gp-percent','dash-gp-value','dash-basket-value','dash-transaction-count','mobile-dash-gp-percent','mobile-dash-gp-value','mobile-dash-basket-value','mobile-dash-transaction-count']
              .forEach(id => { const el = document.getElementById(id); if (el) el.textContent = '—'; });
            return;
          }
          const turnover = Number(mtdData.turnover || 0);
          const gpValue = Number(mtdData.gp_value || 0);
          const txn = Number(mtdData.transaction_count || 0);
          let basket = Number(mtdData.avg_basket || 0);
          const gpPct = turnover ? (gpValue / turnover) * 100 : 0;

          if (basket === 0) {
            const denom = txn > 0 ? txn : (turnover > 0 ? Math.max(1, Math.round(turnover / 150)) : 0);
            basket = denom ? turnover / denom : 0;
          }
          const displayTxn = txn > 0 ? txn : (turnover > 0 ? Math.max(1, Math.round(turnover / 150)) : 0);

          const gpCur = document.getElementById('dash-gp-percent-currency'); if (gpCur) gpCur.textContent = '%';
          const dgp = document.getElementById('dash-gp-percent'); if (dgp) dgp.textContent = fmtPct(gpPct);
          const dgpv = document.getElementById('dash-gp-value'); if (dgpv) dgpv.textContent = `R ${fmtMoneyAmount(gpValue)}`;
          const dbcur = document.getElementById('dash-basket-currency'); if (dbcur) dbcur.textContent = 'R';
          const db = document.getElementById('dash-basket-value'); if (db) db.textContent = basket > 0 ? fmtMoneyAmount(basket) : '—';
          const dtc = document.getElementById('dash-transaction-count'); if (dtc) dtc.textContent = displayTxn ? `${displayTxn.toLocaleString('en-ZA')} transactions` : '—';

          const mgp = document.getElementById('mobile-dash-gp-percent'); if (mgp) mgp.textContent = fmtPct(gpPct);
          const mgpv = document.getElementById('mobile-dash-gp-value'); if (mgpv) mgpv.textContent = `R ${fmtMoneyAmount(gpValue)}`;
          const mbv = document.getElementById('mobile-dash-basket-value'); if (mbv) mbv.textContent = basket > 0 ? fmtMoneyAmount(basket) : '—';
          const mtx = document.getElementById('mobile-dash-transaction-count'); if (mtx) mtx.textContent = displayTxn ? `${displayTxn.toLocaleString('en-ZA')} transactions` : '—';
        } catch (e) {
          console.error('updateDashboardGpAndBasket error:', e);
        }
      }

      // Populate GP/Basket cards for daily view
      function updateDashboardGpAndBasketDaily(dailyData) {
        try {
          if (!dailyData) {
            ['dash-gp-percent','dash-gp-value','dash-basket-value','dash-transaction-count','mobile-dash-gp-percent','mobile-dash-gp-value','mobile-dash-basket-value','mobile-dash-transaction-count']
              .forEach(id => { const el = document.getElementById(id); if (el) el.textContent = '—'; });
            return;
          }
          const turnover = Number(dailyData.turnover || 0);
          const gpValue = Number(dailyData.gp_value || dailyData.gp || 0);
          const txn = Number(dailyData.transaction_count || dailyData.transactions || 0);
          let basket = Number(dailyData.avg_basket || dailyData.basket || 0);
          const gpPct = turnover ? (gpValue / turnover) * 100 : 0;

          if (basket === 0) {
            const denom = txn > 0 ? txn : (turnover > 0 ? Math.max(1, Math.round(turnover / 150)) : 0);
            basket = denom ? turnover / denom : 0;
          }
          const displayTxn = txn > 0 ? txn : (turnover > 0 ? Math.max(1, Math.round(turnover / 150)) : 0);

          const gpCur = document.getElementById('dash-gp-percent-currency'); if (gpCur) gpCur.textContent = '%';
          const dgp = document.getElementById('dash-gp-percent'); if (dgp) dgp.textContent = fmtPct(gpPct);
          const dgpv = document.getElementById('dash-gp-value'); if (dgpv) dgpv.textContent = `R ${fmtMoneyAmount(gpValue)}`;
          const dbcur = document.getElementById('dash-basket-currency'); if (dbcur) dbcur.textContent = 'R';
          const db = document.getElementById('dash-basket-value'); if (db) db.textContent = basket > 0 ? fmtMoneyAmount(basket) : '—';
          const dtc = document.getElementById('dash-transaction-count'); if (dtc) dtc.textContent = displayTxn ? `${displayTxn.toLocaleString('en-ZA')} transactions` : '—';

          const mgp = document.getElementById('mobile-dash-gp-percent'); if (mgp) mgp.textContent = fmtPct(gpPct);
          const mgpv = document.getElementById('mobile-dash-gp-value'); if (mgpv) mgpv.textContent = `R ${fmtMoneyAmount(gpValue)}`;
          const mbv = document.getElementById('mobile-dash-basket-value'); if (mbv) mbv.textContent = basket > 0 ? fmtMoneyAmount(basket) : '—';
          const mtx = document.getElementById('mobile-dash-transaction-count'); if (mtx) mtx.textContent = displayTxn ? `${displayTxn.toLocaleString('en-ZA')} transactions` : '—';
        } catch (e) {
          console.error('updateDashboardGpAndBasketDaily error:', e);
        }
      }

      // Update dashboard with daily view data
      function updateDashboardDaily(dailyData, prevYearDayData, dailyTarget, selectedDate) {
        try {
          if (!selectedDate) return;
          
          const dateObj = new Date(selectedDate + 'T00:00:00');
          const prevYear = dateObj.getFullYear() - 1;
          
          // Update page subtitle with the selected date
          var pageSubtitleEl = document.getElementById('page-subtitle');
          if (pageSubtitleEl) {
            const dateStr = dateObj.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            pageSubtitleEl.textContent = dateStr;
          }

          // Current day values
          const currentTurnover = dailyData ? Number(dailyData.turnover || 0) : 0;
          const currentPurchases = dailyData ? Number(dailyData.purchases || dailyData.daily_purchases || dailyData.purchases_value || 0) : 0;

          // Previous year same day values
          const prevYearTurnover = prevYearDayData ? Number(prevYearDayData.turnover || 0) : 0;

          // Daily target (from targets data or calculate as 10% more than previous year)
          let budgetTurnover = dailyTarget ? Number(dailyTarget.value || 0) : 0;
          if (budgetTurnover === 0 && prevYearTurnover > 0) {
            budgetTurnover = prevYearTurnover * 1.10; // 10% growth
          }

          // Update main KPIs - Daily Turnover
          const currentHeaderEl = document.getElementById('dash-current-month-header');
          if (currentHeaderEl) currentHeaderEl.textContent = 'DAILY TURNOVER';
          document.getElementById('dash-current-turnover-currency').textContent = 'R';
          document.getElementById('dash-current-turnover').textContent = currentTurnover > 0 ? fmtMoneyAmount(currentTurnover) : '—';

          // Update budget header and value - Daily Target
          const budgetHeaderEl = document.getElementById('dash-budget-month-header');
          if (budgetHeaderEl) budgetHeaderEl.textContent = 'Daily Target';
          document.getElementById('dash-budget-turnover-currency').textContent = 'R';
          document.getElementById('dash-budget-turnover').textContent = budgetTurnover > 0 ? fmtMoneyAmount(budgetTurnover) : '—';

          // Update budget comparison
          const budgetComparisonEl = document.getElementById('dash-budget-turnover-comparison');
          const budgetPercentageEl = document.getElementById('dash-budget-turnover-percentage');
          if (budgetComparisonEl && budgetTurnover > 0 && currentTurnover > 0) {
            const difference = currentTurnover - budgetTurnover;
            const absDifference = Math.abs(difference);
            const direction = difference >= 0 ? 'above' : 'under';
            budgetComparisonEl.textContent = `R ${fmtMoneyAmount(absDifference)} ${direction}`;

            const budgetPercentage = (difference / budgetTurnover) * 100;
            if (budgetPercentageEl) {
              budgetPercentageEl.textContent = fmtPct(budgetPercentage);
              budgetPercentageEl.className = 'card-value-percentage ' + (budgetPercentage >= 0 ? 'positive' : 'negative');
            }
          } else {
            if (budgetComparisonEl) budgetComparisonEl.textContent = '—';
            if (budgetPercentageEl) {
              budgetPercentageEl.textContent = '';
              budgetPercentageEl.className = 'card-value-percentage';
            }
          }

          // Calculate Y/Y growth
          const yoyGrowth = prevYearTurnover ? ((currentTurnover - prevYearTurnover) / prevYearTurnover) * 100 : null;

          // Display Y/Y percentage on current day card
          const percentageEl = document.getElementById('dash-current-turnover-percentage');
          if (yoyGrowth !== null) {
            percentageEl.textContent = fmtPct(yoyGrowth);
            percentageEl.className = 'card-value-percentage ' + (yoyGrowth >= 0 ? 'positive' : 'negative');
          } else {
            percentageEl.textContent = '';
            percentageEl.className = 'card-value-percentage';
          }

          // Update desktop comparison text "vs <previous year>: <previous year daily Turnover>"
          const desktopComparisonEl = document.getElementById('dash-current-turnover-comparison');
          if (desktopComparisonEl) {
            if (prevYearTurnover > 0 && prevYear) {
              desktopComparisonEl.textContent = `vs ${prevYear}: R ${fmtMoneyAmount(prevYearTurnover)}`;
            } else {
              desktopComparisonEl.textContent = '—';
            }
          }

          // Update purchases card for daily view
          const purchaseBudgetDaily = budgetTurnover * 0.75;
          const purchaseBudgetDifference = currentPurchases - purchaseBudgetDaily;
          const purchaseBudgetDirection = purchaseBudgetDifference >= 0 ? 'above' : 'below';

          const purchaseActualEl = document.getElementById('dash-purchases-value');
          const purchaseBudgetEl = document.getElementById('dash-purchase-budget');
          const purchaseComparisonEl = document.getElementById('dash-purchases-comparison');
          const purchasePercentageEl = document.getElementById('dash-purchase-budget-percentage');
          const purchaseBudgetComparisonEl = document.getElementById('dash-purchase-budget-comparison');

          if (purchaseActualEl) purchaseActualEl.textContent = fmtMoneyAmount(currentPurchases);
          if (purchaseBudgetEl) purchaseBudgetEl.textContent = purchaseBudgetDaily > 0 ? fmtMoneyAmount(purchaseBudgetDaily) : '—';
          if (purchaseComparisonEl && purchaseBudgetDaily > 0 && currentPurchases > 0) {
            purchaseComparisonEl.textContent = `R ${fmtMoneyAmount(Math.abs(purchaseBudgetDifference))} ${purchaseBudgetDirection}`;
          } else {
            if (purchaseComparisonEl) purchaseComparisonEl.textContent = '—';
          }
          if (purchasePercentageEl && purchaseBudgetDaily > 0 && currentPurchases > 0) {
            const purchaseBudgetPercentage = (purchaseBudgetDifference / purchaseBudgetDaily) * 100;
            purchasePercentageEl.textContent = fmtPct(purchaseBudgetPercentage);
            purchasePercentageEl.className = 'card-value-percentage ' + (purchaseBudgetPercentage < 0 ? 'positive' : 'negative');
          } else {
            if (purchasePercentageEl) {
              purchasePercentageEl.textContent = '';
              purchasePercentageEl.className = 'card-value-percentage';
            }
          }
          if (purchaseBudgetComparisonEl && purchaseBudgetDaily > 0 && currentPurchases > 0) {
            purchaseBudgetComparisonEl.textContent = `R ${fmtMoneyAmount(Math.abs(purchaseBudgetDifference))} ${purchaseBudgetDirection}`;
          } else {
            if (purchaseBudgetComparisonEl) purchaseBudgetComparisonEl.textContent = '—';
          }

          // Update mobile view
          const mobileCurrentHeaderEl = document.getElementById('mobile-dash-current-month-header');
          if (mobileCurrentHeaderEl) mobileCurrentHeaderEl.textContent = 'Daily Turnover';
          const mobileCurrentCurrencyEl = document.getElementById('mobile-dash-current-turnover-currency');
          const mobileCurrentAmountEl = document.getElementById('mobile-dash-current-turnover');
          if (mobileCurrentCurrencyEl) mobileCurrentCurrencyEl.textContent = 'R';
          if (mobileCurrentAmountEl) mobileCurrentAmountEl.textContent = currentTurnover > 0 ? fmtMoneyAmount(currentTurnover) : '—';

          const mobileBudgetHeaderEl = document.getElementById('mobile-dash-budget-month-header');
          if (mobileBudgetHeaderEl) mobileBudgetHeaderEl.textContent = 'Daily Target';
          const mobileBudgetCurrencyEl = document.getElementById('mobile-dash-budget-turnover-currency');
          const mobileBudgetAmountEl = document.getElementById('mobile-dash-budget-turnover');
          if (mobileBudgetCurrencyEl) mobileBudgetCurrencyEl.textContent = 'R';
          if (mobileBudgetAmountEl) mobileBudgetAmountEl.textContent = budgetTurnover > 0 ? fmtMoneyAmount(budgetTurnover) : '—';

          const mobilePurchaseActualEl = document.getElementById('mobile-dash-purchases-value');
          const mobilePurchaseBudgetEl = document.getElementById('mobile-dash-purchase-budget');
          if (mobilePurchaseActualEl) mobilePurchaseActualEl.textContent = fmtMoneyAmount(currentPurchases);
          if (mobilePurchaseBudgetEl) mobilePurchaseBudgetEl.textContent = purchaseBudgetDaily > 0 ? fmtMoneyAmount(purchaseBudgetDaily) : '—';

          const mobilePurchaseComparisonEl = document.getElementById('mobile-dash-purchases-comparison');
          const mobilePurchaseBudgetComparisonEl = document.getElementById('mobile-dash-purchase-budget-comparison');
          const mobilePurchaseBudgetPercentageEl = document.getElementById('mobile-dash-purchase-budget-percentage');
          if (mobilePurchaseComparisonEl && purchaseBudgetDaily > 0 && currentPurchases > 0) {
            mobilePurchaseComparisonEl.textContent = `R ${fmtMoneyAmount(Math.abs(purchaseBudgetDifference))} ${purchaseBudgetDirection}`;
          } else {
            if (mobilePurchaseComparisonEl) mobilePurchaseComparisonEl.textContent = '—';
          }
          if (mobilePurchaseBudgetPercentageEl && purchaseBudgetDaily > 0 && currentPurchases > 0) {
            const purchaseBudgetPercentage = (purchaseBudgetDifference / purchaseBudgetDaily) * 100;
            mobilePurchaseBudgetPercentageEl.textContent = fmtPct(purchaseBudgetPercentage);
            mobilePurchaseBudgetPercentageEl.className = 'combined-metric-comparison combined-metric-percentage ' + (purchaseBudgetPercentage < 0 ? 'positive' : 'negative');
          } else {
            if (mobilePurchaseBudgetPercentageEl) {
              mobilePurchaseBudgetPercentageEl.textContent = '';
              mobilePurchaseBudgetPercentageEl.className = 'combined-metric-comparison combined-metric-percentage';
            }
          }
          if (mobilePurchaseBudgetComparisonEl && purchaseBudgetDaily > 0 && currentPurchases > 0) {
            mobilePurchaseBudgetComparisonEl.textContent = `R ${fmtMoneyAmount(Math.abs(purchaseBudgetDifference))} ${purchaseBudgetDirection}`;
          } else {
            if (mobilePurchaseBudgetComparisonEl) mobilePurchaseBudgetComparisonEl.textContent = '—';
          }

          const mobilePercentageEl = document.getElementById('mobile-dash-current-turnover-percentage');
          if (yoyGrowth !== null) {
            mobilePercentageEl.textContent = fmtPct(yoyGrowth);
            mobilePercentageEl.className = 'combined-metric-comparison combined-metric-percentage ' + (yoyGrowth >= 0 ? 'positive' : 'negative');
          } else {
            mobilePercentageEl.textContent = '';
            mobilePercentageEl.className = 'combined-metric-comparison combined-metric-percentage';
          }

          const mobileComparisonEl = document.getElementById('mobile-dash-current-turnover-comparison');
          if (mobileComparisonEl) {
            if (prevYearTurnover > 0 && prevYear) {
              mobileComparisonEl.textContent = `vs ${prevYear}: R ${fmtMoneyAmount(prevYearTurnover)}`;
            } else {
              mobileComparisonEl.textContent = '—';
            }
          }

          const mobileBudgetPercentageEl = document.getElementById('mobile-dash-budget-turnover-percentage');
          const mobileBudgetComparisonEl = document.getElementById('mobile-dash-budget-turnover-comparison');
          if (budgetTurnover > 0 && currentTurnover > 0) {
            const budgetDifference = currentTurnover - budgetTurnover;
            const absBudgetDifference = Math.abs(budgetDifference);
            const budgetDirection = budgetDifference >= 0 ? 'above' : 'under';

            const budgetPercentage = (budgetDifference / budgetTurnover) * 100;
            if (mobileBudgetPercentageEl) {
              mobileBudgetPercentageEl.textContent = fmtPct(budgetPercentage);
              mobileBudgetPercentageEl.className = 'combined-metric-comparison combined-metric-percentage ' + (budgetPercentage >= 0 ? 'positive' : 'negative');
            }

            if (mobileBudgetComparisonEl) {
              mobileBudgetComparisonEl.textContent = `R ${fmtMoneyAmount(absBudgetDifference)} ${budgetDirection}`;
            }
          } else {
            if (mobileBudgetPercentageEl) {
              mobileBudgetPercentageEl.textContent = '';
              mobileBudgetPercentageEl.className = 'combined-metric-comparison combined-metric-percentage';
            }
            if (mobileBudgetComparisonEl) {
              mobileBudgetComparisonEl.textContent = '—';
            }
          }
          
          // Update spend analytics for daily view
          const purchaseActualSpendDaily = currentTurnover * 0.75;
          updateSpendAnalytics(currentPurchases, purchaseBudgetDaily, currentTurnover, purchaseActualSpendDaily);
        } catch (e) {
          console.error('updateDashboardDaily error:', e);
        }
      }

      // Load and draw cumulative purchases chart from daily data + overlay budget cumulative from targets
      // prevYearData is optional and used to calculate budget as 10% more than previous year when targets are missing
      function loadPurchasesCumulativeChart(dailyData, month, targets, prevYearData) {
        try {
          if (!dailyData || !Array.isArray(dailyData) || dailyData.length === 0) {
            drawEmptyPurchasesChart();
            return;
          }
          
          const [year, monthNum] = month.split('-');
          const selYear = parseInt(year);
          const selMonthIdx = parseInt(monthNum) - 1;
          const today = new Date();
          const isCurrentMonth = today.getFullYear() === selYear && today.getMonth() === selMonthIdx;
          const daysInMonth = new Date(selYear, selMonthIdx + 1, 0).getDate();
          const maxDay = isCurrentMonth ? today.getDate() : daysInMonth;
          
          // Filter and sort daily data by date
          const dailyPurchases = dailyData
            .map(record => {
              const dstr = record.business_date || record.date || record.bdate;
              if (!dstr) return null;
              const d = new Date(dstr + 'T00:00:00');
              if (d.getFullYear() !== selYear || d.getMonth() !== selMonthIdx) return null;
              
              const day = d.getDate();
              const purchases = Number(record.purchases || record.daily_purchases || record.purchases_value || 0);
              const budgetTurnover = Number(record.budget_turnover || record.budget_to || record.budget || 0);
              
              return { day, purchases, budgetTurnover, date: dstr };
            })
            .filter(item => item !== null && item.day <= maxDay)
            .sort((a, b) => a.day - b.day);
          
          // Calculate cumulative purchases
          let cumulativePurchases = 0;
          const purchasesData = [];
          const dayMap = new Map();
          const budgetTurnoverByDay = new Map();
          
          // Create maps of day to purchases and budget turnover
          dailyPurchases.forEach(item => {
            dayMap.set(item.day, item.purchases);
            if (item.budgetTurnover > 0) {
              budgetTurnoverByDay.set(item.day, item.budgetTurnover);
            }
          });
          
          // Build cumulative data for each day
          for (let day = 1; day <= maxDay; day++) {
            const dailyPurchase = dayMap.get(day) || 0;
            cumulativePurchases += dailyPurchase;
            purchasesData.push({
              day: day,
              date: `${month}-${String(day).padStart(2, '0')}`,
              purchases: cumulativePurchases
            });
          }

          // Build cumulative purchase budget from targets (75% of turnover target MTD)
          // Fall back to daily data's budget_turnover, then to previous year * 1.10 if targets are not available
          let cumulativeTarget = 0;
          const targetsByDay = new Map();
          (targets || []).forEach(t => {
            const d = t.date;
            if (!d || typeof t.value === 'undefined' || t.value === null) return;
            if (!d.startsWith(month)) return;
            const day = parseInt(d.slice(8, 10), 10);
            const val = Number(t.value || 0);
            if (val > 0) {
              targetsByDay.set(day, (targetsByDay.get(day) || 0) + val);
            }
          });

          // Build map of previous year turnover by day (for fallback calculation)
          const prevYearTurnoverByDay = new Map();
          if (prevYearData && Array.isArray(prevYearData)) {
            prevYearData.forEach(record => {
              const dstr = record.business_date || record.date || record.bdate;
              if (!dstr) return;
              const d = new Date(dstr + 'T00:00:00');
              if (d.getFullYear() === selYear - 1 && d.getMonth() === selMonthIdx) {
                const day = d.getDate();
                const turnover = Number(record.turnover || 0);
                if (turnover > 0) {
                  prevYearTurnoverByDay.set(day, turnover);
                }
              }
            });
          }

          const budgetData = [];
          for (let day = 1; day <= maxDay; day++) {
            // Priority: 1) saved target, 2) daily data's budget_turnover, 3) previous year * 1.10
            let targetValue = targetsByDay.get(day) || budgetTurnoverByDay.get(day) || 0;
            
            // If still no target value, use previous year's same day with 10% growth
            if (targetValue === 0 && prevYearTurnoverByDay.has(day)) {
              targetValue = prevYearTurnoverByDay.get(day) * 1.10;
            }
            
            cumulativeTarget += targetValue;
            const cumulativePurchaseBudget = cumulativeTarget * 0.75; // purchases budget = 75% of turnover target
            budgetData.push({
              day: day,
              date: `${month}-${String(day).padStart(2, '0')}`,
              budget: cumulativePurchaseBudget
            });
          }
          
          // Debug logging
          console.log('loadPurchasesCumulativeChart debug:', {
            month,
            targetsCount: (targets || []).length,
            targetsByDaySize: targetsByDay.size,
            budgetTurnoverByDaySize: budgetTurnoverByDay.size,
            prevYearDataCount: prevYearData ? prevYearData.length : 0,
            prevYearTurnoverByDaySize: prevYearTurnoverByDay.size,
            budgetDataLength: budgetData.length,
            maxBudgetValue: budgetData.length > 0 ? Math.max(...budgetData.map(d => d.budget || 0)) : 0,
            sampleBudgetData: budgetData.slice(0, 5),
            hasNonZeroBudget: budgetData.some(d => (d.budget || 0) > 0)
          });
          
          // Draw the chart
          drawPurchasesCumulativeChart(purchasesData, budgetData, maxDay);
        } catch (e) {
          console.error('Failed to load purchases cumulative chart:', e);
          drawEmptyPurchasesChart();
        }
      }
      
      function drawPurchasesCumulativeChart(data, budgetData, maxDay) {
        const canvas = document.getElementById('spend-analytics-chart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const container = canvas.parentElement;
        
        // Temporarily make container visible to get proper dimensions (even if hidden)
        const wasHidden = container.style.display === 'none';
        const originalDisplay = container.style.display;
        const originalVisibility = container.style.visibility;
        if (wasHidden) {
          container.style.display = 'block';
          container.style.visibility = 'hidden';
          container.style.position = 'absolute';
          container.style.left = '-9999px';
        }
        
        // Force a layout recalculation
        void container.offsetHeight;
        
        const rect = container.getBoundingClientRect();
        const width = rect.width || 800; // fallback width
        const height = rect.height || 180; // fallback height
        
        // Restore original visibility state
        if (wasHidden) {
          container.style.display = originalDisplay;
          container.style.visibility = originalVisibility;
          container.style.position = '';
          container.style.left = '';
        }
        
        // Scale for high-DPI displays
        const dpr = window.devicePixelRatio || 1;
        canvas.width = width * dpr;
        canvas.height = height * dpr;
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        ctx.scale(dpr, dpr);
        
        ctx.clearRect(0, 0, width, height);
        
        if (!data || data.length === 0) {
          drawEmptyPurchasesChart();
          return;
        }
        
        // Minimal padding to prevent clipping (especially for line width and data points)
        const padding = { top: 4, right: 4, bottom: 4, left: 4 };
        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;
        
        // Find max value across both series for scaling
        const maxPurchases = Math.max(...data.map(d => d.purchases), 1);
        const maxBudget = budgetData && budgetData.length ? Math.max(...budgetData.map(d => d.budget || 0), 0) : 0;
        const maxVal = Math.max(maxPurchases, maxBudget, 1);
        const yScale = chartHeight / maxVal;
        const xScale = chartWidth / (maxDay - 1); // Distribute across days, with padding on sides
        
        // Prepare arrays of points for tooltip hit testing
        const pointsActual = [];
        const pointsBudget = [];

        // Draw cumulative line (actual purchases)
        ctx.strokeStyle = '#F47A20';
        ctx.lineWidth = 3; // unified thickness
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
        
        ctx.beginPath();
        for (let i = 0; i < data.length; i++) {
          // Scale x position to account for padding on sides
          const x = padding.left + ((data[i].day - 1) / (maxDay - 1)) * chartWidth;
          const y = padding.top + chartHeight - (data[i].purchases * yScale);
          pointsActual.push({ x, y, idx: i });
          
          if (i === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        }
        ctx.stroke();
        
        // No data point markers (clean line)

        // Draw budget overlay line (green) - same style
        // Only draw if budgetData exists, has length, and has at least one non-zero value
        const hasBudgetData = budgetData && budgetData.length > 0;
        const hasNonZeroBudget = hasBudgetData && budgetData.some(d => (d.budget || 0) > 0);
        
        if (hasBudgetData && hasNonZeroBudget) {
          console.log('Drawing budget line with max budget:', maxBudget);
          ctx.strokeStyle = '#59BA47';
          ctx.lineWidth = 3; // unified thickness
          ctx.lineJoin = 'round';
          ctx.lineCap = 'round';
          ctx.beginPath();
          for (let i = 0; i < budgetData.length; i++) {
            const x = padding.left + ((budgetData[i].day - 1) / (maxDay - 1)) * chartWidth;
            const y = padding.top + chartHeight - ((budgetData[i].budget || 0) * yScale);
            pointsBudget.push({ x, y, idx: i });
            if (i === 0) {
              ctx.moveTo(x, y);
            } else {
              ctx.lineTo(x, y);
            }
          }
          ctx.stroke();
        } else {
          console.warn('Budget line not drawn:', {
            hasBudgetData,
            hasNonZeroBudget,
            budgetDataLength: budgetData?.length || 0,
            maxBudget
          });
        }

        // Save state for tooltip calculations
        window.spendChartState = {
          padding, chartWidth, chartHeight, maxDay,
          pointsActual, pointsBudget, data, budgetData
        };
        registerSpendChartEvents();
      }
      
      function drawEmptyPurchasesChart() {
        const canvas = document.getElementById('spend-analytics-chart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const container = canvas.parentElement;
        
        // Temporarily make container visible to get proper dimensions (even if hidden)
        const wasHidden = container.style.display === 'none';
        const originalDisplay = container.style.display;
        const originalVisibility = container.style.visibility;
        if (wasHidden) {
          container.style.display = 'block';
          container.style.visibility = 'hidden';
          container.style.position = 'absolute';
          container.style.left = '-9999px';
        }
        
        // Force a layout recalculation
        void container.offsetHeight;
        
        const rect = container.getBoundingClientRect();
        const width = rect.width || 800; // fallback width
        const height = rect.height || 180; // fallback height
        
        // Restore original visibility state
        if (wasHidden) {
          container.style.display = originalDisplay;
          container.style.visibility = originalVisibility;
          container.style.position = '';
          container.style.left = '';
        }
        
        // Scale for high-DPI displays
        const dpr = window.devicePixelRatio || 1;
        canvas.width = width * dpr;
        canvas.height = height * dpr;
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        ctx.scale(dpr, dpr);
        
        ctx.clearRect(0, 0, width, height);
        
        ctx.fillStyle = '#6B7280';
        ctx.font = '16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('No purchases data available', width / 2, height / 2);
      }

      function registerSpendChartEvents() {
        const canvas = document.getElementById('spend-analytics-chart');
        const tooltip = document.getElementById('spend-analytics-tooltip');
        if (!canvas || !tooltip) return;

        if (canvas._spendEventsBound) return;
        canvas._spendEventsBound = true;

        function showTooltip(evt) {
          const state = window.spendChartState;
          if (!state || !state.pointsActual || state.pointsActual.length === 0) return;

          const rect = canvas.getBoundingClientRect();
          const x = evt.clientX - rect.left;
          const y = evt.clientY - rect.top;

          // Find nearest day by x among actual points
          let nearestIdx = 0;
          let nearestDist = Infinity;
          for (let i = 0; i < state.pointsActual.length; i++) {
            const dx = Math.abs(state.pointsActual[i].x - x);
            if (dx < nearestDist) { nearestDist = dx; nearestIdx = i; }
          }

          const actual = state.data[nearestIdx];
          const budget = (state.budgetData && state.budgetData[nearestIdx]) ? state.budgetData[nearestIdx] : null;
          const actualVal = actual ? Number(actual.purchases || 0) : 0;
          const budgetVal = budget ? Number(budget.budget || 0) : 0;
          const diff = actualVal - budgetVal;
          const isAbove = diff >= 0;
          const directionLabel = isAbove ? 'above' : 'below';
          const color = isAbove ? '#FF4509' : '#59BA47';

          tooltip.innerHTML = `
            <div class="tt-title">Day ${nearestIdx + 1}</div>
            <div class="tt-row"><span><span class="tt-swatch" style="background:#F47A20"></span>Purchases</span><span>R ${fmtMoneyAmount(actualVal)}</span></div>
            <div class="tt-row"><span><span class="tt-swatch" style="background:#59BA47"></span>Spend Budget</span><span>R ${fmtMoneyAmount(budgetVal)}</span></div>
            <div class="tt-row"><span>Status</span><span style="color:${color}; font-weight:700;">R ${fmtMoneyAmount(Math.abs(diff))} ${directionLabel}</span></div>
          `;

          // Position tooltip near point but inside container
          let ttX = x + 12;
          let ttY = y - 12 - tooltip.offsetHeight;
          if (ttX + tooltip.offsetWidth > rect.width) ttX = x - tooltip.offsetWidth - 12;
          if (ttY < 0) ttY = y + 12;
          tooltip.style.left = `${ttX}px`;
          tooltip.style.top = `${ttY}px`;
          tooltip.style.display = 'block';
        }

        function hideTooltip() {
          tooltip.style.display = 'none';
        }

        canvas.addEventListener('mousemove', showTooltip);
        canvas.addEventListener('mouseleave', hideTooltip);
        canvas.addEventListener('click', showTooltip);
      }

      function updateDashboard(currentData, prevMonthData, prevYearData, targets, month) {
        // Calculate MTD cutoffs using selectedDate (defaults to yesterday for accurate data)
        const [selYearStr, selMonthStr] = month.split('-');
        const selYear = parseInt(selYearStr, 10);
        const selMonthIdx = parseInt(selMonthStr, 10) - 1; // 0-based
        
        // Use selectedDate to determine the MTD day (defaults to yesterday)
        let mtdDay;
        if (selectedDate) {
          const selectedDateObj = new Date(selectedDate + 'T00:00:00');
          const selectedYear = selectedDateObj.getFullYear();
          const selectedMonthIdx = selectedDateObj.getMonth();
          const selectedDay = selectedDateObj.getDate();
          
          // Only use selectedDate if it's in the same month we're viewing
          if (selectedYear === selYear && selectedMonthIdx === selMonthIdx) {
            mtdDay = selectedDay;
          } else {
            // If selectedDate is in a different month, use the last day of the selected month
            const daysInSelected = new Date(selYear, selMonthIdx + 1, 0).getDate();
            mtdDay = daysInSelected;
          }
        } else {
          // Fallback: use yesterday if selectedDate is not set
          const yesterday = new Date();
          yesterday.setDate(yesterday.getDate() - 1);
          const isCurrentMonth = yesterday.getFullYear() === selYear && yesterday.getMonth() === selMonthIdx;
          const daysInSelected = new Date(selYear, selMonthIdx + 1, 0).getDate();
          mtdDay = isCurrentMonth ? yesterday.getDate() : daysInSelected;
        }
        
        // Update page subtitle with the month-to-date range
        var pageSubtitleEl = document.getElementById('page-subtitle');
        if (pageSubtitleEl) {
          const dateObj = new Date(selYear, selMonthIdx, mtdDay);
          const monthName = dateObj.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
          pageSubtitleEl.textContent = `${monthName} (1 - ${mtdDay})`;
        }

        function filterMTD(data, year, monthIdx, dayLimit) {
          if (!Array.isArray(data)) return [];
          return data.filter(function(rec) {
            const dstr = rec.business_date || rec.date || rec.bdate;
            if (!dstr) return false;
            const d = new Date(dstr + 'T00:00:00');
            return d.getFullYear() === year && d.getMonth() === monthIdx && d.getDate() <= dayLimit;
          });
        }
        function sumTurnover(rows) {
          return rows.reduce((sum, r) => sum + Number(r.turnover || 0), 0);
        }
        function sumPurchases(rows) {
          return rows.reduce((sum, r) => sum + Number(r.purchases || r.daily_purchases || r.purchases_value || 0), 0);
        }

        // Current month MTD
        const currentMTD = filterMTD(currentData, selYear, selMonthIdx, mtdDay);
        const currentTurnover = sumTurnover(currentMTD);
        const currentPurchases = sumPurchases(currentMTD);
        const currentActualSpend = currentTurnover * 0.75;

        // Previous month MTD (same day count)
        const prevMonthDate = new Date(selYear, selMonthIdx - 1, 1);
        const prevMonthDays = new Date(prevMonthDate.getFullYear(), prevMonthDate.getMonth() + 1, 0).getDate();
        const prevMTDDay = Math.min(mtdDay, prevMonthDays);
        const prevMonthMTD = filterMTD(prevMonthData, prevMonthDate.getFullYear(), prevMonthDate.getMonth(), prevMTDDay);
        const prevMonthTurnover = sumTurnover(prevMonthMTD);

        // Previous year same month MTD (same day count)
        const prevYearDate = new Date(selYear - 1, selMonthIdx, 1);
        const prevYearMonthDays = new Date(prevYearDate.getFullYear(), prevYearDate.getMonth() + 1, 0).getDate();
        const prevYearMTDDay = Math.min(mtdDay, prevYearMonthDays);
        const prevYearMTD = filterMTD(prevYearData, prevYearDate.getFullYear(), prevYearDate.getMonth(), prevYearMTDDay);
        const prevYearTurnover = sumTurnover(prevYearMTD);

        // Budget targets MTD (day-to-day calculation up to selected date)
        // Only sum targets for dates up to and including the MTD day
        const cutoffDateStr = `${selYear}-${String(selMonthIdx + 1).padStart(2,'0')}-${String(mtdDay).padStart(2,'0')}`;
        let budgetTurnover = (targets || []).reduce((sum, t) => {
          const d = t.date;
          if (!d) return sum;
          // Only include targets up to the MTD cutoff date (selected date)
          if (d <= cutoffDateStr) return sum + Number(t.value || 0);
          return sum;
        }, 0);
        
        // If no budget exists, calculate as 10% more than previous year MTD (same day count)
        // This ensures 10% growth target and uses day-to-day MTD calculation
        if (budgetTurnover === 0 && prevYearTurnover > 0) {
          budgetTurnover = prevYearTurnover * 1.10; // 10% growth based on MTD
        }
        
        // Update main KPIs - ensure MTD headers (reset from daily view if needed)
        const currentHeaderEl = document.getElementById('dash-current-month-header');
        if (currentHeaderEl) currentHeaderEl.textContent = 'MTD TURNOVER';
        document.getElementById('dash-current-turnover-currency').textContent = 'R';
        document.getElementById('dash-current-turnover').textContent = currentTurnover > 0 ? fmtMoneyAmount(currentTurnover) : '—';
        
        const prevYear = parseInt(month.split('-')[0]) - 1;
        
        // Update budget header and value - also showing MTD (reset from daily view if needed)
        const budgetHeaderEl = document.getElementById('dash-budget-month-header');
        if (budgetHeaderEl) budgetHeaderEl.textContent = 'MTD Target';
        document.getElementById('dash-budget-turnover-currency').textContent = 'R';
        document.getElementById('dash-budget-turnover').textContent = budgetTurnover > 0 ? fmtMoneyAmount(budgetTurnover) : '—';
        
        // Update budget comparison: <mtd turnover-target> <above>/<under>
        const budgetComparisonEl = document.getElementById('dash-budget-turnover-comparison');
        const budgetPercentageEl = document.getElementById('dash-budget-turnover-percentage');
        if (budgetComparisonEl && budgetTurnover > 0 && currentTurnover > 0) {
          const difference = currentTurnover - budgetTurnover;
          const absDifference = Math.abs(difference);
          const direction = difference >= 0 ? 'above' : 'under';
          budgetComparisonEl.textContent = `R ${fmtMoneyAmount(absDifference)} ${direction}`;
          
          // Calculate and display percentage
          const budgetPercentage = (difference / budgetTurnover) * 100;
          if (budgetPercentageEl) {
            budgetPercentageEl.textContent = fmtPct(budgetPercentage);
            budgetPercentageEl.className = 'card-value-percentage ' + (budgetPercentage >= 0 ? 'positive' : 'negative');
          }
        } else {
          if (budgetComparisonEl) budgetComparisonEl.textContent = '—';
          if (budgetPercentageEl) {
            budgetPercentageEl.textContent = '';
            budgetPercentageEl.className = 'card-value-percentage';
          }
        }
        
        // Calculate growth metrics
        const momGrowth = prevMonthTurnover ? ((currentTurnover - prevMonthTurnover) / prevMonthTurnover) * 100 : null;
        const yoyGrowth = prevYearTurnover ? ((currentTurnover - prevYearTurnover) / prevYearTurnover) * 100 : null;
        
        // Display Y/Y percentage on current month card
        const percentageEl = document.getElementById('dash-current-turnover-percentage');
        if (yoyGrowth !== null) {
          percentageEl.textContent = fmtPct(yoyGrowth);
          percentageEl.className = 'card-value-percentage ' + (yoyGrowth >= 0 ? 'positive' : 'negative');
        } else {
          percentageEl.textContent = '';
          percentageEl.className = 'card-value-percentage';
        }
        
        // Update desktop comparison text "vs <previous year>: <previous year MTD Turnover>"
        const desktopComparisonEl = document.getElementById('dash-current-turnover-comparison');
        if (desktopComparisonEl) {
          if (prevYearTurnover > 0 && prevYear) {
            desktopComparisonEl.textContent = `vs ${prevYear}: R ${fmtMoneyAmount(prevYearTurnover)}`;
        } else {
            desktopComparisonEl.textContent = '—';
          }
        }
        
        // Update Purchases card
        document.getElementById('dash-purchases-value-currency').textContent = 'R';
        document.getElementById('dash-purchases-value').textContent = currentPurchases > 0 ? fmtMoneyAmount(currentPurchases) : '—';
        
        // Calculate Purchase Budget (75% of budget turnover)
        const purchaseBudget = budgetTurnover * 0.75;
        document.getElementById('dash-purchase-budget-currency').textContent = 'R';
        document.getElementById('dash-purchase-budget').textContent = purchaseBudget > 0 ? fmtMoneyAmount(Math.round(purchaseBudget)) : '—';
        
        // Update Purchases comparison: show Cost of Sales label
        const purchasesComparisonEl = document.getElementById('dash-purchases-comparison');
        if (purchasesComparisonEl && currentActualSpend > 0) {
          purchasesComparisonEl.textContent = `Cost of Sales: R ${fmtMoneyAmount(currentActualSpend)}`;
        } else if (purchasesComparisonEl) {
          purchasesComparisonEl.textContent = '—';
        }
        
        // Update Purchase Budget comparison: difference from purchases
        const purchaseBudgetComparisonEl = document.getElementById('dash-purchase-budget-comparison');
        const purchaseBudgetPercentageEl = document.getElementById('dash-purchase-budget-percentage');
        if (purchaseBudgetComparisonEl && purchaseBudget > 0 && currentPurchases > 0) {
          const purchaseBudgetDifference = currentPurchases - purchaseBudget;
          const absPurchaseBudgetDifference = Math.abs(purchaseBudgetDifference);
          const purchaseBudgetDirection = purchaseBudgetDifference >= 0 ? 'above' : 'under';
          purchaseBudgetComparisonEl.textContent = `R ${fmtMoneyAmount(absPurchaseBudgetDifference)} ${purchaseBudgetDirection}`;
          
          // Calculate and display percentage
          const purchaseBudgetPercentage = (purchaseBudgetDifference / purchaseBudget) * 100;
          if (purchaseBudgetPercentageEl) {
            purchaseBudgetPercentageEl.textContent = fmtPct(purchaseBudgetPercentage);
            purchaseBudgetPercentageEl.className = 'card-value-percentage ' + (purchaseBudgetPercentage < 0 ? 'positive' : 'negative');
          }
        } else {
          if (purchaseBudgetComparisonEl) purchaseBudgetComparisonEl.textContent = '—';
          if (purchaseBudgetPercentageEl) {
            purchaseBudgetPercentageEl.textContent = '';
            purchaseBudgetPercentageEl.className = 'card-value-percentage';
          }
        }
        
        // Update mobile combined card
        // Update mobile headers - ensure MTD headers (reset from daily view if needed)
        const mobileCurrentHeaderEl = document.getElementById('mobile-dash-current-month-header');
        if (mobileCurrentHeaderEl) mobileCurrentHeaderEl.textContent = 'MTD Turnover';
        const mobileBudgetHeaderEl = document.getElementById('mobile-dash-budget-month-header');
        if (mobileBudgetHeaderEl) mobileBudgetHeaderEl.textContent = 'MTD Target';
        document.getElementById('mobile-dash-current-turnover').textContent = fmtMoney(currentTurnover);
        document.getElementById('mobile-dash-budget-turnover').textContent = budgetTurnover > 0 ? fmtMoney(budgetTurnover) : '—';
        document.getElementById('mobile-dash-purchases-value').textContent = fmtMoney(currentPurchases);
        document.getElementById('mobile-dash-purchase-budget').textContent = purchaseBudget > 0 ? fmtMoney(Math.round(purchaseBudget)) : '—';
        
        // Update mobile Purchases comparison: show Cost of Sales label
        const mobilePurchasesComparisonEl = document.getElementById('mobile-dash-purchases-comparison');
        if (mobilePurchasesComparisonEl && currentActualSpend > 0) {
          mobilePurchasesComparisonEl.textContent = `Cost of Sales: R ${fmtMoneyAmount(currentActualSpend)}`;
        } else if (mobilePurchasesComparisonEl) {
          mobilePurchasesComparisonEl.textContent = '—';
        }
        
        // Update mobile Purchase Budget comparison and percentage
        const mobilePurchaseBudgetComparisonEl = document.getElementById('mobile-dash-purchase-budget-comparison');
        const mobilePurchaseBudgetPercentageEl = document.getElementById('mobile-dash-purchase-budget-percentage');
        if (mobilePurchaseBudgetComparisonEl && purchaseBudget > 0 && currentPurchases > 0) {
          const purchaseBudgetDifference = currentPurchases - purchaseBudget;
          const absPurchaseBudgetDifference = Math.abs(purchaseBudgetDifference);
          const purchaseBudgetDirection = purchaseBudgetDifference >= 0 ? 'above' : 'under';
          mobilePurchaseBudgetComparisonEl.textContent = `R ${fmtMoneyAmount(absPurchaseBudgetDifference)} ${purchaseBudgetDirection}`;
          
          // Calculate and display percentage
          const purchaseBudgetPercentage = (purchaseBudgetDifference / purchaseBudget) * 100;
          if (mobilePurchaseBudgetPercentageEl) {
            mobilePurchaseBudgetPercentageEl.textContent = fmtPct(purchaseBudgetPercentage);
            mobilePurchaseBudgetPercentageEl.className = 'combined-metric-comparison combined-metric-percentage ' + (purchaseBudgetPercentage < 0 ? 'positive' : 'negative');
          }
        } else {
          if (mobilePurchaseBudgetComparisonEl) mobilePurchaseBudgetComparisonEl.textContent = '—';
          if (mobilePurchaseBudgetPercentageEl) {
            mobilePurchaseBudgetPercentageEl.textContent = '';
            mobilePurchaseBudgetPercentageEl.className = 'combined-metric-comparison combined-metric-percentage';
          }
        }
        
        const mobilePercentageEl = document.getElementById('mobile-dash-current-turnover-percentage');
        if (yoyGrowth !== null) {
          mobilePercentageEl.textContent = fmtPct(yoyGrowth);
          mobilePercentageEl.className = 'combined-metric-comparison combined-metric-percentage ' + (yoyGrowth >= 0 ? 'positive' : 'negative');
        } else {
          mobilePercentageEl.textContent = '';
          mobilePercentageEl.className = 'combined-metric-comparison combined-metric-percentage';
        }
        
        // Update mobile comparison text "vs <previous year>: <previous year MTD Turnover>"
        const mobileComparisonEl = document.getElementById('mobile-dash-current-turnover-comparison');
        if (mobileComparisonEl) {
          if (prevYearTurnover > 0 && prevYear) {
            mobileComparisonEl.textContent = `vs ${prevYear}: R ${fmtMoneyAmount(prevYearTurnover)}`;
          } else {
            mobileComparisonEl.textContent = '—';
          }
        }
        
        // Update mobile MTD Target percentage and comparison
        const mobileBudgetPercentageEl = document.getElementById('mobile-dash-budget-turnover-percentage');
        const mobileBudgetComparisonEl = document.getElementById('mobile-dash-budget-turnover-comparison');
        if (budgetTurnover > 0 && currentTurnover > 0) {
          const budgetDifference = currentTurnover - budgetTurnover;
          const absBudgetDifference = Math.abs(budgetDifference);
          const budgetDirection = budgetDifference >= 0 ? 'above' : 'under';
          
          // Update percentage
          const budgetPercentage = (budgetDifference / budgetTurnover) * 100;
          if (mobileBudgetPercentageEl) {
            mobileBudgetPercentageEl.textContent = fmtPct(budgetPercentage);
            mobileBudgetPercentageEl.className = 'combined-metric-comparison combined-metric-percentage ' + (budgetPercentage >= 0 ? 'positive' : 'negative');
          }
          
          // Update comparison text
          if (mobileBudgetComparisonEl) {
            mobileBudgetComparisonEl.textContent = `R ${fmtMoneyAmount(absBudgetDifference)} ${budgetDirection}`;
          }
        } else {
          if (mobileBudgetPercentageEl) {
            mobileBudgetPercentageEl.textContent = '';
            mobileBudgetPercentageEl.className = 'combined-metric-comparison combined-metric-percentage';
          }
          if (mobileBudgetComparisonEl) {
            mobileBudgetComparisonEl.textContent = '—';
          }
        }
        
        // Update spend analytics
        updateSpendAnalytics(currentPurchases, purchaseBudget, currentTurnover, currentActualSpend);
        
        // Update budget performance circle
        if (budgetTurnover > 0) {
          const performance = (currentTurnover / budgetTurnover) * 100;
          const perfEl = document.getElementById('dash-budget-performance');
          if (perfEl) perfEl.textContent = Math.round(performance) + '%';
          
          const circle = document.getElementById('dash-progress-circle');
          if (circle) {
            const circumference = 2 * Math.PI * 60;
            const offset = circumference - (Math.min(performance, 100) / 100) * circumference;
            circle.style.strokeDashoffset = offset;
            
            if (performance >= 100) {
              circle.style.stroke = 'var(--statusSuccess)';
            } else if (performance >= 80) {
              circle.style.stroke = 'var(--accentPrimary)';
            } else {
              circle.style.stroke = 'var(--statusWarning)';
            }
          }
        } else {
          const perfEl = document.getElementById('dash-budget-performance');
          if (perfEl) perfEl.textContent = '—';
        }
      }
      
      // Update Spend Analytics section (used by both monthly and daily views)
      function updateSpendAnalytics(currentPurchases, purchaseBudget, currentTurnover, currentActualSpend) {
        // Update spend analysis bars
        const actualSpendEl = document.getElementById('dash-actual-spend');
        const purchasesEl = document.getElementById('dash-purchases');
        if (actualSpendEl) actualSpendEl.textContent = fmtMoney(currentActualSpend);
        if (purchasesEl) purchasesEl.textContent = fmtMoney(currentPurchases);
        
        const maxSpend = Math.max(currentActualSpend, currentPurchases);
        if (maxSpend > 0) {
          const actualBarEl = document.getElementById('dash-actual-bar');
          const purchasesBarEl = document.getElementById('dash-purchases-bar');
          if (actualBarEl) actualBarEl.style.width = (currentActualSpend / maxSpend * 100) + '%';
          if (purchasesBarEl) purchasesBarEl.style.width = (currentPurchases / maxSpend * 100) + '%';
        }
        
        const spendDiff = currentActualSpend - currentPurchases;
        const spendDiffEl = document.getElementById('dash-spend-diff');
        if (spendDiffEl) {
          if (spendDiff !== 0) {
            spendDiffEl.textContent = (spendDiff > 0 ? 'Under budget by ' : 'Over budget by ') + fmtNum(Math.abs(spendDiff));
            spendDiffEl.className = 'spend-diff ' + (spendDiff > 0 ? 'positive' : 'negative');
          } else {
            spendDiffEl.textContent = 'On budget';
            spendDiffEl.className = 'spend-diff';
          }
        }
        
        // Update Spend Analytics section three pie charts
        const circumference = 2 * Math.PI * 50; // ~314 for radius 50
        
        // Chart 1: Purchase vs Budget Spend (Green gradient)
        const budgetSegment = document.getElementById('spend-budget-chart-segment');
        const budgetPercentage = document.getElementById('spend-budget-percentage');
        if (budgetSegment && budgetPercentage && purchaseBudget > 0) {
          const purchaseVsBudgetPct = Math.round((currentPurchases / purchaseBudget) * 100);
          const visualPct = Math.min(purchaseVsBudgetPct, 100);
          const offset = circumference - (visualPct / 100) * circumference;
          budgetSegment.style.strokeDashoffset = offset;
          budgetPercentage.textContent = purchaseVsBudgetPct + '%';
          if (purchaseVsBudgetPct > 100) {
            budgetPercentage.style.color = 'var(--statusError)';
          } else {
            budgetPercentage.style.color = 'var(--textPrimary)';
          }
          
          const purchasesValueEl = document.getElementById('spend-budget-purchases-value');
          const budgetValueEl = document.getElementById('spend-budget-budget-value');
          const diffValueEl = document.getElementById('spend-budget-diff-value');
          const diffLabelEl = document.getElementById('spend-budget-diff-label');
          
          if (purchasesValueEl) {
            purchasesValueEl.textContent = currentPurchases > 0 ? 'R ' + fmtMoneyAmount(currentPurchases) : '—';
          }
          if (budgetValueEl) {
            budgetValueEl.textContent = purchaseBudget > 0 ? 'R ' + fmtMoneyAmount(Math.round(purchaseBudget)) : '—';
          }
          if (diffValueEl && diffLabelEl) {
            const diff = currentPurchases - purchaseBudget;
            const absDiff = Math.abs(diff);
            if (diff > 0) {
              diffLabelEl.textContent = 'Above Budget';
              diffValueEl.textContent = 'R ' + fmtMoneyAmount(absDiff);
              diffValueEl.style.color = 'var(--statusError)';
            } else if (diff < 0) {
              diffLabelEl.textContent = 'Below Budget';
              diffValueEl.textContent = 'R ' + fmtMoneyAmount(absDiff);
              diffValueEl.style.color = 'var(--statusSuccess)';
            } else {
              diffLabelEl.textContent = 'On Budget';
              diffValueEl.textContent = 'R 0';
              diffValueEl.style.color = 'var(--textPrimary)';
            }
          }
        } else if (budgetSegment && budgetPercentage) {
          budgetSegment.style.strokeDashoffset = circumference;
          budgetPercentage.textContent = '0%';
          budgetPercentage.style.color = 'var(--textPrimary)';
          
          const purchasesValueEl = document.getElementById('spend-budget-purchases-value');
          const budgetValueEl = document.getElementById('spend-budget-budget-value');
          const diffValueEl = document.getElementById('spend-budget-diff-value');
          const diffLabelEl = document.getElementById('spend-budget-diff-label');
          
          if (purchasesValueEl) purchasesValueEl.textContent = '—';
          if (budgetValueEl) budgetValueEl.textContent = '—';
          if (diffValueEl) diffValueEl.textContent = '—';
          if (diffLabelEl) diffLabelEl.textContent = 'Difference';
        }
        
        // Chart 2: Purchase vs Turnover (Orange gradient)
        const turnoverSegment = document.getElementById('spend-turnover-chart-segment');
        const turnoverPercentage = document.getElementById('spend-turnover-percentage');
        if (turnoverSegment && turnoverPercentage && currentTurnover > 0) {
          const purchaseVsTurnoverPct = Math.round((currentPurchases / currentTurnover) * 100);
          const visualPct = Math.min(purchaseVsTurnoverPct, 100);
          const offset = circumference - (visualPct / 100) * circumference;
          turnoverSegment.style.strokeDashoffset = offset;
          turnoverPercentage.textContent = purchaseVsTurnoverPct + '%';
          
          const purchasesValueEl = document.getElementById('spend-turnover-purchases-value');
          const turnoverValueEl = document.getElementById('spend-turnover-turnover-value');
          const percentageValueEl = document.getElementById('spend-turnover-percentage-value');
          
          if (purchasesValueEl) {
            purchasesValueEl.textContent = currentPurchases > 0 ? 'R ' + fmtMoneyAmount(currentPurchases) : '—';
          }
          if (turnoverValueEl) {
            turnoverValueEl.textContent = currentTurnover > 0 ? 'R ' + fmtMoneyAmount(currentTurnover) : '—';
          }
          if (percentageValueEl) {
            percentageValueEl.textContent = purchaseVsTurnoverPct + '%';
          }
        } else if (turnoverSegment && turnoverPercentage) {
          turnoverSegment.style.strokeDashoffset = circumference;
          turnoverPercentage.textContent = '0%';
          
          const purchasesValueEl = document.getElementById('spend-turnover-purchases-value');
          const turnoverValueEl = document.getElementById('spend-turnover-turnover-value');
          const percentageValueEl = document.getElementById('spend-turnover-percentage-value');
          
          if (purchasesValueEl) purchasesValueEl.textContent = '—';
          if (turnoverValueEl) turnoverValueEl.textContent = '—';
          if (percentageValueEl) percentageValueEl.textContent = '—';
        }
      }

      async function loadDailySummary() {
        console.log('loadDailySummary called, selectedDate:', selectedDate);
        if (!selectedDate || !selectedPharmacyId) {
          console.log('loadDailySummary aborted: missing selectedDate or phSidebarEl');
          return;
        }
        var pid = selectedPharmacyId;
        if (!pid) {
          console.log('loadDailySummary aborted: missing pid');
          return;
        }

        try {
          // Get the month from the selected date
          var month = selectedDate.slice(0, 7); // YYYY-MM
          console.log('Fetching data for month:', month, 'date:', selectedDate);
          
          // Get current month data
          const resp = await fetch(`/api/days?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(month)}`);
          if (!resp.ok) throw new Error('Failed to fetch');
          const data = await resp.json();
          
          // Find data for the selected date
          let selectedData = null;
          if (Array.isArray(data) && data.length > 0) {
            selectedData = data.find(d => d.business_date === selectedDate);
          }
          
          // Get previous year's corresponding weekday data
          let prevYearData = null;
          if (selectedDate) {
            prevYearData = await getPreviousYearWeekdayData(selectedDate, pid);
          }
          
          // Fetch GP breakdown if in split mode
          // For daily summary, use single date endpoint
          let gpBreakdown = null;
          if (gpViewMode === 'split') {
            try {
              const url = `/api/pharmacies/${encodeURIComponent(pid)}/days/${encodeURIComponent(selectedDate)}/gp-breakdown`;
              console.log('Fetching GP breakdown for daily split view...', {
                pid: pid,
                date: selectedDate,
                url: url
              });
              const gpBreakdownResp = await fetch(url);
              console.log('Daily GP breakdown response status:', gpBreakdownResp.status);
              if (gpBreakdownResp.ok) {
                gpBreakdown = await gpBreakdownResp.json();
                console.log('Daily GP breakdown data received:', gpBreakdown);
              } else {
                const errorText = await gpBreakdownResp.text();
                console.error('Daily GP breakdown API error:', gpBreakdownResp.status, errorText);
                gpBreakdown = {
                  dispensary: { gp_percentage: 0 },
                  frontshop: { gp_percentage: 0 },
                  error: 'Failed to fetch'
                };
              }
            } catch (e) {
              console.error('Failed to fetch daily GP breakdown:', e);
              // Set empty breakdown so split view still shows
              gpBreakdown = {
                dispensary: { gp_percentage: 0 },
                frontshop: { gp_percentage: 0 },
                error: 'Failed to fetch'
              };
            }
          }
          
          updateDailySummary(selectedData, selectedDate, prevYearData, gpBreakdown);
          
          // Also reload best sellers and worst GP products for the current date/pharmacy
          loadBestSellers();
          loadWorstGP();
        } catch (e) {
          console.error('Failed to load daily summary:', e);
          updateDailySummary(null, selectedDate, null, null);
        }
      }

      async function getPreviousYearWeekdayData(dateStr, pid) {
        try {
          // Parse the current date
          const currentDate = new Date(dateStr + 'T00:00:00');
          const currentWeekday = currentDate.getDay(); // 0 = Sunday, 1 = Monday, etc.
          
          // Calculate the previous year's corresponding weekday
          // Go back exactly 1 year to get the same weekday last year
          const prevYearDate = new Date(currentDate);
          prevYearDate.setFullYear(currentDate.getFullYear() - 1);
          
          // Ensure we have the correct weekday
          const weekdayDiff = prevYearDate.getDay() - currentWeekday;
          if (weekdayDiff !== 0) {
            prevYearDate.setDate(prevYearDate.getDate() - weekdayDiff);
          }
          
          const prevYearStr = formatYmdLocal(prevYearDate);
          const prevYearMonth = prevYearStr.slice(0, 7); // YYYY-MM
          
          console.log('Looking for previous year data:', {
            currentDate: dateStr,
            prevYearStr: prevYearStr,
            prevYearMonth: prevYearMonth
          });
          
          // Fetch the previous year's month data
          const resp = await fetch(`/api/days?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(prevYearMonth)}`);
          if (!resp.ok) return null;
          
          const data = await resp.json();
          if (!Array.isArray(data)) return null;
          
          console.log('Previous year month data:', data);
          
          // Find the data for the corresponding weekday
          const foundData = data.find(d => d.business_date === prevYearStr);
          console.log('Found data for', prevYearStr, ':', foundData);
          
          return foundData || null;
        } catch (e) {
          console.error('Failed to get previous year weekday data:', e);
          return null;
        }
      }
      function updateDailySummary(data, dateStr, prevYearData, gpBreakdown) {
        const dateObj = new Date(dateStr + 'T00:00:00');
        const formattedDate = dateObj.toLocaleDateString(undefined, { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
        
        // Update page subtitle with the selected date
        var pageSubtitleEl = document.getElementById('page-subtitle');
        if (pageSubtitleEl) {
          pageSubtitleEl.textContent = formattedDate;
        }
        
        if (!data) {
          // No data available
          document.getElementById('daily-turnover').textContent = '—';
          document.getElementById('daily-gp-percent').textContent = '—';
          document.getElementById('daily-purchases').textContent = '—';
          document.getElementById('daily-basket-value').textContent = '—';
          
          // Clear mobile card data
          document.getElementById('mobile-daily-turnover').textContent = '—';
          document.getElementById('mobile-daily-gp-percent').textContent = '—';
          document.getElementById('mobile-daily-purchases').textContent = '—';
          document.getElementById('mobile-daily-basket-value').textContent = '—';
          
          // Clear comparison data
          document.getElementById('daily-turnover-comparison-simple').textContent = '—';
          document.getElementById('daily-gp-value').textContent = '—';
          document.getElementById('daily-cost-of-sales').textContent = '—';
          document.getElementById('daily-transaction-count').textContent = '—';
          
          // Hide split view, show full view
          const dailyGpValueEl = document.getElementById('daily-gp-value');
          const dailyGpSplitEl = document.getElementById('daily-gp-split');
          const mobileDailyGpValueEl = document.getElementById('mobile-daily-gp-value');
          const mobileDailyGpSplitEl = document.getElementById('mobile-daily-gp-split');
          
          if (dailyGpValueEl) dailyGpValueEl.style.display = 'block';
          if (dailyGpSplitEl) dailyGpSplitEl.style.display = 'none';
          if (mobileDailyGpValueEl) mobileDailyGpValueEl.style.display = 'block';
          if (mobileDailyGpSplitEl) mobileDailyGpSplitEl.style.display = 'none';
          
          // Clear mobile comparison data
          document.getElementById('mobile-daily-turnover-comparison').textContent = '—';
          document.getElementById('mobile-daily-cost-of-sales').textContent = '—';
          document.getElementById('mobile-daily-transaction-count').textContent = '—';
          return;
        }
        
        // Log all available fields to help identify the correct field names
        console.log('Available data fields:', Object.keys(data));
        console.log('Full data object:', data);
        
        // Calculate metrics
        const turnover = Number(data.turnover || 0);
        const gpValue = Number(data.gp_value || 0);
        // Use GP% from API data (same as Daily tracking screen and GP chart)
        const gpPercent = (data.gp_pct !== undefined && data.gp_pct !== null) ? Number(data.gp_pct) : (turnover ? (gpValue / turnover) * 100 : 0);
        const purchases = Number(data.purchases || data.daily_purchases || data.purchases_value || 0);
        const costOfSales = turnover - gpValue; // Cost of sales = Turnover - GP Value
        
        // Try to get actual transaction count from various possible field names
        const transactionCount = Number(
          data.transaction_count || 
          data.transactions || 
          data.txn_count || 
          data.num_transactions ||
          data.sales_transactions ||
          0
        );
        
        // Calculate basket value
        let basketValue = 0;
        let displayTransactions = 0;
        
        if (transactionCount > 0) {
          // Use actual transaction count if available
          basketValue = turnover / transactionCount;
          displayTransactions = transactionCount;
          console.log('Using actual transaction count:', transactionCount);
        } else {
          // Fallback to estimation if no transaction count in data
          displayTransactions = Math.max(1, Math.round(turnover / 150)); // Assume average transaction ~R150
          basketValue = displayTransactions ? turnover / displayTransactions : 0;
          console.warn('No transaction count found in data, using estimation. Transactions estimated:', displayTransactions);
        }
        
        // Update cards
        document.getElementById('daily-turnover').textContent = fmtMoneyAmount(turnover);
        document.getElementById('daily-gp-percent').textContent = fmtPct(gpPercent);
        document.getElementById('daily-purchases').textContent = fmtMoneyAmount(purchases);
        document.getElementById('daily-basket-value').textContent = fmtMoneyAmount(basketValue);
        
        // Update mobile combined card
        document.getElementById('mobile-daily-turnover').textContent = fmtMoneyAmount(turnover);
        document.getElementById('mobile-daily-gp-percent').textContent = fmtPct(gpPercent);
        document.getElementById('mobile-daily-purchases').textContent = fmtMoneyAmount(purchases);
        document.getElementById('mobile-daily-basket-value').textContent = fmtMoneyAmount(basketValue);
        
        // Handle GP display based on view mode
        const isSplitView = gpViewMode === 'split';
        console.log('updateDailySummary - gpViewMode:', gpViewMode, 'isSplitView:', isSplitView, 'gpBreakdown:', gpBreakdown);
        
        const dailyGpValueEl = document.getElementById('daily-gp-value');
        const dailyGpSplitEl = document.getElementById('daily-gp-split');
        const mobileDailyGpValueEl = document.getElementById('mobile-daily-gp-value');
        const mobileDailyGpSplitEl = document.getElementById('mobile-daily-gp-split');
        
        console.log('Daily GP elements found:', {
          dailyGpValueEl: !!dailyGpValueEl,
          dailyGpSplitEl: !!dailyGpSplitEl,
          mobileDailyGpValueEl: !!mobileDailyGpValueEl,
          mobileDailyGpSplitEl: !!mobileDailyGpSplitEl
        });
        
        if (isSplitView) {
          // Show split view - API response has nested structure: dispensary.gp_percentage and frontshop.gp_percentage
          let dispensaryGpPercent = 0;
          let frontshopGpPercent = 0;
          
          if (gpBreakdown) {
            console.log('Processing GP breakdown:', gpBreakdown);
            // Extract from nested structure: { dispensary: { gp_percentage: ... }, frontshop: { gp_percentage: ... } }
            dispensaryGpPercent = Number(
              gpBreakdown.dispensary?.gp_percentage || 
              gpBreakdown.dispensary?.gp_percent ||
              gpBreakdown.dispensary_gp_percentage ||
              gpBreakdown.dispensary_gp_percent ||
              0
            );
            frontshopGpPercent = Number(
              gpBreakdown.frontshop?.gp_percentage || 
              gpBreakdown.frontshop?.gp_percent ||
              gpBreakdown.frontshop_gp_percentage ||
              gpBreakdown.frontshop_gp_percent ||
              0
            );
            console.log('Extracted GP percentages - Dispensary:', dispensaryGpPercent, 'Frontshop:', frontshopGpPercent);
          }
          
          // Hide full view, show split view
          if (dailyGpValueEl) {
            dailyGpValueEl.style.display = 'none';
            console.log('Hiding daily GP value element');
          }
          if (dailyGpSplitEl) {
            dailyGpSplitEl.style.display = 'block';
            console.log('Showing daily GP split element');
            const dispensaryEl = document.getElementById('daily-gp-dispensary');
            const frontshopEl = document.getElementById('daily-gp-frontshop');
            if (dispensaryEl) {
              dispensaryEl.textContent = dispensaryGpPercent > 0 
                ? `Dispensary: ${fmtPct(dispensaryGpPercent)}` 
                : 'Dispensary: —';
              console.log('Updated daily dispensary GP%:', dispensaryEl.textContent);
            }
            if (frontshopEl) {
              frontshopEl.textContent = frontshopGpPercent > 0 
                ? `Frontshop: ${fmtPct(frontshopGpPercent)}` 
                : 'Frontshop: —';
              console.log('Updated daily frontshop GP%:', frontshopEl.textContent);
            }
          }
          
          if (mobileDailyGpValueEl) {
            mobileDailyGpValueEl.style.display = 'none';
            console.log('Hiding mobile daily GP value element');
          }
          if (mobileDailyGpSplitEl) {
            mobileDailyGpSplitEl.style.display = 'block';
            console.log('Showing mobile daily GP split element');
            const dispensaryEl = document.getElementById('mobile-daily-gp-dispensary');
            const frontshopEl = document.getElementById('mobile-daily-gp-frontshop');
            if (dispensaryEl) {
              dispensaryEl.textContent = dispensaryGpPercent > 0 
                ? `Dispensary: ${fmtPct(dispensaryGpPercent)}` 
                : 'Dispensary: —';
              console.log('Updated mobile daily dispensary GP%:', dispensaryEl.textContent);
            }
            if (frontshopEl) {
              frontshopEl.textContent = frontshopGpPercent > 0 
                ? `Frontshop: ${fmtPct(frontshopGpPercent)}` 
                : 'Frontshop: —';
              console.log('Updated mobile daily frontshop GP%:', frontshopEl.textContent);
            }
          }
        } else {
          // Show full view
          console.log('Showing full GP view for daily summary');
          if (dailyGpValueEl) {
            dailyGpValueEl.style.display = 'block';
            dailyGpValueEl.textContent = `GP: R ${fmtMoneyAmount(gpValue)}`;
          }
          if (dailyGpSplitEl) dailyGpSplitEl.style.display = 'none';
          
          if (mobileDailyGpValueEl) {
            mobileDailyGpValueEl.style.display = 'block';
            mobileDailyGpValueEl.textContent = `GP: R ${fmtMoneyAmount(gpValue)}`;
          }
          if (mobileDailyGpSplitEl) mobileDailyGpSplitEl.style.display = 'none';
        }
        
        // Update cost of sales display
        document.getElementById('daily-cost-of-sales').textContent = `Cost of Sales: R ${fmtMoneyAmount(costOfSales)}`;
        
        // Update transaction count display
        document.getElementById('daily-transaction-count').textContent = `Transactions: ${displayTransactions}`;
        
        // Update mobile comparison displays
        document.getElementById('mobile-daily-cost-of-sales').textContent = `Cost of Sales: R ${fmtMoneyAmount(costOfSales)}`;
        document.getElementById('mobile-daily-transaction-count').textContent = `Transactions: ${displayTransactions}`;
        
        // Update dispensary data
        updateDispensaryData(data, prevYearData);
        
        // Update turnover comparison
        updateTurnoverComparison(turnover, prevYearData);
      }
      
      function updateDispensaryData(data, prevYearData) {
        if (!data) {
          document.getElementById('dispensary-scripts').textContent = '—';
          document.getElementById('dispensary-avg-script').textContent = '—';
          const scriptsM = document.getElementById('dispensary-scripts-mobile');
          const avgScriptM = document.getElementById('dispensary-avg-script-mobile');
          if (scriptsM) scriptsM.textContent = '—';
          if (avgScriptM) avgScriptM.textContent = '—';
          document.getElementById('dispensary-value').textContent = '—';
          document.getElementById('frontshop-value').textContent = '—';
          
          // Clear percentage values
          document.documentElement.style.setProperty('--dispensary-percentage-angle', '0deg');
          return;
        }
        
        // Get scripts count from correct field
        const scripts = Number(data.scripts_qty || 0);
        
        // Get sales breakdown using the correct turnover fields
        const dispensarySales = Number(data.dispensary_turnover || 0);
        const frontShopSales = Number(data.frontshop_turnover || 0);
        
        // Use pre-calculated average script value from database, or calculate if not available
        const avgScriptValue = Number(data.avg_script_value || 0) || (scripts > 0 ? dispensarySales / scripts : 0);
        
        // Update scripts count
        document.getElementById('dispensary-scripts').textContent = scripts || '—';
        const scriptsM = document.getElementById('dispensary-scripts-mobile');
        if (scriptsM) scriptsM.textContent = scripts || '—';
        
        // Update average script value (just the number, no "R ")
        document.getElementById('dispensary-avg-script').textContent = avgScriptValue > 0 ? fmtMoneyAmount(avgScriptValue) : '—';
        const avgScriptM = document.getElementById('dispensary-avg-script-mobile');
        if (avgScriptM) avgScriptM.textContent = avgScriptValue > 0 ? fmtMoneyAmount(avgScriptValue) : '—';
        
        // Update dispensary and front shop values (just the numbers, no "R ")
        document.getElementById('dispensary-value').textContent = fmtMoneyAmount(dispensarySales);
        document.getElementById('frontshop-value').textContent = fmtMoneyAmount(frontShopSales);
        
        // Calculate and update percentages for small circles and donut chart
        const totalSales = dispensarySales + frontShopSales;
        if (totalSales > 0) {
          const dispensaryPercent = Math.round((dispensarySales / totalSales) * 100);
          
          // Update CSS custom property for conic gradient (for small circles)
          const dispensaryAngle = (dispensaryPercent / 100) * 360;
          document.documentElement.style.setProperty('--dispensary-percentage-angle', dispensaryAngle + 'deg');
          
          // Update donut chart
          const chartSegment = document.querySelector('.metric-split .chart-segment');
          const percentageElement = document.getElementById('dispensary-percentage');
          
          if (chartSegment && percentageElement) {
            // Calculate dash offset for donut chart (circumference is ~314 for radius 50)
            const circumference = 2 * Math.PI * 50; // ~314
            const offset = circumference - (dispensaryPercent / 100) * circumference;
            
            // Animate the chart
            chartSegment.style.strokeDashoffset = offset;
            percentageElement.textContent = dispensaryPercent + '%';
          }
        } else {
          // No sales data
          document.documentElement.style.setProperty('--dispensary-percentage-angle', '0deg');
          
          const chartSegment = document.querySelector('.metric-split .chart-segment');
          const percentageElement = document.getElementById('dispensary-percentage');
          
          if (chartSegment && percentageElement) {
            chartSegment.style.strokeDashoffset = '314';
            percentageElement.textContent = '0%';
          }
        }
      }
      
      function updateTurnoverComparison(currentTurnover, prevYearData) {
        const comparisonEl = document.getElementById('daily-turnover-comparison-simple');
        
        if (!prevYearData) {
          comparisonEl.textContent = 'No previous year data';
          const mobileComparisonEl = document.getElementById('mobile-daily-turnover-comparison');
          if (mobileComparisonEl) {
            mobileComparisonEl.textContent = 'No previous year data';
          }
          return;
        }
        
        // Check for turnover value (could be 0, which is valid)
        const prevYearTurnover = Number(prevYearData.turnover || 0);
        if (isNaN(prevYearTurnover)) {
          comparisonEl.textContent = 'No previous year data';
          const mobileComparisonEl = document.getElementById('mobile-daily-turnover-comparison');
          if (mobileComparisonEl) {
            mobileComparisonEl.textContent = 'No previous year data';
          }
          return;
        }
        
        const prevYearDate = new Date(prevYearData.business_date + 'T00:00:00');
        const prevYearFormatted = prevYearDate.getFullYear().toString();
        
        // Calculate percentage difference
        let percentage = 0;
        if (prevYearTurnover > 0) {
          percentage = ((currentTurnover - prevYearTurnover) / prevYearTurnover) * 100;
        }
        
        // Create simplified comparison text with inline percentage
        let percentageText = '';
        let percentageClass = '';
        
        if (percentage > 0) {
          percentageText = `+${percentage.toFixed(1)}%`;
          percentageClass = 'positive';
        } else if (percentage < 0) {
          percentageText = `${percentage.toFixed(1)}%`;
          percentageClass = 'negative';
        } else {
          percentageText = '0.0%';
          percentageClass = '';
        }
        
        // Update with simplified format: "vs Thu, Oct 24: R 42 150 +15.2%"
        comparisonEl.innerHTML = `vs ${prevYearFormatted}: R ${fmtMoneyAmount(prevYearTurnover)} <span class="comparison-percentage ${percentageClass}">${percentageText}</span>`;
        
        // Update mobile comparison
        const mobileComparisonEl = document.getElementById('mobile-daily-turnover-comparison');
        if (mobileComparisonEl) {
          mobileComparisonEl.innerHTML = `vs ${prevYearFormatted}: R ${fmtMoneyAmount(prevYearTurnover)} <span class="comparison-percentage ${percentageClass}">${percentageText}</span>`;
        }
      }

      async function loadMonthlySummary() {
        console.log('loadMonthlySummary called, selectedDate:', selectedDate);
        if (!selectedDate || !selectedPharmacyId) {
          console.log('loadMonthlySummary aborted: missing selectedDate or selectedPharmacyId');
          return;
        }
        var pid = selectedPharmacyId;
        if (!pid) {
          console.log('loadMonthlySummary aborted: missing pid');
          return;
        }

        try {
          // Get the month from the selected date
          var month = selectedDate.slice(0, 7); // YYYY-MM
          console.log('Fetching month-to-date data for month:', month, 'through:', selectedDate);
          
          // Get current month-to-date data using efficient MTD endpoint
          const resp = await fetch(`/api/mtd?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(month)}&through=${encodeURIComponent(selectedDate)}`);
          if (!resp.ok) throw new Error('Failed to fetch MTD data');
          const mtdData = await resp.json();
          
          console.log('Month-to-date data:', mtdData);
          
          // Get previous year's month-to-date data for comparison
          let prevYearMtdData = null;
          if (selectedDate) {
            prevYearMtdData = await getPreviousYearMonthToDateData(selectedDate, pid);
          }
          
          // Fetch GP breakdown if in split mode
          // For monthly summary, use date range endpoint (from first day of month to selected date)
          let gpBreakdown = null;
          if (gpViewMode === 'split') {
            try {
              const fromDate = selectedDate.slice(0, 8) + '01'; // First day of month
              const toDate = selectedDate;
              const url = `/api/pharmacies/${encodeURIComponent(pid)}/days/gp-breakdown?from=${encodeURIComponent(fromDate)}&to=${encodeURIComponent(toDate)}`;
              console.log('Fetching GP breakdown for monthly split view...', {
                pid: pid,
                fromDate: fromDate,
                toDate: toDate,
                url: url
              });
              const gpBreakdownResp = await fetch(url);
              console.log('Monthly GP breakdown response status:', gpBreakdownResp.status);
              if (gpBreakdownResp.ok) {
                gpBreakdown = await gpBreakdownResp.json();
                console.log('Monthly GP breakdown data received:', gpBreakdown);
              } else {
                const errorText = await gpBreakdownResp.text();
                console.error('Monthly GP breakdown API error:', gpBreakdownResp.status, errorText);
                gpBreakdown = {
                  dispensary: { gp_percentage: 0 },
                  frontshop: { gp_percentage: 0 },
                  error: 'Failed to fetch'
                };
              }
            } catch (e) {
              console.error('Failed to fetch monthly GP breakdown:', e);
              // Set empty breakdown so split view still shows
              gpBreakdown = {
                dispensary: { gp_percentage: 0 },
                frontshop: { gp_percentage: 0 },
                error: 'Failed to fetch'
              };
            }
          }
          
          updateMonthlySummary(mtdData, selectedDate, prevYearMtdData, gpBreakdown);
          
          // Also reload best sellers and worst GP products for the current date/pharmacy
          // Note: Best sellers and worst GP are still based on the selected date, not month-to-date
          loadBestSellers();
          loadWorstGP();
        } catch (e) {
          console.error('Failed to load monthly summary:', e);
          updateMonthlySummary(null, selectedDate, null, null);
        }
      }

      async function fetchGPBreakdown(pid, date) {
        try {
          const resp = await fetch(`/api/pharmacies/${encodeURIComponent(pid)}/days/${encodeURIComponent(date)}/gp-breakdown`);
          if (!resp.ok) return null;
          return await resp.json();
        } catch (e) {
          console.error('Failed to fetch GP breakdown:', e);
          return null;
        }
      }

      function initializeGPToggle() {
        const monthlyDesktopToggle = document.getElementById('monthly-gp-toggle');
        const monthlyMobileToggle = document.getElementById('mobile-monthly-gp-toggle');
        const dailyDesktopToggle = document.getElementById('daily-gp-toggle');
        const dailyMobileToggle = document.getElementById('mobile-daily-gp-toggle');
        
        function updateAllToggleStates() {
          const toggles = [
            monthlyDesktopToggle,
            monthlyMobileToggle,
            dailyDesktopToggle,
            dailyMobileToggle
          ];
          
          toggles.forEach(toggle => {
            if (toggle) {
              toggle.setAttribute('data-mode', gpViewMode);
              const labelEl = toggle.querySelector('.gp-toggle-label');
              if (labelEl) {
                labelEl.textContent = gpViewMode === 'full' ? 'Full' : 'Split';
              }
            }
          });
        }
        
        function handleToggle(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const oldMode = gpViewMode;
          gpViewMode = gpViewMode === 'full' ? 'split' : 'full';
          console.log('GP toggle clicked - changing from', oldMode, 'to', gpViewMode);
          
          // Update all toggle button states
          updateAllToggleStates();
          
          // Reload the appropriate summary based on current view mode
          // Check which tab is currently visible to determine which summary to reload
          const monthlySummaryTab = document.getElementById('tab-monthly-summary');
          const dailySummaryTab = document.getElementById('tab-daily-summary');
          const isMonthlyTabVisible = monthlySummaryTab && !monthlySummaryTab.hidden;
          const isDailyTabVisible = dailySummaryTab && !dailySummaryTab.hidden;
          
          console.log('GP Toggle - Tab visibility - Monthly:', isMonthlyTabVisible, 'Daily:', isDailyTabVisible, 'summaryViewMode:', summaryViewMode, 'gpViewMode:', gpViewMode);
          
          if (selectedDate && selectedPharmacyId) {
            // Prioritize tab visibility over summaryViewMode
            if (isDailyTabVisible) {
              console.log('Daily tab visible - Reloading daily summary with gpViewMode:', gpViewMode);
              loadDailySummary();
            } else if (isMonthlyTabVisible) {
              console.log('Monthly tab visible - Reloading monthly summary with gpViewMode:', gpViewMode);
              loadMonthlySummary();
            } else if (summaryViewMode === 'daily') {
              console.log('summaryViewMode is daily - Reloading daily summary with gpViewMode:', gpViewMode);
              loadDailySummary();
            } else if (summaryViewMode === 'monthly') {
              console.log('summaryViewMode is monthly - Reloading monthly summary with gpViewMode:', gpViewMode);
              loadMonthlySummary();
            } else {
              console.log('Neither tab visible and no summaryViewMode, trying both...');
              // If we can't determine, try both
              loadMonthlySummary();
              loadDailySummary();
            }
          } else {
            console.log('Not reloading - selectedDate:', selectedDate, 'selectedPharmacyId:', selectedPharmacyId);
          }
        }
        
        // Initialize monthly toggles
        if (monthlyDesktopToggle) {
          monthlyDesktopToggle.addEventListener('click', handleToggle);
          console.log('Monthly desktop GP toggle initialized');
        } else {
          console.warn('Monthly desktop GP toggle element not found');
        }
        if (monthlyMobileToggle) {
          monthlyMobileToggle.addEventListener('click', handleToggle);
          console.log('Monthly mobile GP toggle initialized');
        } else {
          console.warn('Monthly mobile GP toggle element not found');
        }
        
        // Initialize daily toggles
        if (dailyDesktopToggle) {
          dailyDesktopToggle.addEventListener('click', handleToggle);
          console.log('Daily desktop GP toggle initialized');
        } else {
          console.warn('Daily desktop GP toggle element not found');
        }
        if (dailyMobileToggle) {
          dailyMobileToggle.addEventListener('click', handleToggle);
          console.log('Daily mobile GP toggle initialized');
        } else {
          console.warn('Daily mobile GP toggle element not found');
        }
        
        // Set initial state for all toggles
        updateAllToggleStates();
      }

      async function getPreviousYearMonthToDateData(dateStr, pid) {
        try {
          // Parse the current date
          const currentDate = new Date(dateStr + 'T00:00:00');
          
          // Calculate the previous year's same date
          const prevYearDate = new Date(currentDate);
          prevYearDate.setFullYear(currentDate.getFullYear() - 1);
          
          const prevYearDateStr = formatYmdLocal(prevYearDate);
          const prevYearMonth = prevYearDateStr.slice(0, 7); // YYYY-MM
          
          console.log('Looking for previous year month-to-date data:', {
            currentDate: dateStr,
            prevYearMonth: prevYearMonth,
            throughDate: prevYearDateStr
          });
          
          // Fetch the previous year's MTD data using efficient endpoint
          const resp = await fetch(`/api/mtd?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(prevYearMonth)}&through=${encodeURIComponent(prevYearDateStr)}`);
          if (!resp.ok) return null;
          
          const data = await resp.json();
          console.log('Previous year MTD data:', data);
          
          return data;
        } catch (e) {
          console.error('Failed to get previous year month-to-date data:', e);
          return null;
        }
      }

      function updateMonthlySummary(mtdData, dateStr, prevYearMtdData, gpBreakdown) {
        const dateObj = new Date(dateStr + 'T00:00:00');
        
        // Update page subtitle with the month-to-date range
        var pageSubtitleEl = document.getElementById('page-subtitle');
        if (pageSubtitleEl) {
          const month = dateObj.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
          pageSubtitleEl.textContent = `${month} (1 - ${dateObj.getDate()})`;
        }
        
        if (!mtdData) {
          // No data available
          document.getElementById('monthly-turnover').textContent = '—';
          document.getElementById('monthly-gp-percent').textContent = '—';
          document.getElementById('monthly-purchases').textContent = '—';
          document.getElementById('monthly-basket-value').textContent = '—';
          
          // Clear mobile card data
          document.getElementById('mobile-monthly-turnover').textContent = '—';
          document.getElementById('mobile-monthly-gp-percent').textContent = '—';
          document.getElementById('mobile-monthly-purchases').textContent = '—';
          document.getElementById('mobile-monthly-basket-value').textContent = '—';
          
          // Clear comparison data
          document.getElementById('monthly-turnover-comparison-simple').textContent = '—';
          document.getElementById('monthly-gp-value').textContent = '—';
          document.getElementById('monthly-cost-of-sales').textContent = '—';
          document.getElementById('monthly-transaction-count').textContent = '—';
          
          // Hide split view, show full view
          const monthlyGpValueEl = document.getElementById('monthly-gp-value');
          const monthlyGpSplitEl = document.getElementById('monthly-gp-split');
          const mobileGpValueEl = document.getElementById('mobile-monthly-gp-value');
          const mobileGpSplitEl = document.getElementById('mobile-monthly-gp-split');
          
          if (monthlyGpValueEl) monthlyGpValueEl.style.display = 'block';
          if (monthlyGpSplitEl) monthlyGpSplitEl.style.display = 'none';
          if (mobileGpValueEl) mobileGpValueEl.style.display = 'block';
          if (mobileGpSplitEl) mobileGpSplitEl.style.display = 'none';
          
          // Clear mobile comparison data
          document.getElementById('mobile-monthly-turnover-comparison').textContent = '—';
          document.getElementById('mobile-monthly-cost-of-sales').textContent = '—';
          document.getElementById('mobile-monthly-transaction-count').textContent = '—';
          return;
        }
        
        // Extract pre-aggregated data from MTD endpoint
        const turnover = Number(mtdData.turnover || 0);
        const gpValue = Number(mtdData.gp_value || 0);
        const costOfSales = Number(mtdData.cost_of_sales || 0);
        const purchases = Number(mtdData.purchases || 0);
        const transactionCount = Number(mtdData.transaction_count || 0);
        const avgBasket = Number(mtdData.avg_basket || 0);
        const dispensarySales = Number(mtdData.dispensary_turnover || 0);
        const scripts = Number(mtdData.scripts_qty || 0);
        const dispPct = Number(mtdData.disp_pct || 0);
        
        // Calculate front shop sales (total - dispensary)
        const frontShopSales = turnover - dispensarySales;
        
        console.log('MTD data received:', {
          turnover,
          gpValue,
          costOfSales,
          purchases,
          transactionCount,
          avgBasket,
          dispensarySales,
          frontShopSales,
          scripts,
          dispPct
        });
        
        // Calculate GP%
        const gpPercent = turnover ? (gpValue / turnover) * 100 : 0;
        
        // Use provided avg_basket or calculate if not available
        let basketValue = avgBasket;
        let displayTransactions = transactionCount;
        
        if (basketValue === 0 && transactionCount > 0 && turnover > 0) {
          basketValue = turnover / transactionCount;
        } else if (basketValue === 0 && transactionCount === 0) {
          // Fallback to estimation if no transaction count in data
          displayTransactions = Math.max(1, Math.round(turnover / 150)); // Assume average transaction ~R150
          basketValue = displayTransactions ? turnover / displayTransactions : 0;
          console.warn('No transaction count found in data, using estimation. Transactions estimated:', displayTransactions);
        }
        
        // Update cards
        document.getElementById('monthly-turnover').textContent = fmtMoneyAmount(turnover);
        document.getElementById('monthly-gp-percent').textContent = fmtPct(gpPercent);
        document.getElementById('monthly-purchases').textContent = fmtMoneyAmount(purchases);
        document.getElementById('monthly-basket-value').textContent = fmtMoneyAmount(basketValue);
        
        // Update mobile combined card
        document.getElementById('mobile-monthly-turnover').textContent = fmtMoneyAmount(turnover);
        document.getElementById('mobile-monthly-gp-percent').textContent = fmtPct(gpPercent);
        document.getElementById('mobile-monthly-purchases').textContent = fmtMoneyAmount(purchases);
        document.getElementById('mobile-monthly-basket-value').textContent = fmtMoneyAmount(basketValue);
        
        // Handle GP display based on view mode
        const isSplitView = gpViewMode === 'split';
        console.log('updateMonthlySummary - gpViewMode:', gpViewMode, 'isSplitView:', isSplitView, 'gpBreakdown:', gpBreakdown);
        
        const monthlyGpValueEl = document.getElementById('monthly-gp-value');
        const monthlyGpSplitEl = document.getElementById('monthly-gp-split');
        const mobileGpValueEl = document.getElementById('mobile-monthly-gp-value');
        const mobileGpSplitEl = document.getElementById('mobile-monthly-gp-split');
        
        console.log('Monthly GP elements found:', {
          monthlyGpValueEl: !!monthlyGpValueEl,
          monthlyGpSplitEl: !!monthlyGpSplitEl,
          mobileGpValueEl: !!mobileGpValueEl,
          mobileGpSplitEl: !!mobileGpSplitEl
        });
        
        if (isSplitView) {
          // Show split view - API response has nested structure: dispensary.gp_percentage and frontshop.gp_percentage
          let dispensaryGpPercent = 0;
          let frontshopGpPercent = 0;
          
          if (gpBreakdown) {
            console.log('Processing monthly GP breakdown:', gpBreakdown);
            // Extract from nested structure: { dispensary: { gp_percentage: ... }, frontshop: { gp_percentage: ... } }
            dispensaryGpPercent = Number(
              gpBreakdown.dispensary?.gp_percentage || 
              gpBreakdown.dispensary?.gp_percent ||
              gpBreakdown.dispensary_gp_percentage ||
              gpBreakdown.dispensary_gp_percent ||
              0
            );
            frontshopGpPercent = Number(
              gpBreakdown.frontshop?.gp_percentage || 
              gpBreakdown.frontshop?.gp_percent ||
              gpBreakdown.frontshop_gp_percentage ||
              gpBreakdown.frontshop_gp_percent ||
              0
            );
            console.log('Monthly - Extracted GP percentages - Dispensary:', dispensaryGpPercent, 'Frontshop:', frontshopGpPercent);
          } else {
            console.warn('Monthly GP breakdown is null or undefined');
          }
          
          // Hide full view, show split view
          if (monthlyGpValueEl) {
            monthlyGpValueEl.style.display = 'none';
            console.log('Hiding monthly GP value element');
          }
          if (monthlyGpSplitEl) {
            monthlyGpSplitEl.style.display = 'block';
            console.log('Showing monthly GP split element');
            const dispensaryEl = document.getElementById('monthly-gp-dispensary');
            const frontshopEl = document.getElementById('monthly-gp-frontshop');
            if (dispensaryEl) {
              dispensaryEl.textContent = dispensaryGpPercent > 0 
                ? `Dispensary: ${fmtPct(dispensaryGpPercent)}` 
                : 'Dispensary: —';
              console.log('Updated monthly dispensary GP%:', dispensaryEl.textContent);
            }
            if (frontshopEl) {
              frontshopEl.textContent = frontshopGpPercent > 0 
                ? `Frontshop: ${fmtPct(frontshopGpPercent)}` 
                : 'Frontshop: —';
              console.log('Updated monthly frontshop GP%:', frontshopEl.textContent);
            }
          }
          
          if (mobileGpValueEl) {
            mobileGpValueEl.style.display = 'none';
            console.log('Hiding mobile monthly GP value element');
          }
          if (mobileGpSplitEl) {
            mobileGpSplitEl.style.display = 'block';
            console.log('Showing mobile monthly GP split element');
            const dispensaryEl = document.getElementById('mobile-monthly-gp-dispensary');
            const frontshopEl = document.getElementById('mobile-monthly-gp-frontshop');
            if (dispensaryEl) {
              dispensaryEl.textContent = dispensaryGpPercent > 0 
                ? `Dispensary: ${fmtPct(dispensaryGpPercent)}` 
                : 'Dispensary: —';
              console.log('Updated mobile monthly dispensary GP%:', dispensaryEl.textContent);
            }
            if (frontshopEl) {
              frontshopEl.textContent = frontshopGpPercent > 0 
                ? `Frontshop: ${fmtPct(frontshopGpPercent)}` 
                : 'Frontshop: —';
              console.log('Updated mobile monthly frontshop GP%:', frontshopEl.textContent);
            }
          }
        } else {
          // Show full view
          if (monthlyGpValueEl) {
            monthlyGpValueEl.style.display = 'block';
            monthlyGpValueEl.textContent = `GP: R ${fmtMoneyAmount(gpValue)}`;
          }
          if (monthlyGpSplitEl) monthlyGpSplitEl.style.display = 'none';
          
          if (mobileGpValueEl) {
            mobileGpValueEl.style.display = 'block';
            mobileGpValueEl.textContent = `GP: R ${fmtMoneyAmount(gpValue)}`;
          }
          if (mobileGpSplitEl) mobileGpSplitEl.style.display = 'none';
        }
        
        // Update cost of sales display
        document.getElementById('monthly-cost-of-sales').textContent = `Cost of Sales: R ${fmtMoneyAmount(costOfSales)}`;
        
        // Update transaction count display
        document.getElementById('monthly-transaction-count').textContent = `Transactions: ${displayTransactions}`;
        
        // Update mobile comparison displays
        document.getElementById('mobile-monthly-cost-of-sales').textContent = `Cost of Sales: R ${fmtMoneyAmount(costOfSales)}`;
        document.getElementById('mobile-monthly-transaction-count').textContent = `Transactions: ${displayTransactions}`;
        
        // Update dispensary data
        updateMonthlyDispensaryData(dispensarySales, frontShopSales, scripts);
        
        // Update turnover comparison
        updateMonthlyTurnoverComparison(turnover, prevYearMtdData);
      }
      
      function updateMonthlyDispensaryData(dispensarySales, frontShopSales, scripts) {
        // Calculate average script value
        const avgScriptValue = scripts > 0 ? dispensarySales / scripts : 0;
        
        // Update scripts count
        document.getElementById('monthly-dispensary-scripts').textContent = scripts || '—';
        const scriptsM = document.getElementById('monthly-dispensary-scripts-mobile');
        if (scriptsM) scriptsM.textContent = scripts || '—';
        
        // Update average script value
        document.getElementById('monthly-dispensary-avg-script').textContent = avgScriptValue > 0 ? fmtMoneyAmount(avgScriptValue) : '—';
        const avgScriptM = document.getElementById('monthly-dispensary-avg-script-mobile');
        if (avgScriptM) avgScriptM.textContent = avgScriptValue > 0 ? fmtMoneyAmount(avgScriptValue) : '—';
        
        // Update dispensary and front shop values
        document.getElementById('monthly-dispensary-value').textContent = fmtMoneyAmount(dispensarySales);
        document.getElementById('monthly-frontshop-value').textContent = fmtMoneyAmount(frontShopSales);
        
        // Calculate and update percentages for donut chart
        const totalSales = dispensarySales + frontShopSales;
        if (totalSales > 0) {
          const dispensaryPercent = Math.round((dispensarySales / totalSales) * 100);
          
          // Update donut chart
          const chartSegment = document.getElementById('monthly-chart-segment');
          const percentageElement = document.getElementById('monthly-dispensary-percentage');
          
          if (chartSegment && percentageElement) {
            // Calculate dash offset for donut chart (circumference is ~314 for radius 50)
            const circumference = 2 * Math.PI * 50; // ~314
            const offset = circumference - (dispensaryPercent / 100) * circumference;
            
            // Animate the chart
            chartSegment.style.strokeDashoffset = offset;
            percentageElement.textContent = dispensaryPercent + '%';
          }
        } else {
          // No sales data
          const chartSegment = document.getElementById('monthly-chart-segment');
          const percentageElement = document.getElementById('monthly-dispensary-percentage');
          
          if (chartSegment && percentageElement) {
            chartSegment.style.strokeDashoffset = '314';
            percentageElement.textContent = '0%';
          }
        }
      }
      
      function updateMonthlyTurnoverComparison(currentTurnover, prevYearMtdData) {
        const comparisonEl = document.getElementById('monthly-turnover-comparison-simple');
        
        if (!prevYearMtdData) {
          comparisonEl.textContent = 'No previous year data';
          const mobileComparisonEl = document.getElementById('mobile-monthly-turnover-comparison');
          if (mobileComparisonEl) {
            mobileComparisonEl.textContent = 'No previous year data';
          }
          return;
        }
        
        // Get previous year turnover from MTD data
        const prevYearTurnover = Number(prevYearMtdData.turnover || 0);
        
        if (isNaN(prevYearTurnover) || prevYearTurnover === 0) {
          comparisonEl.textContent = 'No previous year data';
          const mobileComparisonEl = document.getElementById('mobile-monthly-turnover-comparison');
          if (mobileComparisonEl) {
            mobileComparisonEl.textContent = 'No previous year data';
          }
          return;
        }
        
        // Calculate the previous year (current year - 1)
        const currentYear = new Date().getFullYear();
        const prevYear = currentYear - 1;
        
        // Calculate percentage difference
        let percentage = 0;
        if (prevYearTurnover > 0) {
          percentage = ((currentTurnover - prevYearTurnover) / prevYearTurnover) * 100;
        }
        
        // Create simplified comparison text with inline percentage
        let percentageText = '';
        let percentageClass = '';
        
        if (percentage > 0) {
          percentageText = `+${percentage.toFixed(1)}%`;
          percentageClass = 'positive';
        } else if (percentage < 0) {
          percentageText = `${percentage.toFixed(1)}%`;
          percentageClass = 'negative';
        } else {
          percentageText = '0.0%';
          percentageClass = '';
        }
        
        // Update with simplified format
        comparisonEl.innerHTML = `vs ${prevYear}: R ${fmtMoneyAmount(prevYearTurnover)} <span class="comparison-percentage ${percentageClass}">${percentageText}</span>`;
        
        // Update mobile comparison
        const mobileComparisonEl = document.getElementById('mobile-monthly-turnover-comparison');
        if (mobileComparisonEl) {
          mobileComparisonEl.innerHTML = `vs ${prevYear}: R ${fmtMoneyAmount(prevYearTurnover)} <span class="comparison-percentage ${percentageClass}">${percentageText}</span>`;
        }
      }

      // Summary view toggle handlers
      function bindSummaryViewToggle() {
        var monthlyBtn = document.getElementById('summary-view-monthly');
        var dailyBtn = document.getElementById('summary-view-daily');
        
        if (monthlyBtn) {
          monthlyBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Monthly toggle clicked');
            summaryViewMode = 'monthly';
            // Set selectedDate to yesterday for monthly view (for accurate MTD data)
            selectedDate = getYesterdayDate();
            updateDateDisplay();
            monthlyBtn.classList.add('active');
            if (dailyBtn) dailyBtn.classList.remove('active');
            loadDashboard();
            // Reload group view if enabled
            if (groupViewEnabled) {
              loadGroupViewData();
            }
          });
        }
        
        if (dailyBtn) {
          dailyBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Daily toggle clicked, summaryViewMode set to:', 'daily');
            summaryViewMode = 'daily';
            // Set selectedDate to today for daily view
            selectedDate = formatYmdLocal(new Date());
            updateDateDisplay();
            dailyBtn.classList.add('active');
            if (monthlyBtn) monthlyBtn.classList.remove('active');
            loadDashboard();
            // Reload group view if enabled
            if (groupViewEnabled) {
              loadGroupViewData();
            }
          });
        }
      }
      
      // Initialize toggle on page load (run after DOM is ready)
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          bindSummaryViewToggle();
          initializeGPToggle();
        });
      } else {
        bindSummaryViewToggle();
        initializeGPToggle();
      }

      monthEl && monthEl.addEventListener('change', function(){
        // Reload group view data if group view is enabled
        if (groupViewEnabled) {
          loadGroupViewData();
        }
        loadDays();
        var targetsHidden = document.getElementById('tab-targets').hidden;
        var dashboardHidden = document.getElementById('tab-dashboard').hidden;
        var dailySummaryHidden = document.getElementById('tab-daily-summary').hidden;
        var monthlySummaryHidden = document.getElementById('tab-monthly-summary').hidden;
        var stockManagementHidden = document.getElementById('tab-stock-management').hidden;
        if (!targetsHidden) buildTargetsTable();
        if (!dashboardHidden) loadDashboard();
        if (!dailySummaryHidden) loadDailySummary();
        if (!monthlySummaryHidden) loadMonthlySummary();
        if (!stockManagementHidden) loadStockManagement();
      });
      
      // Handle pharmacy selector changes
      function handlePharmacyChange() {
        loadDays();
        var targetsHidden = document.getElementById('tab-targets').hidden;
        var dashboardHidden = document.getElementById('tab-dashboard').hidden;
        var dailySummaryHidden = document.getElementById('tab-daily-summary').hidden;
        var monthlySummaryHidden = document.getElementById('tab-monthly-summary').hidden;
        var stockManagementHidden = document.getElementById('tab-stock-management').hidden;
        var stockQueriesHidden = document.getElementById('tab-stock-queries').hidden;
        var debtorToolsHidden = document.getElementById('tab-debtor-tools').hidden;
        
        // Reload all visible tabs
        if (!targetsHidden) buildTargetsTable();
        if (!dashboardHidden) {
          loadDashboard();
          // Also reload best sellers and worst GP products (used in dashboard)
          loadBestSellers();
          loadWorstGP();
        }
        if (!dailySummaryHidden) loadDailySummary();
        if (!monthlySummaryHidden) loadMonthlySummary();
        if (!stockManagementHidden) loadStockManagement();
        if (!stockQueriesHidden) {
          loadStockQueries();
          loadStockInsights();
        }
        if (!debtorToolsHidden) loadDebtorTools();
        
        // Reload group view if enabled
        if (groupViewEnabled) {
          loadGroupViewData();
        }
      }
      
      // Removed: phSidebarEl event listener('change', handlePharmacyChange);
      applyGrowthBtn && applyGrowthBtn.addEventListener('click', applyGrowth);
      saveTargetsBtn && saveTargetsBtn.addEventListener('click', saveTargets);


      // Modal functionality
      function initModal() {
        var modalOverlay = document.getElementById('metric-modal-overlay');
        var modalClose = document.getElementById('metric-modal-close');
        var metricCards = document.querySelectorAll('.dashboard-card[class*="metric-"]');
        var toggleSales = document.getElementById('toggle-sales');
        var toggleCos = document.getElementById('toggle-cos');
        
        // Add click handlers to metric cards (excluding dispensary cards and stock management cards)
        metricCards.forEach(function(card) {
          // Skip dispensary cards (split and scripts)
          if (card.classList.contains('metric-split') || card.classList.contains('metric-scripts')) {
            card.style.cursor = 'default';
            return;
          }
          
          // Skip stock management cards (cards inside stock-management-container)
          var stockManagementContainer = document.querySelector('.stock-management-container');
          if (stockManagementContainer && stockManagementContainer.contains(card)) {
            card.style.cursor = 'default';
            return;
          }
          
          card.style.cursor = 'pointer';
          card.addEventListener('click', function() {
            var metricType = '';
            if (card.classList.contains('metric-turnover')) metricType = 'turnover';
            else if (card.classList.contains('metric-gp')) metricType = 'gp';
            else if (card.classList.contains('metric-purchases')) metricType = 'purchases';
            else if (card.classList.contains('metric-basket')) metricType = 'basket';
            
            openMetricModal(metricType);
          });
        });
        
        // Add click handlers to mobile combined metrics card icons
        var mobileCardArrows = document.querySelectorAll('.combined-metrics-card .card-arrow');
        mobileCardArrows.forEach(function(arrow, index) {
          arrow.style.cursor = 'pointer';
          arrow.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent card click if any
            var metricType = '';
            // Map index to metric type based on order in combined metrics card
            if (index === 0) metricType = 'turnover';
            else if (index === 1) metricType = 'gp';
            else if (index === 2) metricType = 'purchases';
            else if (index === 3) metricType = 'basket';
            
            openMetricModal(metricType);
          });
        });
        
        // Purchases chart toggle handlers
        toggleSales.addEventListener('click', function() {
          window.selectedPurchasesChart = 'sales';
          toggleSales.classList.add('active');
          toggleCos.classList.remove('active');
          // Redraw chart with current data
          if (window.purchasesChartData) {
            drawPurchasesCharts(window.purchasesChartData);
          }
        });
        
        toggleCos.addEventListener('click', function() {
          window.selectedPurchasesChart = 'cos';
          toggleCos.classList.add('active');
          toggleSales.classList.remove('active');
          // Redraw chart with current data
          if (window.purchasesChartData) {
            drawPurchasesCharts(window.purchasesChartData);
          }
        });
        
        // Close modal handlers
        modalClose.addEventListener('click', closeMetricModal);
        modalOverlay.addEventListener('click', function(e) {
          if (e.target === modalOverlay) {
            closeMetricModal();
          }
        });
        
        // ESC key handler
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && modalOverlay.classList.contains('active')) {
            closeMetricModal();
          }
        });
        
        // Handle window resize/orientation change while modal is open
        window.addEventListener('resize', function() {
          if (modalOverlay.classList.contains('active')) {
            var isNarrowScreen = window.innerWidth < 600 && window.innerHeight > window.innerWidth;
            if (isNarrowScreen) {
              modalOverlay.classList.add('landscape-mode');
              document.body.classList.add('landscape-modal-open');
            } else {
              modalOverlay.classList.remove('landscape-mode');
              document.body.classList.remove('landscape-modal-open');
            }
          }
        });
      }
      
      async function openMetricModal(metricType) {
        var modalOverlay = document.getElementById('metric-modal-overlay');
        var modalTitle = document.getElementById('metric-modal-title');
        var modalDates = document.getElementById('metric-modal-dates');
        var purchasesToggle = document.getElementById('purchases-toggle');
        
        // Check if screen width is less than 600px and in portrait orientation
        var isNarrowScreen = window.innerWidth < 600 && window.innerHeight > window.innerWidth;
        if (isNarrowScreen) {
          modalOverlay.classList.add('landscape-mode');
          document.body.classList.add('landscape-modal-open');
        } else {
          modalOverlay.classList.remove('landscape-mode');
          document.body.classList.remove('landscape-modal-open');
        }
        
        // Set metric-specific styling
        modalOverlay.className = 'metric-modal-overlay active ' + metricType + (isNarrowScreen ? ' landscape-mode' : '');
        
        // Set title based on metric type
        var metricConfig = {
          turnover: 'Turnover',
          gp: 'GP%',
          purchases: 'Purchases',
          basket: 'Basket'
        };
        
        modalTitle.textContent = metricConfig[metricType];
        
        // Show/hide purchases toggle
        if (metricType === 'purchases') {
          purchasesToggle.style.display = 'flex';
          // Reset to sales view
          window.selectedPurchasesChart = 'sales';
          document.getElementById('toggle-sales').classList.add('active');
          document.getElementById('toggle-cos').classList.remove('active');
        } else {
          purchasesToggle.style.display = 'none';
        }
        
        // Show modal
        modalOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Add mouse event handlers for chart tooltips
        const canvas = document.getElementById('metric-trend-chart');
        if (metricType === 'turnover') {
          canvas.addEventListener('mousemove', handleTurnoverMouseMove);
          canvas.addEventListener('mouseleave', handleTurnoverMouseLeave);
        } else if (metricType === 'purchases') {
          canvas.addEventListener('mousemove', handlePurchasesMouseMove);
          canvas.addEventListener('mouseleave', handlePurchasesMouseLeave);
        } else if (metricType === 'gp') {
          canvas.addEventListener('mousemove', handleGPMouseMove);
          canvas.addEventListener('mouseleave', handleGPMouseLeave);
        } else if (metricType === 'basket') {
          canvas.addEventListener('mousemove', handleBasketMouseMove);
          canvas.addEventListener('mouseleave', handleBasketMouseLeave);
        }
        
        // If landscape mode, wait for transform to complete before drawing chart
        if (isNarrowScreen) {
          // Wait for CSS transform and layout to complete
          await new Promise(resolve => {
            // Use requestAnimationFrame to wait for paint
            requestAnimationFrame(() => {
              requestAnimationFrame(() => {
                setTimeout(resolve, 100);
              });
            });
          });
          
          // Set a flag to indicate we're in landscape mode for chart drawing
          window.isLandscapeModal = true;
        } else {
          window.isLandscapeModal = false;
        }
        
        // Load real chart data
        await loadMetricChart(metricType);
      }
      
      function closeMetricModal() {
        var modalOverlay = document.getElementById('metric-modal-overlay');
        modalOverlay.classList.remove('active', 'landscape-mode');
        document.body.style.overflow = '';
        document.body.classList.remove('landscape-modal-open');
        window.isLandscapeModal = false;
        
        // Remove mouse event handlers
        const canvas = document.getElementById('metric-trend-chart');
        canvas.removeEventListener('mousemove', handleTurnoverMouseMove);
        canvas.removeEventListener('mouseleave', handleTurnoverMouseLeave);
        canvas.removeEventListener('mousemove', handlePurchasesMouseMove);
        canvas.removeEventListener('mouseleave', handlePurchasesMouseLeave);
        canvas.removeEventListener('mousemove', handleGPMouseMove);
        canvas.removeEventListener('mouseleave', handleGPMouseLeave);
        canvas.removeEventListener('mousemove', handleBasketMouseMove);
        canvas.removeEventListener('mouseleave', handleBasketMouseLeave);
        
        // Clear tooltips
        window.turnoverTooltip = null;
        window.purchasesSalesTooltip = null;
        window.purchasesCosTooltip = null;
        window.gpTooltip = null;
        window.basketTooltip = null;
      }
      function handleTurnoverMouseMove(event) {
        if (!window.turnoverBarData) return;
        
        const canvas = document.getElementById('metric-trend-chart');
        const rect = canvas.getBoundingClientRect();
        
        let mouseX, mouseY;
        if (window.isLandscapeModal) {
          // In landscape mode, adjust coordinates for rotation
          const rawX = event.clientX - rect.left;
          const rawY = event.clientY - rect.top;
          // Transform coordinates for 90-degree rotation (use display height, not internal canvas height)
          const displayHeight = parseFloat(canvas.style.height) || rect.height;
          mouseX = rawY;
          mouseY = displayHeight - rawX;
        } else {
          mouseX = event.clientX - rect.left;
          mouseY = event.clientY - rect.top;
        }
        
        let foundBar = null;
        
        // Find which bar is being hovered
        for (const bar of window.turnoverBarData) {
          // Check if mouse is within bar bounds (x and y)
          // For bars, we want to check the full height from y to bottom
          const barBottom = bar.y + bar.height;
          
          if (mouseX >= bar.x && mouseX <= bar.x + bar.width && 
              mouseY >= bar.y && mouseY <= barBottom) {
            foundBar = bar;
            break;
          }
        }
        
        if (foundBar) {
          window.turnoverTooltip = {
            x: foundBar.x + foundBar.width / 2,
            y: foundBar.y,
            data: foundBar.data
          };
          canvas.style.cursor = 'pointer';
        } else {
          window.turnoverTooltip = null;
          canvas.style.cursor = 'default';
        }
        
        // Redraw chart
        const data = window.turnoverBarData.map(b => b.data);
        drawTurnoverBarChart(data);
      }
      
      function handleTurnoverMouseLeave(event) {
        window.turnoverTooltip = null;
        const canvas = document.getElementById('metric-trend-chart');
        canvas.style.cursor = 'default';
        if (window.turnoverBarData) {
          const data = window.turnoverBarData.map(b => b.data);
          drawTurnoverBarChart(data);
        }
      }
      
      function handlePurchasesMouseMove(event) {
        if (!window.purchasesSalesBarData && !window.purchasesCosBarData) return;
        
        const canvas = document.getElementById('metric-trend-chart');
        const rect = canvas.getBoundingClientRect();
        
        let mouseX, mouseY;
        if (window.isLandscapeModal) {
          // In landscape mode, adjust coordinates for rotation
          const rawX = event.clientX - rect.left;
          const rawY = event.clientY - rect.top;
          // Transform coordinates for 90-degree rotation (use display height, not internal canvas height)
          const displayHeight = parseFloat(canvas.style.height) || rect.height;
          mouseX = rawY;
          mouseY = displayHeight - rawX;
        } else {
          mouseX = event.clientX - rect.left;
          mouseY = event.clientY - rect.top;
        }
        
        let foundBar = null;
        let chartType = null;
        
        // Check sales chart bars
        if (window.purchasesSalesBarData) {
          for (const bar of window.purchasesSalesBarData) {
            const barBottom = bar.y + bar.height;
            if (mouseX >= bar.x && mouseX <= bar.x + bar.width && 
                mouseY >= bar.y && mouseY <= barBottom) {
              foundBar = bar;
              chartType = 'sales';
              break;
            }
          }
        }
        
        // Check CoS chart bars if not found in sales chart
        if (!foundBar && window.purchasesCosBarData) {
          for (const bar of window.purchasesCosBarData) {
            const barBottom = bar.y + bar.height;
            if (mouseX >= bar.x && mouseX <= bar.x + bar.width && 
                mouseY >= bar.y && mouseY <= barBottom) {
              foundBar = bar;
              chartType = 'cos';
              break;
            }
          }
        }
        
        if (foundBar) {
          if (chartType === 'sales') {
            window.purchasesSalesTooltip = {
              x: foundBar.x + foundBar.width / 2,
              y: foundBar.y,
              data: foundBar.data,
              comparisonType: 'sales'
            };
            window.purchasesCosTooltip = null;
          } else {
            window.purchasesCosTooltip = {
              x: foundBar.x + foundBar.width / 2,
              y: foundBar.y,
              data: foundBar.data,
              comparisonType: 'cos'
            };
            window.purchasesSalesTooltip = null;
          }
          canvas.style.cursor = 'pointer';
        } else {
          window.purchasesSalesTooltip = null;
          window.purchasesCosTooltip = null;
          canvas.style.cursor = 'default';
        }
        
        // Redraw charts
        if (window.purchasesSalesBarData && window.purchasesSalesBarData.length > 0) {
          const data = window.purchasesSalesBarData.map(b => b.data);
          drawPurchasesCharts(data);
        }
      }
      
      function handlePurchasesMouseLeave(event) {
        window.purchasesSalesTooltip = null;
        window.purchasesCosTooltip = null;
        const canvas = document.getElementById('metric-trend-chart');
        canvas.style.cursor = 'default';
        if (window.purchasesSalesBarData && window.purchasesSalesBarData.length > 0) {
          const data = window.purchasesSalesBarData.map(b => b.data);
          drawPurchasesCharts(data);
        }
      }
      
      function getDateRange(days) {
        var endDate = new Date();
        var startDate = new Date();
        startDate.setDate(endDate.getDate() - days);
        
        var formatDate = function(date) {
          return date.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            year: 'numeric' 
          });
        };
        
        return formatDate(startDate) + ' - ' + formatDate(endDate);
      }
      
      function handleGPMouseMove(event) {
        if (!window.gpBarData) return;
        
        const canvas = document.getElementById('metric-trend-chart');
        const rect = canvas.getBoundingClientRect();
        
        let mouseX, mouseY;
        if (window.isLandscapeModal) {
          // In landscape mode, adjust coordinates for rotation
          const rawX = event.clientX - rect.left;
          const rawY = event.clientY - rect.top;
          // Transform coordinates for 90-degree rotation (use display height, not internal canvas height)
          const displayHeight = parseFloat(canvas.style.height) || rect.height;
          mouseX = rawY;
          mouseY = displayHeight - rawX;
        } else {
          mouseX = event.clientX - rect.left;
          mouseY = event.clientY - rect.top;
        }
        
        let foundBar = null;
        
        // Check GP chart bars
        for (const bar of window.gpBarData) {
          const barBottom = bar.y + bar.height;
          if (mouseX >= bar.x && mouseX <= bar.x + bar.width && 
              mouseY >= bar.y && mouseY <= barBottom) {
            foundBar = bar;
            break;
          }
        }
        
        if (foundBar) {
          window.gpTooltip = {
            x: foundBar.x + foundBar.width / 2,
            y: foundBar.y,
            data: foundBar.data
          };
          canvas.style.cursor = 'pointer';
          if (window.gpChartData) {
            drawGPChart(window.gpChartData);
          }
        } else {
          window.gpTooltip = null;
          canvas.style.cursor = 'default';
          if (window.gpChartData) {
            drawGPChart(window.gpChartData);
          }
        }
      }
      
      function handleGPMouseLeave(event) {
        window.gpTooltip = null;
        const canvas = document.getElementById('metric-trend-chart');
        canvas.style.cursor = 'default';
        if (window.gpChartData) {
          drawGPChart(window.gpChartData);
        }
      }
      
      function handleBasketMouseMove(event) {
        if (!window.basketBarData) return;
        
        const canvas = document.getElementById('metric-trend-chart');
        const rect = canvas.getBoundingClientRect();
        
        let mouseX, mouseY;
        if (window.isLandscapeModal) {
          // In landscape mode, adjust coordinates for rotation
          const rawX = event.clientX - rect.left;
          const rawY = event.clientY - rect.top;
          // Transform coordinates for 90-degree rotation (use display height, not internal canvas height)
          const displayHeight = parseFloat(canvas.style.height) || rect.height;
          mouseX = rawY;
          mouseY = displayHeight - rawX;
        } else {
          mouseX = event.clientX - rect.left;
          mouseY = event.clientY - rect.top;
        }
        
        let foundBar = null;
        
        // Check basket chart bars
        for (const bar of window.basketBarData) {
          const barBottom = bar.y + bar.height;
          if (mouseX >= bar.x && mouseX <= bar.x + bar.width && 
              mouseY >= bar.y && mouseY <= barBottom) {
            foundBar = bar;
            break;
          }
        }
        
        if (foundBar) {
          canvas.style.cursor = 'pointer';
          window.basketTooltip = {
            x: mouseX,
            y: mouseY,
            data: foundBar.data
          };
          
          // Redraw chart with tooltip
          if (window.basketChartData) {
            drawBasketChart(window.basketChartData);
          }
        } else {
          canvas.style.cursor = 'default';
          window.basketTooltip = null;
          
          // Redraw chart without tooltip
          if (window.basketChartData) {
            drawBasketChart(window.basketChartData);
          }
        }
      }
      
      function handleBasketMouseLeave(event) {
        window.basketTooltip = null;
        const canvas = document.getElementById('metric-trend-chart');
        canvas.style.cursor = 'default';
        if (window.basketChartData) {
          drawBasketChart(window.basketChartData);
        }
      }
      
      function formatYmdLocal(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }
      
      function formatCurrencyAbbreviated(value) {
        const num = Math.round(value);
        if (num >= 1000000) {
          return 'R' + (num / 1000000).toFixed(1) + 'M';
        } else if (num >= 1000) {
          return 'R' + (num / 1000).toFixed(0) + 'k';
        } else if (num >= 100) {
          return 'R' + (num / 100).toFixed(0) + '00';
        } else {
          return 'R' + num.toString();
        }
      }
      
      async function loadMetricChart(metricType) {
        if (!selectedPharmacyId) return;
        var pid = selectedPharmacyId;
        if (!pid) return;
        
        try {
          if (metricType === 'turnover') {
            await loadTurnoverChart();
          } else if (metricType === 'purchases') {
            await loadPurchasesCharts();
          } else if (metricType === 'gp') {
            await loadGPChart();
          } else if (metricType === 'basket') {
            await loadBasketChart();
          } else {
            // For other metrics, use the existing 30-day line chart
            await loadOtherMetricChart(metricType);
          }
        } catch (e) {
          console.error('Failed to load chart data:', e);
        }
      }
      
      async function loadTurnoverChart() {
        const pid = selectedPharmacyId;
        
        // Check if we're on monthly summary tab
        const monthlySummaryTab = document.getElementById('tab-monthly-summary');
        const isMonthlyView = monthlySummaryTab && !monthlySummaryTab.hidden;
        
        // Show loading spinner
        showChartLoading();
        
        try {
          if (isMonthlyView) {
            // MONTHLY VIEW: Show last 12 months using aggregated monthly totals
            const today = new Date();
            const months = [];
            
            // Get last 12 months (including current month)
            for (let i = 0; i < 12; i++) {
              const monthDate = new Date(today.getFullYear(), today.getMonth() - i, 1);
              months.push(monthDate);
            }
            
            months.reverse(); // Oldest to newest
            
            // Fetch current year monthly totals using MTD endpoint with last day of month
            // This gives us the pre-aggregated full month total from the backend
            const currentYearPromises = months.map(async (monthDate) => {
              const year = monthDate.getFullYear();
              const month = monthDate.getMonth() + 1;
              const monthStr = `${year}-${String(month).padStart(2, '0')}`;
              
              // Get the last day of the month for full month aggregation
              const lastDay = new Date(year, month, 0).getDate();
              const lastDayDate = `${year}-${String(month).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;
              
              // Use MTD endpoint - backend returns pre-aggregated full month total
              try {
                const resp = await fetch(`/api/mtd?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(monthStr)}&through=${encodeURIComponent(lastDayDate)}`);
                if (resp.ok) {
                  const mtdData = await resp.json();
                  return {
                    month: monthDate,
                    turnover: Number(mtdData.turnover || 0)
                  };
                }
              } catch (e) {
                console.warn(`Failed to fetch MTD for ${monthStr}:`, e);
              }
              return {
                month: monthDate,
                turnover: 0
              };
            });
            
            // Fetch previous year monthly totals (same months, pre-aggregated)
            const previousYearPromises = months.map(async (monthDate) => {
              const prevYear = monthDate.getFullYear() - 1;
              const month = monthDate.getMonth() + 1;
              const monthStr = `${prevYear}-${String(month).padStart(2, '0')}`;
              
              // Get the last day of the month for full month aggregation
              const lastDay = new Date(prevYear, month, 0).getDate();
              const lastDayDate = `${prevYear}-${String(month).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;
              
              // Use MTD endpoint - backend returns pre-aggregated full month total
              try {
                const resp = await fetch(`/api/mtd?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(monthStr)}&through=${encodeURIComponent(lastDayDate)}`);
                if (resp.ok) {
                  const mtdData = await resp.json();
                  return {
                    month: monthDate,
                    turnover: Number(mtdData.turnover || 0)
                  };
                }
              } catch (e) {
                console.warn(`Failed to fetch previous year MTD for ${monthStr}:`, e);
              }
              return {
                month: monthDate,
                turnover: 0
              };
            });
            
            // Wait for all promises to resolve
            const [currentYearData, previousYearData] = await Promise.all([
              Promise.all(currentYearPromises),
              Promise.all(previousYearPromises)
            ]);
            
            // Format chart data for monthly view (no aggregation needed - data is pre-aggregated)
            const chartData = months.map((monthDate, index) => {
              const currentTurnover = currentYearData[index]?.turnover || 0;
              const previousTurnover = previousYearData[index]?.turnover || 0;
              const label = monthDate.toLocaleDateString('en-US', { month: 'short' });
              return {
                date: monthDate,
                currentTurnover,
                previousTurnover,
                label,
                businessDate: formatYmdLocal(monthDate)
              };
            });
            
            // Draw turnover bar chart
            drawTurnoverBarChart(chartData);
          } else {
            // DAILY VIEW: Show last 14 trading days (existing logic)
          // Generate candidate dates (last 45 days to find 14 trading days)
          const maxLookbackDays = 45;
          const candidateDates = [];
          for (let i = 0; i < maxLookbackDays; i++) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            candidateDates.push(d);
          }
          
          const candidateStart = candidateDates[candidateDates.length - 1];
          const candidateEnd = candidateDates[0];
          const currentRangeStartStr = formatYmdLocal(candidateStart);
          const currentRangeEndStr = formatYmdLocal(candidateEnd);
          
          // Get all months needed for the range
          const monthsToFetch = getMonthsInRange(candidateStart, candidateEnd);
          const allData = [];
          
          for (const monthStr of monthsToFetch) {
            const resp = await fetch(`/api/days?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(monthStr)}`);
            if (resp.ok) {
              const data = await resp.json();
              if (Array.isArray(data)) {
                allData.push(...data);
              }
            }
          }
          
          // Map data by business_date
          const currentYearMap = new Map();
          allData.forEach(d => {
            currentYearMap.set(d.business_date, Number(d.turnover) || 0);
          });
          
          // Select 14 trading days (days with turnover > 0)
          const selectedCurrentDatesDesc = [];
          for (const d of candidateDates) {
            const ds = formatYmdLocal(d);
            const val = currentYearMap.get(ds) || 0;
            if (val > 0) {
              selectedCurrentDatesDesc.push(d);
            }
            if (selectedCurrentDatesDesc.length === 14) break;
          }
          
          const selectedCurrentDates = selectedCurrentDatesDesc.slice().reverse();
          
          if (selectedCurrentDates.length === 0) {
            drawEmptyChart();
            return;
          }
          
          // Get corresponding previous year dates
          const selectedPreviousDates = selectedCurrentDates.map(d => getPreviousYearSameDayOfWeek(d));
          
          // Fetch previous year data
          const prevStart = selectedPreviousDates[0];
          const prevEnd = selectedPreviousDates[selectedPreviousDates.length - 1];
          const prevRangeStartStr = formatYmdLocal(prevStart);
          const prevRangeEndStr = formatYmdLocal(prevEnd);
          
          const prevMonthsToFetch = getMonthsInRange(prevStart, prevEnd);
          const prevAllData = [];
          
          for (const monthStr of prevMonthsToFetch) {
            const resp = await fetch(`/api/days?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(monthStr)}`);
            if (resp.ok) {
              const data = await resp.json();
              if (Array.isArray(data)) {
                prevAllData.push(...data);
              }
            }
          }
          
          const previousYearMap = new Map();
          prevAllData.forEach(d => {
            previousYearMap.set(d.business_date, Number(d.turnover) || 0);
          });
          
          // Format chart data
          const chartData = selectedCurrentDates.map((d, index) => {
            const ds = formatYmdLocal(d);
            const currentTurnover = currentYearMap.get(ds) || 0;
            const prevDs = formatYmdLocal(selectedPreviousDates[index]);
            const previousTurnover = previousYearMap.get(prevDs) || 0;
            const label = d.toLocaleDateString('en-US', { weekday: 'short' });
            return { 
              date: d, 
              currentTurnover, 
              previousTurnover, 
              label,
              businessDate: ds
            };
          });
          
          // Draw turnover bar chart
          drawTurnoverBarChart(chartData);
          }
        } catch (error) {
          console.error('Error loading turnover chart:', error);
          drawEmptyChart();
        }
      }
      
      async function loadGPChart() {
        // Show loading spinner
        showChartLoading();
        
        try {
          console.log('=== GP CHART DEBUG START ===');
          const pid = selectedPharmacyId;
          console.log('Selected pharmacy ID:', pid);
          
          const today = new Date();
          const fourteenDaysAgo = new Date(today);
          fourteenDaysAgo.setDate(today.getDate() - 45); // Look back 45 days to find 14 trading days
          
          const startDate = formatYmdLocal(fourteenDaysAgo);
          const endDate = formatYmdLocal(today);
          console.log('Date range:', startDate, 'to', endDate);
          
          // Get all months needed for the range (same as turnover chart)
          const monthsToFetch = getMonthsInRange(fourteenDaysAgo, today);
          const allData = [];
          
          for (const monthStr of monthsToFetch) {
            const resp = await fetch(`/api/days?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(monthStr)}`);
            if (resp.ok) {
              const data = await resp.json();
              if (Array.isArray(data)) {
                allData.push(...data);
              }
            }
          }
          
          console.log('Raw API data:', allData);
          
          if (!allData || allData.length === 0) {
            console.log('No data, drawing empty chart');
            drawEmptyChart();
            return;
          }
          
          // Filter for trading days (days with turnover > 0) and take last 14
          const tradingDays = allData
            .filter(d => Number(d.turnover) > 0)
            .sort((a, b) => new Date(b.business_date) - new Date(a.business_date))
            .slice(0, 14)
            .reverse(); // Reverse to show chronologically
          
          console.log('Trading days found:', tradingDays.length);
          console.log('Trading days data:', tradingDays);
          
          if (tradingDays.length === 0) {
            console.log('No trading days, drawing empty chart');
            drawEmptyChart();
            return;
          }
          
          // Format chart data
          const chartData = tradingDays.map(d => {
            const ds = d.business_date;
            const date = new Date(ds + 'T00:00:00');
            const label = `${date.getDate()}/${date.getMonth() + 1}`;
            
            // Use GP% from API data (same as Daily tracking screen)
            const sales = Number(d.turnover) || 0;
            const gpVal = Number(d.gp_value || 0);
            const gpPercent = (d.gp_pct !== undefined && d.gp_pct !== null) ? Number(d.gp_pct) : (sales ? (gpVal / sales) * 100 : 0);
            
            console.log(`Date: ${ds}, Sales: ${sales}, GP Value: ${gpVal}, GP%: ${gpPercent}`);
            
            return {
              date,
              gpPercent,
              label,
              businessDate: ds
            };
          });
          
          console.log('Chart data:', chartData);
          
          // Store data for tooltip switching
          window.gpChartData = chartData;
          
          // Draw GP chart
          console.log('Calling drawGPChart...');
          drawGPChart(chartData);
          console.log('=== GP CHART DEBUG END ===');
        } catch (error) {
          console.error('Error loading GP chart:', error);
          drawEmptyChart();
        }
      }
      
      async function loadBasketChart() {
        // Show loading spinner
        showChartLoading();
        
        try {
          console.log('=== BASKET CHART DEBUG START ===');
          const pid = selectedPharmacyId;
          console.log('Selected pharmacy ID:', pid);
          
          const today = new Date();
          const fourteenDaysAgo = new Date(today);
          fourteenDaysAgo.setDate(today.getDate() - 45); // Look back 45 days to find 14 trading days
          
          const startDate = formatYmdLocal(fourteenDaysAgo);
          const endDate = formatYmdLocal(today);
          console.log('Date range:', startDate, 'to', endDate);
          
          // Get all months needed for the range (same as other charts)
          const monthsToFetch = getMonthsInRange(fourteenDaysAgo, today);
          const allData = [];
          
          for (const monthStr of monthsToFetch) {
            const resp = await fetch(`/api/days?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(monthStr)}`);
            if (resp.ok) {
              const data = await resp.json();
              if (Array.isArray(data)) {
                allData.push(...data);
              }
            }
          }
          
          console.log('Raw API data:', allData);
          
          if (!allData || allData.length === 0) {
            console.log('No data, drawing empty chart');
            drawEmptyChart();
            return;
          }
          
          // Filter for trading days (days with turnover > 0) and take last 14
          const tradingDays = allData
            .filter(d => Number(d.turnover) > 0)
            .sort((a, b) => new Date(b.business_date) - new Date(a.business_date))
            .slice(0, 14)
            .reverse(); // Reverse to show chronologically
          
          console.log('Trading days found:', tradingDays.length);
          console.log('Trading days data:', tradingDays);
          
          if (tradingDays.length === 0) {
            console.log('No trading days, drawing empty chart');
            drawEmptyChart();
            return;
          }
          
          // Format chart data
          const chartData = tradingDays.map(d => {
            const ds = d.business_date;
            const date = new Date(ds + 'T00:00:00');
            const label = `${date.getDate()}/${date.getMonth() + 1}`;
            
            // Calculate basket value from turnover and transaction count
            const turnover = Number(d.turnover) || 0;
            const transactionCount = Number(d.transaction_count || d.transactions || d.txn_count || d.num_transactions || d.sales_transactions || 0);
            
            // If no transaction count, estimate based on turnover (average R150 per transaction)
            const estimatedTxns = transactionCount || Math.max(1, Math.round(turnover / 150));
            const basketValue = turnover / estimatedTxns;
            
            console.log(`Date: ${ds}, Turnover: ${turnover}, Transactions: ${estimatedTxns}, Basket Value: ${basketValue}`);
            
            return {
              date,
              basketValue,
              label,
              businessDate: ds
            };
          });
          
          console.log('Chart data:', chartData);
          
          // Store data for tooltip switching
          window.basketChartData = chartData;
          
          // Draw basket chart
          console.log('Calling drawBasketChart...');
          drawBasketChart(chartData);
          console.log('=== BASKET CHART DEBUG END ===');
        } catch (error) {
          console.error('Error loading basket chart:', error);
          drawEmptyChart();
        }
      }
      
      async function loadOtherMetricChart(metricType) {
        // Show loading spinner
        showChartLoading();
        
        try {
          // Fetch 30 days of data for other metrics (existing logic)
          const endDate = new Date();
          const startDate = new Date();
          startDate.setDate(endDate.getDate() - 30);
          
          const monthsToFetch = getMonthsInRange(startDate, endDate);
          const allData = [];
          
          for (const monthStr of monthsToFetch) {
            const resp = await fetch(`/api/days?pid=${encodeURIComponent(selectedPharmacyId)}&month=${encodeURIComponent(monthStr)}`);
            if (resp.ok) {
              const data = await resp.json();
              if (Array.isArray(data)) {
                allData.push(...data);
              }
            }
          }
          
          const thirtyDaysAgo = formatYmdLocal(startDate);
          const today = formatYmdLocal(endDate);
          
          const filteredData = allData
            .filter(d => d.business_date >= thirtyDaysAgo && d.business_date <= today)
            .sort((a, b) => a.business_date.localeCompare(b.business_date));
          
          drawComboChart(filteredData, metricType);
        } catch (error) {
          console.error('Error loading other metric chart:', error);
          drawEmptyChart();
        }
      }
      
      function getPreviousYearSameDayOfWeek(date) {
        const prevYearDate = new Date(date);
        prevYearDate.setFullYear(date.getFullYear() - 1);
        
        // Ensure we have the correct weekday
        const weekdayDiff = prevYearDate.getDay() - date.getDay();
        if (weekdayDiff !== 0) {
          prevYearDate.setDate(prevYearDate.getDate() - weekdayDiff);
        }
        
        return prevYearDate;
      }
      function drawEmptyChart() {
        const canvas = document.getElementById('metric-trend-chart');
        const ctx = canvas.getContext('2d');
        const container = canvas.parentElement;
        const width = container.clientWidth;
        const height = container.clientHeight;
        
        // Scale for high-DPI displays
        const dpr = window.devicePixelRatio || 1;
        canvas.width = width * dpr;
        canvas.height = height * dpr;
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        ctx.scale(dpr, dpr);
        
        ctx.clearRect(0, 0, width, height);
        
        ctx.fillStyle = '#6B7280';
        ctx.font = '16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('No trading data available', width / 2, height / 2);
      }
      
      function showChartLoading() {
        const canvas = document.getElementById('metric-trend-chart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const container = canvas.parentElement;
        
        // Get actual pixel dimensions from container
        const rect = container.getBoundingClientRect();
        
        // If in landscape modal mode, use screen dimensions instead
        let width, height;
        if (window.isLandscapeModal) {
          // In landscape mode, use screen height as width and screen width as height
          width = window.innerHeight * 0.75; // 75% of screen height
          height = window.innerWidth * 0.6;  // 60% of screen width
        } else {
          width = rect.width;
          height = rect.height;
        }
        
        // Scale for high-DPI displays
        const dpr = window.devicePixelRatio || 1;
        canvas.width = width * dpr;
        canvas.height = height * dpr;
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        ctx.scale(dpr, dpr);
        
        // Draw loading spinner
        const centerX = width / 2;
        const centerY = height / 2;
        const radius = 20;
        
        let startTime = null;
        window.chartLoadingActive = true;
        
        // Create smooth animated spinner using requestAnimationFrame
        function animate(timestamp) {
          // Stop if loading is no longer active
          if (!window.chartLoadingActive) {
            window.chartLoadingAnimationId = null;
            return;
          }
          
          if (!startTime) startTime = timestamp;
          const elapsed = timestamp - startTime;
          
          // Calculate rotation (full rotation every 1 second)
          const rotation = (elapsed / 1000) * Math.PI * 2;
          
          ctx.clearRect(0, 0, width, height);
          
          // Draw spinner circle
          ctx.strokeStyle = '#F47A20';
          ctx.lineWidth = 3;
          ctx.lineCap = 'round';
          
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius, rotation, rotation + Math.PI * 1.5);
          ctx.stroke();
          
          // Draw loading text
          ctx.fillStyle = '#6B7280';
          ctx.font = '14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('Loading chart data...', centerX, centerY + 50);
          
          // Continue animation if still active
          if (window.chartLoadingActive) {
            window.chartLoadingAnimationId = requestAnimationFrame(animate);
          }
        }
        
        // Start animation
        window.chartLoadingAnimationId = requestAnimationFrame(animate);
      }
      
      function hideChartLoading() {
        window.chartLoadingActive = false;
        if (window.chartLoadingAnimationId) {
          cancelAnimationFrame(window.chartLoadingAnimationId);
          window.chartLoadingAnimationId = null;
        }
      }
      
      function drawTurnoverBarChart(data) {
        // Hide loading spinner
        hideChartLoading();
        
        const canvas = document.getElementById('metric-trend-chart');
        const ctx = canvas.getContext('2d');
        const container = canvas.parentElement;
        
        // Get actual pixel dimensions from container
        const rect = container.getBoundingClientRect();
        
        // If in landscape modal mode, use screen dimensions instead
        let width, height;
        if (window.isLandscapeModal) {
          // In landscape mode, use screen height as width and screen width as height
          width = window.innerHeight * 0.75; // 75% of screen height
          height = window.innerWidth * 0.6;  // 60% of screen width
        } else {
          width = rect.width;
          height = rect.height;
        }
        
        // Scale for high-DPI displays
        const dpr = window.devicePixelRatio || 1;
        canvas.width = width * dpr;
        canvas.height = height * dpr;
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        ctx.scale(dpr, dpr);
        
        ctx.clearRect(0, 0, width, height);
        
        if (!data || data.length === 0) {
          drawEmptyChart();
          return;
        }
        
        const padding = { top: 40, right: 40, bottom: 60, left: 80 };
        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;
        
        // Calculate max value for scaling
        const maxValue = Math.max(...data.flatMap(d => [d.currentTurnover, d.previousTurnover]));
        
        const barWidth = (chartWidth / data.length) * 0.7;
        const barSpacing = chartWidth / data.length;
        const radius = 4; // Rounded corner radius
        
        // Store bar data for tooltip interaction (using exact canvas coordinates)
        window.turnoverBarData = data.map((d, index) => {
          const x = padding.left + (index * barSpacing) + (barSpacing - barWidth) / 2;
          const currentHeight = (d.currentTurnover / maxValue) * chartHeight;
          const currentY = padding.top + chartHeight - currentHeight;
          const isHigher = d.currentTurnover >= d.previousTurnover;
          const currentColor = isHigher ? '#59BA47' : '#FF4509';
          
          return {
            x, y: currentY, width: barWidth, height: currentHeight,
            currentColor, data: d, index
          };
        });
        
        // Draw bars
        data.forEach((d, index) => {
          const x = padding.left + (index * barSpacing) + (barSpacing - barWidth) / 2;
          
          // Previous year bar (background)
          const prevHeight = (d.previousTurnover / maxValue) * chartHeight;
          const prevY = padding.top + chartHeight - prevHeight;
          
          // Current year bar
          const currentHeight = (d.currentTurnover / maxValue) * chartHeight;
          const currentY = padding.top + chartHeight - currentHeight;
          
          // Color based on growth
          const isHigher = d.currentTurnover >= d.previousTurnover;
          const currentColor = isHigher ? '#59BA47' : '#FF4509';
          
          // Draw previous year bar (gray background) with rounded corners
          ctx.fillStyle = '#6B7280';
          ctx.globalAlpha = 0.4;
          drawRoundedRect(ctx, x, prevY, barWidth, prevHeight, radius);
          ctx.fill();
          
          // Draw current year bar with rounded corners
          ctx.globalAlpha = 1;
          ctx.fillStyle = currentColor;
          drawRoundedRect(ctx, x, currentY, barWidth, currentHeight, radius);
          ctx.fill();
          
          // Draw day labels (responsive font size)
          ctx.fillStyle = '#6B7280';
          const labelFontSize = width < 600 ? 10 : 12;
          ctx.font = `${labelFontSize}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`;
          ctx.textAlign = 'center';
          
          // Only show every other label on very small screens
          const showLabel = width >= 600 || index % 2 === 0;
          if (showLabel) {
            ctx.fillText(d.label, x + barWidth / 2, padding.top + chartHeight + 20);
          }
        });
        
        // Draw Y-axis labels
        ctx.fillStyle = '#6B7280';
        ctx.font = '11px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        ctx.textAlign = 'right';
        
        // Reduce number of labels on smaller screens
        const labelCount = width < 600 ? 3 : 5;
        const labelStep = labelCount === 3 ? 2 : 1;
        
        for (let i = 0; i <= labelCount; i += labelStep) {
          const value = (maxValue * i) / labelCount;
          const y = padding.top + chartHeight - (chartHeight * i / labelCount);
          const label = formatCurrencyAbbreviated(value);
          
          // Adjust label position for better readability
          const labelX = padding.left - 8;
          const labelY = y + 3;
          
          ctx.fillText(label, labelX, labelY);
        }
        
        // Draw tooltip if hovering
        if (window.turnoverTooltip) {
          drawTurnoverTooltip(ctx, window.turnoverTooltip, padding);
        }
      }
      
      function drawTurnoverTooltip(ctx, tooltip, padding) {
        const { x, y, data } = tooltip;
        const percent = ((data.currentTurnover - data.previousTurnover) / data.previousTurnover * 100) || 0;
        const isHigher = data.currentTurnover >= data.previousTurnover;
        const color = isHigher ? '#59BA47' : '#FF4509';
        
        // Get display dimensions (CSS pixels, not internal canvas resolution)
        const displayWidth = parseFloat(ctx.canvas.style.width) || ctx.canvas.getBoundingClientRect().width;
        
        // Tooltip dimensions
        const tooltipWidth = 140;
        const tooltipHeight = 60;
        const tooltipX = Math.max(padding.left, Math.min(x - tooltipWidth / 2, displayWidth - tooltipWidth - padding.right));
        const tooltipY = Math.max(padding.top, y - tooltipHeight - 10);
        
        // Draw tooltip background
        ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
        ctx.strokeStyle = '#E5E7EB';
        ctx.lineWidth = 1;
        drawRoundedRect(ctx, tooltipX, tooltipY, tooltipWidth, tooltipHeight, 8);
        ctx.fill();
        ctx.stroke();
        
        // Draw tooltip content
        ctx.fillStyle = '#1F2937';
        ctx.font = '12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        ctx.textAlign = 'center';
        
        // Date
        ctx.fillText(data.label, tooltipX + tooltipWidth / 2, tooltipY + 18);
        
        // Current value
        ctx.fillText('R ' + Math.round(data.currentTurnover).toLocaleString(), tooltipX + tooltipWidth / 2, tooltipY + 35);
        
        // Percentage change
        ctx.fillStyle = color;
        ctx.font = 'bold 12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        const percentText = (percent > 0 ? '+' : '') + percent.toFixed(1) + '%';
        ctx.fillText(percentText, tooltipX + tooltipWidth / 2, tooltipY + 50);
      }
      
      function drawRoundedRect(ctx, x, y, width, height, radius) {
        ctx.beginPath();
        ctx.moveTo(x + radius, y);
        ctx.lineTo(x + width - radius, y);
        ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
        ctx.lineTo(x + width, y + height - radius);
        ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
        ctx.lineTo(x + radius, y + height);
        ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
        ctx.lineTo(x, y + radius);
        ctx.quadraticCurveTo(x, y, x + radius, y);
        ctx.closePath();
      }
      
      // Purchases Charts Functions
      async function loadPurchasesCharts() {
        const pid = selectedPharmacyId;
        
        // Show loading spinner
        showChartLoading();
        
        try {
          // Generate candidate dates (last 45 days to find 14 trading days)
          const maxLookbackDays = 45;
          const candidateDates = [];
          for (let i = 0; i < maxLookbackDays; i++) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            candidateDates.push(d);
          }
          
          const candidateStart = candidateDates[candidateDates.length - 1];
          const candidateEnd = candidateDates[0];
          const currentRangeStartStr = formatYmdLocal(candidateStart);
          const currentRangeEndStr = formatYmdLocal(candidateEnd);
          
          // Get all months needed for the range
          const monthsToFetch = getMonthsInRange(candidateStart, candidateEnd);
          const allData = [];
          
          for (const monthStr of monthsToFetch) {
            const resp = await fetch(`/api/days?pid=${encodeURIComponent(pid)}&month=${encodeURIComponent(monthStr)}`);
            if (resp.ok) {
              const data = await resp.json();
              if (Array.isArray(data)) {
                allData.push(...data);
              }
            }
          }
          
          // Map data by business_date
          const dataMap = new Map();
          allData.forEach(d => {
            dataMap.set(d.business_date, d);
          });
          
          // Select 14 trading days (days with turnover > 0)
          const selectedDatesDesc = [];
          for (const d of candidateDates) {
            const ds = formatYmdLocal(d);
            const dayData = dataMap.get(ds);
            if (dayData && Number(dayData.turnover || 0) > 0) {
              selectedDatesDesc.push(d);
            }
            if (selectedDatesDesc.length === 14) break;
          }
          
          const selectedDates = selectedDatesDesc.slice().reverse();
          
          if (selectedDates.length === 0) {
            drawEmptyChart();
            return;
          }
          
          // Format chart data
          const chartData = selectedDates.map(date => {
            const ds = formatYmdLocal(date);
            const dayData = dataMap.get(ds);
            const label = date.toLocaleDateString('en-US', { weekday: 'short' });
            
            return {
              date,
              purchases: Number(dayData?.purchases) || 0,
              sales: Number(dayData?.turnover) || 0,
              costOfSales: Number(dayData?.cost_of_sales) || 0,
              label,
              businessDate: ds
            };
          });
        
        // Store data for toggle switching
        window.purchasesChartData = chartData;
        
        // Draw purchases chart
        drawPurchasesCharts(chartData);
        } catch (error) {
          console.error('Error loading purchases charts:', error);
          drawEmptyChart();
        }
      }
      
      function drawPurchasesCharts(data) {
        // Hide loading spinner
        hideChartLoading();
        
        const canvas = document.getElementById('metric-trend-chart');
        const ctx = canvas.getContext('2d');
        const container = canvas.parentElement;
        
        // Get actual pixel dimensions from container
        const rect = container.getBoundingClientRect();
        
        // If in landscape modal mode, use screen dimensions instead
        let width, height;
        if (window.isLandscapeModal) {
          // In landscape mode, use screen height as width and screen width as height
          width = window.innerHeight * 0.75; // 75% of screen height
          height = window.innerWidth * 0.6;  // 60% of screen width
        } else {
          width = rect.width;
          height = rect.height;
        }
        
        // Scale for high-DPI displays
        const dpr = window.devicePixelRatio || 1;
        canvas.width = width * dpr;
        canvas.height = height * dpr;
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        ctx.scale(dpr, dpr);
        
        ctx.clearRect(0, 0, width, height);
        
        if (!data || data.length === 0) {
          drawEmptyChart();
          return;
        }
        
        // Get selected chart type (default to 'sales')
        const chartType = window.selectedPurchasesChart || 'sales';
        
        // Clear tooltips for inactive chart
        if (chartType === 'sales') {
          window.purchasesCosBarData = [];
          window.purchasesCosTooltip = null;
        } else {
          window.purchasesSalesBarData = [];
          window.purchasesSalesTooltip = null;
        }
        
        // Draw only the selected chart
        const padding = { top: 40, right: 40, bottom: 60, left: 80 };
        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;
        
        drawPurchasesComparisonChart(ctx, data, chartType, padding.top, chartHeight, width);
        
        // Draw tooltip if hovering
        if (chartType === 'sales' && window.purchasesSalesTooltip) {
          drawPurchasesTooltip(ctx, window.purchasesSalesTooltip);
        } else if (chartType === 'cos' && window.purchasesCosTooltip) {
          drawPurchasesTooltip(ctx, window.purchasesCosTooltip);
        }
      }
      
      function drawPurchasesComparisonChart(ctx, data, comparisonType, startY, chartHeight, canvasWidth) {
        const padding = { top: 20, right: 40, bottom: 50, left: 80 };
        const chartWidth = canvasWidth - padding.left - padding.right;
        const effectiveHeight = chartHeight; // chartHeight already has padding removed
        
        // Determine comparison field
        const comparisonField = comparisonType === 'sales' ? 'sales' : 'costOfSales';
        
        // Calculate max value for scaling
        const maxValue = Math.max(...data.flatMap(d => [d.purchases, d[comparisonField]]));
        
        const barWidth = (chartWidth / data.length) * 0.7;
        const barSpacing = chartWidth / data.length;
        const radius = 4;
        
        // Store bar data for tooltip interaction
        const barDataArray = data.map((d, index) => {
          const x = padding.left + (index * barSpacing) + (barSpacing - barWidth) / 2;
          const purchasesHeight = (d.purchases / maxValue) * effectiveHeight;
          const purchasesY = startY + effectiveHeight - purchasesHeight;
          
          // Determine color based on comparison
          let purchasesColor;
          if (comparisonType === 'sales') {
            const pctOfSales = d.sales > 0 ? (d.purchases / d.sales) : 0;
            purchasesColor = pctOfSales < 0.75 ? '#59BA47' : '#FF4509';
          } else {
            purchasesColor = d.purchases > d.costOfSales ? '#FF4509' : '#59BA47';
          }
          
          return {
            x, y: purchasesY, width: barWidth, height: purchasesHeight,
            purchasesColor, data: d, index, comparisonType
          };
        });
        
        if (comparisonType === 'sales') {
          window.purchasesSalesBarData = barDataArray;
        } else {
          window.purchasesCosBarData = barDataArray;
        }
        
        // Draw bars
        data.forEach((d, index) => {
          const x = padding.left + (index * barSpacing) + (barSpacing - barWidth) / 2;
          
          // Base bar (comparison value)
          const baseHeight = (d[comparisonField] / maxValue) * effectiveHeight;
          const baseY = startY + effectiveHeight - baseHeight;
          
          // Purchases bar
          const purchasesHeight = (d.purchases / maxValue) * effectiveHeight;
          const purchasesY = startY + effectiveHeight - purchasesHeight;
          
          // Determine color
          let purchasesColor;
          if (comparisonType === 'sales') {
            const pctOfSales = d.sales > 0 ? (d.purchases / d.sales) : 0;
            purchasesColor = pctOfSales < 0.75 ? '#59BA47' : '#FF4509';
          } else {
            purchasesColor = d.purchases > d.costOfSales ? '#FF4509' : '#59BA47';
          }
          
          // Draw base bar (gray background)
          ctx.fillStyle = '#6B7280';
          ctx.globalAlpha = 0.4;
          drawRoundedRect(ctx, x, baseY, barWidth, baseHeight, radius);
          ctx.fill();
          
          // Draw purchases bar
          ctx.globalAlpha = 1;
          ctx.fillStyle = purchasesColor;
          drawRoundedRect(ctx, x, purchasesY, barWidth, purchasesHeight, radius);
          ctx.fill();
          
          // Draw day labels (responsive font size)
          ctx.fillStyle = '#6B7280';
          const labelFontSize = canvasWidth < 600 ? 10 : 12;
          ctx.font = `${labelFontSize}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`;
          ctx.textAlign = 'center';
          
          // Only show every other label on very small screens
          const showLabel = canvasWidth >= 600 || index % 2 === 0;
          if (showLabel) {
            ctx.fillText(d.label, x + barWidth / 2, startY + effectiveHeight + 20);
          }
        });
        
        // Draw Y-axis labels
        ctx.fillStyle = '#6B7280';
        ctx.font = '11px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        ctx.textAlign = 'right';
        
        // Reduce number of labels on smaller screens
        const labelCount = canvasWidth < 600 ? 3 : 5;
        const labelStep = labelCount === 3 ? 2 : 1;
        
        for (let i = 0; i <= labelCount; i += labelStep) {
          const value = (maxValue * i) / labelCount;
          const y = startY + effectiveHeight - (effectiveHeight * i / labelCount);
          const label = formatCurrencyAbbreviated(value);
          
          // Adjust label position for better readability
          const labelX = padding.left - 8;
          const labelY = y + 3;
          
          ctx.fillText(label, labelX, labelY);
        }
      }
      
      function drawGPChart(data) {
        console.log('=== DRAW GP CHART DEBUG START ===');
        console.log('drawGPChart called with data:', data);
        
        // Hide loading spinner
        hideChartLoading();
        
        const canvas = document.getElementById('metric-trend-chart');
        const ctx = canvas.getContext('2d');
        const container = canvas.parentElement;
        
        console.log('Canvas element:', canvas);
        console.log('Container element:', container);
        
        // Get actual pixel dimensions from container
        const rect = container.getBoundingClientRect();
        
        // If in landscape modal mode, use screen dimensions instead
        let width, height;
        if (window.isLandscapeModal) {
          // In landscape mode, use screen height as width and screen width as height
          width = window.innerHeight * 0.75; // 75% of screen height
          height = window.innerWidth * 0.6;  // 60% of screen width
        } else {
          width = rect.width;
          height = rect.height;
        }
        
        // Scale for high-DPI displays
        const dpr = window.devicePixelRatio || 1;
        canvas.width = width * dpr;
        canvas.height = height * dpr;
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        ctx.scale(dpr, dpr);
        
        ctx.clearRect(0, 0, width, height);
        
        if (!data || data.length === 0) {
          drawEmptyChart();
          return;
        }
        
        // Store bar data for tooltip interaction
        window.gpBarData = [];
        
        // Draw GP chart
        const padding = { top: 40, right: 40, bottom: 60, left: 80 };
        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;
        
        drawGPComparisonChart(ctx, data, padding.top, chartHeight, width);
        
        // Draw tooltip if hovering
        if (window.gpTooltip) {
          drawGPTooltip(ctx, window.gpTooltip);
        }
        
        console.log('=== DRAW GP CHART DEBUG END ===');
      }
      
      function drawBasketChart(data) {
        console.log('=== DRAW BASKET CHART DEBUG START ===');
        console.log('drawBasketChart called with data:', data);
        
        // Hide loading spinner
        hideChartLoading();
        
        const canvas = document.getElementById('metric-trend-chart');
        const ctx = canvas.getContext('2d');
        const container = canvas.parentElement;
        
        console.log('Canvas element:', canvas);
        console.log('Container element:', container);
        
        // Get actual pixel dimensions from container
        const rect = container.getBoundingClientRect();
        
        // If in landscape modal mode, use screen dimensions instead
        let width, height;
        if (window.isLandscapeModal) {
          // In landscape mode, use screen height as width and screen width as height
          width = window.innerHeight * 0.75; // 75% of screen height
          height = window.innerWidth * 0.6;  // 60% of screen width
        } else {
          width = rect.width;
          height = rect.height;
        }
        
        // Scale for high-DPI displays
        const dpr = window.devicePixelRatio || 1;
        canvas.width = width * dpr;
        canvas.height = height * dpr;
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        ctx.scale(dpr, dpr);
        
        console.log('Canvas dimensions:', canvas.width, 'x', canvas.height);
        console.log('Container dimensions:', rect.width, 'x', rect.height);
        
        // Clear canvas
        ctx.clearRect(0, 0, width, height);
        
        if (!data || data.length === 0) {
          console.log('No data to draw');
          return;
        }
        
        const canvasWidth = width;
        const canvasHeight = height;
        
        console.log('Canvas width:', canvasWidth, 'height:', canvasHeight);
        
        // Calculate chart dimensions
        const padding = { top: 20, right: 40, bottom: 50, left: 80 };
        const chartWidth = canvasWidth - padding.left - padding.right;
        const chartHeight = canvasHeight - padding.top - padding.bottom;
        const startY = padding.top;
        
        console.log('Chart dimensions:', chartWidth, 'x', chartHeight);
        console.log('Start Y:', startY);
        
        // Find max value for scaling (R200 target + some buffer)
        const maxValue = Math.max(200, Math.max(...data.map(d => d.basketValue)) * 1.1);
        console.log('Max value for scaling:', maxValue);
        
        // Draw basket chart
        drawBasketComparisonChart(ctx, data, startY, chartHeight, canvasWidth, maxValue);
        
        // Draw tooltip if hovering
        if (window.basketTooltip) {
          drawBasketTooltip(ctx, window.basketTooltip);
        }
        
        console.log('=== DRAW BASKET CHART DEBUG END ===');
      }
      
      function drawBasketComparisonChart(ctx, data, startY, chartHeight, canvasWidth, maxValue) {
        const padding = { top: 20, right: 40, bottom: 50, left: 80 };
        const chartWidth = canvasWidth - padding.left - padding.right;
        const effectiveHeight = chartHeight;
        
        console.log('drawBasketComparisonChart called');
        console.log('Data length:', data.length);
        console.log('Max value:', maxValue);
        
        // Draw Y-axis labels
        ctx.fillStyle = '#6B7280';
        ctx.font = canvasWidth < 600 ? '10px' : '12px';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        
        const labelCount = 5;
        for (let i = 0; i <= labelCount; i++) {
          const value = (maxValue * i) / labelCount;
          const y = startY + effectiveHeight - (effectiveHeight * i / labelCount);
          const label = formatCurrencyAbbreviated(value);
          ctx.fillText(label, padding.left - 10, y);
        }
        
        // Draw bars
        const barWidth = Math.max(8, chartWidth / data.length * 0.6);
        const barSpacing = chartWidth / data.length;
        const radius = 4;
        
        // Store bar data for tooltip interaction
        const barDataArray = data.map((d, index) => {
          const x = padding.left + (index * barSpacing) + (barSpacing - barWidth) / 2;
          const basketHeight = (d.basketValue / maxValue) * effectiveHeight;
          const basketY = startY + effectiveHeight - basketHeight;
          
          // Color logic: Green if >= R200, Orange if < R200
          const basketColor = d.basketValue >= 200 ? '#59BA47' : '#FF4509';
          
          return {
            x, y: basketY, width: barWidth, height: basketHeight,
            basketColor, data: d, index
          };
        });
        
        window.basketBarData = barDataArray;
        
        // Draw bars
        data.forEach((d, index) => {
          const x = padding.left + (index * barSpacing) + (barSpacing - barWidth) / 2;
          
          // Draw base bar (R200 target)
          const targetHeight = (200 / maxValue) * effectiveHeight;
          const targetY = startY + effectiveHeight - targetHeight;
          
          // Draw base bar (R200 target)
          drawRoundedRect(ctx, x, targetY, barWidth, targetHeight, radius);
          ctx.fillStyle = '#E5E7EB';
          ctx.fill();
          
          // Actual basket value bar (colored overlay)
          const basketHeight = (d.basketValue / maxValue) * effectiveHeight;
          const basketY = startY + effectiveHeight - basketHeight;
          
          // Color logic: Green if >= R200, Orange if < R200
          const basketColor = d.basketValue >= 200 ? '#59BA47' : '#FF4509';
          
          // Draw basket value bar
          drawRoundedRect(ctx, x, basketY, barWidth, basketHeight, radius);
          ctx.fillStyle = basketColor;
          ctx.fill();
        });
        
        // Draw X-axis labels
        ctx.fillStyle = '#6B7280';
        ctx.font = canvasWidth < 600 ? '10px' : '12px';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        
        data.forEach((d, index) => {
          const x = padding.left + (index * barSpacing) + barSpacing / 2;
          const labelY = startY + effectiveHeight + 20;
          ctx.fillText(d.label, x, labelY);
        });
      }
      function drawBasketTooltip(ctx, tooltip) {
        if (!tooltip) return;
        
        const { x, y, data } = tooltip;
        const basketValue = data.basketValue;
        const target = 200;
        const difference = basketValue - target;
        const percentDiff = target ? (difference / target) * 100 : 0;
        
        // Tooltip dimensions
        const tooltipWidth = 160;
        const tooltipHeight = 80;
        const padding = 12;
        
        // Get display dimensions (CSS pixels, not internal canvas resolution)
        const displayWidth = parseFloat(ctx.canvas.style.width) || ctx.canvas.getBoundingClientRect().width;
        const displayHeight = parseFloat(ctx.canvas.style.height) || ctx.canvas.getBoundingClientRect().height;
        
        // Position tooltip
        let tooltipX = x - tooltipWidth / 2;
        let tooltipY = y - tooltipHeight - 10;
        
        // Keep tooltip within canvas bounds
        if (tooltipX < 10) tooltipX = 10;
        if (tooltipX + tooltipWidth > displayWidth - 10) {
          tooltipX = displayWidth - tooltipWidth - 10;
        }
        if (tooltipY < 10) tooltipY = y + 10;
        
        // Draw tooltip background
        ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
        ctx.fillRect(tooltipX, tooltipY, tooltipWidth, tooltipHeight);
        
        // Draw tooltip border
        ctx.strokeStyle = '#E5E7EB';
        ctx.lineWidth = 1;
        ctx.strokeRect(tooltipX, tooltipY, tooltipWidth, tooltipHeight);
        
        // Draw tooltip content
        ctx.fillStyle = '#FFFFFF';
        ctx.font = '12px Nunito, sans-serif';
        ctx.textAlign = 'left';
        ctx.textBaseline = 'top';
        
        const lineHeight = 16;
        let currentY = tooltipY + padding;
        
        // Date
        ctx.fillText(data.businessDate, tooltipX + padding, currentY);
        currentY += lineHeight;
        
        // Basket value
        ctx.fillText(`Basket: R${basketValue.toFixed(0)}`, tooltipX + padding, currentY);
        currentY += lineHeight;
        
        // Target
        ctx.fillText(`Target: R${target}`, tooltipX + padding, currentY);
        currentY += lineHeight;
        
        // Difference
        const diffColor = difference >= 0 ? '#59BA47' : '#FF4509';
        ctx.fillStyle = diffColor;
        ctx.fillText(`${difference >= 0 ? '+' : ''}R${difference.toFixed(0)} (${percentDiff >= 0 ? '+' : ''}${percentDiff.toFixed(1)}%)`, tooltipX + padding, currentY);
      }
      
      function drawGPComparisonChart(ctx, data, startY, chartHeight, canvasWidth) {
        const padding = { top: 20, right: 40, bottom: 50, left: 80 };
        const chartWidth = canvasWidth - padding.left - padding.right;
        const effectiveHeight = chartHeight; // chartHeight already has padding removed
        
        // Calculate max value (at least 25% target, plus some buffer)
        const maxValue = Math.max(25, ...data.map(d => d.gpPercent || 0), 1);
        
        const barWidth = (chartWidth / data.length) * 0.7;
        const barSpacing = chartWidth / data.length;
        const radius = 4;
        
        // Store bar data for tooltip interaction
        const barDataArray = data.map((d, index) => {
          const x = padding.left + (index * barSpacing) + (barSpacing - barWidth) / 2;
          const gpHeight = (d.gpPercent / maxValue) * effectiveHeight;
          const gpY = startY + effectiveHeight - gpHeight;
          
          // Color logic: Green if >= 25%, Orange if < 25%
          const gpColor = d.gpPercent >= 25 ? '#59BA47' : '#FF4509';
          
          return {
            x, y: gpY, width: barWidth, height: gpHeight,
            gpColor, data: d, index
          };
        });
        
        window.gpBarData = barDataArray;
        
        // Draw bars
        data.forEach((d, index) => {
          const x = padding.left + (index * barSpacing) + (barSpacing - barWidth) / 2;
          
          // Base bar: 25% target (gray background)
          const targetHeight = (25 / maxValue) * effectiveHeight;
          const targetY = startY + effectiveHeight - targetHeight;
          
          // Draw base bar (25% target)
          drawRoundedRect(ctx, x, targetY, barWidth, targetHeight, radius);
          ctx.fillStyle = '#E5E7EB';
          ctx.fill();
          
          // Actual GP% bar (colored overlay)
          const gpHeight = (d.gpPercent / maxValue) * effectiveHeight;
          const gpY = startY + effectiveHeight - gpHeight;
          
          // Color logic: Green if >= 25%, Orange if < 25%
          const gpColor = d.gpPercent >= 25 ? '#59BA47' : '#FF4509';
          
          // Draw GP% bar
          drawRoundedRect(ctx, x, gpY, barWidth, gpHeight, radius);
          ctx.fillStyle = gpColor;
          ctx.fill();
        });
        
        // Draw X-axis labels
        ctx.fillStyle = '#6B7280';
        ctx.font = canvasWidth < 600 ? '10px' : '12px';
        ctx.font += ' -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        ctx.textAlign = 'center';
        
        data.forEach((d, index) => {
          const x = padding.left + (index * barSpacing) + (barSpacing - barWidth) / 2;
          
          // Only show every other label on very small screens
          const showLabel = canvasWidth >= 600 || index % 2 === 0;
          if (showLabel) {
            ctx.fillText(d.label, x + barWidth / 2, startY + effectiveHeight + 20);
          }
        });
        
        // Draw Y-axis labels
        ctx.fillStyle = '#6B7280';
        ctx.font = '11px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        ctx.textAlign = 'right';
        
        // Reduce number of labels on smaller screens
        const labelCount = canvasWidth < 600 ? 3 : 5;
        const labelStep = labelCount === 3 ? 2 : 1;
        
        for (let i = 0; i <= labelCount; i += labelStep) {
          const value = (maxValue * i) / labelCount;
          const y = startY + effectiveHeight - (effectiveHeight * i / labelCount);
          const label = Math.round(value) + '%';
          
          // Adjust label position for better readability
          const labelX = padding.left - 8;
          const labelY = y + 3;
          
          ctx.fillText(label, labelX, labelY);
        }
      }
      
      function drawGPTooltip(ctx, tooltip) {
        const { x, y, data } = tooltip;
        
        // Get display dimensions (CSS pixels, not internal canvas resolution)
        const displayWidth = parseFloat(ctx.canvas.style.width) || ctx.canvas.getBoundingClientRect().width;
        
        const tooltipText = [
          `${data.label}`,
          `GP%: ${data.gpPercent.toFixed(1)}%`,
          `Target: 25%`
        ];
        
        const tooltipWidth = 120;
        const tooltipHeight = 60;
        const tooltipX = Math.max(80, Math.min(x - tooltipWidth / 2, displayWidth - tooltipWidth - 40));
        const tooltipY = Math.max(40, y - tooltipHeight - 10);
        
        // Draw tooltip background
        ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
        ctx.strokeStyle = '#E5E7EB';
        ctx.lineWidth = 1;
        drawRoundedRect(ctx, tooltipX, tooltipY, tooltipWidth, tooltipHeight, 8);
        ctx.fill();
        ctx.stroke();
        
        // Draw tooltip content
        ctx.fillStyle = '#1F2937';
        ctx.font = '12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        ctx.textAlign = 'center';
        
        tooltipText.forEach((text, i) => {
          const textY = tooltipY + 20 + (i * 14);
          ctx.fillText(text, tooltipX + tooltipWidth / 2, textY);
        });
      }
      
      function drawPurchasesTooltip(ctx, tooltip) {
        const { x, y, data, comparisonType } = tooltip;
        const comparisonValue = comparisonType === 'sales' ? data.sales : data.costOfSales;
        const percent = comparisonValue > 0 ? (data.purchases / comparisonValue) * 100 : 0;
        
        // Get display dimensions (CSS pixels, not internal canvas resolution)
        const displayWidth = parseFloat(ctx.canvas.style.width) || ctx.canvas.getBoundingClientRect().width;
        
        let color;
        if (comparisonType === 'sales') {
          color = percent < 75 ? '#59BA47' : '#FF4509';
        } else {
          color = data.purchases > data.costOfSales ? '#FF4509' : '#59BA47';
        }
        
        // Tooltip dimensions
        const tooltipWidth = 140;
        const tooltipHeight = 60;
        const tooltipX = Math.max(80, Math.min(x - tooltipWidth / 2, displayWidth - tooltipWidth - 40));
        const tooltipY = Math.max(40, y - tooltipHeight - 10);
        
        // Draw tooltip background
        ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
        ctx.strokeStyle = '#E5E7EB';
        ctx.lineWidth = 1;
        drawRoundedRect(ctx, tooltipX, tooltipY, tooltipWidth, tooltipHeight, 8);
        ctx.fill();
        ctx.stroke();
        
        // Draw tooltip content
        ctx.fillStyle = '#1F2937';
        ctx.font = '12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        ctx.textAlign = 'center';
        
        // Date
        ctx.fillText(data.label, tooltipX + tooltipWidth / 2, tooltipY + 18);
        
        // Purchases value
        ctx.fillText('R ' + Math.round(data.purchases).toLocaleString(), tooltipX + tooltipWidth / 2, tooltipY + 35);
        
        // Percentage
        ctx.fillStyle = color;
        ctx.font = 'bold 12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        ctx.fillText(percent.toFixed(1) + '% of ' + (comparisonType === 'sales' ? 'Sales' : 'CoS'), tooltipX + tooltipWidth / 2, tooltipY + 50);
      }
      
      function getMonthsInRange(startDate, endDate) {
        const months = [];
        const current = new Date(startDate);
        
        while (current <= endDate) {
          const year = current.getFullYear();
          const month = String(current.getMonth() + 1).padStart(2, '0');
          months.push(`${year}-${month}`);
          current.setMonth(current.getMonth() + 1);
        }
        
        return months;
      }
      
      function getMetricColor(metricType) {
        switch(metricType) {
          case 'turnover': return '#ef4523';
          case 'gp': return '#56b947';
          case 'purchases': return '#00b5dc';
          case 'basket': return '#565da9';
          default: return '#007AFF';
        }
      }
      
      function drawComboChart(data, metricType) {
        // Hide loading spinner
        hideChartLoading();
        
        const canvas = document.getElementById('metric-trend-chart');
        const ctx = canvas.getContext('2d');
        const color = getMetricColor(metricType);
        
        // Set canvas size to match container
        const container = canvas.parentElement;
        const width = container.clientWidth;
        const height = container.clientHeight;
        
        // Scale for high-DPI displays
        const dpr = window.devicePixelRatio || 1;
        canvas.width = width * dpr;
        canvas.height = height * dpr;
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        ctx.scale(dpr, dpr);
        
        // Clear canvas
        ctx.clearRect(0, 0, width, height);
        
        if (!data || data.length === 0) {
          ctx.fillStyle = '#6B7280';
          ctx.font = '16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('No data available', width / 2, height / 2);
          return;
        }
        
        // Maintain consistent aspect ratio (landscape proportions)
        const targetAspectRatio = 2.5; // Width/Height ratio
        const padding = { top: 40, right: 40, bottom: 60, left: 80 };
        
        let chartWidth, chartHeight;
        let offsetX = 0, offsetY = 0;
        
        // Calculate chart dimensions maintaining aspect ratio
        const availableWidth = width - padding.left - padding.right;
        const availableHeight = height - padding.top - padding.bottom;
        
        if (availableWidth / availableHeight > targetAspectRatio) {
          // Container is too wide - constrain by height
          chartHeight = availableHeight;
          chartWidth = chartHeight * targetAspectRatio;
          offsetX = (availableWidth - chartWidth) / 2;
        } else {
          // Container is too tall - constrain by width
          chartWidth = availableWidth;
          chartHeight = chartWidth / targetAspectRatio;
          offsetY = (availableHeight - chartHeight) / 2;
        }
        
        // Adjust padding to center the chart
        const finalPadding = {
          top: padding.top + offsetY,
          right: padding.right + offsetX,
          bottom: padding.bottom + offsetY,
          left: padding.left + offsetX
        };
        
        // Extract values based on metric type (line only)
        let lineValues = [];
        let labels = [];
        
        data.forEach(d => {
          const date = new Date(d.business_date + 'T00:00:00');
          const label = date.getDate();
          labels.push(label);
          
          switch(metricType) {
            case 'turnover':
              lineValues.push(Number(d.turnover || 0));
              break;
            case 'gp':
              const gpValue = Number(d.gp_value || 0);
              // Use GP% from API data (same as Daily tracking screen and GP chart)
              const gpPercent = (d.gp_pct !== undefined && d.gp_pct !== null) ? Number(d.gp_pct) : (d.turnover ? (gpValue / Number(d.turnover)) * 100 : 0);
              lineValues.push(gpPercent);
              break;
            case 'purchases':
              lineValues.push(Number(d.purchases || d.daily_purchases || 0));
              break;
            case 'basket':
              const turnover = Number(d.turnover || 0);
              const estimatedTxns = Math.max(1, Math.round(turnover / 150));
              const basketVal = turnover / estimatedTxns;
              lineValues.push(basketVal);
              break;
          }
        });
        
        // Calculate scales for line series
        const maxLineValue = Math.max(...lineValues);
        const minLineValue = Math.min(...lineValues, 0);
        const lineRange = Math.max(1, maxLineValue - minLineValue);
        const step = chartWidth / Math.max(1, data.length - 1);
        
        // Draw line
        ctx.strokeStyle = color;
        ctx.lineWidth = 2.5;
        ctx.beginPath();
        
        lineValues.forEach((value, i) => {
          const x = finalPadding.left + (i * step);
          const y = finalPadding.top + chartHeight - ((value - minLineValue) / lineRange) * chartHeight;
          
          if (i === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        });
        
        ctx.stroke();
        
        // Soft area fill under line
        ctx.fillStyle = hexToRgba(color, 0.12);
        ctx.beginPath();
        lineValues.forEach((value, i) => {
          const x = finalPadding.left + (i * step);
          const y = finalPadding.top + chartHeight - ((value - minLineValue) / lineRange) * chartHeight;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.lineTo(finalPadding.left + (lineValues.length - 1) * step, finalPadding.top + chartHeight);
        ctx.lineTo(finalPadding.left, finalPadding.top + chartHeight);
        ctx.closePath();
        ctx.fill();
        
        // Draw Y-axis labels (left side)
        ctx.fillStyle = '#6B7280';
        ctx.font = '12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        ctx.textAlign = 'right';
        
        for (let i = 0; i <= 5; i++) {
          const value = minLineValue + (lineRange * i / 5);
          const y = finalPadding.top + chartHeight - (chartHeight * i / 5);
          let label = '';
          
          if (metricType === 'turnover' || metricType === 'purchases' || metricType === 'basket') {
            label = 'R ' + Math.round(value).toLocaleString();
          } else {
            label = Math.round(value).toLocaleString();
          }
          
          ctx.fillText(label, finalPadding.left - 10, y + 4);
        }
        
        // Draw X-axis labels (dates - bottom)
        ctx.textAlign = 'center';
        const labelInterval = Math.ceil(data.length / 12); // Show ~12 labels
        
        labels.forEach((label, i) => {
          if (i % labelInterval === 0 || i === labels.length - 1) {
            const x = finalPadding.left + (i * step);
            const y = finalPadding.top + chartHeight + 20;
            ctx.fillText(label, x, y);
          }
        });
      }

      function hexToRgba(hex, alpha) {
        const h = hex.replace('#','');
        const bigint = parseInt(h, 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }

      // Custom Date Picker Functions
      var datePickerCurrentMonth = new Date();
      
      function updateDateDisplay() {
        var displayEl = document.getElementById('selected-date-display');
        if (!displayEl || !selectedDate) return;
        
        var today = new Date();
        var todayStr = formatYmdLocal(today);
        var yesterdayStr = getYesterdayDate();
        
        if (selectedDate === todayStr) {
          displayEl.textContent = 'Today';
        } else if (selectedDate === yesterdayStr) {
          displayEl.textContent = 'Yesterday';
        } else {
          var dateObj = new Date(selectedDate + 'T00:00:00');
          displayEl.textContent = dateObj.toLocaleDateString('en-US', { 
            weekday: 'short', 
            month: 'short', 
            day: 'numeric' 
          });
        }
      }
      
      function openDatePicker() {
        var overlay = document.getElementById('date-picker-modal-overlay');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Check if we're on Daily Tracking or Targets tabs - use month selector value
        var dailyHidden = document.getElementById('tab-daily').hidden;
        var targetsHidden = document.getElementById('tab-targets').hidden;
        
        if ((!dailyHidden || !targetsHidden) && monthEl && monthEl.value) {
          // Use month selector value for Daily Tracking and Targets tabs
          var monthValue = monthEl.value; // Format: YYYY-MM
          var parts = monthValue.split('-');
          datePickerCurrentMonth = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, 1);
        } else if (selectedDate) {
          // Set date picker to current selected date's month for other tabs
          var parts = selectedDate.split('-');
          datePickerCurrentMonth = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, 1);
        }
        renderDatePicker();
      }
      
      function closeDatePicker() {
        var overlay = document.getElementById('date-picker-modal-overlay');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
      }
      
      function renderDatePicker() {
        var monthEl = document.getElementById('date-picker-month');
        var daysEl = document.getElementById('date-picker-days');
        
        var year = datePickerCurrentMonth.getFullYear();
        var month = datePickerCurrentMonth.getMonth();
        
        // Update month display
        monthEl.textContent = datePickerCurrentMonth.toLocaleDateString('en-US', { 
          month: 'long', 
          year: 'numeric' 
        });
        
        // Calculate calendar days
        var firstDay = new Date(year, month, 1).getDay();
        var daysInMonth = new Date(year, month + 1, 0).getDate();
        var today = formatYmdLocal(new Date());
        
        var html = '';
        
        // Empty cells for days before month starts
        for (var i = 0; i < firstDay; i++) {
          html += '<div class="date-picker-day empty"></div>';
        }
        
        // Days of the month
        for (var day = 1; day <= daysInMonth; day++) {
          var dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
          var isSelected = dateStr === selectedDate;
          var isToday = dateStr === today;
          var classes = 'date-picker-day';
          if (isSelected) classes += ' selected';
          if (isToday) classes += ' today';
          
          html += `<div class="${classes}" data-date="${dateStr}">${day}</div>`;
        }
        
        daysEl.innerHTML = html;
        
        // Add click handlers
        var dayElements = daysEl.querySelectorAll('.date-picker-day:not(.empty)');
        dayElements.forEach(function(el) {
          el.addEventListener('click', function() {
            selectedDate = el.getAttribute('data-date');
            console.log('Date selected:', selectedDate);
            updateDateDisplay();
            
            // Update month selector for Daily Tracking and Targets tabs
            if (monthEl && selectedDate) {
              var monthStr = selectedDate.slice(0, 7); // Extract YYYY-MM from YYYY-MM-DD
              monthEl.value = monthStr;
            }
            
            renderDatePicker(); // Re-render to update selected state
            
            // Check if we're on the Dashboard tab
            var dashboardHidden = document.getElementById('tab-dashboard').hidden;
            if (!dashboardHidden) {
              console.log('Loading dashboard for:', selectedDate);
              loadDashboard();
              // Reload group view if enabled
              if (groupViewEnabled) {
                loadGroupViewData();
              }
            }
            
            // Check if we're on the Daily Summary tab
            var dailySummaryHidden = document.getElementById('tab-daily-summary').hidden;
            if (!dailySummaryHidden) {
              console.log('Loading daily summary for:', selectedDate);
              loadDailySummary();
            }
            
            // Check if we're on the Monthly Summary tab
            var monthlySummaryHidden = document.getElementById('tab-monthly-summary').hidden;
            if (!monthlySummaryHidden) {
              console.log('Loading monthly summary for:', selectedDate);
              loadMonthlySummary();
            }
            
            // Check if we're on the Daily Tracking tab
            var dailyHidden = document.getElementById('tab-daily').hidden;
            if (!dailyHidden) {
              console.log('Loading daily tracking for month:', selectedDate ? selectedDate.slice(0, 7) : null);
              loadDays();
            }
            
            // Check if we're on the Targets tab
            var targetsHidden = document.getElementById('tab-targets').hidden;
            if (!targetsHidden) {
              console.log('Loading targets for month:', selectedDate ? selectedDate.slice(0, 7) : null);
              buildTargetsTable();
            }
            
            // Check if we're on the Stock Management tab
            var stockManagementHidden = document.getElementById('tab-stock-management').hidden;
            if (!stockManagementHidden) {
              console.log('Loading stock management for:', selectedDate);
              loadStockManagement();
            }
            
            // Also reload best sellers and worst GP products for the new date
            loadBestSellers();
            loadWorstGP();
          });
        });
      }
      
      function initDatePicker() {
        var datePickerBtn = document.getElementById('date-picker-btn');
        var prevMonthBtn = document.getElementById('date-picker-prev-month');
        var nextMonthBtn = document.getElementById('date-picker-next-month');
        var todayBtn = document.getElementById('date-picker-today');
        var closeBtn = document.getElementById('date-picker-close');
        var overlay = document.getElementById('date-picker-modal-overlay');
        
        datePickerBtn && datePickerBtn.addEventListener('click', openDatePicker);
        closeBtn && closeBtn.addEventListener('click', closeDatePicker);
        
        overlay && overlay.addEventListener('click', function(e) {
          if (e.target === overlay) closeDatePicker();
        });
        
        prevMonthBtn && prevMonthBtn.addEventListener('click', function() {
          datePickerCurrentMonth.setMonth(datePickerCurrentMonth.getMonth() - 1);
          renderDatePicker();
        });
        
        nextMonthBtn && nextMonthBtn.addEventListener('click', function() {
          datePickerCurrentMonth.setMonth(datePickerCurrentMonth.getMonth() + 1);
          renderDatePicker();
        });
        
        todayBtn && todayBtn.addEventListener('click', function() {
          var today = new Date();
          selectedDate = formatYmdLocal(today);
          datePickerCurrentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
          console.log('Today button clicked, date set to:', selectedDate);
          updateDateDisplay();
          
          // Update month selector for Daily Tracking and Targets tabs
          if (monthEl && selectedDate) {
            var monthStr = selectedDate.slice(0, 7); // Extract YYYY-MM from YYYY-MM-DD
            monthEl.value = monthStr;
          }
          
          renderDatePicker();
          
          // Check if we're on the Dashboard tab
          var dashboardHidden = document.getElementById('tab-dashboard').hidden;
          if (!dashboardHidden) {
            console.log('Loading dashboard for today:', selectedDate);
            loadDashboard();
            // Reload group view if enabled
            if (groupViewEnabled) {
              loadGroupViewData();
            }
          }
          
          // Check if we're on the Daily Summary tab
          var dailySummaryHidden = document.getElementById('tab-daily-summary').hidden;
          if (!dailySummaryHidden) {
            console.log('Loading daily summary for today:', selectedDate);
            loadDailySummary();
          }
          
          // Check if we're on the Monthly Summary tab
          var monthlySummaryHidden = document.getElementById('tab-monthly-summary').hidden;
          if (!monthlySummaryHidden) {
            console.log('Loading monthly summary for today:', selectedDate);
            loadMonthlySummary();
          }
          
          // Check if we're on the Daily Tracking tab
          var dailyHidden = document.getElementById('tab-daily').hidden;
          if (!dailyHidden) {
            console.log('Loading daily tracking for month:', selectedDate.slice(0, 7));
            loadDays();
          }
          
          // Check if we're on the Targets tab
          var targetsHidden = document.getElementById('tab-targets').hidden;
          if (!targetsHidden) {
            console.log('Loading targets for month:', selectedDate.slice(0, 7));
            buildTargetsTable();
          }
          
          // Check if we're on the Stock Management tab
          var stockManagementHidden = document.getElementById('tab-stock-management').hidden;
          if (!stockManagementHidden) {
            console.log('Loading stock management for today:', selectedDate);
            loadStockManagement();
          }
          
          // Also reload best sellers and worst GP products for today
          loadBestSellers();
          loadWorstGP();
        });
      }

      // Pharmacy Picker Functions
      function updatePharmacyDisplay() {
        var displayEl = document.getElementById('selected-pharmacy-display');
        if (!displayEl) return;
        
        if (selectedPharmacyName) {
          displayEl.textContent = selectedPharmacyName;
        } else {
          displayEl.textContent = 'Select Pharmacy';
        }
      }
      
      function updatePharmacySelectionHighlight() {
        var pharmacyOptions = document.querySelectorAll('.pharmacy-option');
        pharmacyOptions.forEach(function(option) {
          // Remove selected class from all options
          option.classList.remove('selected');
          // Add selected class to the currently selected pharmacy
          if (option.getAttribute('data-pharmacy-id') === selectedPharmacyId) {
            option.classList.add('selected');
          }
        });
      }
      
      function openPharmacyPicker() {
        var overlay = document.getElementById('pharmacy-picker-modal-overlay');
        // Update the highlighting before opening the modal
        updatePharmacySelectionHighlight();
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
      
      function closePharmacyPicker() {
        var overlay = document.getElementById('pharmacy-picker-modal-overlay');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
      }
      
      function initPharmacyPicker() {
        var pharmacyPickerBtn = document.getElementById('pharmacy-picker-btn');
        var closeBtn = document.getElementById('pharmacy-picker-close');
        var overlay = document.getElementById('pharmacy-picker-modal-overlay');
        var pharmacyOptions = document.querySelectorAll('.pharmacy-option');
        
        // Initialize with first pharmacy if available
        if (!selectedPharmacyId && pharmacyOptions.length > 0) {
          var firstOption = pharmacyOptions[0];
          selectedPharmacyId = firstOption.getAttribute('data-pharmacy-id');
          selectedPharmacyName = firstOption.getAttribute('data-pharmacy-name');
          window.selectedPharmacyId = selectedPharmacyId;
          window.selectedPharmacyName = selectedPharmacyName;
          updatePharmacyDisplay();
        }
        
        pharmacyPickerBtn && pharmacyPickerBtn.addEventListener('click', openPharmacyPicker);
        closeBtn && closeBtn.addEventListener('click', closePharmacyPicker);
        
        overlay && overlay.addEventListener('click', function(e) {
          if (e.target === overlay) closePharmacyPicker();
        });
        
        pharmacyOptions.forEach(function(option) {
          option.addEventListener('click', function() {
            selectedPharmacyId = this.getAttribute('data-pharmacy-id');
            selectedPharmacyName = this.getAttribute('data-pharmacy-name');
            window.selectedPharmacyId = selectedPharmacyId;
            window.selectedPharmacyName = selectedPharmacyName;
            console.log('Pharmacy selected:', selectedPharmacyId, selectedPharmacyName);
            updatePharmacyDisplay();
            // Update highlighting after selection
            updatePharmacySelectionHighlight();
            closePharmacyPicker();
            
            // Disable group view and switch to single pharmacy view when pharmacy is selected
            const groupViewToggleEl = document.getElementById('group-view-toggle-btn');
            const groupViewContainerEl = document.getElementById('group-view-container');
            const singlePharmacyViewEl = document.getElementById('single-pharmacy-view');
            
            if (groupViewToggleEl && groupViewContainerEl && singlePharmacyViewEl) {
              // Check if group view is currently active (button has 'active' class)
              if (groupViewToggleEl.classList.contains('active')) {
                // Disable group view by clicking the toggle button (this properly updates the state variable)
                groupViewToggleEl.click();
              } else {
                // Ensure single view is visible and group view is hidden
                singlePharmacyViewEl.style.display = 'block';
                groupViewContainerEl.style.display = 'none';
              }
            }
            
            // Reload data for the new pharmacy
            loadDays();
            var targetsHidden = document.getElementById('tab-targets').hidden;
            var dashboardHidden = document.getElementById('tab-dashboard').hidden;
            var dailySummaryHidden = document.getElementById('tab-daily-summary').hidden;
            var monthlySummaryHidden = document.getElementById('tab-monthly-summary').hidden;
            var stockManagementHidden = document.getElementById('tab-stock-management').hidden;
            var stockQueriesHidden = document.getElementById('tab-stock-queries').hidden;
            var debtorToolsHidden = document.getElementById('tab-debtor-tools').hidden;
            
            // Reload all visible tabs
            if (!targetsHidden) buildTargetsTable();
            if (!dashboardHidden) {
              loadDashboard();
              // Also reload best sellers and worst GP products (used in dashboard)
              loadBestSellers();
              loadWorstGP();
            }
            if (!dailySummaryHidden) loadDailySummary();
            if (!monthlySummaryHidden) loadMonthlySummary();
            if (!stockManagementHidden) loadStockManagement();
            if (!stockQueriesHidden) {
              loadStockQueries();
              loadStockInsights();
            }
            if (!debtorToolsHidden) loadDebtorTools();
            
            var unmatchedTransactionsHidden = document.getElementById('tab-unmatched-transactions').hidden;
            if (!unmatchedTransactionsHidden) {
              loadReconciliationSummary(selectedPharmacyId);
              loadUnmatchedTransactions(selectedPharmacyId);
            }
            
            // Reload group view if enabled
            if (groupViewEnabled) {
              loadGroupViewData();
            }
          });
        });
        
        // Initialize highlighting on page load
        updatePharmacySelectionHighlight();
      }

      // Best Sellers List Modal Functions
      async function openBestSellersListModal() {
        var overlay = document.getElementById('best-sellers-list-modal-overlay');
        
        // No landscape rotation for this modal - keep it portrait full screen
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Load and render list data
        await loadBestSellersList();
      }
      
      function closeBestSellersListModal() {
        var overlay = document.getElementById('best-sellers-list-modal-overlay');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
      }
      async function loadBestSellersList() {
        if (!selectedPharmacyId) {
          console.log('No pharmacy selected');
          return;
        }
        
        var dateToUse = selectedDate || new Date().toISOString().split('T')[0];
        var pid = selectedPharmacyId;
        
        // Check if we're on monthly summary tab
        const monthlySummaryTab = document.getElementById('tab-monthly-summary');
        const isMonthlyView = monthlySummaryTab && !monthlySummaryTab.hidden;
        
        console.log('Modal fetching for pid:', pid, 'date:', dateToUse, 'monthly view:', isMonthlyView);
        
        const container = document.getElementById('best-sellers-list-content');
        
        try {
          // Show loading state
          if (container) {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--textMuted);">Loading...</div>';
          }
          
          // Fetch top 20 best sellers
          let url;
          if (isMonthlyView) {
            const fromDate = dateToUse.slice(0, 8) + '01'; // First day of month
            const toDate = dateToUse;
            url = `/api/best-sellers?pid=${encodeURIComponent(pid)}&from_date=${encodeURIComponent(fromDate)}&to_date=${encodeURIComponent(toDate)}&limit=20`;
          } else {
            url = `/api/best-sellers?pid=${encodeURIComponent(pid)}&date=${encodeURIComponent(dateToUse)}&limit=20`;
          }
          
          console.log('Modal fetching best sellers:', url);
          const resp = await fetch(url);
          console.log('Modal response status:', resp.status);
          const data = resp.ok ? await resp.json() : {items: []};
          console.log('Modal Best Sellers RAW data:', JSON.stringify(data, null, 2));
          
          // Handle different response structures
          let bestSellers = [];
          if (Array.isArray(data)) {
            bestSellers = data;
          } else if (data.best_sellers) {
            bestSellers = data.best_sellers;
          } else if (data.stock_activity) {
            bestSellers = data.stock_activity;
          } else if (data.items) {
            bestSellers = data.items;
          } else if (data.data && Array.isArray(data.data)) {
            bestSellers = data.data;
          }
          
          console.log('Modal - Best sellers array received:', bestSellers.length);
          
          // Take top 20
          const top20 = bestSellers.slice(0, 20);
          
          // Update modal title with date
          const modalTitle = document.getElementById('best-sellers-modal-title');
          const modalDates = document.getElementById('best-sellers-modal-dates');
          if (modalTitle) modalTitle.textContent = 'Top 20 Best Sellers';
          if (modalDates) modalDates.textContent = dateToUse;
          
          // Render list
          if (!container) return;
          
          if (top20.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--textMuted);">No products found for this period</div>';
          return;
        }
        
          container.innerHTML = top20.map((item, idx) => {
            // Use correct field names from the API response (with fallbacks for older endpoints)
            const productName = item.product_description || item.description || item.product_name || item.name || 'Unknown Product';
            const productCode = item.nappi_code || item.product_code || item.code || '';
            const quantity = item.qty_sold || item.quantity_sold || item.qty || item.quantity || item.total_quantity || item.units_sold || 0;
            const gpPercent = item.gp_percent || item.gp_pct || item.margin_pct || 0;
            
            return `
              <div class="worst-gp-list-item">
                <div class="worst-gp-rank">${idx + 1}</div>
                <div class="worst-gp-details">
                  <div class="worst-gp-name">${escapeHtml(productName)}</div>
                  <div class="worst-gp-code">${escapeHtml(productCode)}</div>
                </div>
                <div class="worst-gp-stats">
                  <div class="best-seller-qty">${quantity} units</div>
                  <div class="best-seller-gp">${gpPercent.toFixed(1)}% GP</div>
                </div>
              </div>
            `;
          }).join('');
          
        } catch (e) {
          console.error('Failed to load best sellers list:', e);
          if (container) {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--textMuted);">Error loading data</div>';
          }
        }
      }
      
      function initBestSellersListModal() {
        var listBtn = document.getElementById('best-sellers-chart-btn');
        var monthlyListBtn = document.getElementById('monthly-best-sellers-chart-btn');
        var stockListBtn = document.getElementById('stock-best-sellers-chart-btn');
        var closeBtn = document.getElementById('best-sellers-list-close');
        var overlay = document.getElementById('best-sellers-list-modal-overlay');
        
        listBtn && listBtn.addEventListener('click', openBestSellersListModal);
        monthlyListBtn && monthlyListBtn.addEventListener('click', openBestSellersListModal);
        stockListBtn && stockListBtn.addEventListener('click', openBestSellersListModal);
        closeBtn && closeBtn.addEventListener('click', closeBestSellersListModal);
        
        overlay && overlay.addEventListener('click', function(e) {
          if (e.target === overlay) closeBestSellersListModal();
        });
      }
      
      // Worst GP List Modal Functions
      async function openWorstGPListModal() {
        var overlay = document.getElementById('worst-gp-list-modal-overlay');
        
        // No landscape rotation for this modal - keep it portrait full screen
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Reset to NO SEP by default and update button states
        currentExcludePdst = true;
        updateSepButtonStates();
        
        // Load and render list data
        await loadWorstGPList();
      }
      
      function closeWorstGPListModal() {
        var overlay = document.getElementById('worst-gp-list-modal-overlay');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
      }
      
      // Track current exclude_pdst state (default to true = NO SEP)
      var currentExcludePdst = true;
      
      function updateSepButtonStates() {
        var sepBtn = document.getElementById('sep-btn');
        var noSepBtn = document.getElementById('no-sep-btn');
        
        if (sepBtn && noSepBtn) {
          if (currentExcludePdst) {
            // NO SEP is active
            sepBtn.classList.remove('btn-primary');
            sepBtn.classList.add('btn-secondary');
            noSepBtn.classList.remove('btn-secondary');
            noSepBtn.classList.add('btn-primary');
          } else {
            // SEP is active
            sepBtn.classList.remove('btn-secondary');
            sepBtn.classList.add('btn-primary');
            noSepBtn.classList.remove('btn-primary');
            noSepBtn.classList.add('btn-secondary');
          }
        }
      }
      
      async function loadWorstGPList(threshold, excludePdst) {
        console.log('loadWorstGPList called with threshold:', threshold, 'excludePdst:', excludePdst);
        if (!selectedPharmacyId) {
          console.log('No pharmacy selected');
          return;
        }
        
        // Use provided threshold or get from input, default to 20
        if (threshold === undefined) {
          const thresholdInput = document.getElementById('gp-threshold-input');
          threshold = thresholdInput ? parseFloat(thresholdInput.value) : 20;
        }
        console.log('Using threshold:', threshold);
        
        // Use provided excludePdst or use current state
        if (excludePdst === undefined) {
          excludePdst = currentExcludePdst;
        } else {
          currentExcludePdst = excludePdst;
        }
        console.log('Using exclude_pdst:', excludePdst);
        
        var dateToUse = selectedDate || new Date().toISOString().split('T')[0];
        var pid = selectedPharmacyId;
        
        // Check if we're on monthly summary tab or stock management tab (which uses monthly data)
        const monthlySummaryTab = document.getElementById('tab-monthly-summary');
        const stockManagementTab = document.getElementById('tab-stock-management');
        const isMonthlyView = (monthlySummaryTab && !monthlySummaryTab.hidden) || 
                              (stockManagementTab && !stockManagementTab.hidden);
        
        console.log('Modal fetching for pid:', pid, 'date:', dateToUse, 'monthly view:', isMonthlyView);
        
        const container = document.getElementById('worst-gp-list-content');
        const countDisplay = document.getElementById('gp-threshold-count');
        
        try {
          // Show loading state
          if (container) {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--textMuted);">Loading...</div>';
          }
          if (countDisplay) {
            countDisplay.textContent = 'Loading...';
          }
          
          // Fetch items with exclude PDST/KSAA based on parameter
          let url;
          if (isMonthlyView) {
            const fromDate = dateToUse.slice(0, 8) + '01'; // First day of month
            const toDate = dateToUse;
            url = `/api/worst-gp?pid=${encodeURIComponent(pid)}&from_date=${encodeURIComponent(fromDate)}&to_date=${encodeURIComponent(toDate)}&threshold=${threshold}&limit=100&exclude_pdst=${excludePdst}`;
          } else {
            // For daily view, use date range with same from_date and to_date (today only)
            url = `/api/worst-gp?pid=${encodeURIComponent(pid)}&from_date=${encodeURIComponent(dateToUse)}&to_date=${encodeURIComponent(dateToUse)}&threshold=${threshold}&limit=100&exclude_pdst=${excludePdst}`;
          }
          
          console.log('Modal fetching worst GP:', url);
          const resp = await fetch(url);
          console.log('Modal response status:', resp.status);
          const data = resp.ok ? await resp.json() : {items: []};
          console.log('Modal Worst GP RAW data:', JSON.stringify(data, null, 2));
          
          // Handle different response structures
          let worstGPProducts = [];
          if (Array.isArray(data)) {
            worstGPProducts = data;
          } else if (data.worst_gp_products) {
            worstGPProducts = data.worst_gp_products;
          } else if (data.low_gp_products) {
            worstGPProducts = data.low_gp_products;
          } else if (data.items) {
            worstGPProducts = data.items;
          } else if (data.data && Array.isArray(data.data)) {
            worstGPProducts = data.data;
          }
          
          console.log('Modal - Worst GP array received:', worstGPProducts.length);
          
          // No client-side filtering needed - backend already:
          // 1. Excludes PDST/KSAA when exclude_pdst=true is passed
          // 2. Filters by GP% threshold (returns items with GP% <= threshold)
          
          console.log('Modal - Products with GP% <=' + threshold + '%:', worstGPProducts.length);
          
          // Update modal title with date
          const modalTitle = document.getElementById('worst-gp-modal-title');
          const modalDates = document.getElementById('worst-gp-modal-dates');
          if (modalTitle) modalTitle.textContent = 'Low GP Products';
          if (modalDates) {
            if (isMonthlyView) {
              // Show date range for monthly view
              const fromDate = dateToUse.slice(0, 8) + '01'; // First day of month
              modalDates.textContent = `${fromDate} to ${dateToUse}`;
            } else {
              modalDates.textContent = dateToUse;
            }
          }
          
          // Update count display
          if (countDisplay) {
            countDisplay.textContent = `Showing ${worstGPProducts.length} product${worstGPProducts.length !== 1 ? 's' : ''} with GP% ≤ ${threshold}%`;
          }
          
          // Render list
          if (!container) return;
          
          if (worstGPProducts.length === 0) {
            container.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--textMuted);">No products found with GP% ≤ ${threshold}% for this period</div>`;
            return;
          }
          
          container.innerHTML = worstGPProducts.map((item, idx) => {
            // Use correct field names from the API response (with fallbacks for older endpoints)
            const productName = item.product_name || item.product_description || item.description || item.name || 'Unknown Product';
            const productCode = item.nappi_code || item.product_code || item.code || '';
            const quantity = item.quantity_sold || item.qty_sold || item.qty || item.quantity || item.total_quantity || item.units_sold || 0;
            const gpPercent = item.gp_percent || item.gp_pct || item.margin_pct || 0;
            
            return `
              <div class="worst-gp-list-item">
                <div class="worst-gp-rank">${idx + 1}</div>
                <div class="worst-gp-details">
                  <div class="worst-gp-name">${escapeHtml(productName)}</div>
                  <div class="worst-gp-code">${escapeHtml(productCode)}</div>
                </div>
                <div class="worst-gp-stats">
                  <div class="worst-gp-gp">${gpPercent.toFixed(1)}%</div>
                  <div class="worst-gp-qty">${quantity} units</div>
                </div>
              </div>
            `;
          }).join('');
        } catch (e) {
          console.error('Failed to load worst GP list:', e);
          if (container) {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--textMuted);">Error loading data</div>';
          }
          if (countDisplay) {
            countDisplay.textContent = 'Error loading data';
          }
        }
      }
      
      function downloadWorstGPListPDF() {
        const container = document.getElementById('worst-gp-list-content');
        const threshold = document.getElementById('gp-threshold-input');
        const thresholdValue = threshold ? threshold.value : '20';
        
        if (!container) return;
        
        // Get all the items currently displayed
        const items = container.querySelectorAll('.worst-gp-list-item');
        
        if (items.length === 0) {
          showStyledAlert('No data to download', 'warning', 'No Data');
          return;
        }
        
        // Create PDF using jsPDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const dateToUse = selectedDate || new Date().toISOString().split('T')[0];
        
        // Check if we're on monthly summary tab or stock management tab (which uses monthly data)
        const monthlySummaryTab = document.getElementById('tab-monthly-summary');
        const stockManagementTab = document.getElementById('tab-stock-management');
        const isMonthlyView = (monthlySummaryTab && !monthlySummaryTab.hidden) || 
                              (stockManagementTab && !stockManagementTab.hidden);
        
        // Add title
        const pharmacyName = selectedPharmacyName || 'Unknown Pharmacy';
        doc.setFontSize(16);
        doc.text(`${pharmacyName} - Low GP Products Report`, 14, 15);
        
        doc.setFontSize(10);
        if (isMonthlyView) {
          // Show date range for monthly view
          const fromDate = dateToUse.slice(0, 8) + '01'; // First day of month
          doc.text(`Period: ${fromDate} to ${dateToUse}`, 14, 22);
        } else {
          doc.text(`Date: ${dateToUse}`, 14, 22);
        }
        doc.text(`Threshold: Below ${thresholdValue}% GP`, 14, 28);
        doc.text(`Total Products: ${items.length}`, 14, 34);
        
        // Add table headers
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        let yPos = 45;
        doc.text('Rank', 14, yPos);
        doc.text('Product Name', 30, yPos);
        doc.text('Product Code', 110, yPos);
        doc.text('GP%', 155, yPos);
        doc.text('Qty', 180, yPos);
        
        // Add line under headers
        doc.line(14, yPos + 2, 195, yPos + 2);
        
        // Add data rows
        doc.setFont(undefined, 'normal');
        yPos += 8;
        
        items.forEach((item, index) => {
          const rank = item.querySelector('.worst-gp-rank')?.textContent.trim() || '';
          const name = item.querySelector('.worst-gp-name')?.textContent.trim() || '';
          const code = item.querySelector('.worst-gp-code')?.textContent.trim() || '';
          const gp = item.querySelector('.worst-gp-gp')?.textContent.trim() || '';
          const qty = item.querySelector('.worst-gp-qty')?.textContent.trim() || '';
          
          // Check if we need a new page
          if (yPos > 280) {
            doc.addPage();
            yPos = 15;
          }
          
          doc.text(rank, 14, yPos);
          doc.text(name.substring(0, 45), 30, yPos); // Truncate long names
          doc.text(code, 110, yPos);
          doc.text(gp, 155, yPos);
          doc.text(qty, 180, yPos);
          
          yPos += 6;
        });
        
        // Save the PDF with appropriate filename
        let filename;
        if (isMonthlyView) {
          const fromDate = dateToUse.slice(0, 8) + '01'; // First day of month
          filename = `low-gp-products-${fromDate}-to-${dateToUse}-below-${thresholdValue}percent.pdf`;
        } else {
          filename = `low-gp-products-${dateToUse}-below-${thresholdValue}percent.pdf`;
        }
        doc.save(filename);
      }
      
      function initWorstGPListModal() {
        var listBtn = document.getElementById('worst-gp-list-btn');
        var monthlyListBtn = document.getElementById('monthly-worst-gp-list-btn');
        var stockListBtn = document.getElementById('stock-worst-gp-list-btn');
        var closeBtn = document.getElementById('worst-gp-list-close');
        var overlay = document.getElementById('worst-gp-list-modal-overlay');
        var applyBtn = document.getElementById('apply-gp-threshold');
        var downloadBtn = document.getElementById('download-gp-list');
        var thresholdInput = document.getElementById('gp-threshold-input');
        var sepBtn = document.getElementById('sep-btn');
        var noSepBtn = document.getElementById('no-sep-btn');
        
        listBtn && listBtn.addEventListener('click', openWorstGPListModal);
        monthlyListBtn && monthlyListBtn.addEventListener('click', openWorstGPListModal);
        stockListBtn && stockListBtn.addEventListener('click', openWorstGPListModal);
        closeBtn && closeBtn.addEventListener('click', closeWorstGPListModal);
        
        overlay && overlay.addEventListener('click', function(e) {
          if (e.target === overlay) closeWorstGPListModal();
        });
        
        // Apply threshold button - uses current exclude_pdst state
        applyBtn && applyBtn.addEventListener('click', function() {
          const threshold = thresholdInput ? parseFloat(thresholdInput.value) : 20;
          loadWorstGPList(threshold);
        });
        
        // SEP button - does NOT remove PDST (excludePdst=false)
        sepBtn && sepBtn.addEventListener('click', function() {
          const threshold = thresholdInput ? parseFloat(thresholdInput.value) : 20;
          currentExcludePdst = false;
          updateSepButtonStates();
          loadWorstGPList(threshold, false);
        });
        
        // NO SEP button - removes PDST (excludePdst=true)
        noSepBtn && noSepBtn.addEventListener('click', function() {
          const threshold = thresholdInput ? parseFloat(thresholdInput.value) : 20;
          currentExcludePdst = true;
          updateSepButtonStates();
          loadWorstGPList(threshold, true);
        });
        
        // Download PDF button
        downloadBtn && downloadBtn.addEventListener('click', function() {
          downloadWorstGPListPDF();
        });
        
        // Allow Enter key to apply threshold
        thresholdInput && thresholdInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            const threshold = parseFloat(thresholdInput.value);
            loadWorstGPList(threshold);
          }
        });
      }

      bindNavigation();
      initDefaults();
      initModal();
      initDatePicker();
      initPharmacyPicker();
      initBestSellersListModal();
      initWorstGPListModal();
      
      // Set initial date picker visibility (dashboard is active by default)
      var monthControl = document.getElementById('month-control');
      var datePickerBtn = document.getElementById('date-picker-btn');
      
      // Set initial group view button visibility (dashboard is active by default)
      var groupViewToggleBtn = document.getElementById('group-view-toggle-btn');
      if (groupViewToggleBtn) {
        groupViewToggleBtn.style.display = 'flex'; // Dashboard is active by default
      }
      if (monthControl && datePickerBtn) {
        monthControl.style.display = 'none';
        datePickerBtn.style.display = 'flex';
      }
      
      // Initialize chart toggle functionality
      const spendChartToggle = document.getElementById('spend-chart-toggle');
      const spendChartContainer = document.getElementById('spend-chart-container');
      if (spendChartToggle && spendChartContainer) {
        const spendChartCard = spendChartContainer.closest('.dashboard-card');
        spendChartToggle.addEventListener('click', function() {
          const isCollapsed = spendChartContainer.style.display === 'none';
          spendChartContainer.style.display = isCollapsed ? 'block' : 'none';
          spendChartToggle.classList.toggle('collapsed', !isCollapsed);
          if (spendChartCard) {
            spendChartCard.classList.toggle('chart-collapsed', !isCollapsed);
          }
        });
        // Set initial collapsed state
        if (spendChartCard && spendChartContainer.style.display === 'none') {
          spendChartCard.classList.add('chart-collapsed');
        }
      }
      
      // Group View Toggle Functionality
      var groupViewEnabled = true; // Default to group view enabled
      const groupViewToggle = document.getElementById('group-view-toggle-btn');
      const groupViewContainer = document.getElementById('group-view-container');
      const singlePharmacyView = document.getElementById('single-pharmacy-view');
      const groupViewGrid = document.getElementById('group-view-grid');
      
      // Get pharmacies list from the modal (they're already loaded in the DOM)
      function getPharmaciesList() {
        const pharmacyOptions = document.querySelectorAll('.pharmacy-option');
        const pharmacies = [];
        pharmacyOptions.forEach(option => {
          pharmacies.push({
            id: option.getAttribute('data-pharmacy-id'),
            name: option.getAttribute('data-pharmacy-name')
          });
        });
        // Sort pharmacies so "TLC GROUP" always appears last
        pharmacies.sort((a, b) => {
          const aIsGroup = (a.name || '').toUpperCase() === 'TLC GROUP';
          const bIsGroup = (b.name || '').toUpperCase() === 'TLC GROUP';
          if (aIsGroup && !bIsGroup) return 1;  // TLC GROUP goes to end
          if (!aIsGroup && bIsGroup) return -1;  // Non-group goes before TLC GROUP
          return (a.name || '').localeCompare(b.name || ''); // Otherwise alphabetical
        });
        return pharmacies;
      }
      
      // Generate the 4 metric cards for group view
      function generateGroupViewCards() {
        const pharmacies = getPharmaciesList();
        
        return `
          <!-- Card 1: MTD Turnover -->
          <div class="dashboard-card primary group-metric-card" id="group-card-turnover">
            <div class="card-header with-icon">
              <span class="card-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="12" y1="1" x2="12" y2="23"></line>
                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
              </span>
              <h3>MTD Turnover</h3>
            </div>
            <div class="group-pharmacy-list" id="group-list-turnover">
              ${pharmacies.map(p => `
                <div class="group-pharmacy-list-item" data-pharmacy-id="${p.id}">
                  <div class="pharmacy-name">${p.name}</div>
                  <div class="pharmacy-value-row">
                    <div class="pharmacy-value-wrapper">
                      <span class="card-value-currency" data-pharmacy-id="${p.id}" data-metric="turnover-currency">R</span>
                      <span class="card-value-amount" data-pharmacy-id="${p.id}" data-metric="turnover">—</span>
                    </div>
                    <div class="card-value-percentage" data-pharmacy-id="${p.id}" data-metric="turnover-percentage"></div>
                  </div>
                  <div class="pharmacy-growth" data-pharmacy-id="${p.id}" data-metric="turnover-growth">—</div>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- Card 2: Purchases -->
          <div class="dashboard-card metric-purchases group-metric-card" id="group-card-purchases">
            <div class="card-header with-icon">
              <span class="card-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="9" cy="21" r="1"></circle>
                  <circle cx="20" cy="21" r="1"></circle>
                  <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                </svg>
              </span>
              <h3>Purchases</h3>
            </div>
            <div class="group-pharmacy-list" id="group-list-purchases">
              ${pharmacies.map(p => `
                <div class="group-pharmacy-list-item" data-pharmacy-id="${p.id}">
                  <div class="pharmacy-name">${p.name}</div>
                  <div class="pharmacy-value-row">
                    <div class="pharmacy-value-wrapper">
                      <span class="card-value-currency" data-pharmacy-id="${p.id}" data-metric="purchases-currency">R</span>
                      <span class="card-value-amount" data-pharmacy-id="${p.id}" data-metric="purchases">—</span>
                    </div>
                    <div class="card-value-percentage" data-pharmacy-id="${p.id}" data-metric="purchases-percentage"></div>
                  </div>
                  <div class="pharmacy-status" data-pharmacy-id="${p.id}" data-metric="purchases-status">
                    <span class="status-amount" data-pharmacy-id="${p.id}" data-metric="purchases-diff">—</span>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- Card 3: GP (starts row 2) -->
          <div class="dashboard-card metric-gp group-metric-card" id="group-card-gp">
            <div class="card-header with-icon">
              <span class="card-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
              </span>
              <h3>GP</h3>
            </div>
            <div class="group-pharmacy-list" id="group-list-gp">
              ${pharmacies.map(p => `
                <div class="group-pharmacy-list-item" data-pharmacy-id="${p.id}">
                  <div class="pharmacy-name">${p.name}</div>
                  <div class="pharmacy-value-wrapper">
                    <span class="card-value-currency" data-pharmacy-id="${p.id}" data-metric="gp-percent-currency">%</span>
                    <span class="card-value-amount" data-pharmacy-id="${p.id}" data-metric="gp-percent">—</span>
                  </div>
                  <div class="pharmacy-detail" data-pharmacy-id="${p.id}" data-metric="gp-value">—</div>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- Card 4: Basket -->
          <div class="dashboard-card metric-basket group-metric-card" id="group-card-basket">
            <div class="card-header with-icon">
              <span class="card-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                  <line x1="7" y1="7" x2="7.01" y2="7"></line>
                </svg>
              </span>
              <h3>Basket</h3>
            </div>
            <div class="group-pharmacy-list" id="group-list-basket">
              ${pharmacies.map(p => `
                <div class="group-pharmacy-list-item" data-pharmacy-id="${p.id}">
                  <div class="pharmacy-name">${p.name}</div>
                  <div class="pharmacy-value-wrapper">
                    <span class="card-value-currency">R</span>
                    <span class="card-value-amount" data-pharmacy-id="${p.id}" data-metric="basket">—</span>
                  </div>
                  <div class="pharmacy-detail" data-pharmacy-id="${p.id}" data-metric="transaction-count">—</div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      function loadGroupViewData() {
        if (!groupViewEnabled) return;
        
        const pharmacies = getPharmaciesList();
        const monthEl = document.getElementById('report-month');
        if (!monthEl) return;
        const month = monthEl.value || new Date().toISOString().slice(0, 7);
        
        pharmacies.forEach(pharmacy => {
          if (summaryViewMode === 'daily') {
            loadPharmacyGroupDataDaily(parseInt(pharmacy.id), month);
          } else {
            loadPharmacyGroupData(parseInt(pharmacy.id), month);
          }
        });
      }
      
      async function loadPharmacyGroupData(pid, month) {
        try {
          // Get current month data
          const currentResp = await fetch(`/api/days?pid=${pid}&month=${month}`);
          if (!currentResp.ok) {
            console.warn(`Failed to fetch daily data for pharmacy ${pid}:`, currentResp.status);
          }
          const currentData = currentResp.ok ? await currentResp.json() : [];
          
          // Get targets data
          const targetsResp = await fetch(`/api/targets?pid=${pid}&month=${month}`);
          if (!targetsResp.ok) {
            console.warn(`Failed to fetch targets for pharmacy ${pid}:`, targetsResp.status);
          }
          const targetsData = targetsResp.ok ? await targetsResp.json() : {targets: []};
          
          // Get previous year same month data for 10% default target calculation
          const [yr, mn] = month.split('-');
          const prevYearMonth = `${parseInt(yr) - 1}-${mn}`;
          const prevYearResp = await fetch(`/api/days?pid=${pid}&month=${prevYearMonth}`);
          const prevYearData = prevYearResp.ok ? await prevYearResp.json() : [];
          
          // Get aggregated MTD data using selectedDate (defaults to yesterday for accurate MTD)
          const throughDate = selectedDate || getYesterdayDate(); // Use selectedDate for accurate MTD
          const mtdAggResp = await fetch(`/api/mtd?pid=${pid}&month=${month}&through=${encodeURIComponent(throughDate)}`);
          if (!mtdAggResp.ok) {
            console.warn(`Failed to fetch MTD data for pharmacy ${pid}:`, mtdAggResp.status);
          }
          const mtdAgg = mtdAggResp.ok ? await mtdAggResp.json() : null;
          
          // Calculate and update metrics for this pharmacy
          updatePharmacyGroupCard(pid, currentData, targetsData.targets || [], prevYearData, mtdAgg, month);
        } catch (e) {
          console.error(`Failed to load group data for pharmacy ${pid}:`, e);
          // Still try to update with empty data so UI shows "—"
          updatePharmacyGroupCard(pid, [], [], [], null, month);
        }
      }

      async function loadPharmacyGroupDataDaily(pid, month) {
        try {
          if (!selectedDate) return;
          
          // Get current month data
          const currentResp = await fetch(`/api/days?pid=${pid}&month=${month}`);
          if (!currentResp.ok) {
            console.warn(`Failed to fetch daily data for pharmacy ${pid}:`, currentResp.status);
          }
          const currentData = currentResp.ok ? await currentResp.json() : [];
          
          // Find the selected date in current month data
          const selectedDayData = currentData.find(d => d.business_date === selectedDate) || null;
          
          // Get previous year's corresponding weekday data
          let prevYearDayData = null;
          if (selectedDate) {
            prevYearDayData = await getPreviousYearWeekdayData(selectedDate, pid);
          }
          
          // Get targets data for the selected date
          const targetsResp = await fetch(`/api/targets?pid=${pid}&month=${month}`);
          if (!targetsResp.ok) {
            console.warn(`Failed to fetch targets for pharmacy ${pid}:`, targetsResp.status);
          }
          const targetsData = targetsResp.ok ? await targetsResp.json() : {targets: []};
          const selectedDayTarget = (targetsData.targets || []).find(t => t.date === selectedDate) || null;
          
          // Calculate and update metrics for this pharmacy (daily view)
          updatePharmacyGroupCardDaily(pid, selectedDayData, prevYearDayData, selectedDayTarget, selectedDate);
        } catch (e) {
          console.error(`Failed to load daily group data for pharmacy ${pid}:`, e);
          // Still try to update with empty data so UI shows "—"
          updatePharmacyGroupCardDaily(pid, null, null, null, selectedDate);
        }
      }
      
      function updatePharmacyGroupCard(pid, currentData, targets, prevYearData, mtdAgg, month) {
        // Similar calculation logic to updateDashboard, but update elements with data-pharmacy-id
        // Calculate MTD cutoffs using selectedDate (defaults to yesterday for accurate data)
        const [selYearStr, selMonthStr] = month.split('-');
        const selYear = parseInt(selYearStr, 10);
        const selMonthIdx = parseInt(selMonthStr, 10) - 1; // 0-based
        
        // Use selectedDate to determine the MTD day (defaults to yesterday)
        let mtdDay;
        if (selectedDate) {
          const selectedDateObj = new Date(selectedDate + 'T00:00:00');
          const selectedYear = selectedDateObj.getFullYear();
          const selectedMonthIdx = selectedDateObj.getMonth();
          const selectedDay = selectedDateObj.getDate();
          
          // Only use selectedDate if it's in the same month we're viewing
          if (selectedYear === selYear && selectedMonthIdx === selMonthIdx) {
            mtdDay = selectedDay;
          } else {
            // If selectedDate is in a different month, use the last day of the selected month
            const daysInSelected = new Date(selYear, selMonthIdx + 1, 0).getDate();
            mtdDay = daysInSelected;
          }
        } else {
          // Fallback: use yesterday if selectedDate is not set
          const yesterday = new Date();
          yesterday.setDate(yesterday.getDate() - 1);
          const isCurrentMonth = yesterday.getFullYear() === selYear && yesterday.getMonth() === selMonthIdx;
          const daysInSelected = new Date(selYear, selMonthIdx + 1, 0).getDate();
          mtdDay = isCurrentMonth ? yesterday.getDate() : daysInSelected;
        }
        
        function filterMTD(rows, year, monthIdx, cutoffDay) {
          return rows.filter(r => {
            const dstr = r.business_date || r.date || r.bdate;
            if (!dstr) return false;
            const d = new Date(dstr + 'T00:00:00');
            return d.getFullYear() === year && d.getMonth() === monthIdx && d.getDate() <= cutoffDay;
          });
        }
        
        function sumTurnover(rows) {
          return rows.reduce((sum, r) => sum + Number(r.turnover || 0), 0);
        }
        function sumPurchases(rows) {
          return rows.reduce((sum, r) => sum + Number(r.purchases || r.daily_purchases || r.purchases_value || 0), 0);
        }
        
        const currentMTD = filterMTD(currentData, selYear, selMonthIdx, mtdDay);
        const currentTurnover = sumTurnover(currentMTD);
        const currentPurchases = sumPurchases(currentMTD);
        
        // Calculate budget from targets (only up to MTD day)
        const cutoffDateStr = `${selYear}-${String(selMonthIdx + 1).padStart(2,'0')}-${String(mtdDay).padStart(2,'0')}`;
        let budgetTurnover = (targets || []).reduce((sum, t) => {
          const d = t.date;
          if (!d) return sum;
          // Only include targets up to the MTD cutoff date
          if (d <= cutoffDateStr) return sum + Number(t.value || 0);
          return sum;
        }, 0);
        
        // If no budget exists, calculate as 10% more than previous year MTD (same day count)
        // This ensures 10% growth target and uses day-to-day MTD calculation
        if (budgetTurnover === 0 && prevYearData && prevYearData.length > 0) {
          const prevYearDate = new Date(selYear - 1, selMonthIdx, 1);
          const prevYearMonthDays = new Date(prevYearDate.getFullYear(), prevYearDate.getMonth() + 1, 0).getDate();
          const prevYearMTDDay = Math.min(mtdDay, prevYearMonthDays);
          const prevYearMTD = filterMTD(prevYearData, prevYearDate.getFullYear(), prevYearDate.getMonth(), prevYearMTDDay);
          const prevYearTurnover = sumTurnover(prevYearMTD);
          
          if (prevYearTurnover > 0) {
            budgetTurnover = prevYearTurnover * 1.10; // 10% growth based on MTD
          }
        }
        
        const purchaseBudget = budgetTurnover * 0.75;
        
        // Calculate previous year turnover for growth calculation
        const prevYearDate = new Date(selYear - 1, selMonthIdx, 1);
        const prevYearMonthDays = new Date(prevYearDate.getFullYear(), prevYearDate.getMonth() + 1, 0).getDate();
        const prevYearMTDDay = Math.min(mtdDay, prevYearMonthDays);
        const prevYearMTD = filterMTD(prevYearData, prevYearDate.getFullYear(), prevYearDate.getMonth(), prevYearMTDDay);
        const prevYearTurnover = sumTurnover(prevYearMTD);
        
        // Calculate turnover growth vs last year
        let turnoverGrowth = null;
        if (prevYearTurnover > 0 && currentTurnover > 0) {
          turnoverGrowth = Math.round(((currentTurnover - prevYearTurnover) / prevYearTurnover) * 100);
        }
        
        // Calculate percentages
        const purchaseBudgetPct = purchaseBudget > 0 ? Math.round((currentPurchases / purchaseBudget) * 100) : 0;
        
        // Update turnover (Card 1)
        const turnoverEl = document.querySelector(`[data-pharmacy-id="${pid}"][data-metric="turnover"]`);
        if (turnoverEl) {
          turnoverEl.textContent = currentTurnover > 0 ? fmtMoneyAmount(currentTurnover) : '—';
        }
        
        // Update turnover percentage badge
        const turnoverPctBadgeEl = document.querySelector(`[data-pharmacy-id="${pid}"][data-metric="turnover-percentage"]`);
        if (turnoverPctBadgeEl) {
          if (turnoverGrowth !== null) {
            turnoverPctBadgeEl.textContent = `${turnoverGrowth >= 0 ? '+' : ''}${turnoverGrowth}%`;
            turnoverPctBadgeEl.className = 'card-value-percentage ' + (turnoverGrowth >= 0 ? 'positive' : 'negative');
          } else {
            turnoverPctBadgeEl.textContent = '';
            turnoverPctBadgeEl.className = 'card-value-percentage';
          }
        }
        
        // Update turnover growth vs last year (comparison text)
        const turnoverGrowthEl = document.querySelector(`[data-pharmacy-id="${pid}"][data-metric="turnover-growth"]`);
        if (turnoverGrowthEl) {
          if (turnoverGrowth !== null) {
            turnoverGrowthEl.textContent = `vs last year: R ${fmtMoneyAmount(prevYearTurnover)}`;
          } else {
            turnoverGrowthEl.textContent = '—';
          }
        }
        
        // Update purchases (Card 2)
        const purchasesEl = document.querySelector(`[data-pharmacy-id="${pid}"][data-metric="purchases"]`);
        if (purchasesEl) {
          purchasesEl.textContent = currentPurchases > 0 ? fmtMoneyAmount(currentPurchases) : '—';
        }
        
        // Update purchases percentage badge
        const purchasesPctBadgeEl = document.querySelector(`[data-pharmacy-id="${pid}"][data-metric="purchases-percentage"]`);
        const purchasesDiffEl = document.querySelector(`[data-pharmacy-id="${pid}"][data-metric="purchases-diff"]`);
        
        if (purchaseBudget > 0) {
          const diff = currentPurchases - purchaseBudget;
          const diffPct = Math.round((diff / purchaseBudget) * 100);
          const isOver = diff >= 0;
          
          if (purchasesPctBadgeEl) {
            purchasesPctBadgeEl.textContent = `${diffPct >= 0 ? '+' : ''}${diffPct}%`;
            purchasesPctBadgeEl.className = 'card-value-percentage ' + (isOver ? 'negative' : 'positive');
          }
          if (purchasesDiffEl) {
            purchasesDiffEl.textContent = `R ${fmtMoneyAmount(Math.abs(diff))} ${isOver ? 'over' : 'under'}`;
          }
        } else {
          if (purchasesPctBadgeEl) {
            purchasesPctBadgeEl.textContent = '';
            purchasesPctBadgeEl.className = 'card-value-percentage';
          }
          if (purchasesDiffEl) {
            purchasesDiffEl.textContent = '—';
          }
        }
        
        // Update GP (Card 3)
        const gpPercentEl = document.querySelector(`[data-pharmacy-id="${pid}"][data-metric="gp-percent"]`);
        const gpValueEl = document.querySelector(`[data-pharmacy-id="${pid}"][data-metric="gp-value"]`);
        
        if (mtdAgg) {
          const gpPercent = mtdAgg.gp_percent !== undefined ? Number(mtdAgg.gp_percent) : null;
          const gpValue = mtdAgg.gp_value !== undefined ? Number(mtdAgg.gp_value) : null;
          const turnover = Number(mtdAgg.turnover || 0);
          
          // Calculate GP percent from value if not provided
          let displayGpPercent = gpPercent;
          if (displayGpPercent === null && gpValue !== null && turnover > 0) {
            displayGpPercent = (gpValue / turnover) * 100;
          }
          
          if (gpPercentEl) {
            gpPercentEl.textContent = displayGpPercent !== null && displayGpPercent > 0 ? Math.round(displayGpPercent) + '%' : '—';
          }
          
          // Hide the separate % symbol element since we're appending it to the value
          const gpPercentCurrencyEl = document.querySelector(`[data-pharmacy-id="${pid}"][data-metric="gp-percent-currency"]`);
          if (gpPercentCurrencyEl) {
            gpPercentCurrencyEl.style.display = 'none';
          }
          
          if (gpValueEl) {
            gpValueEl.textContent = gpValue !== null && gpValue > 0 ? 'R ' + fmtMoneyAmount(gpValue) : '—';
          }
        } else {
          if (gpPercentEl) gpPercentEl.textContent = '—';
          if (gpValueEl) gpValueEl.textContent = '—';
        }
        
        // Update Basket (Card 4)
        const basketEl = document.querySelector(`[data-pharmacy-id="${pid}"][data-metric="basket"]`);
        const transactionCountEl = document.querySelector(`[data-pharmacy-id="${pid}"][data-metric="transaction-count"]`);
        
        if (mtdAgg) {
          const basketValue = mtdAgg.basket_value !== undefined ? Number(mtdAgg.basket_value) : null;
          const transactionCount = mtdAgg.transaction_count !== undefined ? Number(mtdAgg.transaction_count) : null;
          const turnover = Number(mtdAgg.turnover || 0);
          
          // Calculate basket if not provided
          let displayBasket = basketValue;
          if (displayBasket === null || displayBasket === 0) {
            const denom = transactionCount > 0 ? transactionCount : (turnover > 0 ? Math.max(1, Math.round(turnover / 150)) : 0);
            displayBasket = denom ? turnover / denom : 0;
          }
          
          const displayTxn = transactionCount > 0 ? transactionCount : (turnover > 0 ? Math.max(1, Math.round(turnover / 150)) : 0);
          
          if (basketEl) {
            basketEl.textContent = displayBasket > 0 ? fmtMoneyAmount(displayBasket) : '—';
          }
          
          if (transactionCountEl) {
            transactionCountEl.textContent = displayTxn > 0 ? displayTxn.toLocaleString() + ' transactions' : '—';
          }
          
        } else {
          if (basketEl) basketEl.textContent = '—';
          if (transactionCountEl) transactionCountEl.textContent = '—';
        }
      }

      function updatePharmacyGroupCardDaily(pid, dailyData, prevYearDayData, dailyTarget, selectedDate) {
        // Daily view: use single day's data instead of MTD
        const currentTurnover = dailyData ? Number(dailyData.turnover || 0) : 0;
        const currentPurchases = dailyData ? Number(dailyData.purchases || dailyData.daily_purchases || dailyData.purchases_value || 0) : 0;
        const prevYearTurnover = prevYearDayData ? Number(prevYearDayData.turnover || 0) : 0;

        // Daily target (from targets data or calculate as 10% more than previous year)
        let budgetTurnover = dailyTarget ? Number(dailyTarget.value || 0) : 0;
        if (budgetTurnover === 0 && prevYearTurnover > 0) {
          budgetTurnover = prevYearTurnover * 1.10; // 10% growth
        }

        const purchaseBudget = budgetTurnover * 0.75;

        // Calculate turnover growth vs last year (same weekday)
        let turnoverGrowth = null;
        if (prevYearTurnover > 0 && currentTurnover > 0) {
          turnoverGrowth = Math.round(((currentTurnover - prevYearTurnover) / prevYearTurnover) * 100);
        }

        // Calculate purchase percentages
        const purchaseBudgetPct = purchaseBudget > 0 ? Math.round((currentPurchases / purchaseBudget) * 100) : 0;

        // Update turnover (Card 1)
        const turnoverEl = document.querySelector(`[data-pharmacy-id="${pid}"][data-metric="turnover"]`);
        if (turnoverEl) {
          turnoverEl.textContent = currentTurnover > 0 ? fmtMoneyAmount(currentTurnover) : '—';
        }

        // Update turnover percentage badge
        const turnoverPctBadgeEl = document.querySelector(`[data-pharmacy-id="${pid}"][data-metric="turnover-percentage"]`);
        if (turnoverPctBadgeEl) {
          if (turnoverGrowth !== null) {
            turnoverPctBadgeEl.textContent = `${turnoverGrowth >= 0 ? '+' : ''}${turnoverGrowth}%`;
            turnoverPctBadgeEl.className = 'card-value-percentage ' + (turnoverGrowth >= 0 ? 'positive' : 'negative');
          } else {
            turnoverPctBadgeEl.textContent = '';
            turnoverPctBadgeEl.className = 'card-value-percentage';
          }
        }

        // Update turnover growth vs last year (comparison text)
        const turnoverGrowthEl = document.querySelector(`[data-pharmacy-id="${pid}"][data-metric="turnover-growth"]`);
        if (turnoverGrowthEl) {
          if (prevYearTurnover > 0) {
            const prevYear = new Date(selectedDate + 'T00:00:00').getFullYear() - 1;
            turnoverGrowthEl.textContent = `vs last year: R ${fmtMoneyAmount(prevYearTurnover)}`;
          } else {
            turnoverGrowthEl.textContent = '—';
          }
        }

        // Update purchases (Card 2)
        const purchasesEl = document.querySelector(`[data-pharmacy-id="${pid}"][data-metric="purchases"]`);
        if (purchasesEl) {
          purchasesEl.textContent = currentPurchases > 0 ? fmtMoneyAmount(currentPurchases) : '—';
        }

        // Update purchases percentage badge
        const purchasesPctBadgeEl = document.querySelector(`[data-pharmacy-id="${pid}"][data-metric="purchases-percentage"]`);
        const purchasesDiffEl = document.querySelector(`[data-pharmacy-id="${pid}"][data-metric="purchases-diff"]`);

        if (purchaseBudget > 0) {
          const diff = currentPurchases - purchaseBudget;
          const diffPct = Math.round((diff / purchaseBudget) * 100);
          const isOver = diff >= 0;

          if (purchasesPctBadgeEl) {
            purchasesPctBadgeEl.textContent = `${diffPct >= 0 ? '+' : ''}${diffPct}%`;
            purchasesPctBadgeEl.className = 'card-value-percentage ' + (isOver ? 'negative' : 'positive');
          }
          if (purchasesDiffEl) {
            purchasesDiffEl.textContent = `R ${fmtMoneyAmount(Math.abs(diff))} ${isOver ? 'over' : 'under'}`;
          }
        } else {
          if (purchasesPctBadgeEl) {
            purchasesPctBadgeEl.textContent = '';
            purchasesPctBadgeEl.className = 'card-value-percentage';
          }
          if (purchasesDiffEl) {
            purchasesDiffEl.textContent = '—';
          }
        }

        // Update GP (Card 3) - from daily data
        const gpPercentEl = document.querySelector(`[data-pharmacy-id="${pid}"][data-metric="gp-percent"]`);
        const gpValueEl = document.querySelector(`[data-pharmacy-id="${pid}"][data-metric="gp-value"]`);

        if (dailyData) {
          const gpValue = Number(dailyData.gp_value || dailyData.gp || 0);
          const gpPercent = (dailyData.gp_pct !== undefined && dailyData.gp_pct !== null) ? Number(dailyData.gp_pct) : (currentTurnover ? (gpValue / currentTurnover) * 100 : 0);

          if (gpPercentEl) {
            gpPercentEl.textContent = gpPercent > 0 ? Math.round(gpPercent) + '%' : '—';
          }

          // Hide the separate % symbol element
          const gpPercentCurrencyEl = document.querySelector(`[data-pharmacy-id="${pid}"][data-metric="gp-percent-currency"]`);
          if (gpPercentCurrencyEl) {
            gpPercentCurrencyEl.style.display = 'none';
          }

          if (gpValueEl) {
            gpValueEl.textContent = gpValue > 0 ? 'R ' + fmtMoneyAmount(gpValue) : '—';
          }
        } else {
          if (gpPercentEl) gpPercentEl.textContent = '—';
          if (gpValueEl) gpValueEl.textContent = '—';
        }

        // Update Basket (Card 4) - from daily data
        const basketEl = document.querySelector(`[data-pharmacy-id="${pid}"][data-metric="basket"]`);
        const transactionCountEl = document.querySelector(`[data-pharmacy-id="${pid}"][data-metric="transaction-count"]`);

        if (dailyData) {
          const transactionCount = Number(dailyData.transaction_count || dailyData.transactions || 0);
          let basketValue = Number(dailyData.avg_basket || dailyData.basket || 0);

          // Calculate basket if not provided
          if (basketValue === 0) {
            const denom = transactionCount > 0 ? transactionCount : (currentTurnover > 0 ? Math.max(1, Math.round(currentTurnover / 150)) : 0);
            basketValue = denom ? currentTurnover / denom : 0;
          }

          const displayTxn = transactionCount > 0 ? transactionCount : (currentTurnover > 0 ? Math.max(1, Math.round(currentTurnover / 150)) : 0);

          if (basketEl) {
            basketEl.textContent = basketValue > 0 ? fmtMoneyAmount(basketValue) : '—';
          }

          if (transactionCountEl) {
            transactionCountEl.textContent = displayTxn > 0 ? `${displayTxn.toLocaleString('en-ZA')} transactions` : '—';
          }
        } else {
          if (basketEl) basketEl.textContent = '—';
          if (transactionCountEl) transactionCountEl.textContent = '—';
        }
      }
      
      // Function to enable/disable group view UI
      function updateGroupViewUI() {
        if (groupViewEnabled) {
          // Show group view, hide single view
          if (groupViewContainer) groupViewContainer.style.display = 'block';
          if (singlePharmacyView) singlePharmacyView.style.display = 'none';
          
          // Hide spend analytics section in group view
          const spendAnalyticsSection = document.getElementById('spend-analytics-section');
          if (spendAnalyticsSection) {
            spendAnalyticsSection.style.display = 'none';
          }
          
          // Ensure grid is visible
          if (groupViewGrid) {
            groupViewGrid.style.display = 'grid';
          }
          
          // Generate metric cards if not already generated
          if (groupViewGrid && groupViewGrid.children.length === 0) {
            const pharmacies = getPharmaciesList();
            console.log('Group View: Found', pharmacies.length, 'pharmacies');
            if (pharmacies.length === 0) {
              console.warn('Group View: No pharmacies found in modal');
            }
            groupViewGrid.insertAdjacentHTML('beforeend', generateGroupViewCards());
          }
          
          // Load data for all pharmacies
          loadGroupViewData();
        } else {
          // Show single view, hide group view
          if (groupViewContainer) groupViewContainer.style.display = 'none';
          if (singlePharmacyView) singlePharmacyView.style.display = 'block';
          
          // Show spend analytics section in single view
          const spendAnalyticsSection = document.getElementById('spend-analytics-section');
          if (spendAnalyticsSection) {
            spendAnalyticsSection.style.display = 'block';
          }
        }
        
        // Update button active state
        if (groupViewToggle) {
          groupViewToggle.classList.toggle('active', groupViewEnabled);
        }
      }
      
      if (groupViewToggle && groupViewContainer && singlePharmacyView) {
        groupViewToggle.addEventListener('click', function() {
          groupViewEnabled = !groupViewEnabled;
          updateGroupViewUI();
        });
        
        // Initialize group view on page load (after a short delay to ensure DOM is ready)
        setTimeout(function() {
          updateGroupViewUI();
        }, 100);
      }
      
      // Debtor Tools Functions
      var debtorState = {
        pharmacyId: null,
        debtors: [],
        statistics: null,
        selectedDebtors: [],
        filters: {
          minBalance: 100,
          ageingBuckets: ['current', 'd30', 'd60', 'd90', 'd120', 'd150', 'd180'],
          hasEmail: false,
          hasPhone: false,
          search: ''
        },
        sortColumn: null,
        sortDirection: 'asc',
        pagination: {
          page: 1,
          perPage: 1000,
          total: 0,
          pages: 0
        },
        messages: {
          template_vars: {
            pharmacy_name: '',
            bank_name: '',
            account_number: '',
            pharmacy_email: '',
            pharmacy_phone: ''
          }
        }
      };
      
      function loadDebtorTools() {
        if (!selectedPharmacyId) {
          showDebtorError('Please select a pharmacy first');
          return;
        }
        
        // Reset debtor state when pharmacy changes
        if (debtorState.pharmacyId !== selectedPharmacyId) {
          debtorState.pharmacyId = selectedPharmacyId;
          clearAllPharmacyContactDetails();
          // Collapse the send reminders section when pharmacy changes
          var sendRemindersContent = document.getElementById('debtor-send-reminders-content');
          var sendRemindersToggle = document.getElementById('debtor-send-reminders-toggle');
          if (sendRemindersContent && sendRemindersToggle) {
            sendRemindersContent.style.display = 'none';
            sendRemindersToggle.classList.remove('debtor-collapsible-open');
          }
          // Update previews if they're visible when pharmacy changes
          if (typeof updatePreviews === 'function') {
            updatePreviews();
          }
          debtorState.debtors = [];
          debtorState.statistics = null;
          debtorState.selectedDebtors = [];
          debtorState.pagination.page = 1;
          debtorState.sortColumn = null;
          debtorState.sortDirection = 'asc';
          
          // Clear the table display
          var tableBody = document.getElementById('debtor-table-body');
          if (tableBody) {
            tableBody.innerHTML = '<tr><td colspan="13" style="text-align: center; padding: 40px;">Loading...</td></tr>';
          }
          
          // Clear statistics display
          var currentValue = document.getElementById('debtor-current-value');
          var totalOutstanding = document.getElementById('debtor-total-outstanding');
          var totalAccounts = document.getElementById('debtor-total-accounts');
          var ageingList = document.getElementById('debtor-ageing-list');
          if (currentValue) currentValue.textContent = '0.00';
          if (totalOutstanding) totalOutstanding.textContent = '0.00';
          if (totalAccounts) totalAccounts.textContent = '0';
          if (ageingList) ageingList.innerHTML = '';
          
          // Reset sort icons
          updateSortIcons();
        }
        
        initDebtorTools();
      }
      
      function initDebtorTools() {
        // Load statistics and debtors
        fetchDebtorStatistics();
        fetchDebtors();
        
        // Balance slider - auto-apply on change
        var balanceSlider = document.getElementById('debtor-min-balance');
        var balanceValue = document.getElementById('debtor-min-balance-value');
        if (balanceSlider && balanceValue) {
          // Update slider progress on load
          function updateSliderProgress() {
            var value = parseInt(balanceSlider.value);
            var max = parseInt(balanceSlider.max);
            var min = parseInt(balanceSlider.min);
            var progress = ((value - min) / (max - min)) * 100;
            balanceSlider.style.setProperty('--slider-progress', progress + '%');
          }
          
          updateSliderProgress();
          
          balanceSlider.addEventListener('input', function(e) {
            var value = parseInt(e.target.value);
            balanceValue.textContent = 'R ' + value.toLocaleString();
            updateSliderProgress();
            // Auto-apply filter
            debtorState.filters.minBalance = value;
            debtorState.pagination.page = 1;
            fetchDebtors();
          });
        }
        
        // Ageing buckets checkboxes
        var ageingBuckets = document.getElementById('debtor-ageing-buckets');
        if (ageingBuckets) {
          ageingBuckets.addEventListener('change', function(e) {
            if (e.target.type === 'checkbox') {
              var buckets = Array.from(ageingBuckets.querySelectorAll('input[type="checkbox"]:checked'))
                .map(function(cb) { return cb.value; });
              debtorState.filters.ageingBuckets = buckets;
              fetchDebtors();
            }
          });
        }
        
        // Contact filters
        var hasEmail = document.getElementById('debtor-has-email');
        var hasPhone = document.getElementById('debtor-has-phone');
        if (hasEmail) {
          hasEmail.addEventListener('change', function() {
            debtorState.filters.hasEmail = this.checked;
            fetchDebtors();
          });
        }
        if (hasPhone) {
          hasPhone.addEventListener('change', function() {
            debtorState.filters.hasPhone = this.checked;
            fetchDebtors();
          });
        }
        
        // Search input
        var searchInput = document.getElementById('debtor-search');
        var searchTimeout;
        if (searchInput) {
          searchInput.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
              debtorState.filters.search = e.target.value;
              debtorState.pagination.page = 1;
              fetchDebtors();
            }, 500);
          });
        }
        
        // Table sorting
        var sortableHeaders = document.querySelectorAll('.debtor-sortable');
        sortableHeaders.forEach(function(header) {
          header.addEventListener('click', function() {
            var column = this.dataset.column;
            if (debtorState.sortColumn === column) {
              debtorState.sortDirection = debtorState.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
              debtorState.sortColumn = column;
              debtorState.sortDirection = 'asc';
            }
            updateSortIcons();
            // Reset to page 1 when sorting changes
            debtorState.pagination.page = 1;
            // Fetch fresh data with new sort
            fetchDebtors();
          });
        });
        
        // Select all checkbox
        var selectAll = document.getElementById('debtor-select-all');
        if (selectAll) {
          selectAll.addEventListener('change', function() {
            if (this.checked) {
              selectAllDebtors();
            } else {
              clearSelection();
            }
          });
        }
        
        // Send Reminders section toggle - show modal if contact details missing
        var sendRemindersToggle = document.getElementById('debtor-send-reminders-toggle');
        var sendRemindersContent = document.getElementById('debtor-send-reminders-content');
        
        // Remove old event listeners by cloning and replacing
        if (sendRemindersToggle) {
          var newSendRemindersToggle = sendRemindersToggle.cloneNode(true);
          sendRemindersToggle.parentNode.replaceChild(newSendRemindersToggle, sendRemindersToggle);
          sendRemindersToggle = newSendRemindersToggle;
        }
        
        if (sendRemindersToggle && sendRemindersContent) {
          sendRemindersToggle.addEventListener('click', function() {
            var isHidden = sendRemindersContent.style.display === 'none' || sendRemindersContent.style.display === '';
            
            if (isHidden) {
              // Opening the section - check if contact details are needed
              if (!validatePharmacyContactDetails()) {
                // Show modal first - section will open after details are saved
                showPharmacyContactModal();
                return; // Don't open section yet
              } else {
                // Contact details exist, open section
                sendRemindersContent.style.display = 'block';
                sendRemindersToggle.classList.add('debtor-collapsible-open');
                // Update previews when section opens
                if (typeof updatePreviews === 'function') {
                  updatePreviews();
                }
              }
            } else {
              // Closing the section
              sendRemindersContent.style.display = 'none';
              sendRemindersToggle.classList.remove('debtor-collapsible-open');
            }
          });
        }
        
        // Preview toggles - remove old listeners first to prevent duplicates
        var emailPreviewToggle = document.getElementById('debtor-email-preview-toggle');
        var emailPreviewContent = document.getElementById('debtor-email-preview-content');
        var smsPreviewToggle = document.getElementById('debtor-sms-preview-toggle');
        var smsPreviewContent = document.getElementById('debtor-sms-preview-content');
        
        // Remove old event listeners by cloning and replacing elements
        if (emailPreviewToggle) {
          var newEmailToggle = emailPreviewToggle.cloneNode(true);
          emailPreviewToggle.parentNode.replaceChild(newEmailToggle, emailPreviewToggle);
          emailPreviewToggle = newEmailToggle;
        }
        
        if (smsPreviewToggle) {
          var newSmsToggle = smsPreviewToggle.cloneNode(true);
          smsPreviewToggle.parentNode.replaceChild(newSmsToggle, smsPreviewToggle);
          smsPreviewToggle = newSmsToggle;
        }
        
        if (emailPreviewToggle && emailPreviewContent) {
          emailPreviewToggle.addEventListener('click', function() {
            var isHidden = emailPreviewContent.style.display === 'none' || emailPreviewContent.style.display === '';
            emailPreviewContent.style.display = isHidden ? 'block' : 'none';
            emailPreviewToggle.classList.toggle('debtor-collapsible-open', isHidden);
            if (isHidden && typeof updateEmailPreview === 'function') {
              updateEmailPreview();
            }
          });
        }
        
        if (smsPreviewToggle && smsPreviewContent) {
          smsPreviewToggle.addEventListener('click', function() {
            var isHidden = smsPreviewContent.style.display === 'none' || smsPreviewContent.style.display === '';
            smsPreviewContent.style.display = isHidden ? 'block' : 'none';
            smsPreviewToggle.classList.toggle('debtor-collapsible-open', isHidden);
            if (isHidden && typeof updateSMSPreview === 'function') {
              updateSMSPreview();
            }
          });
        }
        
        // Template variables collapsible - remove old listeners first
        var templateVarsToggle = document.getElementById('debtor-template-vars-toggle');
        var templateVarsContent = document.getElementById('debtor-template-vars-content');
        
        if (templateVarsToggle) {
          var newTemplateVarsToggle = templateVarsToggle.cloneNode(true);
          templateVarsToggle.parentNode.replaceChild(newTemplateVarsToggle, templateVarsToggle);
          templateVarsToggle = newTemplateVarsToggle;
        }
        
        if (templateVarsToggle && templateVarsContent) {
          templateVarsToggle.addEventListener('click', function() {
            var isHidden = templateVarsContent.style.display === 'none' || templateVarsContent.style.display === '';
            templateVarsContent.style.display = isHidden ? 'block' : 'none';
            templateVarsToggle.classList.toggle('debtor-collapsible-open', isHidden);
          });
        }
        
        // Template variables
        var varBankName = document.getElementById('debtor-var-bank-name');
        var varAccountNumber = document.getElementById('debtor-var-account-number');
        var varPharmacyEmail = document.getElementById('debtor-var-pharmacy-email');
        var varPharmacyPhone = document.getElementById('debtor-var-pharmacy-phone');
        
        // Track template variable changes and update previews
        function updatePreviews() {
          if (typeof updateEmailPreview === 'function') updateEmailPreview();
          if (typeof updateSMSPreview === 'function') updateSMSPreview();
        }
        
        if (varBankName) {
          varBankName.addEventListener('input', function() {
            debtorState.messages.template_vars.bank_name = this.value;
            updatePreviews();
          });
        }
        if (varAccountNumber) {
          varAccountNumber.addEventListener('input', function() {
            debtorState.messages.template_vars.account_number = this.value;
            updatePreviews();
          });
        }
        if (varPharmacyEmail) {
          varPharmacyEmail.addEventListener('input', function() {
            debtorState.messages.template_vars.pharmacy_email = this.value;
            updatePreviews();
          });
        }
        if (varPharmacyPhone) {
          varPharmacyPhone.addEventListener('input', function() {
            debtorState.messages.template_vars.pharmacy_phone = this.value;
            updatePreviews();
          });
        }
        
        // Preview functions (defined in outer scope so they're accessible)
        window.updateEmailPreview = function() {
          var subjectEl = document.getElementById('debtor-preview-email-subject');
          var bodyEl = document.getElementById('debtor-preview-email-body');
          
          if (!subjectEl || !bodyEl) return;
          
          // Get sample debtor or first selected debtor
          var sampleDebtor = null;
          if (debtorState.selectedDebtors.length > 0) {
            sampleDebtor = debtorState.debtors.find(function(d) {
              return debtorState.selectedDebtors.indexOf(d.id) > -1;
            });
          }
          if (!sampleDebtor && debtorState.debtors.length > 0) {
            sampleDebtor = debtorState.debtors[0];
          }
          
          // Get template variables - prefer sessionStorage, then template vars, then defaults
          var contactDetails = getPharmacyContactDetails();
          var varBankName = document.getElementById('debtor-var-bank-name');
          var varAccountNumber = document.getElementById('debtor-var-account-number');
          var varPharmacyEmail = document.getElementById('debtor-var-pharmacy-email');
          var varPharmacyPhone = document.getElementById('debtor-var-pharmacy-phone');
          
          // Calculate arrears amount (60+ days)
          var arrearsAmount = 0;
          if (sampleDebtor) {
            debtorState.filters.ageingBuckets.forEach(function(bucket) {
              arrearsAmount += parseFloat(sampleDebtor[bucket] || 0);
            });
          }
          
          // Calculate total balance (all ageing buckets)
          var totalBalance = 0;
          if (sampleDebtor) {
            totalBalance = parseFloat(sampleDebtor.balance || 0);
            // If balance field not available, calculate from all buckets
            if (!totalBalance || totalBalance === 0) {
              totalBalance = parseFloat(sampleDebtor.current || 0) +
                            parseFloat(sampleDebtor.d30 || 0) +
                            parseFloat(sampleDebtor.d60 || 0) +
                            parseFloat(sampleDebtor.d90 || 0) +
                            parseFloat(sampleDebtor.d120 || 0) +
                            parseFloat(sampleDebtor.d150 || 0) +
                            parseFloat(sampleDebtor.d180 || 0);
            }
          }
          
          // Build preview variables - use actual values or show placeholders
          // Pharmacy name always uses selected pharmacy name
          var pharmacyName = selectedPharmacyName || '[Pharmacy Name]';
          
          // Get values from sessionStorage or template vars, show placeholders if not entered
          var bankName = '';
          var accountNumber = '';
          var pharmacyEmail = '';
          var pharmacyPhone = '';
          
          if (contactDetails) {
            bankName = contactDetails.bank_name && contactDetails.bank_name.trim() ? contactDetails.bank_name.trim() : '';
            accountNumber = contactDetails.account_number && contactDetails.account_number.trim() ? contactDetails.account_number.trim() : '';
            pharmacyEmail = contactDetails.email && contactDetails.email.trim() ? contactDetails.email.trim() : '';
            pharmacyPhone = contactDetails.phone && contactDetails.phone.trim() ? contactDetails.phone.trim() : '';
          }
          
          // Check template vars as fallback
          if (!bankName && varBankName && varBankName.value.trim()) {
            bankName = varBankName.value.trim();
          }
          if (!accountNumber && varAccountNumber && varAccountNumber.value.trim()) {
            accountNumber = varAccountNumber.value.trim();
          }
          if (!pharmacyEmail && varPharmacyEmail && varPharmacyEmail.value.trim()) {
            pharmacyEmail = varPharmacyEmail.value.trim();
          }
          if (!pharmacyPhone && varPharmacyPhone && varPharmacyPhone.value.trim()) {
            pharmacyPhone = varPharmacyPhone.value.trim();
          }
          
          var vars = {
            name: sampleDebtor ? (sampleDebtor.name || '[Name]') : '[Name]',
            acc_no: sampleDebtor ? (sampleDebtor.acc_no || '[Account Number]') : '[Account Number]',
            amount: arrearsAmount.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
            arrears_amount: arrearsAmount.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
            total_balance: totalBalance.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
            pharmacy_name: pharmacyName,
            bank_name: bankName || '[Bank Name]',
            account_number: accountNumber || '[Account Number]',
            pharmacy_email: pharmacyEmail || '[Pharmacy Email]',
            pharmacy_phone: pharmacyPhone || '[Pharmacy Phone]'
          };
          
          // Default email template (matching backend defaults with total_balance)
          var defaultSubject = 'Reminder: Account Overdue at {pharmacy_name}';
          var defaultBody = '<p>Dear {name},</p><p>We hope you\'re well. This is a reminder that your account at <b>{pharmacy_name}</b> shows an outstanding balance of <b>R{amount}</b>, which has been overdue for more than 60 days.</p><p><b>Total balance (Total outstanding amount):</b> R{total_balance}</p><p>We kindly request that payment be made at your earliest convenience using the EFT details below:</p><hr><p><b>Banking Details:</b><br>Bank: {bank_name}<br>Account Number: {account_number}<br>Reference: {acc_no}</p><hr><p>If you\'ve already made this payment or require a statement, please feel free to contact us.</p><p>Thank you for your continued support.</p><p style=\'margin-top:24px;\'>Warm regards,<br><b>{pharmacy_name} Team</b><br><a href=\'mailto:{pharmacy_email}\'>{pharmacy_email}</a><br>{pharmacy_phone}</p>';
          
          // Replace placeholders
          var subject = defaultSubject.replace(/\{(\w+)\}/g, function(match, key) {
            return vars[key] || match;
          });
          var body = defaultBody.replace(/\{(\w+)\}/g, function(match, key) {
            return vars[key] || match;
          });
          
          subjectEl.textContent = subject;
          bodyEl.innerHTML = body;
        };
        
        window.updateSMSPreview = function() {
          var smsEl = document.getElementById('debtor-preview-sms');
          var charCountEl = document.getElementById('debtor-preview-sms-charcount');
          
          if (!smsEl) return;
          
          // Get sample debtor or first selected debtor
          var sampleDebtor = null;
          if (debtorState.selectedDebtors.length > 0) {
            sampleDebtor = debtorState.debtors.find(function(d) {
              return debtorState.selectedDebtors.indexOf(d.id) > -1;
            });
          }
          if (!sampleDebtor && debtorState.debtors.length > 0) {
            sampleDebtor = debtorState.debtors[0];
          }
          
          // Get template variables - prefer sessionStorage, then template vars, then defaults
          var contactDetails = getPharmacyContactDetails();
          var varBankName = document.getElementById('debtor-var-bank-name');
          var varAccountNumber = document.getElementById('debtor-var-account-number');
          
          // Calculate arrears amount (60+ days)
          var arrearsAmount = 0;
          if (sampleDebtor) {
            debtorState.filters.ageingBuckets.forEach(function(bucket) {
              arrearsAmount += parseFloat(sampleDebtor[bucket] || 0);
            });
          }
          
          // Calculate total balance (all ageing buckets)
          var totalBalance = 0;
          if (sampleDebtor) {
            totalBalance = parseFloat(sampleDebtor.balance || 0);
            // If balance field not available, calculate from all buckets
            if (!totalBalance || totalBalance === 0) {
              totalBalance = parseFloat(sampleDebtor.current || 0) +
                            parseFloat(sampleDebtor.d30 || 0) +
                            parseFloat(sampleDebtor.d60 || 0) +
                            parseFloat(sampleDebtor.d90 || 0) +
                            parseFloat(sampleDebtor.d120 || 0) +
                            parseFloat(sampleDebtor.d150 || 0) +
                            parseFloat(sampleDebtor.d180 || 0);
            }
          }
          
          // Build preview variables - use actual values or show placeholders
          // Pharmacy name always uses selected pharmacy name
          var pharmacyName = selectedPharmacyName || '[Pharmacy Name]';
          
          // Get values from sessionStorage or template vars, show placeholders if not entered
          var bankName = '';
          var accountNumber = '';
          
          if (contactDetails) {
            bankName = contactDetails.bank_name && contactDetails.bank_name.trim() ? contactDetails.bank_name.trim() : '';
            accountNumber = contactDetails.account_number && contactDetails.account_number.trim() ? contactDetails.account_number.trim() : '';
          }
          
          // Check template vars as fallback
          if (!bankName && varBankName && varBankName.value.trim()) {
            bankName = varBankName.value.trim();
          }
          if (!accountNumber && varAccountNumber && varAccountNumber.value.trim()) {
            accountNumber = varAccountNumber.value.trim();
          }
          
          var vars = {
            name: sampleDebtor ? (sampleDebtor.name || '[Name]') : '[Name]',
            acc_no: sampleDebtor ? (sampleDebtor.acc_no || '[Account Number]') : '[Account Number]',
            amount: arrearsAmount.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
            total_balance: totalBalance.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
            pharmacy_name: pharmacyName,
            bank_name: bankName || '[Bank Name]',
            account_number: accountNumber || '[Account Number]'
          };
          
          // Default SMS template (matching backend defaults with total_balance)
          var defaultSMS = 'Hi {name}, your {pharmacy_name} account is overdue (60+ days): R{amount}. Total balance (Total outstanding amount): R{total_balance}. EFT {bank_name} {account_number}. Ref {acc_no}. Thanks!';
          
          // Replace placeholders
          var sms = defaultSMS.replace(/\{(\w+)\}/g, function(match, key) {
            return vars[key] || match;
          });
          
          smsEl.textContent = sms;
          
          if (charCountEl) {
            charCountEl.textContent = sms.length;
            if (sms.length > 160) {
              charCountEl.style.color = 'var(--error)';
            } else {
              charCountEl.style.color = 'var(--textSecondary)';
            }
          }
        };
        
        // Update previews when debtors are loaded
        window.updatePreviewsOnDebtorLoad = function() {
          if (debtorState.debtors && debtorState.debtors.length > 0) {
            if (typeof updateEmailPreview === 'function') updateEmailPreview();
            if (typeof updateSMSPreview === 'function') updateSMSPreview();
          }
        };
        
        // Communication buttons - remove old listeners first to prevent duplicates
        var sendEmailBtn = document.getElementById('debtor-send-email');
        var sendSMSBtn = document.getElementById('debtor-send-sms');
        var downloadCSVBtn = document.getElementById('debtor-download-csv');
        var downloadPDFBtn = document.getElementById('debtor-download-pdf');
        
        // Remove old event listeners by cloning and replacing buttons
        if (sendEmailBtn) {
          var newSendEmailBtn = sendEmailBtn.cloneNode(true);
          sendEmailBtn.parentNode.replaceChild(newSendEmailBtn, sendEmailBtn);
          sendEmailBtn = newSendEmailBtn;
        }
        if (sendSMSBtn) {
          var newSendSMSBtn = sendSMSBtn.cloneNode(true);
          sendSMSBtn.parentNode.replaceChild(newSendSMSBtn, sendSMSBtn);
          sendSMSBtn = newSendSMSBtn;
        }
        if (downloadCSVBtn) {
          var newDownloadCSVBtn = downloadCSVBtn.cloneNode(true);
          downloadCSVBtn.parentNode.replaceChild(newDownloadCSVBtn, downloadCSVBtn);
          downloadCSVBtn = newDownloadCSVBtn;
        }
        if (downloadPDFBtn) {
          var newDownloadPDFBtn = downloadPDFBtn.cloneNode(true);
          downloadPDFBtn.parentNode.replaceChild(newDownloadPDFBtn, downloadPDFBtn);
          downloadPDFBtn = newDownloadPDFBtn;
        }
        
        if (sendEmailBtn) {
          sendEmailBtn.addEventListener('click', function() {
            sendDebtorEmail();
          });
        }
        if (sendSMSBtn) {
          sendSMSBtn.addEventListener('click', function() {
            sendDebtorSMS();
          });
        }
        if (downloadCSVBtn) {
          downloadCSVBtn.addEventListener('click', function() {
            downloadDebtorCSV();
          });
        }
        if (downloadPDFBtn) {
          downloadPDFBtn.addEventListener('click', function() {
            downloadDebtorPDF();
          });
        }
        
        // Pagination
        var prevPageBtn = document.getElementById('debtor-prev-page');
        var nextPageBtn = document.getElementById('debtor-next-page');
        if (prevPageBtn) {
          prevPageBtn.addEventListener('click', function() {
            if (debtorState.pagination.page > 1) {
              debtorState.pagination.page--;
              fetchDebtors();
            }
          });
        }
        if (nextPageBtn) {
          nextPageBtn.addEventListener('click', function() {
            if (debtorState.pagination.page < debtorState.pagination.pages) {
              debtorState.pagination.page++;
              fetchDebtors();
            }
          });
        }
        
      }
      
      function fetchDebtorStatistics() {
        if (!debtorState.pharmacyId) return;
        
        fetch('/api/pharmacies/' + debtorState.pharmacyId + '/debtors/statistics', {
          credentials: 'include'
        })
          .then(function(response) {
            if (!response.ok) {
              // If 404, backend endpoints not implemented yet - this is OK
              if (response.status === 404) {
                console.log('Debtor statistics endpoint not available yet');
                return null;
              }
              throw new Error('Failed to fetch statistics');
            }
            return response.json();
          })
          .then(function(data) {
            if (data) {
              debtorState.statistics = data;
              updateStatistics();
            }
          })
          .catch(function(error) {
            console.error('Failed to fetch statistics:', error);
          });
      }
      
      function updateStatistics() {
        if (!debtorState.statistics) return;
        
        var currentValue = document.getElementById('debtor-current-value');
        var totalOutstanding = document.getElementById('debtor-total-outstanding');
        var totalAccounts = document.getElementById('debtor-total-accounts');
        var ageingList = document.getElementById('debtor-ageing-list');
        
        // Update primary card values
        if (currentValue) {
          currentValue.textContent = formatMoney(debtorState.statistics.current || 0);
        }
        if (totalOutstanding) {
          totalOutstanding.textContent = formatMoney(debtorState.statistics.total_outstanding || 0);
        }
        if (totalAccounts) {
          totalAccounts.textContent = (debtorState.statistics.total_accounts || 0).toLocaleString();
        }
        
        // Update ageing buckets list
        if (ageingList) {
          var buckets = ['d30', 'd60', 'd90', 'd120', 'd150', 'd180'];
          var labels = { d30: '30 Days', d60: '60 Days', d90: '90 Days', d120: '120 Days', d150: '150 Days', d180: '180+ Days' };
          
          ageingList.innerHTML = buckets.map(function(bucket) {
            var value = debtorState.statistics[bucket] || 0;
            return '<div class="debtor-ageing-item">' +
              '<div class="debtor-ageing-label">' + labels[bucket] + '</div>' +
              '<div class="debtor-ageing-value-wrapper">' +
              '<span class="debtor-ageing-currency">R</span>' +
              '<span class="debtor-ageing-value">' + formatMoney(value) + '</span>' +
              '</div>' +
              '</div>';
          }).join('');
        }
      }
      
      function fetchDebtors() {
        if (!debtorState.pharmacyId) return;
        
        var loadingEl = document.getElementById('debtor-table-loading');
        var errorEl = document.getElementById('debtor-table-error');
        var tableBody = document.getElementById('debtor-table-body');
        
        if (loadingEl) loadingEl.style.display = 'flex';
        if (errorEl) errorEl.style.display = 'none';
        
        var params = new URLSearchParams();
        if (debtorState.filters.minBalance) {
          params.append('min_balance', debtorState.filters.minBalance);
        }
        if (debtorState.filters.ageingBuckets.length) {
          params.append('ageing_buckets', debtorState.filters.ageingBuckets.join(','));
        }
        if (debtorState.filters.hasEmail) {
          params.append('has_email', 'true');
        }
        if (debtorState.filters.hasPhone) {
          params.append('has_phone', 'true');
        }
        if (debtorState.filters.search) {
          params.append('search', debtorState.filters.search);
        }
        // Add sorting parameters if backend supports it
        if (debtorState.sortColumn) {
          params.append('sort_by', debtorState.sortColumn);
          params.append('sort_order', debtorState.sortDirection);
        }
        // When sorting, fetch more records to get better results
        var perPage = debtorState.sortColumn ? Math.max(debtorState.pagination.perPage, 1000) : debtorState.pagination.perPage;
        params.append('page', debtorState.pagination.page);
        params.append('per_page', perPage);
        
        fetch('/api/pharmacies/' + debtorState.pharmacyId + '/debtors?' + params.toString(), {
          credentials: 'include'
        })
          .then(function(response) {
            if (!response.ok) throw new Error('Failed to fetch debtors');
            return response.json();
          })
          .then(function(data) {
            debtorState.debtors = data.debtors || [];
            debtorState.pagination = {
              page: data.page || 1,
              perPage: data.per_page || 100,
              total: data.total || 0,
              pages: data.pages || 1
            };
            renderDebtors();
            updatePagination();
            if (typeof updatePreviewsOnDebtorLoad === 'function') {
              updatePreviewsOnDebtorLoad();
            }
          })
          .catch(function(error) {
            if (errorEl) {
              errorEl.textContent = 'Error: ' + error.message;
              errorEl.style.display = 'block';
            }
          })
          .finally(function() {
            if (loadingEl) loadingEl.style.display = 'none';
          });
      }
      
      function renderDebtors() {
        var tableBody = document.getElementById('debtor-table-body');
        if (!tableBody) return;
        
        // Filter out medical aid accounts (backend should already filter, but double-check)
        var displayDebtors = debtorState.debtors.filter(function(d) {
          return !d.is_medical_aid_control;
        });
        
        // Sort debtors client-side (only if backend doesn't support sorting)
        // If backend supports sorting, it should already be sorted
        if (debtorState.sortColumn) {
          displayDebtors = sortDebtorsArray(displayDebtors);
        }
        
        if (displayDebtors.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="13" style="text-align: center; padding: 40px;">No debtors match your current filters</td></tr>';
          return;
        }
        
        var buckets = ['current', 'd30', 'd60', 'd90', 'd120', 'd150', 'd180'];
        
        tableBody.innerHTML = displayDebtors.map(function(debtor) {
          var isSelected = debtorState.selectedDebtors.indexOf(debtor.id) > -1;
          var bucketCells = buckets.map(function(bucket) {
            var value = debtor[bucket] || 0;
            return '<td>' + (value > 0 ? 'R ' + formatMoney(value) : '-') + '</td>';
          }).join('');
          
          return '<tr class="' + (isSelected ? 'debtor-row-selected' : '') + '">' +
            '<td><input type="checkbox" class="debtor-row-checkbox" data-debtor-id="' + debtor.id + '" ' + (isSelected ? 'checked' : '') + ' /></td>' +
            '<td>' + (debtor.acc_no || '-') + '</td>' +
            '<td>' + (debtor.name || '-') + '</td>' +
            bucketCells +
            '<td>R ' + formatMoney(debtor.balance || 0) + '</td>' +
            '<td>' + (debtor.email ? '<a href="mailto:' + debtor.email + '">' + debtor.email + '</a>' : '<span style="color: var(--textSecondary);">No email</span>') + '</td>' +
            '<td>' + (debtor.phone ? '<a href="tel:' + debtor.phone + '">' + debtor.phone + '</a>' : '<span style="color: var(--textSecondary);">No phone</span>') + '</td>' +
            '</tr>';
        }).join('');
        
        // Attach checkbox handlers
        tableBody.querySelectorAll('.debtor-row-checkbox').forEach(function(checkbox) {
          checkbox.addEventListener('change', function() {
            var debtorId = parseInt(this.dataset.debtorId);
            toggleDebtorSelection(debtorId);
          });
        });
        
        updateSelectionInfo();
      }
      
      function sortDebtorsArray(debtors) {
        if (!debtorState.sortColumn) return debtors;
        
        return debtors.slice().sort(function(a, b) {
          var aValue, bValue;
          
          if (['balance', 'current', 'd30', 'd60', 'd90', 'd120', 'd150', 'd180'].indexOf(debtorState.sortColumn) > -1) {
            aValue = Number(a[debtorState.sortColumn]) || 0;
            bValue = Number(b[debtorState.sortColumn]) || 0;
          } else {
            aValue = (a[debtorState.sortColumn] || '').toString().toLowerCase();
            bValue = (b[debtorState.sortColumn] || '').toString().toLowerCase();
          }
          
          if (aValue < bValue) return debtorState.sortDirection === 'asc' ? -1 : 1;
          if (aValue > bValue) return debtorState.sortDirection === 'asc' ? 1 : -1;
          return 0;
        });
      }
      
      function sortDebtors() {
        renderDebtors();
      }
      
      function updateSortIcons() {
        document.querySelectorAll('.debtor-sortable .sort-icon').forEach(function(icon) {
          icon.textContent = '↕';
        });
        
        if (debtorState.sortColumn) {
          var header = document.querySelector('.debtor-sortable[data-column="' + debtorState.sortColumn + '"]');
          if (header) {
            var icon = header.querySelector('.sort-icon');
            if (icon) {
              icon.textContent = debtorState.sortDirection === 'asc' ? '↑' : '↓';
            }
          }
        }
      }
      
      function toggleDebtorSelection(debtorId) {
        var index = debtorState.selectedDebtors.indexOf(debtorId);
        if (index > -1) {
          debtorState.selectedDebtors.splice(index, 1);
        } else {
          debtorState.selectedDebtors.push(debtorId);
        }
        renderDebtors();
        updateSelectionInfo();
      }
      
      function selectAllDebtors() {
        var displayDebtors = debtorState.debtors.filter(function(d) {
          return !d.is_medical_aid_control;
        });
        debtorState.selectedDebtors = displayDebtors.map(function(d) { return d.id; });
        renderDebtors();
        updateSelectionInfo();
      }
      
      function clearSelection() {
        debtorState.selectedDebtors = [];
        renderDebtors();
        updateSelectionInfo();
      }
      
      function updateSelectionInfo() {
        var countEl = document.getElementById('debtor-selected-count');
        var sendEmailBtn = document.getElementById('debtor-send-email');
        var sendSMSBtn = document.getElementById('debtor-send-sms');
        
        if (countEl) {
          countEl.textContent = debtorState.selectedDebtors.length;
        }
        
        var hasSelection = debtorState.selectedDebtors.length > 0;
        if (sendEmailBtn) sendEmailBtn.disabled = !hasSelection;
        if (sendSMSBtn) sendSMSBtn.disabled = !hasSelection;
        
        // Update select all checkbox
        var selectAll = document.getElementById('debtor-select-all');
        if (selectAll) {
          var displayDebtors = debtorState.debtors.filter(function(d) {
            return !d.is_medical_aid_control;
          });
          selectAll.checked = displayDebtors.length > 0 && 
            displayDebtors.every(function(d) {
              return debtorState.selectedDebtors.indexOf(d.id) > -1;
            });
        }
        
        // Update previews when selection changes
        var emailPreviewContent = document.getElementById('debtor-email-preview-content');
        var smsPreviewContent = document.getElementById('debtor-sms-preview-content');
        if (emailPreviewContent && emailPreviewContent.style.display !== 'none') {
          if (typeof updateEmailPreview === 'function') updateEmailPreview();
        }
        if (smsPreviewContent && smsPreviewContent.style.display !== 'none') {
          if (typeof updateSMSPreview === 'function') updateSMSPreview();
        }
      }
      
      function updatePagination() {
        var paginationEl = document.getElementById('debtor-pagination');
        var pageInfoEl = document.getElementById('debtor-page-info');
        var prevBtn = document.getElementById('debtor-prev-page');
        var nextBtn = document.getElementById('debtor-next-page');
        
        if (paginationEl) {
          paginationEl.style.display = debtorState.pagination.pages > 1 ? 'flex' : 'none';
        }
        
        if (pageInfoEl) {
          pageInfoEl.textContent = 'Page ' + debtorState.pagination.page + ' of ' + debtorState.pagination.pages;
        }
        
        if (prevBtn) {
          prevBtn.disabled = debtorState.pagination.page <= 1;
        }
        if (nextBtn) {
          nextBtn.disabled = debtorState.pagination.page >= debtorState.pagination.pages;
        }
      }
      
      // Check if pharmacy contact details are stored
      function getCurrentPharmacyIdForContacts() {
        return selectedPharmacyId || debtorState.pharmacyId || null;
      }
      
      function getPharmacyContactStorageKeyForId(pharmacyId) {
        return pharmacyId ? (PHARMACY_CONTACT_STORAGE_PREFIX + pharmacyId) : 'pharmacy_contact_details';
      }
      
      function getPharmacyContactStorageKey() {
        var pharmacyId = getCurrentPharmacyIdForContacts();
        return getPharmacyContactStorageKeyForId(pharmacyId);
      }
      
      function getPharmacyContactDetails() {
        try {
          var storageKey = getPharmacyContactStorageKey();
          var stored = sessionStorage.getItem(storageKey);
          
          // Backwards compatibility with legacy key
          if (!stored && storageKey !== 'pharmacy_contact_details') {
            stored = sessionStorage.getItem('pharmacy_contact_details');
          }
          
          if (stored) {
            return JSON.parse(stored);
          }
        } catch (e) {
          console.error('Error reading pharmacy contact details:', e);
        }
        return null;
      }
      
      function savePharmacyContactDetails(details) {
        try {
          var storageKey = getPharmacyContactStorageKey();
          sessionStorage.setItem(storageKey, JSON.stringify(details));
          return true;
        } catch (e) {
          console.error('Error saving pharmacy contact details:', e);
          return false;
        }
      }
      
      function clearAllPharmacyContactDetails() {
        try {
          var keysToRemove = [];
          for (var i = 0; i < sessionStorage.length; i++) {
            var key = sessionStorage.key(i);
            if (key && (key === 'pharmacy_contact_details' || key.indexOf(PHARMACY_CONTACT_STORAGE_PREFIX) === 0)) {
              keysToRemove.push(key);
            }
          }
          keysToRemove.forEach(function(key) {
            sessionStorage.removeItem(key);
          });
          sessionStorage.removeItem('pharmacy_contact_details');
        } catch (e) {
          console.error('Error clearing stored pharmacy contact details:', e);
        }
      }
      
      function showPharmacyContactModal() {
        var overlay = document.getElementById('pharmacy-contact-modal-overlay');
        if (overlay) {
          overlay.classList.add('active');
          // Load existing values if any
          var existing = getPharmacyContactDetails();
          if (existing) {
            var phoneInput = document.getElementById('modal-pharmacy-phone');
            var emailInput = document.getElementById('modal-pharmacy-email');
            var bankInput = document.getElementById('modal-pharmacy-bank-name');
            var accountInput = document.getElementById('modal-pharmacy-account-number');
            if (phoneInput) phoneInput.value = existing.phone || '';
            if (emailInput) emailInput.value = existing.email || '';
            if (bankInput) bankInput.value = existing.bank_name || '';
            if (accountInput) accountInput.value = existing.account_number || '';
          } else {
            if (phoneInput) phoneInput.value = '';
            if (emailInput) emailInput.value = '';
            if (bankInput) bankInput.value = '';
            if (accountInput) accountInput.value = '';
          }
        }
      }
      
      function hidePharmacyContactModal() {
        var overlay = document.getElementById('pharmacy-contact-modal-overlay');
        if (overlay) {
          overlay.classList.remove('active');
        }
      }
      
      function validatePharmacyContactDetails() {
        var details = getPharmacyContactDetails();
        if (!details) {
          return false;
        }
        // Check that all required fields are present and not empty (no defaults/examples)
        // Trim values to ensure they're not just whitespace
        var hasPhone = details.phone && details.phone.trim() !== '';
        var hasEmail = details.email && details.email.trim() !== '';
        var hasBankName = details.bank_name && details.bank_name.trim() !== '';
        var hasAccountNumber = details.account_number && details.account_number.trim() !== '';
        
        return hasPhone && hasEmail && hasBankName && hasAccountNumber;
      }
      
      function validatePharmacyContactDetailsForSMS() {
        var details = getPharmacyContactDetails();
        if (!details) {
          return false;
        }
        // For SMS, only need bank_name and account_number
        var hasBankName = details.bank_name && details.bank_name.trim() !== '';
        var hasAccountNumber = details.account_number && details.account_number.trim() !== '';
        
        return hasBankName && hasAccountNumber;
      }
      
      // Initialize pharmacy contact modal
      var pharmacyContactForm = document.getElementById('pharmacy-contact-form');
      var pharmacyContactModalClose = document.getElementById('pharmacy-contact-modal-close');
      var pharmacyContactOverlay = document.getElementById('pharmacy-contact-modal-overlay');
      
      if (pharmacyContactForm) {
        pharmacyContactForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          var phone = document.getElementById('modal-pharmacy-phone').value.trim();
          var email = document.getElementById('modal-pharmacy-email').value.trim();
          var bankName = document.getElementById('modal-pharmacy-bank-name').value.trim();
          var accountNumber = document.getElementById('modal-pharmacy-account-number').value.trim();
          
          if (!phone || !email || !bankName || !accountNumber) {
            showStyledAlert('Please fill in all required fields.', 'warning', 'Required Fields');
            return;
          }
          
          var details = {
            phone: phone,
            email: email,
            bank_name: bankName,
            account_number: accountNumber
          };
          
          if (savePharmacyContactDetails(details)) {
            hidePharmacyContactModal();
            // Update template variables if they're visible
            var varPharmacyPhone = document.getElementById('debtor-var-pharmacy-phone');
            var varPharmacyEmail = document.getElementById('debtor-var-pharmacy-email');
            var varBankName = document.getElementById('debtor-var-bank-name');
            var varAccountNumber = document.getElementById('debtor-var-account-number');
            if (varPharmacyPhone) varPharmacyPhone.value = phone;
            if (varPharmacyEmail) varPharmacyEmail.value = email;
            if (varBankName) varBankName.value = bankName;
            if (varAccountNumber) varAccountNumber.value = accountNumber;
            
            // If Send Reminders section was trying to open, open it now
            var sendRemindersContent = document.getElementById('debtor-send-reminders-content');
            var sendRemindersToggle = document.getElementById('debtor-send-reminders-toggle');
            if (sendRemindersContent && sendRemindersContent.style.display === 'none') {
              sendRemindersContent.style.display = 'block';
              if (sendRemindersToggle) {
                sendRemindersToggle.classList.add('debtor-collapsible-open');
              }
            }
            
            // Update previews
            if (typeof updatePreviews === 'function') updatePreviews();
          } else {
            showStyledAlert('Failed to save details. Please try again.', 'error', 'Error');
          }
        });
      }
      
      if (pharmacyContactModalClose) {
        pharmacyContactModalClose.addEventListener('click', hidePharmacyContactModal);
      }
      
      if (pharmacyContactOverlay) {
        pharmacyContactOverlay.addEventListener('click', function(e) {
          if (e.target === pharmacyContactOverlay) {
            hidePharmacyContactModal();
          }
        });
      }
      
      function sendDebtorEmail() {
        // Prevent multiple simultaneous sends
        var sendBtn = document.getElementById('debtor-send-email');
        if (sendBtn && sendBtn.disabled) {
          return; // Already sending
        }
        
        if (debtorState.selectedDebtors.length === 0) return;
        
        if (!debtorState.pharmacyId) {
          var statusEl = document.getElementById('debtor-communication-status');
          statusEl.innerHTML = '<span style="color: var(--error);">✗ Error: No pharmacy selected. Please select a pharmacy first.</span>';
          statusEl.style.display = 'block';
          return;
        }
        
        // Build accounts array from selected debtors
        var accounts = debtorState.debtors
          .filter(function(debtor) {
            return debtorState.selectedDebtors.indexOf(debtor.id) > -1 && debtor.email;
          })
          .map(function(debtor) {
            return {
              acc_no: debtor.acc_no || '',
              name: debtor.name || '',
              email: debtor.email || '',
              phone: debtor.phone || '',
              current: parseFloat(debtor.current || 0),
              d30: parseFloat(debtor.d30 || 0),
              d60: parseFloat(debtor.d60 || 0),
              d90: parseFloat(debtor.d90 || 0),
              d120: parseFloat(debtor.d120 || 0),
              d150: parseFloat(debtor.d150 || 0),
              d180: parseFloat(debtor.d180 || 0),
              balance: parseFloat(debtor.balance || 0) // Include balance if available
            };
          });
        
        if (accounts.length === 0) {
          var statusEl = document.getElementById('debtor-communication-status');
          statusEl.innerHTML = '<span style="color: var(--error);">✗ Error: No selected debtors have email addresses.</span>';
          statusEl.style.display = 'block';
          return;
        }
        
        // Pharmacy name validation
        var pharmacyName = selectedPharmacyName;
        if (!pharmacyName || pharmacyName === 'Select Pharmacy' || pharmacyName.trim() === '') {
          var statusEl = document.getElementById('debtor-communication-status');
          statusEl.innerHTML = '<span style="color: var(--error);">✗ Error: Please select a pharmacy first.</span>';
          statusEl.style.display = 'block';
          return;
        }
        
        // Check if pharmacy contact details are provided (must be actually entered, not defaults)
        if (!validatePharmacyContactDetails()) {
          showPharmacyContactModal();
          return;
        }
        
        // Build request payload - use default templates from backend
        var payload = {
          accounts: accounts
        };
        
        // Get pharmacy contact details from sessionStorage (required)
        var contactDetails = getPharmacyContactDetails();
        
        // Validate that we have all required contact details with actual values
        var bankName = contactDetails.bank_name && contactDetails.bank_name.trim() ? contactDetails.bank_name.trim() : null;
        var accountNumber = contactDetails.account_number && contactDetails.account_number.trim() ? contactDetails.account_number.trim() : null;
        var pharmacyEmail = contactDetails.email && contactDetails.email.trim() ? contactDetails.email.trim() : null;
        var pharmacyPhone = contactDetails.phone && contactDetails.phone.trim() ? contactDetails.phone.trim() : null;
        
        if (!bankName || !accountNumber || !pharmacyEmail || !pharmacyPhone) {
          showPharmacyContactModal();
          return;
        }
        
        // Always include ALL required template variables for email (only actual entered values)
        var templateVars = {
          pharmacy_name: pharmacyName.trim(),     // Required - from selected pharmacy
          bank_name: bankName,                   // Required - from sessionStorage (user-entered)
          account_number: accountNumber,         // Required - from sessionStorage (user-entered)
          pharmacy_email: pharmacyEmail,         // Required - from sessionStorage (user-entered)
          pharmacy_phone: pharmacyPhone          // Required - from sessionStorage (user-entered)
        };
        
        payload.template_variables = templateVars;
        
        var statusEl = document.getElementById('debtor-communication-status');
        var sendBtn = document.getElementById('debtor-send-email');
        
        statusEl.innerHTML = '<div class="spinner"></div> Sending emails...';
        statusEl.style.display = 'block';
        sendBtn.disabled = true;
        
        fetch('https://debtor-reminder-backend.onrender.com/send_email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
        .then(async function(response) {
          var responseData = null;
          try {
            responseData = await response.json();
          } catch (e) {
            // Response is not JSON
          }
          
          if (!response.ok) {
            var errorMsg = 'Failed to send emails';
            if (responseData && responseData.detail) {
              errorMsg = responseData.detail;
            } else if (responseData && responseData.error) {
              errorMsg = responseData.error;
            } else {
              errorMsg = 'Failed to send emails: ' + response.status + ' ' + response.statusText;
            }
            throw new Error(errorMsg);
          }
          return responseData || {};
        })
        .then(function(data) {
          var sentCount = Array.isArray(data.sent) ? data.sent.length : 0;
          var errorCount = Array.isArray(data.errors) ? data.errors.length : 0;
          var message = '✓ Emails sent successfully! Sent: ' + sentCount;
          if (errorCount > 0) {
            message += ', Errors: ' + errorCount;
          }
          statusEl.innerHTML = '<span style="color: var(--success);">' + message + '</span>';
          statusEl.style.display = 'block';
        })
        .catch(function(error) {
          statusEl.innerHTML = '<span style="color: var(--error);">✗ Error: ' + error.message + '</span>';
          statusEl.style.display = 'block';
        })
        .finally(function() {
          sendBtn.disabled = false;
        });
      }
      
      function sendDebtorSMS() {
        // Prevent multiple simultaneous sends
        var sendBtn = document.getElementById('debtor-send-sms');
        if (sendBtn && sendBtn.disabled) {
          return; // Already sending
        }
        
        if (debtorState.selectedDebtors.length === 0) return;
        
        if (!debtorState.pharmacyId) {
          var statusEl = document.getElementById('debtor-communication-status');
          statusEl.innerHTML = '<span style="color: var(--error);">✗ Error: No pharmacy selected. Please select a pharmacy first.</span>';
          statusEl.style.display = 'block';
          return;
        }
        
        // Build accounts array from selected debtors
        var accounts = debtorState.debtors
          .filter(function(debtor) {
            return debtorState.selectedDebtors.indexOf(debtor.id) > -1 && debtor.phone;
          })
          .map(function(debtor) {
            return {
              acc_no: debtor.acc_no || '',
              name: debtor.name || '',
              email: debtor.email || '',
              phone: debtor.phone || '',
              current: parseFloat(debtor.current || 0),
              d30: parseFloat(debtor.d30 || 0),
              d60: parseFloat(debtor.d60 || 0),
              d90: parseFloat(debtor.d90 || 0),
              d120: parseFloat(debtor.d120 || 0),
              d150: parseFloat(debtor.d150 || 0),
              d180: parseFloat(debtor.d180 || 0),
              balance: parseFloat(debtor.balance || 0) // Include balance if available
            };
          });
        
        if (accounts.length === 0) {
          var statusEl = document.getElementById('debtor-communication-status');
          statusEl.innerHTML = '<span style="color: var(--error);">✗ Error: No selected debtors have phone numbers.</span>';
          statusEl.style.display = 'block';
          return;
        }
        
        // Build request payload - use default templates from backend
        var payload = {
          accounts: accounts
        };
        
        // Pharmacy name validation
        var pharmacyName = selectedPharmacyName;
        if (!pharmacyName || pharmacyName === 'Select Pharmacy' || pharmacyName.trim() === '') {
          var statusEl = document.getElementById('debtor-communication-status');
          statusEl.innerHTML = '<span style="color: var(--error);">✗ Error: Please select a pharmacy first.</span>';
          statusEl.style.display = 'block';
          return;
        }
        
        // Check if pharmacy contact details are provided (must be actually entered, not defaults)
        if (!validatePharmacyContactDetailsForSMS()) {
          showPharmacyContactModal();
          return;
        }
        
        // Get pharmacy contact details from sessionStorage (required)
        var contactDetails = getPharmacyContactDetails();
        
        // Validate that we have all required contact details with actual values
        var bankName = contactDetails.bank_name && contactDetails.bank_name.trim() ? contactDetails.bank_name.trim() : null;
        var accountNumber = contactDetails.account_number && contactDetails.account_number.trim() ? contactDetails.account_number.trim() : null;
        
        if (!bankName || !accountNumber) {
          showPharmacyContactModal();
          return;
        }
        
        // Always include ALL required template variables for SMS (only actual entered values)
        var templateVars = {
          pharmacy_name: pharmacyName.trim(),    // Required - from selected pharmacy
          bank_name: bankName,                  // Required - from sessionStorage (user-entered)
          account_number: accountNumber          // Required - from sessionStorage (user-entered)
        };
        
        payload.template_variables = templateVars;
        
        var statusEl = document.getElementById('debtor-communication-status');
        var sendBtn = document.getElementById('debtor-send-sms');
        
        statusEl.innerHTML = '<div class="spinner"></div> Sending SMS...';
        statusEl.style.display = 'block';
        sendBtn.disabled = true;
        
        fetch('https://debtor-reminder-backend.onrender.com/send_sms', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
        .then(async function(response) {
          var responseData = null;
          try {
            responseData = await response.json();
          } catch (e) {
            // Response is not JSON
          }
          
          if (!response.ok) {
            var errorMsg = 'Failed to send SMS';
            if (responseData && responseData.detail) {
              errorMsg = responseData.detail;
            } else if (responseData && responseData.error) {
              errorMsg = responseData.error;
            } else {
              errorMsg = 'Failed to send SMS: ' + response.status + ' ' + response.statusText;
            }
            throw new Error(errorMsg);
          }
          return responseData || {};
        })
        .then(function(data) {
          var sentCount = Array.isArray(data.sent) ? data.sent.length : 0;
          var errorCount = Array.isArray(data.errors) ? data.errors.length : 0;
          var message = '✓ SMS sent successfully! Sent: ' + sentCount;
          if (errorCount > 0) {
            message += ', Errors: ' + errorCount;
          }
          statusEl.innerHTML = '<span style="color: var(--success);">' + message + '</span>';
          statusEl.style.display = 'block';
        })
        .catch(function(error) {
          statusEl.innerHTML = '<span style="color: var(--error);">✗ Error: ' + error.message + '</span>';
          statusEl.style.display = 'block';
        })
        .finally(function() {
          sendBtn.disabled = false;
        });
      }
      
      function downloadDebtorCSV() {
        fetch('/api/pharmacies/' + debtorState.pharmacyId + '/debtors/download-csv', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            debtor_ids: debtorState.selectedDebtors.length > 0 ? debtorState.selectedDebtors : null,
            min_balance: debtorState.filters.minBalance
          })
        })
        .then(function(response) {
          if (!response.ok) throw new Error('Failed to download CSV');
          return response.blob();
        })
        .then(function(blob) {
          var url = window.URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url;
          a.download = 'debtors_' + debtorState.pharmacyId + '_' + Date.now() + '.csv';
          a.click();
          window.URL.revokeObjectURL(url);
        })
        .catch(function(error) {
          showStyledAlert('Error downloading CSV: ' + error.message, 'error', 'Download Error');
        });
      }
      
      function downloadDebtorPDF() {
        fetch('/api/pharmacies/' + debtorState.pharmacyId + '/debtors/download-pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            debtor_ids: debtorState.selectedDebtors.length > 0 ? debtorState.selectedDebtors : null,
            ageing_buckets: debtorState.filters.ageingBuckets,
            col_names: {
              current: 'Current',
              d30: '30D',
              d60: '60D',
              d90: '90D',
              d120: '120D',
              d150: '150D',
              d180: '180D'
            }
          })
        })
        .then(function(response) {
          if (!response.ok) throw new Error('Failed to download PDF');
          return response.blob();
        })
        .then(function(blob) {
          var url = window.URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url;
          a.download = 'debtors_' + debtorState.pharmacyId + '_' + Date.now() + '.pdf';
          a.click();
          window.URL.revokeObjectURL(url);
        })
        .catch(function(error) {
          showStyledAlert('Error downloading PDF: ' + error.message, 'error', 'Download Error');
        });
      }
      
      function showDebtorError(message) {
        var errorEl = document.getElementById('debtor-table-error');
        if (errorEl) {
          errorEl.textContent = message;
          errorEl.style.display = 'block';
        }
      }
      
      function formatMoney(amount) {
        return Number(amount || 0).toLocaleString('en-ZA', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      }
      
      loadDays();
      loadDashboard();
      window.addEventListener('beforeunload', function() {
        clearAllPharmacyContactDetails();
      });

      // Chart of Accounts functionality
      var coaState = {
        accounts: [],
        filteredAccounts: [],
        sortOrder: 'asc',
        sortColumn: 'code',
        typeFilter: ''
      };

      var COAService = {
        async listAccounts() {
          const response = await fetch('/api/accounts', {
            credentials: 'include'
          });
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || `Request failed: ${response.status}`);
          }
          return await response.json();
        },

        async createAccount(accountData) {
          console.log('Creating account with data:', accountData);
          const jsonBody = JSON.stringify(accountData);
          console.log('JSON being sent to backend:', jsonBody);
          console.log('Formatted JSON:', JSON.stringify(accountData, null, 2));
          
          const response = await fetch('/api/admin/chart-of-accounts', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: jsonBody
          });
          
          console.log('Response status:', response.status, response.statusText);
          
          if (!response.ok) {
            const errorData = await response.json().catch(() => {
              return { detail: `Request failed: ${response.status} ${response.statusText}` };
            });
            console.error('Error response:', errorData);
            throw new Error(errorData.detail || `Request failed: ${response.status}`);
          }
          return await response.json();
        },

        async updateAccount(accountId, updates) {
          const response = await fetch(`/api/admin/chart-of-accounts/${accountId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(updates)
          });
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || `Request failed: ${response.status}`);
          }
          return await response.json();
        },

        async toggleActive(accountId, isActive) {
          return await this.updateAccount(accountId, { is_active: isActive });
        }
      };

      // Expose COAService to window for access from other script scopes
      window.COAService = COAService;

      function loadCOAAccounts() {
        const tbody = document.getElementById('coa-table-body');
        if (!tbody) return;
        
        tbody.innerHTML = '<tr><td colspan="6" class="loading-cell">Loading accounts...</td></tr>';
        
        COAService.listAccounts()
          .then(function(accounts) {
            console.log('Chart of Accounts loaded:', accounts);
            console.log('First account:', accounts[0]);
            
            // Ensure accounts is an array
            if (!Array.isArray(accounts)) {
              console.error('Expected array but got:', typeof accounts, accounts);
              throw new Error('Invalid response format: expected array');
            }
            
            coaState.accounts = accounts;
            applyCOAFilters();
          })
          .catch(function(error) {
            console.error('Error loading accounts:', error);
            console.error('Error stack:', error.stack);
            tbody.innerHTML = `<tr><td colspan="6" class="error-cell">Error: ${error.message}</td></tr>`;
            showStyledAlert(error.message, 'error', 'Error Loading Accounts');
          });
      }

      function applyCOAFilters() {
        var filtered = coaState.accounts.slice();
        
        // Apply type filter
        if (coaState.typeFilter) {
          filtered = filtered.filter(function(acc) {
            return acc.type === coaState.typeFilter;
          });
        }
        
        // Apply sorting
        filtered.sort(function(a, b) {
          var aVal = a[coaState.sortColumn] || '';
          var bVal = b[coaState.sortColumn] || '';
          
          if (coaState.sortColumn === 'code') {
            // Sort codes numerically if possible, otherwise alphabetically
            var aNum = parseInt(aVal);
            var bNum = parseInt(bVal);
            if (!isNaN(aNum) && !isNaN(bNum)) {
              return coaState.sortOrder === 'asc' ? aNum - bNum : bNum - aNum;
            }
          }
          
          if (aVal < bVal) return coaState.sortOrder === 'asc' ? -1 : 1;
          if (aVal > bVal) return coaState.sortOrder === 'asc' ? 1 : -1;
          return 0;
        });
        
        coaState.filteredAccounts = filtered;
        renderCOATable();
      }

      function renderCOATable() {
        const tbody = document.getElementById('coa-table-body');
        if (!tbody) return;
        
        if (coaState.filteredAccounts.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty-cell">No accounts found</td></tr>';
          return;
        }
        
        tbody.innerHTML = coaState.filteredAccounts.map(function(account) {
          return `
            <tr>
              <td>${account.code || ''}</td>
              <td>${account.name || ''}</td>
              <td>${account.type || ''}</td>
              <td>${account.category || ''}</td>
              <td>
                <span class="badge ${account.is_active ? 'badge-success' : 'badge-danger'}">
                  ${account.is_active ? 'Active' : 'Inactive'}
                </span>
              </td>
              <td class="actions-cell">
                <button class="btn btn-sm btn-secondary" onclick="editCOAAccount(${account.account_id || account.id})">Edit</button>
                <button class="btn btn-sm ${account.is_active ? 'btn-warning' : 'btn-success'}" onclick="toggleCOAActive(${account.account_id || account.id}, ${!account.is_active})">
                  ${account.is_active ? 'Deactivate' : 'Activate'}
                </button>
              </td>
            </tr>
          `;
        }).join('');
      }

      function editCOAAccount(accountId) {
        const account = coaState.accounts.find(function(a) {
          return (a.account_id || a.id) === accountId;
        });
        
        if (!account) {
          showStyledAlert('Account not found', 'error', 'Error');
          return;
        }
        
        document.getElementById('coa-edit-id').value = accountId;
        document.getElementById('coa-edit-code').value = account.code || '';
        document.getElementById('coa-edit-name').value = account.name || '';
        document.getElementById('coa-edit-type').value = account.type || '';
        document.getElementById('coa-edit-category').value = account.category || '';
        
        const modal = document.getElementById('coa-edit-modal');
        modal.style.display = 'flex';
      }

      function toggleCOAActive(accountId, newActiveState) {
        const account = coaState.accounts.find(function(a) {
          return (a.account_id || a.id) === accountId;
        });
        
        if (!account) {
          showStyledAlert('Account not found', 'error', 'Error');
          return;
        }
        
        const action = newActiveState ? 'activate' : 'deactivate';
        const confirmed = confirm(`Are you sure you want to ${action} account "${account.name}"?`);
        
        if (!confirmed) return;
        
        COAService.toggleActive(accountId, newActiveState)
          .then(function() {
            showStyledAlert(`Account ${action}d successfully`, 'success', 'Success');
            loadCOAAccounts();
          })
          .catch(function(error) {
            showStyledAlert(error.message, 'error', 'Error');
          });
      }

      // Initialize Chart of Accounts when tab is shown
      var coaTab = document.getElementById('tab-chart-of-accounts');
      if (coaTab) {
        var observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (!coaTab.hidden && coaState.accounts.length === 0) {
              loadCOAAccounts();
            }
          });
        });
        observer.observe(coaTab, { attributes: true, attributeFilter: ['hidden'] });
      }

      // Event listeners
      var coaAddBtn = document.getElementById('coa-add-btn');
      if (coaAddBtn) {
        coaAddBtn.addEventListener('click', function() {
          document.getElementById('coa-add-modal').style.display = 'flex';
        });
      }

      var coaRefreshBtn = document.getElementById('coa-refresh-btn');
      if (coaRefreshBtn) {
        coaRefreshBtn.addEventListener('click', loadCOAAccounts);
      }

      var coaTypeFilter = document.getElementById('coa-type-filter');
      if (coaTypeFilter) {
        coaTypeFilter.addEventListener('change', function(e) {
          coaState.typeFilter = e.target.value;
          applyCOAFilters();
        });
      }

      var coaSortCode = document.getElementById('coa-sort-code');
      if (coaSortCode) {
        coaSortCode.addEventListener('click', function() {
          if (coaState.sortColumn === 'code') {
            coaState.sortOrder = coaState.sortOrder === 'asc' ? 'desc' : 'asc';
          } else {
            coaState.sortColumn = 'code';
            coaState.sortOrder = 'asc';
          }
          applyCOAFilters();
          // Update sort indicator
          var indicator = document.getElementById('coa-sort-code-indicator');
          if (indicator) {
            indicator.textContent = coaState.sortOrder === 'asc' ? '▼' : '▲';
          }
        });
      }

      // Add Account Form
      var coaAddForm = document.getElementById('coa-add-form');
      if (coaAddForm) {
        coaAddForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const formData = new FormData(e.target);
          
          const accountData = {
            code: formData.get('code'),
            name: formData.get('name'),
            type: formData.get('type'),
            category: formData.get('category'),
            is_active: true
          };
          
          COAService.createAccount(accountData)
            .then(function() {
              showStyledAlert('Account created successfully', 'success', 'Success');
              document.getElementById('coa-add-modal').style.display = 'none';
              coaAddForm.reset();
              loadCOAAccounts();
            })
            .catch(function(error) {
              showStyledAlert(error.message, 'error', 'Error Creating Account');
            });
        });
      }

      // Edit Account Form
      var coaEditForm = document.getElementById('coa-edit-form');
      if (coaEditForm) {
        coaEditForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const accountId = parseInt(document.getElementById('coa-edit-id').value);
          const formData = new FormData(e.target);
          
          const account = coaState.accounts.find(function(a) {
            return (a.account_id || a.id) === accountId;
          });
          
          // Check if code/name/type/category is already used by another account
          const code = formData.get('code');
          const name = formData.get('name');
          const type = formData.get('type');
          const category = formData.get('category');
          
          const codeUsed = coaState.accounts.some(function(a) {
            return (a.account_id || a.id) !== accountId && a.code === code;
          });
          const nameUsed = coaState.accounts.some(function(a) {
            return (a.account_id || a.id) !== accountId && a.name === name;
          });
          
          if (codeUsed) {
            showStyledAlert('Account code is already in use by another account', 'warning', 'Warning');
            return;
          }
          
          if (nameUsed) {
            showStyledAlert('Account name is already in use by another account', 'warning', 'Warning');
            return;
          }
          
          const updates = {
            code: code,
            name: name,
            type: type,
            category: category
          };
          
          COAService.updateAccount(accountId, updates)
            .then(function() {
              showStyledAlert('Account updated successfully', 'success', 'Success');
              document.getElementById('coa-edit-modal').style.display = 'none';
              loadCOAAccounts();
            })
            .catch(function(error) {
              showStyledAlert(error.message, 'error', 'Error Updating Account');
            });
        });
      }

      // Modal close handlers
      var coaAddModal = document.getElementById('coa-add-modal');
      var coaEditModal = document.getElementById('coa-edit-modal');
      
      if (coaAddModal) {
        document.getElementById('coa-add-close')?.addEventListener('click', function() {
          coaAddModal.style.display = 'none';
        });
        document.getElementById('coa-add-cancel')?.addEventListener('click', function() {
          coaAddModal.style.display = 'none';
        });
        coaAddModal.addEventListener('click', function(e) {
          if (e.target === coaAddModal) {
            coaAddModal.style.display = 'none';
          }
        });
      }
      
      if (coaEditModal) {
        document.getElementById('coa-edit-close')?.addEventListener('click', function() {
          coaEditModal.style.display = 'none';
        });
        document.getElementById('coa-edit-cancel')?.addEventListener('click', function() {
          coaEditModal.style.display = 'none';
        });
        coaEditModal.addEventListener('click', function(e) {
          if (e.target === coaEditModal) {
            coaEditModal.style.display = 'none';
          }
        });
      }

      // Make functions globally available
      window.editCOAAccount = editCOAAccount;
      window.toggleCOAActive = toggleCOAActive;

      // Bank Accounts functionality
      var bankAccountsState = {
        accounts: []
      };

      var BankAccountsService = {
        async listAccounts(pharmacyId) {
          const response = await fetch(`/api/bank-accounts/pharmacies/${pharmacyId}`, {
            credentials: 'include'
          });
          if (!response.ok) {
            // Check if it's an authentication error that might cause redirect
            if (response.status === 401 || response.status === 403) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(errorData.detail || 'Authentication failed. Please log in again.');
            }
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || `Request failed: ${response.status}`);
          }
          return await response.json();
        },

        async createAccount(accountData) {
          const response = await fetch('/api/bank-accounts', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(accountData)
          });
          if (!response.ok) {
            // Check if it's an authentication error that might cause redirect
            if (response.status === 401 || response.status === 403) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(errorData.detail || 'Authentication failed. Please log in again.');
            }
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || `Request failed: ${response.status}`);
          }
          return await response.json();
        },

        async updateAccount(accountId, updates) {
          const response = await fetch(`/api/bank-accounts/${accountId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(updates)
          });
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || `Request failed: ${response.status}`);
          }
          return await response.json();
        }
      };

      function maskAccountNumber(accountNumber) {
        if (!accountNumber) return '';
        const str = String(accountNumber);
        if (str.length <= 4) return '•••• ' + str;
        return '•••• ' + str.slice(-4);
      }

      function loadBankAccounts(pharmacyId) {
        const tbody = document.getElementById('bank-accounts-table-body');
        if (!tbody) return;
        
        if (!pharmacyId) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty-cell">Please select a pharmacy from the top selector to view bank accounts</td></tr>';
          return;
        }
        
        tbody.innerHTML = '<tr><td colspan="6" class="loading-cell">Loading bank accounts...</td></tr>';
        
        BankAccountsService.listAccounts(pharmacyId)
          .then(function(accounts) {
            bankAccountsState.accounts = accounts;
            renderBankAccountsTable();
          })
          .catch(function(error) {
            console.error('Error loading bank accounts:', error);
            tbody.innerHTML = `<tr><td colspan="6" class="error-cell">Error: ${error.message}</td></tr>`;
            showStyledAlert(error.message, 'error', 'Error Loading Bank Accounts');
          });
      }

      function renderBankAccountsTable() {
        const tbody = document.getElementById('bank-accounts-table-body');
        if (!tbody) return;
        
        if (bankAccountsState.accounts.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty-cell">No bank accounts found</td></tr>';
          return;
        }
        
        tbody.innerHTML = bankAccountsState.accounts.map(function(account) {
          const accountId = account.id || account.bank_account_id;
          return `
            <tr>
              <td>${account.name || ''}</td>
              <td>${account.bank_name || ''}</td>
              <td>${maskAccountNumber(account.account_number)}</td>
              <td>${account.branch_code || '-'}</td>
              <td>
                <span class="badge ${account.is_active ? 'badge-success' : 'badge-danger'}">
                  ${account.is_active ? 'Active' : 'Inactive'}
                </span>
              </td>
              <td class="actions-cell">
                <button class="btn btn-sm btn-secondary" onclick="editBankAccount(${accountId})">Edit</button>
              </td>
            </tr>
          `;
        }).join('');
      }

      function editBankAccount(accountId) {
        const account = bankAccountsState.accounts.find(function(a) {
          return (a.id || a.bank_account_id) === accountId;
        });
        
        if (!account) {
          showStyledAlert('Bank account not found', 'error', 'Error');
          return;
        }
        
        document.getElementById('bank-account-edit-id').value = accountId;
        document.getElementById('bank-account-edit-name').value = account.name || '';
        document.getElementById('bank-account-edit-bank-name').value = account.bank_name || '';
        document.getElementById('bank-account-edit-account-number').value = account.account_number || '';
        document.getElementById('bank-account-edit-branch-code').value = account.branch_code || '';
        document.getElementById('bank-account-edit-currency').value = account.currency || 'ZAR';
        document.getElementById('bank-account-edit-is-active').checked = account.is_active !== false;
        
        const modal = document.getElementById('bank-account-edit-modal');
        modal.style.display = 'flex';
      }

      function toggleBankAccountActive(accountId, newActiveState) {
        const account = bankAccountsState.accounts.find(function(a) {
          return (a.id || a.bank_account_id) === accountId;
        });
        
        if (!account) {
          showStyledAlert('Bank account not found', 'error', 'Error');
          return;
        }
        
        const action = newActiveState ? 'activate' : 'deactivate';
        const message = newActiveState 
          ? `Are you sure you want to activate bank account "${account.name}"?`
          : `Are you sure you want to deactivate bank account "${account.name}"? This will prevent new imports from using this account, but existing data remains.`;
        
        const confirmed = confirm(message);
        
        if (!confirmed) return;
        
        BankAccountsService.updateAccount(accountId, { is_active: newActiveState })
          .then(function() {
            showStyledAlert(`Bank account ${action}d successfully`, 'success', 'Success');
            loadBankAccounts(selectedPharmacyId);
          })
          .catch(function(error) {
            showStyledAlert(error.message, 'error', 'Error');
          });
      }

      // Initialize Bank Accounts when tab is shown
      var bankAccountsTab = document.getElementById('tab-bank-accounts');
      if (bankAccountsTab) {
        // Update Add button state based on selected pharmacy
        function updateBankAccountsUI() {
          const addBtn = document.getElementById('bank-accounts-add-btn');
          if (addBtn) {
            addBtn.disabled = !selectedPharmacyId;
          }
          
          // Load bank accounts if pharmacy is selected and tab is visible
          if (selectedPharmacyId && !bankAccountsTab.hidden) {
            loadBankAccounts(selectedPharmacyId);
          } else if (!selectedPharmacyId) {
            const tbody = document.getElementById('bank-accounts-table-body');
            if (tbody) {
              tbody.innerHTML = '<tr><td colspan="6" class="empty-cell">Please select a pharmacy from the top selector to view bank accounts</td></tr>';
            }
          }
        }

        // Listen for pharmacy selection changes
        var pharmacyOptions = document.querySelectorAll('.pharmacy-option');
        pharmacyOptions.forEach(function(option) {
          option.addEventListener('click', function() {
            // Small delay to ensure selectedPharmacyId is updated
            setTimeout(updateBankAccountsUI, 100);
          });
        });

        // Watch for tab visibility changes
        var observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (!bankAccountsTab.hidden) {
              updateBankAccountsUI();
            }
          });
        });
        observer.observe(bankAccountsTab, { attributes: true, attributeFilter: ['hidden'] });
        
        // Initial update
        updateBankAccountsUI();
      }

      // Event listeners
      var bankAccountsAddBtn = document.getElementById('bank-accounts-add-btn');
      if (bankAccountsAddBtn) {
        bankAccountsAddBtn.addEventListener('click', function() {
          if (!selectedPharmacyId) {
            showStyledAlert('Please select a pharmacy from the top selector first', 'warning', 'Warning');
            return;
          }
          document.getElementById('bank-account-add-modal').style.display = 'flex';
        });
      }

      var bankAccountsRefreshBtn = document.getElementById('bank-accounts-refresh-btn');
      if (bankAccountsRefreshBtn) {
        bankAccountsRefreshBtn.addEventListener('click', function() {
          if (selectedPharmacyId) {
            loadBankAccounts(selectedPharmacyId);
          } else {
            showStyledAlert('Please select a pharmacy from the top selector first', 'warning', 'Warning');
          }
        });
      }

      // NOTE: Bank Account form handlers are initialized in a separate script block
      // at the end of the document, after the modal HTML is loaded into the DOM.

      // Make functions globally available
      window.editBankAccount = editBankAccount;
      window.toggleBankAccountActive = toggleBankAccountActive;
      window.loadBankAccounts = loadBankAccounts;
      window.BankAccountsService = BankAccountsService;
      window.bankAccountsState = bankAccountsState;

      // Bank Imports functionality
      var bankImportsState = {
        bankAccounts: [],
        previewData: null,
        selectedFile: null
      };

      var BankImportsService = {
        async getBankAccounts(pharmacyId) {
          const response = await fetch(`/api/bank-accounts/pharmacies/${pharmacyId}`, {
            credentials: 'include'
          });
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || `Request failed: ${response.status}`);
          }
          return await response.json();
        },

        async previewImport(pharmacyId, bankAccountId, file) {
          const formData = new FormData();
          formData.append('pharmacy_id', pharmacyId);
          formData.append('bank_account_id', bankAccountId);
          formData.append('file', file);

          const response = await fetch('/api/bank-imports/preview', {
            method: 'POST',
            credentials: 'include',
            body: formData
          });
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || `Request failed: ${response.status}`);
          }
          return await response.json();
        },

        async confirmImport(pharmacyId, bankAccountId, fileName, file) {
          const formData = new FormData();
          formData.append('pharmacy_id', pharmacyId);
          formData.append('bank_account_id', bankAccountId);
          formData.append('file_name', fileName);
          formData.append('file', file);
          formData.append('skip_duplicates', 'true');

          const response = await fetch('/api/bank-imports/confirm', {
            method: 'POST',
            credentials: 'include',
            body: formData
          });
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || `Request failed: ${response.status}`);
          }
          return await response.json();
        },

        async getImportHistory(pharmacyId, limit = 50, offset = 0) {
          const params = new URLSearchParams({ limit: limit.toString(), offset: offset.toString() });
          const response = await fetch(`/api/bank-imports/pharmacies/${pharmacyId}?${params}`, {
            credentials: 'include'
          });
          if (!response.ok) {
            if (response.status === 404) {
              throw new Error('Pharmacy not found');
            }
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || `Request failed: ${response.status}`);
          }
          return await response.json();
        }
      };

      function loadBankAccountsForImport(pharmacyId) {
        const accountList = document.getElementById('bank-account-picker-list');
        const accountBtn = document.getElementById('bank-imports-account-btn');
        const accountDisplay = document.getElementById('bank-imports-account-display');
        const accountIdInput = document.getElementById('bank-imports-account-id');
        
        if (!accountList || !accountBtn) return;

        if (!pharmacyId) {
          accountList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--textMuted);">Please select a pharmacy from the top selector first</div>';
          accountBtn.disabled = true;
          accountDisplay.textContent = 'Select Bank Account';
          accountIdInput.value = '';
          updateImportButtons();
          return;
        }

        accountBtn.disabled = true;
        BankImportsService.getBankAccounts(pharmacyId)
          .then(function(accounts) {
            bankImportsState.bankAccounts = accounts.filter(function(acc) {
              return acc.is_active !== false;
            });
            
            if (bankImportsState.bankAccounts.length === 0) {
              accountList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--textMuted);">No active bank accounts found. Please create one first.</div>';
              accountBtn.disabled = true;
              accountDisplay.textContent = 'No Accounts Available';
              accountIdInput.value = '';
            } else {
              accountList.innerHTML = bankImportsState.bankAccounts.map(function(acc) {
                const accId = acc.bank_account_id || acc.id;
                const accName = acc.name || 'Unnamed Account';
                const bankName = acc.bank_name || '';
                const displayName = bankName ? accName + ' (' + bankName + ')' : accName;
                return `
                  <button class="bank-account-option" data-account-id="${accId}" data-account-name="${displayName}">
                    <span class="bank-account-icon">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                        <line x1="1" y1="10" x2="23" y2="10"></line>
                      </svg>
                    </span>
                    <span>${displayName}</span>
                  </button>
                `;
              }).join('');
              
              // Attach click handlers to bank account options
              accountList.querySelectorAll('.bank-account-option').forEach(function(option) {
                option.addEventListener('click', function() {
                  const accountId = this.getAttribute('data-account-id');
                  const accountName = this.getAttribute('data-account-name');
                  
                  // Update selected state
                  accountList.querySelectorAll('.bank-account-option').forEach(function(opt) {
                    opt.classList.remove('selected');
                  });
                  this.classList.add('selected');
                  
                  // Update display
                  accountIdInput.value = accountId;
                  accountDisplay.textContent = accountName;
                  
                  // Close modal
                  closeBankAccountPicker();
                  
                  // Update buttons
                  updateImportButtons();
                });
              });
              
              accountBtn.disabled = false;
            }
            
            updateImportButtons();
          })
          .catch(function(error) {
            console.error('Error loading bank accounts:', error);
            accountList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--statusError);">Error loading accounts</div>';
            accountBtn.disabled = true;
            showStyledAlert(error.message, 'error', 'Error Loading Bank Accounts');
          });
      }
      
      function openBankAccountPicker() {
        const overlay = document.getElementById('bank-account-picker-modal-overlay');
        if (overlay) {
          overlay.classList.add('active');
          document.body.style.overflow = 'hidden';
        }
      }
      
      function closeBankAccountPicker() {
        const overlay = document.getElementById('bank-account-picker-modal-overlay');
        if (overlay) {
          overlay.classList.remove('active');
          document.body.style.overflow = '';
        }
      }

      function updateImportButtons() {
        const accountIdInput = document.getElementById('bank-imports-account-id');
        const fileInput = document.getElementById('bank-imports-file-input');
        const previewBtn = document.getElementById('bank-imports-preview-btn');
        
        if (previewBtn && accountIdInput && fileInput) {
          const hasAccount = accountIdInput.value && accountIdInput.value !== '';
          const hasFile = fileInput.files && fileInput.files.length > 0;
          previewBtn.disabled = !hasAccount || !hasFile;
        }
      }

      function formatCurrency(amount) {
        if (amount === null || amount === undefined) return '-';
        return 'R ' + Number(amount).toLocaleString('en-ZA', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      }

      function formatDate(dateStr) {
        if (!dateStr) return '-';
        try {
          const date = new Date(dateStr);
          return date.toLocaleDateString('en-ZA');
        } catch (e) {
          return dateStr;
        }
      }

      // Helper: Format amount with color (for unmatched transactions)
      function formatAmountWithColor(amountIn, amountOut) {
        const amount = amountIn > 0 ? amountIn : -amountOut;
        const color = amount >= 0 ? 'var(--statusSuccess)' : 'var(--statusError)';
        const sign = amount >= 0 ? '+' : '';
        return `<span style="color: ${color}; font-weight: 600;">${sign}${formatCurrency(amount)}</span>`;
      }

      function displayPreview(previewData) {
        // Debug: Log the actual response structure
        console.log('Preview API Response:', previewData);
        
        bankImportsState.previewData = previewData;
        const previewSection = document.getElementById('bank-imports-preview-section');
        if (previewSection) {
          previewSection.style.display = 'block';
        }

        // ✅ CORRECT: Use summary values directly - these are pre-calculated by the backend
        // The API returns: { summary: { transaction_count, total_in, total_out, min_date, max_date }, sample_transactions: [...], errors: [...] }
        const summary = previewData.summary || previewData;
        
        // Extract summary values directly (don't recalculate from sample_transactions)
        const transactionCount = summary.transaction_count ?? previewData.transaction_count ?? 0;
        const totalIn = summary.total_in ?? previewData.total_in ?? 0;  // Sum of all positive amounts
        const totalOut = summary.total_out ?? previewData.total_out ?? 0;  // Already positive (absolute value of negative amounts)
        const periodStart = summary.min_date ?? summary.period_start ?? previewData.min_date ?? previewData.period_start;
        const periodEnd = summary.max_date ?? summary.period_end ?? previewData.max_date ?? previewData.period_end;
        
        // Sample transactions are ONLY for display - NOT for calculations
        // sample_transactions only contains first 20 rows, so don't use it to calculate totals
        const sampleRows = previewData.sample_transactions || previewData.sample_rows || previewData.transactions || previewData.rows || [];
        const errors = previewData.errors || [];

        // Update summary card using summary values directly
        document.getElementById('preview-transaction-count').textContent = transactionCount;
        document.getElementById('preview-total-in').textContent = formatCurrency(totalIn);
        // ✅ total_out is already positive (absolute value), don't use Math.abs()
        document.getElementById('preview-total-out').textContent = formatCurrency(totalOut);
        
        const periodStartFormatted = formatDate(periodStart);
        const periodEndFormatted = formatDate(periodEnd);
        document.getElementById('preview-period').textContent = periodStartFormatted && periodEndFormatted 
          ? `${periodStartFormatted} → ${periodEndFormatted}` 
          : '-';

        // Update sample table
        const tbody = document.getElementById('bank-imports-preview-table-body');
        if (tbody) {
          if (sampleRows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="empty-cell">No transactions found</td></tr>';
          } else {
            tbody.innerHTML = sampleRows.map(function(row, index) {
              return `
                <tr style="font-size: 11px;">
                  <td style="font-size: 11px;">${row.row_number || row.row || index + 1}</td>
                  <td style="font-size: 11px;">${formatDate(row.date || row.transaction_date)}</td>
                  <td style="font-size: 11px;">${row.description || row.memo || '-'}</td>
                  <td style="font-size: 11px;">${row.reference || row.ref || '-'}</td>
                  <td style="font-size: 11px;">${formatCurrency(row.amount)}</td>
                </tr>
              `;
            }).join('');
          }
        }

        // Update errors section
        const errorsSection = document.getElementById('bank-imports-errors-section');
        const errorsWarning = document.getElementById('bank-imports-errors-warning');
        const errorsMessage = document.getElementById('bank-imports-errors-message');
        const errorsTableBody = document.getElementById('bank-imports-errors-table-body');

        if (errors.length > 0) {
          if (errorsWarning) {
            errorsWarning.style.display = 'block';
            errorsMessage.textContent = `${errors.length} row${errors.length !== 1 ? 's' : ''} could not be parsed and will be excluded from import.`;
          }
          if (errorsSection) {
            errorsSection.style.display = 'block';
          }
          if (errorsTableBody) {
            errorsTableBody.innerHTML = errors.map(function(error) {
              return `
                <tr>
                  <td>${error.row_number || error.row || '-'}</td>
                  <td style="color: var(--statusError);">${error.error || error.message || error.detail || '-'}</td>
                </tr>
              `;
            }).join('');
          }
        } else {
          if (errorsWarning) errorsWarning.style.display = 'none';
          if (errorsSection) errorsSection.style.display = 'none';
        }

        // Show cancel button
        const cancelBtn = document.getElementById('bank-imports-cancel-btn');
        if (cancelBtn) cancelBtn.style.display = 'inline-block';
      }

      function clearPreview(clearFileInput) {
        bankImportsState.previewData = null;
        const previewSection = document.getElementById('bank-imports-preview-section');
        if (previewSection) {
          previewSection.style.display = 'none';
        }
        // Only clear file input if explicitly requested (e.g., when clicking Cancel)
        if (clearFileInput) {
          const fileInput = document.getElementById('bank-imports-file-input');
          const fileNameDisplay = document.getElementById('bank-imports-file-name');
          if (fileInput) {
            fileInput.value = '';
            bankImportsState.selectedFile = null;
          }
          if (fileNameDisplay) {
            fileNameDisplay.textContent = '';
          }
        }
        const cancelBtn = document.getElementById('bank-imports-cancel-btn');
        if (cancelBtn) cancelBtn.style.display = 'none';
        // Note: We don't clear the account selection here - user might want to try another file
        updateImportButtons();
      }

      function loadImportHistory(pharmacyId) {
        const tbody = document.getElementById('bank-imports-history-table-body');
        if (!tbody) return;

        if (!pharmacyId) {
          tbody.innerHTML = '<tr><td colspan="5" class="empty-cell">Please select a pharmacy from the top selector to view import history</td></tr>';
          return;
        }

        tbody.innerHTML = '<tr><td colspan="5" class="loading-cell">Loading import history...</td></tr>';

        BankImportsService.getImportHistory(pharmacyId)
          .then(function(batches) {
            if (!batches || batches.length === 0) {
              tbody.innerHTML = '<tr><td colspan="5" class="empty-cell">No import history found</td></tr>';
              return;
            }

            // Helper function to format status label
            function getStatusLabel(status) {
              const statusMap = {
                'IMPORTED': 'Imported',
                'CLASSIFIED_PARTIAL': 'Partially Classified',
                'CLASSIFIED_COMPLETE': 'Fully Classified',
                'POSTED_TO_LEDGER': 'Posted to Ledger'
              };
              return statusMap[status] || status;
            }

            // Helper function to format bank account display
            function formatBankAccount(batch) {
              if (batch.bank_account_name && batch.bank_name) {
                return `${batch.bank_account_name} (${batch.bank_name})`;
              } else if (batch.bank_account_name) {
                return batch.bank_account_name;
              }
              return 'Unknown Account';
            }

            // Helper function to format period
            function formatPeriod(batch) {
              if (batch.period_start && batch.period_end) {
                const start = formatDate(batch.period_start);
                const end = formatDate(batch.period_end);
                return start && end ? `${start} → ${end}` : 'N/A';
              }
              return 'N/A';
            }

            tbody.innerHTML = batches.map(function(batch) {
              const period = formatPeriod(batch);
              const bankAccount = formatBankAccount(batch);
              const status = batch.status || 'UNKNOWN';
              const statusLabel = getStatusLabel(status);
              const statusClass = status === 'POSTED_TO_LEDGER' ? 'badge-success' : 
                                 status === 'CLASSIFIED_COMPLETE' ? 'badge-success' :
                                 status === 'CLASSIFIED_PARTIAL' ? 'badge-warning' :
                                 status === 'IMPORTED' ? 'badge-info' : 'badge-secondary';

              return `
                <tr>
                  <td>${period}</td>
                  <td>${bankAccount}</td>
                  <td>${batch.transaction_count || 0}</td>
                  <td><span class="badge ${statusClass}">${statusLabel}</span></td>
                  <td class="actions-cell">
                    <button class="btn btn-sm btn-secondary" onclick="viewImportDetails(${batch.id})">View Details</button>
                  </td>
                </tr>
              `;
            }).join('');
          })
          .catch(function(error) {
            console.error('Error loading import history:', error);
            tbody.innerHTML = `<tr><td colspan="5" class="error-cell">Error: ${error.message}</td></tr>`;
          });
      }

      function viewImportDetails(importId) {
        // Placeholder for future implementation
        showStyledAlert('View Details functionality will be implemented in future steps', 'info', 'Coming Soon');
      }

      // Initialize Bank Imports when tab is shown
      var bankImportsTab = document.getElementById('tab-bank-imports');
      if (bankImportsTab) {
        function updateBankImportsUI() {
          // Clear account selection when pharmacy changes
          const accountIdInput = document.getElementById('bank-imports-account-id');
          const accountDisplay = document.getElementById('bank-imports-account-display');
          if (accountIdInput) accountIdInput.value = '';
          if (accountDisplay) accountDisplay.textContent = 'Select Bank Account';
          
          loadBankAccountsForImport(selectedPharmacyId);
          if (selectedPharmacyId) {
            loadImportHistory(selectedPharmacyId);
          } else {
            const tbody = document.getElementById('bank-imports-history-table-body');
            if (tbody) {
              tbody.innerHTML = '<tr><td colspan="5" class="empty-cell">Please select a pharmacy from the top selector to view import history</td></tr>';
            }
          }
          updateImportButtons();
        }

        // Listen for pharmacy selection changes
        var pharmacyOptions = document.querySelectorAll('.pharmacy-option');
        pharmacyOptions.forEach(function(option) {
          option.addEventListener('click', function() {
            setTimeout(updateBankImportsUI, 100);
          });
        });

        // Watch for tab visibility changes
        var observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (!bankImportsTab.hidden) {
              updateBankImportsUI();
            }
          });
        });
        observer.observe(bankImportsTab, { attributes: true, attributeFilter: ['hidden'] });

        // Initial update
        updateBankImportsUI();
      }

      // Event listeners
      var accountBtn = document.getElementById('bank-imports-account-btn');
      if (accountBtn) {
        accountBtn.addEventListener('click', function() {
          if (!accountBtn.disabled) {
            openBankAccountPicker();
          }
        });
      }
      
      var bankAccountPickerClose = document.getElementById('bank-account-picker-close');
      if (bankAccountPickerClose) {
        bankAccountPickerClose.addEventListener('click', closeBankAccountPicker);
      }
      
      var bankAccountPickerOverlay = document.getElementById('bank-account-picker-modal-overlay');
      if (bankAccountPickerOverlay) {
        bankAccountPickerOverlay.addEventListener('click', function(e) {
          if (e.target === bankAccountPickerOverlay) {
            closeBankAccountPicker();
          }
        });
        
        // Close on ESC key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && bankAccountPickerOverlay.classList.contains('active')) {
            closeBankAccountPicker();
          }
        });
      }

      var fileInput = document.getElementById('bank-imports-file-input');
      var fileNameDisplay = document.getElementById('bank-imports-file-name');
      if (fileInput) {
        fileInput.addEventListener('change', function(e) {
          const selectedFile = e.target.files[0];
          if (selectedFile) {
            bankImportsState.selectedFile = selectedFile;
            console.log('File selected:', selectedFile.name, selectedFile.size, 'bytes');
            
            // Show file name
            if (fileNameDisplay) {
              const fileSizeKB = (selectedFile.size / 1024).toFixed(2);
              fileNameDisplay.textContent = `Selected: ${selectedFile.name} (${fileSizeKB} KB)`;
              fileNameDisplay.style.color = 'var(--statusSuccess)';
            }
            
            // Clear preview section but keep the file input value
            clearPreview(false);
            updateImportButtons();
          } else {
            bankImportsState.selectedFile = null;
            if (fileNameDisplay) {
              fileNameDisplay.textContent = '';
            }
            clearPreview(false);
            updateImportButtons();
          }
        });
      }

      var previewBtn = document.getElementById('bank-imports-preview-btn');
      if (previewBtn) {
        previewBtn.addEventListener('click', function() {
          if (!selectedPharmacyId) {
            showStyledAlert('Please select a pharmacy first', 'warning', 'Warning');
            return;
          }
          
          const accountIdInput = document.getElementById('bank-imports-account-id');
          const accountId = accountIdInput?.value;
          // Try to get file from input first, then from state
          const file = fileInput?.files?.[0] || bankImportsState.selectedFile;

          if (!accountId) {
            showStyledAlert('Please select a bank account', 'warning', 'Warning');
            return;
          }
          
          if (!file) {
            showStyledAlert('Please select a CSV file to upload', 'warning', 'Warning');
            return;
          }

          console.log('Previewing import with pharmacy:', selectedPharmacyId, 'account:', accountId, 'file:', file.name);

          previewBtn.disabled = true;
          previewBtn.textContent = 'Processing...';

          BankImportsService.previewImport(selectedPharmacyId, accountId, file)
            .then(function(previewData) {
              displayPreview(previewData);
              previewBtn.disabled = false;
              previewBtn.textContent = 'Preview Import';
            })
            .catch(function(error) {
              console.error('Preview error:', error);
              showStyledAlert(error.message || 'Failed to preview import', 'error', 'Error Previewing Import');
              previewBtn.disabled = false;
              previewBtn.textContent = 'Preview Import';
            });
        });
      }

      var confirmBtn = document.getElementById('bank-imports-confirm-btn');
      if (confirmBtn) {
        confirmBtn.addEventListener('click', function() {
          if (!selectedPharmacyId) {
            showStyledAlert('Please select a pharmacy first', 'error', 'Error');
            return;
          }
          
          const accountIdInput = document.getElementById('bank-imports-account-id');
          const accountId = accountIdInput?.value;
          const file = bankImportsState.selectedFile;

          if (!accountId || !file) {
            showStyledAlert('Missing bank account or file', 'error', 'Error');
            return;
          }

          const confirmed = confirm('Are you sure you want to import these transactions?');
          if (!confirmed) return;

          confirmBtn.disabled = true;
          confirmBtn.textContent = 'Importing...';

          BankImportsService.confirmImport(selectedPharmacyId, accountId, file.name, file)
            .then(function(result) {
              const inserted = result.inserted_count || result.transactions_inserted || result.transaction_count || 0;
              const duplicates = result.duplicate_count || result.duplicates_skipped || 0;
              const message = `Import complete – ${inserted} transaction${inserted !== 1 ? 's' : ''} inserted${duplicates > 0 ? `, ${duplicates} duplicate${duplicates !== 1 ? 's' : ''} skipped` : ''}.`;
              
              showStyledAlert(message, 'success', 'Import Complete');
              clearPreview();
              if (selectedPharmacyId) {
                loadImportHistory(selectedPharmacyId);
              }
              confirmBtn.disabled = false;
              confirmBtn.textContent = 'Confirm Import';
            })
            .catch(function(error) {
              showStyledAlert(error.message, 'error', 'Error Importing');
              confirmBtn.disabled = false;
              confirmBtn.textContent = 'Confirm Import';
            });
        });
      }

      var cancelBtn = document.getElementById('bank-imports-cancel-btn');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
          clearPreview(true); // Clear file input when canceling
        });
      }

      var previewCancelBtn = document.getElementById('bank-imports-preview-cancel-btn');
      if (previewCancelBtn) {
        previewCancelBtn.addEventListener('click', function() {
          clearPreview(true); // Clear file input when canceling
        });
      }

      var refreshHistoryBtn = document.getElementById('bank-imports-refresh-history-btn');
      if (refreshHistoryBtn) {
        refreshHistoryBtn.addEventListener('click', function() {
          if (selectedPharmacyId) {
            loadImportHistory(selectedPharmacyId);
          } else {
            showStyledAlert('Please select a pharmacy from the top selector first', 'warning', 'Warning');
          }
        });
      }

      // Make functions globally available
      window.viewImportDetails = viewImportDetails;
    })();
  </script>

  <!-- Bank Rules & Unmatched Transactions Functionality -->
  <script>
    (function() {
      'use strict';

      // Bank Rules State
      var bankRulesState = {
        rules: [],
        accounts: [],
        editingRule: null
      };

      // Unmatched Transactions State
      var unmatchedState = {
        transactions: [],
        statements: [],
        selectedStatementId: null,
        accounts: []
      };

      // Bank Rules Service
      var BankRulesService = {
        async getRules(pharmacyId) {
          const response = await fetch(`/api/bank-rules/pharmacies/${pharmacyId}/bank-rules`, {
            credentials: 'include'
          });
          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            const errorMsg = error.detail || `Failed to fetch rules: ${response.statusText}`;
            // If it's a 500 error, return empty array instead of throwing (endpoint may not be deployed yet)
            if (response.status === 500) {
              console.info('Bank Rules API endpoint returned 500 - remote API may not have this endpoint deployed yet. Showing empty rules list.');
              return [];
            }
            console.error('Bank Rules API Error:', errorMsg);
            throw new Error(errorMsg);
          }
          return await response.json();
        },

        async createRule(pharmacyId, ruleData) {
          const requestBody = JSON.stringify(ruleData);
          const requestUrl = `/api/bank-rules/pharmacies/${pharmacyId}/bank-rules`;
          
          // Log exact request for backend team
          console.log('%c🔵 EXACT REQUEST BEING SENT TO BACKEND:', 'color: #4a90e2; font-weight: bold; font-size: 14px;');
          console.log('URL:', requestUrl);
          console.log('Method: POST');
          console.log('Headers:', { 'Content-Type': 'application/json' });
          console.log('Body (JSON):', requestBody);
          
          const response = await fetch(requestUrl, {
            method: 'POST',
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json'
            },
            body: requestBody
          });
          if (!response.ok) {
            let errorMessage = `Failed to create rule: ${response.statusText}`;
            try {
              const error = await response.json();
              console.error('[Bank Rule] Error response:', error);
              
              // Handle different error response formats
              if (typeof error === 'string') {
                errorMessage = error;
              } else if (error.detail) {
                // FastAPI typically uses 'detail' field
                errorMessage = typeof error.detail === 'string' ? error.detail : JSON.stringify(error.detail);
              } else if (error.message) {
                errorMessage = typeof error.message === 'string' ? error.message : JSON.stringify(error.message);
              } else if (error.error) {
                errorMessage = typeof error.error === 'string' ? error.error : JSON.stringify(error.error);
              } else if (Array.isArray(error)) {
                // Validation errors might be arrays
                errorMessage = error.map(e => e.msg || e.message || JSON.stringify(e)).join(', ');
              } else if (typeof error === 'object') {
                // Try to extract meaningful error message
                const errorStr = JSON.stringify(error, null, 2);
                errorMessage = errorStr.length > 500 ? errorStr.substring(0, 500) + '...' : errorStr;
              }
            } catch (e) {
              // If JSON parsing fails, try to get text
              try {
                const text = await response.text();
                errorMessage = text || errorMessage;
              } catch (textError) {
                console.error('[Bank Rule] Could not parse error:', textError);
                errorMessage = `Server returned ${response.status} ${response.statusText}`;
              }
            }
            console.error('[Bank Rule] Throwing error:', errorMessage);
            throw new Error(errorMessage);
          }
          return await response.json();
        },

        async updateRule(ruleId, ruleData) {
          const response = await fetch(`/api/bank-rules/bank-rules/${ruleId}`, {
            method: 'PUT',
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(ruleData)
          });
          if (!response.ok) {
            let errorMessage = `Failed to update rule: ${response.statusText}`;
            try {
              const error = await response.json();
              console.error('[Bank Rule] Error response:', error);
              
              // Handle different error response formats
              if (typeof error === 'string') {
                errorMessage = error;
              } else if (error.detail) {
                // FastAPI typically uses 'detail' field
                errorMessage = typeof error.detail === 'string' ? error.detail : JSON.stringify(error.detail);
              } else if (error.message) {
                errorMessage = typeof error.message === 'string' ? error.message : JSON.stringify(error.message);
              } else if (error.error) {
                errorMessage = typeof error.error === 'string' ? error.error : JSON.stringify(error.error);
              } else if (Array.isArray(error)) {
                // Validation errors might be arrays
                errorMessage = error.map(e => e.msg || e.message || JSON.stringify(e)).join(', ');
              } else if (typeof error === 'object') {
                // Try to extract meaningful error message
                const errorStr = JSON.stringify(error, null, 2);
                errorMessage = errorStr.length > 500 ? errorStr.substring(0, 500) + '...' : errorStr;
              }
            } catch (e) {
              // If JSON parsing fails, try to get text
              try {
                const text = await response.text();
                errorMessage = text || errorMessage;
              } catch (textError) {
                console.error('[Bank Rule] Could not parse error:', textError);
                errorMessage = `Server returned ${response.status} ${response.statusText}`;
              }
            }
            console.error('[Bank Rule] Throwing error:', errorMessage);
            throw new Error(errorMessage);
          }
          return await response.json();
        },

        async toggleActive(ruleId, isActive) {
          return this.updateRule(ruleId, { is_active: isActive });
        }
      };

      // Unmatched Transactions Service
      var UnmatchedService = {
        async getUnmatched(pharmacyId) {
          const response = await fetch(`/api/bank-rules/pharmacies/${pharmacyId}/bank-transactions/unmatched`, {
            credentials: 'include'
          });
          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.detail || `Failed to fetch unmatched: ${response.statusText}`);
          }
          return await response.json();
        },

        async getReconciliationSummary(pharmacyId) {
          const response = await fetch(`/api/bank-rules/pharmacies/${pharmacyId}/reconciliation-summary`, {
            credentials: 'include'
          });
          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.detail || `Failed to fetch reconciliation summary: ${response.statusText}`);
          }
          return await response.json();
        },

        async applyRules(batchId) {
          const response = await fetch(`/api/bank-rules/bank-import-batches/${batchId}/apply-rules`, {
            method: 'POST',
            credentials: 'include'
          });
          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.detail || `Failed to apply rules: ${response.statusText}`);
          }
          return await response.json();
        },


        async manualClassify(lineId, classifyData) {
          const response = await fetch(`/api/bank-statement-lines/${lineId}/manual-classify`, {
            method: 'POST',
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(classifyData)
          });
          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.detail || `Failed to classify: ${response.statusText}`);
          }
          return await response.json();
        },

        async applyRulesToTransaction(transactionId) {
          const response = await fetch(`/api/bank-rules/bank-transactions/${transactionId}/apply-rules`, {
            method: 'POST',
            credentials: 'include'
          });
          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.detail || `Failed to apply rules: ${response.statusText}`);
          }
          return await response.json();
        }
      };

      // Accounts Service (for dropdowns)
      var AccountsService = {
        async getAccounts(options) {
          // Support both old API (with pharmacyId) and new API (with query params)
          let url = '/api/accounts';
          const params = new URLSearchParams();
          
          if (typeof options === 'number') {
            // Legacy: pharmacyId as number
            url = `/api/pharmacies/${options}/accounts`;
          } else if (typeof options === 'object' && options !== null) {
            // New: options object with filters
            if (options.is_active !== undefined) {
              params.append('is_active', options.is_active);
            }
            if (options.type) {
              params.append('type', options.type);
            }
            if (options.category) {
              params.append('category', options.category);
            }
            if (params.toString()) {
              url += '?' + params.toString();
            }
          } else {
            // Default: get active accounts
            url += '?is_active=true';
          }
          
          const response = await fetch(url, {
            credentials: 'include'
          });
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || `Failed to fetch accounts: ${response.statusText}`);
          }
          const data = await response.json();
          // Handle both array response and object with accounts property
          return Array.isArray(data) ? data : (data.accounts || data.items || []);
        }
      };

      // Helper: Format currency (local to this script scope)
      function formatCurrency(amount) {
        if (amount === null || amount === undefined) return '-';
        return 'R ' + Number(amount).toLocaleString('en-ZA', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      }

      // Helper: Format amount with color
      function formatAmountWithColor(amountIn, amountOut) {
        const amount = amountIn > 0 ? amountIn : -amountOut;
        const color = amount >= 0 ? 'var(--statusSuccess)' : 'var(--statusError)';
        const sign = amount >= 0 ? '+' : '';
        return `<span style="color: ${color}; font-weight: 600;">${sign}${formatCurrency(amount)}</span>`;
      }

      // Helper: Format date
      function formatDate(dateStr) {
        if (!dateStr) return '-';
        try {
          const date = new Date(dateStr);
          return date.toLocaleDateString('en-ZA');
        } catch (e) {
          return dateStr;
        }
      }

      // Helper: Format status chip
      function getStatusChip(status) {
        const statusMap = {
          'unclassified': { label: 'Unclassified', class: 'badge-secondary' },
          'rule_classified': { label: 'Rule Classified', class: 'badge-success' },
          'user_override': { label: 'User Override', class: 'badge-warning' }
        };
        const config = statusMap[status] || { label: status, class: 'badge-secondary' };
        return `<span class="badge ${config.class}">${config.label}</span>`;
      }

      // Update button state based on pharmacy selection and transactions
      function updateUnmatchedUI() {
        const applyBtn = document.getElementById('unmatched-apply-rules-btn');
        const classifyAllBtn = document.getElementById('unmatched-manual-classify-all-btn');
        const hasTransactions = unmatchedState.transactions && unmatchedState.transactions.length > 0;
        
        if (applyBtn) applyBtn.disabled = !selectedPharmacyId || !hasTransactions;
        
        // Check if there are any transactions with selected accounts
        let hasSelectedAccounts = false;
        if (hasTransactions && unmatchedState.transactions) {
          hasSelectedAccounts = unmatchedState.transactions.some(function(tx) {
            const hiddenInput = document.getElementById('account-select-' + tx.id);
            return hiddenInput && hiddenInput.value;
          });
        }
        
        if (classifyAllBtn) {
          classifyAllBtn.disabled = !selectedPharmacyId || !hasTransactions || !hasSelectedAccounts;
        }
      }

      // Load Bank Rules
      function loadBankRules(pharmacyId) {
        const tbody = document.getElementById('bank-rules-table-body');
        if (!tbody) return;

        if (!pharmacyId) {
          tbody.innerHTML = '<tr><td colspan="7" class="empty-cell">Please select a pharmacy from the top selector to view bank rules</td></tr>';
          return;
        }

        tbody.innerHTML = '<tr><td colspan="7" class="loading-cell">Loading bank rules...</td></tr>';

        BankRulesService.getRules(pharmacyId)
          .then(function(rules) {
            bankRulesState.rules = rules || [];
            renderBankRulesTable();
            // Show helpful message if empty (likely due to 500 error from remote API)
            if (bankRulesState.rules.length === 0 && tbody.querySelector('.empty-cell')) {
              const emptyRow = tbody.querySelector('.empty-cell').closest('tr');
              if (emptyRow && emptyRow.textContent.includes('No bank rules found')) {
                emptyRow.innerHTML = '<td colspan="7" class="empty-cell">No bank rules found. The bank rules API endpoint may not be deployed yet on the remote server.</td>';
              }
            }
          })
          .catch(function(error) {
            console.error('Error loading bank rules:', error);
            tbody.innerHTML = `<tr><td colspan="7" class="error-cell">Error: ${error.message}</td></tr>`;
            showStyledAlert(error.message, 'error', 'Error Loading Bank Rules');
          });
      }

      // Render Bank Rules Table
      function renderBankRulesTable() {
        const tbody = document.getElementById('bank-rules-table-body');
        if (!tbody) return;

        let filteredRules = bankRulesState.rules;

        // Apply filters
        const searchTerm = document.getElementById('bank-rules-search')?.value.toLowerCase() || '';
        const typeFilter = document.getElementById('bank-rules-type-filter')?.value || '';
        const showInactive = document.getElementById('bank-rules-show-inactive')?.checked || false;

        filteredRules = filteredRules.filter(function(rule) {
          if (!showInactive && !rule.is_active) return false;
          if (typeFilter && rule.type !== typeFilter) return false;
          if (searchTerm && !rule.name.toLowerCase().includes(searchTerm)) return false;
          return true;
        });

        if (filteredRules.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="empty-cell">No bank rules found</td></tr>';
          return;
        }

        // Sort by priority
        filteredRules.sort(function(a, b) {
          return (a.priority || 999) - (b.priority || 999);
        });

        tbody.innerHTML = filteredRules.map(function(rule) {
          const conditionsSummary = rule.conditions && rule.conditions.length > 0
            ? rule.conditions[0].field + ' ' + rule.conditions[0].operator + ' "' + rule.conditions[0].value + '"'
            : 'No conditions';
          
          const allocateSummary = rule.allocate && rule.allocate.length > 0
            ? rule.allocate.map(function(a) {
                return a.percent + '% → ' + (a.account_code || '') + ' ' + (a.account_name || '');
              }).join(', ')
            : 'No allocation';

          const statusBadge = rule.is_active 
            ? '<span class="badge badge-success">Active</span>'
            : '<span class="badge badge-secondary">Inactive</span>';

          return `
            <tr>
              <td>${rule.priority || '-'}</td>
              <td>${rule.name || '-'}</td>
              <td><span class="badge badge-info">${(rule.type || '').charAt(0).toUpperCase() + (rule.type || '').slice(1)}</span></td>
              <td style="font-size: 11px; color: var(--textMuted);">${conditionsSummary}</td>
              <td style="font-size: 11px; color: var(--textMuted);">${allocateSummary}</td>
              <td>${statusBadge}</td>
              <td class="actions-cell">
                <button class="btn btn-sm btn-secondary" onclick="editBankRule(${rule.id})">Edit</button>
                <button class="btn btn-sm ${rule.is_active ? 'btn-warning' : 'btn-success'}" onclick="toggleBankRuleActive(${rule.id}, ${!rule.is_active})">
                  ${rule.is_active ? 'Deactivate' : 'Activate'}
                </button>
              </td>
            </tr>
          `;
        }).join('');
      }

      // Load Reconciliation Summary
      function loadReconciliationSummary(pharmacyId) {
        if (!pharmacyId) {
          document.getElementById('reconciled-count').textContent = '-';
          document.getElementById('unmatched-count').textContent = '-';
          document.getElementById('reconciliation-difference').textContent = '-';
          return;
        }

        UnmatchedService.getReconciliationSummary(pharmacyId)
          .then(function(summary) {
            // Update the widget with the summary data
            const reconciled = summary.reconciled_count || summary.reconciled || 0;
            const unmatched = summary.unmatched_count || summary.unmatched || 0;
            const difference = summary.difference || summary.difference_amount || 0;

            document.getElementById('reconciled-count').textContent = reconciled;
            document.getElementById('unmatched-count').textContent = unmatched;
            
            // Format difference as currency (R)
            const formattedDifference = typeof difference === 'number' 
              ? (difference >= 0 ? 'R' : '-R') + Math.abs(difference).toFixed(2)
              : difference || 'R0.00';
            document.getElementById('reconciliation-difference').textContent = formattedDifference;
          })
          .catch(function(error) {
            console.error('Error loading reconciliation summary:', error);
            // Silently fail - show dashes if endpoint doesn't exist
            document.getElementById('reconciled-count').textContent = '-';
            document.getElementById('unmatched-count').textContent = '-';
            document.getElementById('reconciliation-difference').textContent = '-';
          });
      }

      // Load Unmatched Transactions
      function loadUnmatchedTransactions(pharmacyId) {
        const tbody = document.getElementById('unmatched-transactions-table-body');
        if (!tbody) return;

        if (!pharmacyId) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty-cell">Please select a pharmacy from the top selector to view unmatched transactions</td></tr>';
          return;
        }

        tbody.innerHTML = '<tr><td colspan="6" class="loading-cell">Loading unmatched transactions...</td></tr>';

        UnmatchedService.getUnmatched(pharmacyId)
          .then(function(transactions) {
            unmatchedState.transactions = transactions || [];
            renderUnmatchedTable();
            // Update button states after loading transactions
            updateUnmatchedUI();
            // Reload reconciliation summary to update counts
            loadReconciliationSummary(pharmacyId);
            // Load accounts for dropdowns (silently fail if endpoint doesn't exist or returns 404)
            AccountsService.getAccounts({ is_active: true })
              .then(function(accounts) {
                unmatchedState.accounts = accounts;
                // Re-render table to populate account dropdowns
                renderUnmatchedTable();
              })
              .catch(function(error) {
                // Silently fail - accounts endpoint may not be available or may require admin access
                console.debug('Accounts endpoint not available (this is OK):', error.message);
                unmatchedState.accounts = [];
                // Re-render table even if accounts failed to load
                renderUnmatchedTable();
              });
          })
          .catch(function(error) {
            console.error('Error loading unmatched transactions:', error);
            unmatchedState.transactions = [];
            tbody.innerHTML = `<tr><td colspan="6" class="error-cell">Error: ${error.message}</td></tr>`;
            showStyledAlert(error.message, 'error', 'Error Loading Unmatched Transactions');
            updateUnmatchedUI();
          });
      }

      // Render Unmatched Transactions Table
      function renderUnmatchedTable() {
        const tbody = document.getElementById('unmatched-transactions-table-body');
        if (!tbody) return;

        let filtered = unmatchedState.transactions;

        if (filtered.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty-cell">No unmatched transactions found</td></tr>';
          return;
        }

        // Ensure accounts are loaded
        const accounts = unmatchedState.accounts || [];
        const accountOptions = accounts.length > 0
          ? '<option value="">Select Account</option>' + accounts.map(function(acc) {
              const code = acc.code || '';
              const name = acc.name || '';
              const category = acc.category || '';
              const displayText = category 
                ? `${code} – ${name} – ${category}`
                : `${code} – ${name}`;
              return `<option value="${acc.id}">${displayText}</option>`;
            }).join('')
          : '<option value="">Loading accounts...</option>';

        tbody.innerHTML = filtered.map(function(tx) {
          const statusChip = getStatusChip(tx.classification_status);
          
          // Transform amount field to amount_in/amount_out format
          // API returns: amount (negative for outflows, positive for inflows)
          // Frontend expects: amount_in (positive) and amount_out (positive)
          let amountIn = 0;
          let amountOut = 0;
          if (tx.amount !== undefined && tx.amount !== null) {
            if (tx.amount > 0) {
              amountIn = tx.amount;
            } else {
              amountOut = Math.abs(tx.amount);
            }
          } else if (tx.amount_in !== undefined || tx.amount_out !== undefined) {
            // Fallback to existing amount_in/amount_out if present
            amountIn = tx.amount_in || 0;
            amountOut = tx.amount_out || 0;
          }
          
          const amountCell = formatAmountWithColor(amountIn, amountOut);

          const selectedAccountId = ''; // Could be stored in state if needed
          const accountButtonText = selectedAccountId 
            ? (() => {
                const acc = accounts.find(a => a.id == selectedAccountId);
                if (acc) {
                  const code = acc.code || '';
                  const name = acc.name || '';
                  return code ? `${code} – ${name}` : name;
                }
                return 'Select Account';
              })()
            : 'Select Account';

          const accountDropdown = `
            <button 
              type="button" 
              class="account-select-button" 
              id="account-select-btn-${tx.id}" 
              onclick="openAccountSelectionModal(${tx.id})"
              ${accounts.length === 0 ? 'disabled' : ''}
            >
              ${accountButtonText}
            </button>
            <input type="hidden" id="account-select-${tx.id}" value="${selectedAccountId}" />
          `;

          const actionsCell = `
            <button class="btn btn-sm btn-primary" onclick="applyRulesToTransaction(${tx.id})" style="margin-right: 4px;">Apply Rules</button>
            <button class="btn btn-sm btn-secondary" onclick="quickClassify(${tx.id})" id="quick-classify-${tx.id}">Manual Classify</button>
          `;

          return `
            <tr>
              <td>${formatDate(tx.date)}</td>
              <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${tx.description || ''}">${tx.description || '-'}</td>
              <td>${amountCell}</td>
              <td>${statusChip}</td>
              <td>${accountDropdown}</td>
              <td class="actions-cell">${actionsCell}</td>
            </tr>
          `;
        }).join('');
      }

      // Close Bank Rule Modal
      function closeBankRuleModal() {
        const modal = document.getElementById('bank-rule-modal');
        const form = document.getElementById('bank-rule-form');
        if (modal) modal.style.display = 'none';
        if (form) form.reset();
        // Clear dynamic lists
        const conditionsList = document.getElementById('bank-rule-conditions-list');
        const allocateList = document.getElementById('bank-rule-allocate-list');
        if (conditionsList) conditionsList.innerHTML = '';
        if (allocateList) allocateList.innerHTML = '';
        // Reset state
        bankRulesState.editingRule = null;
        const ruleIdInput = document.getElementById('bank-rule-id');
        if (ruleIdInput) ruleIdInput.value = '';
        updateTotalPercent();
      }

      // Close Manual Classify Modal
      function closeManualClassifyModal() {
        const modal = document.getElementById('manual-classify-modal');
        const form = document.getElementById('manual-classify-form');
        const accountSelect = document.getElementById('manual-classify-account');
        
        if (modal) {
          modal.style.display = 'none';
        }
        if (form) {
          form.reset();
        }
        if (accountSelect) {
          accountSelect.disabled = false;
          accountSelect.innerHTML = '<option value="">Select Account</option>';
        }
        
        const lineIdInput = document.getElementById('manual-classify-line-id');
        if (lineIdInput) {
          lineIdInput.value = '';
          lineIdInput.removeAttribute('data-tx');
        }
        unmatchedState.selectedLineId = null;
      }

      // Open Bank Rule Modal (Create/Edit)
      function openBankRuleModal(ruleId) {
        const modal = document.getElementById('bank-rule-modal');
        const title = document.getElementById('bank-rule-modal-title');
        const form = document.getElementById('bank-rule-form');
        
        // Ensure accounts are loaded before opening modal
        if (!bankRulesState.accounts || bankRulesState.accounts.length === 0) {
          if (!selectedPharmacyId) {
            showStyledAlert('Please select a pharmacy first', 'warning', 'Warning');
            return;
          }
          
          // Load accounts first
          AccountsService.getAccounts({ is_active: true })
            .then(function(accounts) {
              // Ensure accounts is an array
              const accountsArray = Array.isArray(accounts) ? accounts : (accounts.accounts || accounts.items || []);
              bankRulesState.accounts = accountsArray;
              if (bankRulesState.accounts.length === 0) {
                showStyledAlert('No accounts found. Please ensure accounts are configured.', 'warning', 'No Accounts');
                return;
              }
              // Now open the modal with accounts loaded
              openBankRuleModal(ruleId);
            })
            .catch(function(error) {
              console.error('Error loading accounts:', error);
              showStyledAlert('Failed to load accounts: ' + error.message, 'error', 'Error Loading Accounts');
            });
          return;
        }
        
        if (ruleId) {
          // Edit mode
          const rule = bankRulesState.rules.find(function(r) { return r.id === ruleId; });
          if (!rule) {
            showStyledAlert('Rule not found', 'error', 'Error');
            return;
          }
          bankRulesState.editingRule = rule;
          title.textContent = 'Edit Bank Rule';
          populateBankRuleForm(rule);
          document.getElementById('bank-rule-deactivate').style.display = rule.is_active ? 'inline-block' : 'none';
        } else {
          // Create mode
          bankRulesState.editingRule = null;
          title.textContent = 'New Bank Rule';
          form.reset();
          document.getElementById('bank-rule-id').value = '';
          document.getElementById('bank-rule-deactivate').style.display = 'none';
          // Clear existing rows
          const conditionsList = document.getElementById('bank-rule-conditions-list');
          const allocateList = document.getElementById('bank-rule-allocate-list');
          if (conditionsList) conditionsList.innerHTML = '';
          if (allocateList) allocateList.innerHTML = '';
          // Add default condition and allocation rows
          addConditionRow();
          addAllocationRow();
        }
        
        modal.style.display = 'flex';
      }

      // Populate Bank Rule Form
      function populateBankRuleForm(rule) {
        document.getElementById('bank-rule-id').value = rule.id;
        document.getElementById('bank-rule-name').value = rule.name || '';
        document.getElementById('bank-rule-type').value = rule.type || '';
        document.getElementById('bank-rule-priority').value = rule.priority || 10;
        document.getElementById('bank-rule-contact').value = rule.contact_name || '';
        document.getElementById('bank-rule-group-type').value = (rule.conditions && rule.conditions[0]?.group_type) || 'ALL';

        // Populate conditions
        const conditionsList = document.getElementById('bank-rule-conditions-list');
        conditionsList.innerHTML = '';
        if (rule.conditions && rule.conditions.length > 0) {
          rule.conditions.forEach(function(cond) {
            addConditionRow(cond);
          });
        } else {
          addConditionRow();
        }

        // Populate allocations
        const allocateList = document.getElementById('bank-rule-allocate-list');
        allocateList.innerHTML = '';
        if (rule.allocate && rule.allocate.length > 0) {
          rule.allocate.forEach(function(alloc) {
            addAllocationRow(alloc);
          });
        } else {
          addAllocationRow();
        }

        updateTotalPercent();
      }

      // Add Condition Row
      function addConditionRow(condition) {
        const list = document.getElementById('bank-rule-conditions-list');
        if (!list) {
          console.error('bank-rule-conditions-list element not found');
          return;
        }
        const row = document.createElement('div');
        row.className = 'bank-rule-condition-row';
        row.style.display = 'flex';
        row.style.gap = '8px';
        row.style.alignItems = 'center';

        const fields = ['description', 'reference', 'amount', 'amount_in', 'amount_out', 'date'];
        const operators = ['contains', 'not contains', 'equals', 'starts with', 'ends with', 'greater than', 'less than'];

        row.innerHTML = `
          <select class="form-control" style="flex: 1; min-width: 120px;" data-field="field">
            ${fields.map(function(f) {
              return `<option value="${f}" ${condition && condition.field === f ? 'selected' : ''}>${f.charAt(0).toUpperCase() + f.slice(1).replace('_', ' ')}</option>`;
            }).join('')}
          </select>
          <select class="form-control" style="flex: 1; min-width: 120px;" data-field="operator">
            ${operators.map(function(op) {
              return `<option value="${op}" ${condition && condition.operator === op ? 'selected' : ''}>${op}</option>`;
            }).join('')}
          </select>
          <input type="text" class="form-control" style="flex: 2; min-width: 150px;" data-field="value" value="${condition ? (condition.value || '') : ''}" placeholder="Value" />
          <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('.bank-rule-condition-row').remove()" style="padding: 4px 8px;">×</button>
        `;

        list.appendChild(row);
      }

      // Add Allocation Row
      function addAllocationRow(allocation) {
        const tbody = document.getElementById('bank-rule-allocate-list');
        const row = document.createElement('tr');
        
        // Check if accounts are loaded
        if (!bankRulesState.accounts || bankRulesState.accounts.length === 0) {
          console.warn('No accounts loaded for bank rule allocation');
          // Try to load accounts if we have a pharmacy selected
          if (selectedPharmacyId) {
            AccountsService.getAccounts({ is_active: true })
              .then(function(accounts) {
                // Ensure accounts is an array
                const accountsArray = Array.isArray(accounts) ? accounts : (accounts.accounts || accounts.items || []);
                bankRulesState.accounts = accountsArray;
                // Rebuild the row with accounts
                row.remove();
                addAllocationRow(allocation);
              })
              .catch(function(error) {
                console.error('Error loading accounts:', error);
              });
          }
        }
        
        // Build account options
        const accountOptions = (bankRulesState.accounts || []).map(function(acc) {
          const selected = allocation && allocation.account_id === acc.id ? 'selected' : '';
          return `<option value="${acc.id}" ${selected}>${acc.code || ''} – ${acc.name || ''}</option>`;
        }).join('');
        
        // If no accounts, show a message
        if (!accountOptions) {
          row.innerHTML = `
            <td colspan="4" style="color: var(--statusError); padding: 12px; text-align: center;">
              No accounts available. Please ensure accounts are configured.
            </td>
          `;
          tbody.appendChild(row);
          return;
        }

        row.innerHTML = `
          <td>
            <select class="form-control" style="font-size: 11px;" data-field="account_id" required>
              <option value="">Select Account</option>
              ${accountOptions}
            </select>
          </td>
          <td>
            <input type="number" class="form-control" style="font-size: 11px;" data-field="percent" value="${allocation ? (allocation.percent || 0) : 0}" min="0" max="100" step="0.01" required />
          </td>
          <td>
            <select class="form-control" style="font-size: 11px;" data-field="vat_code">
              <option value="NO_VAT" ${(!allocation || allocation.vat_code === 'NO_VAT' || !allocation.vat_code) ? 'selected' : ''}>NO_VAT</option>
              <option value="VAT_STANDARD" ${allocation && allocation.vat_code === 'VAT_STANDARD' ? 'selected' : ''}>VAT_STANDARD (15%)</option>
              <option value="VAT_ZERO" ${allocation && allocation.vat_code === 'VAT_ZERO' ? 'selected' : ''}>VAT_ZERO (0%)</option>
              <option value="VAT_EXEMPT" ${allocation && allocation.vat_code === 'VAT_EXEMPT' ? 'selected' : ''}>VAT_EXEMPT</option>
            </select>
          </td>
          <td>
            <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('tr').remove(); updateTotalPercent();" style="padding: 2px 6px;">×</button>
          </td>
        `;

        tbody.appendChild(row);
        
        // Add change listener to update total
        row.querySelector('[data-field="percent"]').addEventListener('input', updateTotalPercent);
      }

      // Update Total Percent
      function updateTotalPercent() {
        const rows = document.querySelectorAll('#bank-rule-allocate-list tr');
        let total = 0;
        rows.forEach(function(row) {
          const percentInput = row.querySelector('[data-field="percent"]');
          if (percentInput) {
            total += parseFloat(percentInput.value) || 0;
          }
        });
        
        const totalEl = document.getElementById('bank-rule-total-percent');
        const errorEl = document.getElementById('bank-rule-percent-error');
        
        if (totalEl) totalEl.textContent = total.toFixed(2);
        if (errorEl) {
          errorEl.style.display = Math.abs(total - 100) > 0.01 ? 'inline' : 'none';
        }
      }

      // Save Bank Rule
      function saveBankRule() {
        const form = document.getElementById('bank-rule-form');
        const ruleId = document.getElementById('bank-rule-id').value;
        
        // Get pharmacy ID from multiple sources - ensure we always have one
        let pharmacyId = selectedPharmacyId || window.selectedPharmacyId;
        
        // Fallback: try to get from pharmacy selector
        if (!pharmacyId && window.phSidebarEl) {
          const selectedOption = window.phSidebarEl.options[window.phSidebarEl.selectedIndex];
          if (selectedOption) {
            pharmacyId = selectedOption.value || selectedOption.getAttribute('data-pharmacy-id');
          }
        }
        
        // Convert to integer if it's a string
        if (pharmacyId) {
          pharmacyId = parseInt(pharmacyId);
        }

        if (!pharmacyId || isNaN(pharmacyId)) {
          showStyledAlert('Please select a pharmacy from the top selector first', 'warning', 'Warning');
          return;
        }
        
        console.log('[Bank Rule] Using pharmacy_id:', pharmacyId);

        // Collect form data - matching API specification exactly
        // Note: Some API implementations require pharmacy_id in body even though it's in path
        const ruleData = {
          pharmacy_id: pharmacyId, // Include in body as some APIs require it
          name: document.getElementById('bank-rule-name').value.trim(),
          type: document.getElementById('bank-rule-type').value,
          priority: parseInt(document.getElementById('bank-rule-priority').value) || 100, // Default 100 per spec
          contact_name: document.getElementById('bank-rule-contact').value.trim() || null,
          conditions: [],
          allocate: []
        };

        // Collect conditions - each condition includes group_type per spec
        const groupType = document.getElementById('bank-rule-group-type').value || 'ALL';
        const conditionRows = document.querySelectorAll('.bank-rule-condition-row');
        conditionRows.forEach(function(row) {
          const field = row.querySelector('[data-field="field"]')?.value;
          const operator = row.querySelector('[data-field="operator"]')?.value;
          const value = row.querySelector('[data-field="value"]')?.value?.trim();
          if (field && operator && value) {
            ruleData.conditions.push({
              group_type: groupType, // Each condition has group_type per spec
              field: field,
              operator: operator,
              value: value
            });
          }
        });

        // Collect allocations - matching API specification exactly
        const allocateRows = document.querySelectorAll('#bank-rule-allocate-list tr');
        allocateRows.forEach(function(row) {
          // Skip rows that are error messages (no account select)
          const accountSelect = row.querySelector('[data-field="account_id"]');
          if (!accountSelect) return;
          
          const accountId = parseInt(accountSelect.value);
          const percentInput = row.querySelector('[data-field="percent"]');
          const vatCodeInput = row.querySelector('[data-field="vat_code"]');
          
          if (accountId && percentInput) {
            const percent = parseFloat(percentInput.value);
            // VAT code is now a dropdown, so value will always be valid
            let vatCode = (vatCodeInput?.value || 'NO_VAT').trim();
            
            // Fallback validation - should never happen with dropdown, but keep for safety
            if (!vatCode || /^\d+$/.test(vatCode)) {
              vatCode = 'NO_VAT';
            }
            
            if (accountId && !isNaN(percent) && percent > 0) {
              ruleData.allocate.push({
                account_id: accountId,
                percent: percent,
                vat_code: vatCode
              });
            }
          }
        });
        
        // Debug: Log the rule data being sent
        console.log('[Bank Rule] Rule data to be sent:', JSON.stringify(ruleData, null, 2));

        // Validate - matching API requirements
        if (!ruleData.name || !ruleData.name.trim()) {
          showStyledAlert('Please enter a rule name', 'warning', 'Validation Error');
          return;
        }

        if (!ruleData.type || !['receive', 'spend', 'transfer'].includes(ruleData.type)) {
          showStyledAlert('Please select a valid rule type (receive, spend, or transfer)', 'warning', 'Validation Error');
          return;
        }

        if (ruleData.conditions.length === 0) {
          showStyledAlert('Please add at least one condition', 'warning', 'Validation Error');
          return;
        }

        if (ruleData.allocate.length === 0) {
          showStyledAlert('Please add at least one allocation', 'warning', 'Validation Error');
          return;
        }

        // Validate allocations
        const total = ruleData.allocate.reduce(function(sum, a) { return sum + a.percent; }, 0);
        if (Math.abs(total - 100) > 0.01) {
          showStyledAlert(`Total allocation must equal 100% (currently ${total.toFixed(2)}%)`, 'error', 'Validation Error');
          return;
        }
        
        // Validate each allocation has valid account_id
        const invalidAllocations = ruleData.allocate.filter(function(a) {
          return !a.account_id || !a.percent || a.percent <= 0;
        });
        if (invalidAllocations.length > 0) {
          showStyledAlert('All allocations must have a valid account and percentage > 0', 'error', 'Validation Error');
          return;
        }
        
        // Clean up: remove contact_name if empty string
        if (ruleData.contact_name === '') {
          ruleData.contact_name = null;
        }
        
        // Final debug log before sending
        console.log('[Bank Rule] Final rule data:', JSON.stringify(ruleData, null, 2));
        
        // Output clean JSON for backend team - easy to copy
        const jsonForBackend = JSON.stringify(ruleData, null, 2);
        console.log('%c═══════════════════════════════════════════════════════════', 'color: #ff6b6b; font-weight: bold; font-size: 14px;');
        console.log('%c📋 COPY THIS JSON FOR BACKEND TEAM:', 'color: #ff6b6b; font-weight: bold; font-size: 14px;');
        console.log('%c═══════════════════════════════════════════════════════════', 'color: #ff6b6b; font-weight: bold; font-size: 14px;');
        console.log(jsonForBackend);
        console.log('%c═══════════════════════════════════════════════════════════', 'color: #ff6b6b; font-weight: bold; font-size: 14px;');
        console.log('%cEndpoint: POST /bank-rules/pharmacies/' + pharmacyId + '/bank-rules', 'color: #4ecdc4; font-weight: bold;');
        console.log('%cError: "Object of type BankRuleAllocation is not JSON serializable"', 'color: #ff6b6b; font-weight: bold;');

        // Save
        const submitBtn = document.getElementById('bank-rule-submit');
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = 'Saving...';
        }

        const savePromise = ruleId 
          ? BankRulesService.updateRule(ruleId, ruleData)
          : BankRulesService.createRule(pharmacyId, ruleData);

        savePromise
          .then(function(result) {
            // Close modal first
            closeBankRuleModal();
            // Show success message and wait for user to dismiss
            return showStyledAlert('Bank rule saved successfully!', 'success', 'Success');
          })
          .then(function() {
            // Ensure we stay on the Bank Rules tab
            var bankRulesTabBtn = document.querySelector('.nav-item[data-tab="bank-rules"]');
            var bankRulesTabPanel = document.getElementById('tab-bank-rules');
            
            if (bankRulesTabBtn && bankRulesTabPanel) {
              document.querySelectorAll('.nav-item').forEach(function(b) {
                b.classList.remove('active');
              });
              bankRulesTabBtn.classList.add('active');
              
              document.querySelectorAll('.tab-panel').forEach(function(panel) {
                panel.hidden = true;
                panel.style.display = 'none';
              });
              
              bankRulesTabPanel.hidden = false;
              bankRulesTabPanel.style.display = 'block';
            }
            
            // Reload the rules list
            loadBankRules(pharmacyId);
          })
          .catch(function(error) {
            console.error('Error saving rule:', error);
            console.error('Error type:', typeof error);
            console.error('Error message:', error?.message);
            
            // Ensure error message is a string
            let errorMessage = 'An error occurred while saving the rule';
            if (error) {
              if (error.message) {
                // error.message might be a string or object
                if (typeof error.message === 'string') {
                  errorMessage = error.message;
                } else if (typeof error.message === 'object') {
                  errorMessage = JSON.stringify(error.message, null, 2);
                } else {
                  errorMessage = String(error.message);
                }
              } else if (typeof error === 'string') {
                errorMessage = error;
              } else if (typeof error === 'object') {
                // Try to extract meaningful info
                const errorStr = JSON.stringify(error, null, 2);
                errorMessage = errorStr.length > 500 ? errorStr.substring(0, 500) + '...' : errorStr;
              } else {
                errorMessage = String(error);
              }
            }
            
            console.error('Final error message:', errorMessage);
            showStyledAlert(errorMessage, 'error', 'Error Saving Rule');
          })
          .finally(function() {
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = 'Save Rule';
            }
          });
      }

      // Toggle Rule Active
      function toggleBankRuleActive(ruleId, isActive) {
        BankRulesService.toggleActive(ruleId, isActive)
          .then(function() {
            showStyledAlert(`Rule ${isActive ? 'activated' : 'deactivated'} successfully!`, 'success', 'Success');
            loadBankRules(selectedPharmacyId);
          })
          .catch(function(error) {
            console.error('Error toggling rule:', error);
            showStyledAlert(error.message, 'error', 'Error');
          });
      }

      // Open Manual Classify Modal
      function openManualClassify(lineId) {
        const tx = unmatchedState.transactions.find(function(t) { return t.id === lineId; });
        if (!tx) {
          showStyledAlert('Transaction not found', 'error', 'Error');
          return;
        }

        // Transform amount field to amount_in/amount_out format
        let amountIn = 0;
        let amountOut = 0;
        if (tx.amount !== undefined && tx.amount !== null) {
          if (tx.amount > 0) {
            amountIn = tx.amount;
          } else {
            amountOut = Math.abs(tx.amount);
          }
        } else if (tx.amount_in !== undefined || tx.amount_out !== undefined) {
          amountIn = tx.amount_in || 0;
          amountOut = tx.amount_out || 0;
        }

        const modal = document.getElementById('manual-classify-modal');
        document.getElementById('manual-classify-line-id').value = lineId;
        // Store transaction data for later use
        document.getElementById('manual-classify-line-id').setAttribute('data-tx', JSON.stringify(tx));
        document.getElementById('manual-classify-date').textContent = formatDate(tx.date);
        document.getElementById('manual-classify-amount').innerHTML = formatAmountWithColor(amountIn, amountOut);
        document.getElementById('manual-classify-description').textContent = tx.description || '-';
        document.getElementById('manual-classify-reference').textContent = tx.reference || '-';
        document.getElementById('manual-classify-description-input').value = tx.description || '';

        // Load and populate account dropdown
        const accountSelect = document.getElementById('manual-classify-account');
        accountSelect.innerHTML = '<option value="">Loading accounts...</option>';
        accountSelect.disabled = true;

        AccountsService.getAccounts({ is_active: true })
          .then(function(accounts) {
            unmatchedState.accounts = accounts;
            accountSelect.innerHTML = '<option value="">Select Account</option>' +
              accounts.map(function(acc) {
                const code = acc.code || '';
                const name = acc.name || '';
                const category = acc.category || '';
                const displayText = category 
                  ? `${code} – ${name} – ${category}`
                  : `${code} – ${name}`;
                return `<option value="${acc.id}">${displayText}</option>`;
              }).join('');
            accountSelect.disabled = false;
          })
          .catch(function(error) {
            console.error('Error loading accounts:', error);
            accountSelect.innerHTML = '<option value="">Error loading accounts</option>';
            accountSelect.disabled = false;
            showStyledAlert('Failed to load accounts. Please try again.', 'error', 'Error');
          });

        modal.style.display = 'flex';
      }

      // Save Manual Classification
      function saveManualClassify() {
        const form = document.getElementById('manual-classify-form');
        const lineIdInput = document.getElementById('manual-classify-line-id');
        const lineId = lineIdInput.value;
        const accountId = document.getElementById('manual-classify-account').value;
        const description = document.getElementById('manual-classify-description-input').value;

        if (!accountId) {
          showStyledAlert('Please select an account', 'warning', 'Validation Error');
          return;
        }

        // Get transaction data
        const txData = lineIdInput.getAttribute('data-tx');
        if (!txData) {
          showStyledAlert('Transaction data not found. Please try again.', 'error', 'Error');
          return;
        }
        
        const tx = JSON.parse(txData);

        const submitBtn = document.getElementById('manual-classify-submit');
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = 'Saving...';
        }

        // Always use manual-classify endpoint
        // Prepare classification data
        const classifyData = {
          account_id: parseInt(accountId),
          description: description || tx.description || ''
        };

        // Debug logging - show what we're sending
        console.log('%c═══════════════════════════════════════════════════════════', 'color: #4a90e2; font-weight: bold; font-size: 14px;');
        console.log('%c🔵 MANUAL CLASSIFY REQUEST:', 'color: #4a90e2; font-weight: bold; font-size: 14px;');
        console.log('%c═══════════════════════════════════════════════════════════', 'color: #4a90e2; font-weight: bold; font-size: 14px;');
        console.log('Endpoint: POST /api/bank-statement-lines/' + lineId + '/manual-classify');
        console.log('Line ID:', lineId);
        console.log('Request Body:', JSON.stringify(classifyData, null, 2));
        console.log('Transaction Data:', JSON.stringify(tx, null, 2));
        console.log('%c═══════════════════════════════════════════════════════════', 'color: #4a90e2; font-weight: bold; font-size: 14px;');

        UnmatchedService.manualClassify(lineId, classifyData)
          .then(function(result) {
            // Close modal first
            closeManualClassifyModal();
            
            // Remove transaction from unmatched list immediately
            unmatchedState.transactions = unmatchedState.transactions.filter(function(t) {
              return t.id !== parseInt(lineId);
            });
            
            // Re-render the table
            renderUnmatchedTable();
            
            // Update button states
            updateUnmatchedUI();
            
            // Show success toast
            showStyledAlert('Transaction classified manually', 'success', 'Success');
            
            // Ask if user wants to save this as a rule
            setTimeout(function() {
              const saveAsRule = confirm('Would you like to save this classification as a rule for future transactions?');
              if (saveAsRule) {
                createRuleFromTransaction(tx, parseInt(accountId), description || tx.description || '');
              }
            }, 500); // Small delay to let the success message show first
          })
          .catch(function(error) {
            console.error('Error classifying:', error);
            showStyledAlert(error.message || 'Failed to classify transaction', 'error', 'Error Classifying');
          })
          .finally(function() {
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = 'Save & Classify';
            }
          });
      }

      // Account Selection Modal State
      var accountSelectionState = {
        currentTransactionId: null,
        selectedAccountId: null
      };

      // Open Account Selection Modal
      function openAccountSelectionModal(transactionId) {
        accountSelectionState.currentTransactionId = transactionId;
        accountSelectionState.selectedAccountId = null;
        
        const modal = document.getElementById('account-selection-modal');
        const searchInput = document.getElementById('account-search-input');
        const accountList = document.getElementById('account-selection-list');
        
        if (!modal) {
          showStyledAlert('Account selection modal not found', 'error', 'Error');
          return;
        }

        // Get currently selected account if any
        const hiddenInput = document.getElementById('account-select-' + transactionId);
        if (hiddenInput && hiddenInput.value) {
          accountSelectionState.selectedAccountId = hiddenInput.value;
        }

        // Setup search handler
        setupAccountSearchHandler();

        // Populate account list
        renderAccountSelectionList('');

        // Focus search input
        const searchInputAfterSetup = document.getElementById('account-search-input');
        if (searchInputAfterSetup) {
          searchInputAfterSetup.value = '';
          setTimeout(function() {
            searchInputAfterSetup.focus();
          }, 100);
        }

        modal.style.display = 'flex';
      }

      // Close Account Selection Modal
      function closeAccountSelectionModal() {
        const modal = document.getElementById('account-selection-modal');
        if (modal) {
          modal.style.display = 'none';
        }
        accountSelectionState.currentTransactionId = null;
        accountSelectionState.selectedAccountId = null;
      }

      // Render Account Selection List
      function renderAccountSelectionList(searchTerm) {
        const accountList = document.getElementById('account-selection-list');
        if (!accountList) return;

        const accounts = unmatchedState.accounts || [];
        const searchLower = (searchTerm || '').toLowerCase().trim();

        // Filter accounts based on search - supports partial matches
        const filteredAccounts = accounts.filter(function(acc) {
          if (!searchLower) return true;
          
          // Get all searchable fields
          const code = String(acc.code || '').toLowerCase();
          const name = String(acc.name || '').toLowerCase();
          const category = String(acc.category || '').toLowerCase();
          
          // Combine all fields into a searchable string
          const searchableText = `${code} ${name} ${category}`.trim();
          
          // Split search term into words and check if all words match (partial match)
          const searchWords = searchLower.split(/\s+/).filter(function(word) {
            return word.length > 0;
          });
          
          // If no search words, show all
          if (searchWords.length === 0) return true;
          
          // Check if all search words are found in the searchable text
          return searchWords.every(function(word) {
            return searchableText.includes(word);
          });
        });

        if (filteredAccounts.length === 0) {
          accountList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--textMuted);">No accounts found</div>';
          return;
        }

        accountList.innerHTML = filteredAccounts.map(function(acc) {
          const code = String(acc.code || '');
          const name = String(acc.name || '');
          const category = String(acc.category || '');
          const isSelected = accountSelectionState.selectedAccountId == acc.id;
          
          // Escape quotes and special characters for onclick
          const escapedCode = code.replace(/'/g, "\\'").replace(/"/g, '&quot;');
          const escapedName = name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
          
          return `
            <div 
              class="account-selection-item ${isSelected ? 'selected' : ''}" 
              onclick="selectAccount(${acc.id}, '${escapedCode}', '${escapedName}')"
            >
              <span class="account-selection-code">${code || 'No Code'}</span>
              <span class="account-selection-separator">–</span>
              <span class="account-selection-name">${name || 'Unnamed Account'}</span>
              ${category ? `<span class="account-selection-separator">–</span><span class="account-selection-category">${category}</span>` : ''}
            </div>
          `;
        }).join('');
      }

      // Select Account
      function selectAccount(accountId, code, name) {
        accountSelectionState.selectedAccountId = accountId;
        
        const transactionId = accountSelectionState.currentTransactionId;
        if (!transactionId) {
          showStyledAlert('Transaction ID not found', 'error', 'Error');
          return;
        }

        // Update hidden input
        const hiddenInput = document.getElementById('account-select-' + transactionId);
        if (hiddenInput) {
          hiddenInput.value = accountId;
        }

        // Update button text
        const button = document.getElementById('account-select-btn-' + transactionId);
        if (button) {
          const displayText = code ? `${code} – ${name}` : name;
          button.textContent = displayText;
        }

        // Re-render list to show selection
        const searchInput = document.getElementById('account-search-input');
        renderAccountSelectionList(searchInput ? searchInput.value : '');

        // Update button states (check if Manual Classify All should be enabled)
        updateUnmatchedUI();

        // Close modal
        closeAccountSelectionModal();
      }

      // Manual Classify All - Classify all transactions with selected accounts
      function manualClassifyAll() {
        const transactions = unmatchedState.transactions || [];
        
        if (transactions.length === 0) {
          showStyledAlert('No transactions found', 'warning', 'Warning');
          return;
        }

        // Find all transactions with selected accounts
        const transactionsToClassify = transactions.filter(function(tx) {
          const hiddenInput = document.getElementById('account-select-' + tx.id);
          return hiddenInput && hiddenInput.value;
        });

        if (transactionsToClassify.length === 0) {
          showStyledAlert('Please select accounts for transactions first', 'warning', 'No Accounts Selected');
          return;
        }

        // Ask if user wants to save all as rules
        const saveAsRules = confirm(`You are about to classify ${transactionsToClassify.length} transaction${transactionsToClassify.length !== 1 ? 's' : ''}. Would you like to save all classifications as rules for future transactions?`);

        const btn = document.getElementById('unmatched-manual-classify-all-btn');
        if (btn) {
          btn.disabled = true;
          btn.textContent = 'Classifying...';
        }

        let completedCount = 0;
        let successCount = 0;
        let errorCount = 0;
        const errors = [];
        const rulesToCreate = [];

        // Classify all transactions
        function classifyNext(index) {
          if (index >= transactionsToClassify.length) {
            // All transactions processed
            if (btn) {
              btn.disabled = false;
              btn.textContent = 'Manual Classify All';
            }

            // Reload transactions to show updated status
            loadUnmatchedTransactions(selectedPharmacyId);

            // Show summary
            if (errorCount === 0) {
              showStyledAlert(
                `Successfully classified ${successCount} transaction${successCount !== 1 ? 's' : ''}.`,
                'success',
                'Classification Complete'
              );
            } else {
              showStyledAlert(
                `Classified ${successCount} transaction${successCount !== 1 ? 's' : ''}. ${errorCount} error${errorCount !== 1 ? 's' : ''} occurred.`,
                errorCount < successCount ? 'warning' : 'error',
                'Classification Complete (with errors)'
              );
              console.error('Errors during classification:', errors);
            }

            // Create rules if user requested
            if (saveAsRules && rulesToCreate.length > 0) {
              createRulesFromTransactions(rulesToCreate);
            }

            return;
          }

          const tx = transactionsToClassify[index];
          const hiddenInput = document.getElementById('account-select-' + tx.id);
          const accountId = hiddenInput ? hiddenInput.value : null;

          if (!accountId) {
            // Skip if no account selected
            completedCount++;
            classifyNext(index + 1);
            return;
          }

          // Prepare classification data
          const classifyData = {
            account_id: parseInt(accountId),
            description: tx.description || ''
          };

          // Perform classification
          UnmatchedService.manualClassify(tx.id, classifyData)
            .then(function(result) {
              successCount++;
              completedCount++;

              // Store rule data if user wants to save as rules
              if (saveAsRules) {
                rulesToCreate.push({
                  transaction: tx,
                  accountId: parseInt(accountId),
                  description: tx.description || ''
                });
              }

              // Process next transaction
              setTimeout(function() {
                classifyNext(index + 1);
              }, 100); // Small delay between requests
            })
            .catch(function(error) {
              errorCount++;
              completedCount++;
              errors.push({
                transactionId: tx.id,
                error: error.message || String(error)
              });
              console.error(`Error classifying transaction ${tx.id}:`, error);

              // Continue with next transaction even if there's an error
              setTimeout(function() {
                classifyNext(index + 1);
              }, 100);
            });
        }

        // Start processing
        classifyNext(0);
      }

      // Create Rules from Multiple Transactions
      function createRulesFromTransactions(rulesData) {
        if (!rulesData || rulesData.length === 0) return;

        // Get pharmacy ID
        let pharmacyId = selectedPharmacyId || window.selectedPharmacyId;
        if (!pharmacyId && window.phSidebarEl) {
          const selectedOption = window.phSidebarEl.options[window.phSidebarEl.selectedIndex];
          if (selectedOption) {
            pharmacyId = selectedOption.value || selectedOption.getAttribute('data-pharmacy-id');
          }
        }
        if (pharmacyId) {
          pharmacyId = parseInt(pharmacyId);
        }

        if (!pharmacyId || isNaN(pharmacyId)) {
          showStyledAlert('Cannot create rules: Please select a pharmacy first', 'warning', 'Warning');
          return;
        }

        let createdCount = 0;
        let errorCount = 0;

        // Create rules sequentially
        function createNextRule(index) {
          if (index >= rulesData.length) {
            // All rules processed
            if (errorCount === 0) {
              showStyledAlert(
                `Successfully created ${createdCount} rule${createdCount !== 1 ? 's' : ''}! Future transactions matching these descriptions will be automatically classified.`,
                'success',
                'Rules Created'
              );
            } else {
              showStyledAlert(
                `Created ${createdCount} rule${createdCount !== 1 ? 's' : ''}. ${errorCount} error${errorCount !== 1 ? 's' : ''} occurred.`,
                errorCount < createdCount ? 'warning' : 'error',
                'Rules Created (with errors)'
              );
            }
            // Reload bank rules to show the new rules
            if (selectedPharmacyId) {
              loadBankRules(selectedPharmacyId);
            }
            return;
          }

          const ruleData = rulesData[index];
          const tx = ruleData.transaction;
          const accountId = ruleData.accountId;
          const description = ruleData.description;

          // Determine transaction type based on amount
          const amount = tx.amount || 0;
          const transactionType = amount > 0 ? 'receive' : 'spend';

          // Get account details for rule name
          const account = unmatchedState.accounts.find(function(acc) { return acc.id === accountId; });
          const accountName = account ? (account.name || '') : '';
          
          // Create rule name from description (truncate if too long)
          const ruleName = description.length > 50 ? description.substring(0, 47) + '...' : description;

          // Build rule data
          const ruleDataToCreate = {
            pharmacy_id: pharmacyId,
            name: ruleName || 'Manual Classification Rule',
            type: transactionType,
            priority: 100, // Default priority
            contact_name: null,
            conditions: [
              {
                group_type: 'ALL',
                field: 'description',
                operator: 'contains',
                value: description || tx.description || ''
              }
            ],
            allocate: [
              {
                account_id: accountId,
                percent: 100,
                vat_code: 'NO_VAT' // Default VAT code
              }
            ]
          };

          // Create the rule
          BankRulesService.createRule(pharmacyId, ruleDataToCreate)
            .then(function(result) {
              createdCount++;
              // Process next rule
              setTimeout(function() {
                createNextRule(index + 1);
              }, 200); // Small delay between rule creations
            })
            .catch(function(error) {
              errorCount++;
              console.error('Error creating rule:', error);
              // Continue with next rule even if there's an error
              setTimeout(function() {
                createNextRule(index + 1);
              }, 200);
            });
        }

        // Start creating rules
        createNextRule(0);
      }

      // Quick Classify - Direct classification without modal
      function quickClassify(lineId) {
        const tx = unmatchedState.transactions.find(function(t) { return t.id === lineId; });
        if (!tx) {
          showStyledAlert('Transaction not found', 'error', 'Error');
          return;
        }

        // Get selected account from hidden input
        const hiddenInput = document.getElementById('account-select-' + lineId);
        if (!hiddenInput) {
          showStyledAlert('Account selection not found. Please refresh the page.', 'error', 'Error');
          return;
        }

        const accountId = hiddenInput.value;
        if (!accountId) {
          showStyledAlert('Please select an account first', 'warning', 'Validation Error');
          openAccountSelectionModal(lineId);
          return;
        }

        // Disable the button while processing
        const classifyBtn = document.getElementById('quick-classify-' + lineId);
        if (classifyBtn) {
          classifyBtn.disabled = true;
          classifyBtn.textContent = 'Classifying...';
        }

        // Prepare classification data
        const classifyData = {
          account_id: parseInt(accountId),
          description: tx.description || ''
        };

        // Perform classification
        UnmatchedService.manualClassify(lineId, classifyData)
          .then(function(result) {
            // Remove transaction from unmatched list immediately
            unmatchedState.transactions = unmatchedState.transactions.filter(function(t) {
              return t.id !== parseInt(lineId);
            });
            
            // Re-render the table
            renderUnmatchedTable();
            
            // Update button states
            updateUnmatchedUI();
            
            // Show success toast
            showStyledAlert('Transaction classified successfully', 'success', 'Success');
            
            // Ask if user wants to save this as a rule
            setTimeout(function() {
              const saveAsRule = confirm('Would you like to save this classification as a rule for future transactions?');
              if (saveAsRule) {
                createRuleFromTransaction(tx, parseInt(accountId), tx.description || '');
              }
            }, 500); // Small delay to let the success message show first
          })
          .catch(function(error) {
            console.error('Error classifying:', error);
            showStyledAlert(error.message || 'Failed to classify transaction', 'error', 'Error Classifying');
            // Re-enable button on error
            if (classifyBtn) {
              classifyBtn.disabled = false;
              classifyBtn.textContent = 'Manual Classify';
            }
          });
      }

      // Create Bank Rule from Transaction
      function createRuleFromTransaction(tx, accountId, description) {
        // Get pharmacy ID
        let pharmacyId = selectedPharmacyId || window.selectedPharmacyId;
        if (!pharmacyId && window.phSidebarEl) {
          const selectedOption = window.phSidebarEl.options[window.phSidebarEl.selectedIndex];
          if (selectedOption) {
            pharmacyId = selectedOption.value || selectedOption.getAttribute('data-pharmacy-id');
          }
        }
        if (pharmacyId) {
          pharmacyId = parseInt(pharmacyId);
        }

        if (!pharmacyId || isNaN(pharmacyId)) {
          showStyledAlert('Cannot create rule: Please select a pharmacy first', 'warning', 'Warning');
          return;
        }

        // Determine transaction type based on amount
        const amount = tx.amount || 0;
        const transactionType = amount > 0 ? 'receive' : 'spend';

        // Get account details for rule name
        const account = unmatchedState.accounts.find(function(acc) { return acc.id === accountId; });
        const accountName = account ? (account.name || '') : '';
        
        // Create rule name from description (truncate if too long)
        const ruleName = description.length > 50 ? description.substring(0, 47) + '...' : description;

        // Build rule data
        const ruleData = {
          pharmacy_id: pharmacyId,
          name: ruleName || 'Manual Classification Rule',
          type: transactionType,
          priority: 100, // Default priority
          contact_name: null,
          conditions: [
            {
              group_type: 'ALL',
              field: 'description',
              operator: 'contains',
              value: description || tx.description || ''
            }
          ],
          allocate: [
            {
              account_id: accountId,
              percent: 100,
              vat_code: 'NO_VAT' // Default VAT code
            }
          ]
        };

        // Create the rule
        BankRulesService.createRule(pharmacyId, ruleData)
          .then(function(result) {
            showStyledAlert('Bank rule created successfully! Future transactions matching this description will be automatically classified.', 'success', 'Rule Created');
            // Reload bank rules to show the new rule
            if (selectedPharmacyId) {
              loadBankRules(selectedPharmacyId);
            }
          })
          .catch(function(error) {
            console.error('Error creating rule:', error);
            showStyledAlert('Failed to create rule: ' + (error.message || 'Unknown error'), 'error', 'Error Creating Rule');
          });
      }


      // Apply Rules to Individual Transaction
      function applyRulesToTransaction(transactionId) {
        UnmatchedService.applyRulesToTransaction(transactionId)
          .then(function(result) {
            if (result.rule_id) {
              showStyledAlert(`Rule ${result.rule_id} matched and applied!`, 'success', 'Rules Applied');
            } else {
              showStyledAlert('No matching rule found for this transaction.', 'info', 'No Match');
            }
            loadUnmatchedTransactions(selectedPharmacyId);
          })
          .catch(function(error) {
            console.error('Error applying rules to transaction:', error);
            showStyledAlert(error.message, 'error', 'Error Applying Rules');
          });
      }

      // Apply Rules
      function applyRules() {
        const transactions = unmatchedState.transactions || [];
        
        if (transactions.length === 0) {
          showStyledAlert('No transactions found. Please ensure transactions are loaded.', 'warning', 'Warning');
          return;
        }

        // Get unique batch IDs from transactions
        const batchIds = [...new Set(transactions.map(t => t.bank_import_batch_id).filter(Boolean))];
        
        if (batchIds.length === 0) {
          showStyledAlert('No batch IDs found in transactions.', 'warning', 'Warning');
          return;
        }
        
        // Use first batch ID (or we could apply to all batches)
        const batchId = batchIds[0];
        
        if (batchIds.length > 1) {
          console.info(`Found ${batchIds.length} different batches. Applying rules to batch ${batchId}. You may need to apply rules to other batches separately.`);
        }

        // Filter transactions for the current batch
        const batchTransactions = transactions.filter(function(t) {
          return t.bank_import_batch_id === batchId && t.id;
        });

        if (batchTransactions.length === 0) {
          showStyledAlert('No transactions found for this batch.', 'warning', 'Warning');
          return;
        }

        const btn = document.getElementById('unmatched-apply-rules-btn');
        const progressModal = document.getElementById('unmatched-progress-modal');
        const progressBar = document.getElementById('unmatched-progress-bar-fill');
        const progressText = document.getElementById('unmatched-progress-text');
        const progressStatus = document.getElementById('unmatched-progress-status');

        if (btn) {
          btn.disabled = true;
          btn.textContent = 'Applying Rules...';
        }

        // Show progress modal
        if (progressModal) {
          progressModal.style.display = 'flex';
        }
        if (progressBar) {
          progressBar.style.width = '0%';
        }
        if (progressText) {
          progressText.textContent = 'Loading data...';
        }
        if (progressStatus) {
          progressStatus.textContent = 'Processing transactions... 0%';
        }

        // Split transactions into chunks of 20
        const CHUNK_SIZE = 20;
        const chunks = [];
        for (let i = 0; i < batchTransactions.length; i += CHUNK_SIZE) {
          chunks.push(batchTransactions.slice(i, i + CHUNK_SIZE));
        }

        console.log(`Processing ${batchTransactions.length} transactions in ${chunks.length} chunks of ${CHUNK_SIZE}`);

        let processedCount = 0;
        let successCount = 0;
        let errorCount = 0;
        const errors = [];

        // Update progress bar
        function updateProgress() {
          const percent = Math.round((processedCount / batchTransactions.length) * 100);
          if (progressBar) {
            progressBar.style.width = percent + '%';
          }
          if (progressStatus) {
            progressStatus.textContent = `Processing transactions... ${percent}%`;
          }
          if (progressText) {
            progressText.textContent = 'Loading data...';
          }
        }

        // Process chunks sequentially
        function processChunk(chunkIndex) {
          if (chunkIndex >= chunks.length) {
            // All chunks processed
            if (btn) {
              btn.disabled = false;
              btn.textContent = 'Apply Rules';
            }
            
            // Hide progress modal
            if (progressModal) {
              progressModal.style.display = 'none';
            }
            
            // Reload transactions to show updated status
            loadUnmatchedTransactions(selectedPharmacyId);
            
            // Show summary
            if (errorCount === 0) {
              showStyledAlert(
                `Successfully applied rules to ${successCount} transaction${successCount !== 1 ? 's' : ''}.`,
                'success',
                'Rules Applied'
              );
            } else {
              showStyledAlert(
                `Applied rules to ${successCount} transaction${successCount !== 1 ? 's' : ''}. ${errorCount} error${errorCount !== 1 ? 's' : ''} occurred.`,
                errorCount < successCount ? 'warning' : 'error',
                'Rules Applied (with errors)'
              );
              console.error('Errors during rule application:', errors);
            }
            return;
          }

          const chunk = chunks[chunkIndex];
          const chunkNumber = chunkIndex + 1;

          console.log(`Processing chunk ${chunkNumber}/${chunks.length} (${chunk.length} transactions)`);

          // Process transactions in this chunk sequentially to avoid overwhelming the server
          function processTransactionInChunk(txIndex) {
            if (txIndex >= chunk.length) {
              // All transactions in this chunk processed, move to next chunk
              setTimeout(function() {
                processChunk(chunkIndex + 1);
              }, 100);
              return;
            }

            const transaction = chunk[txIndex];
            
            UnmatchedService.applyRulesToTransaction(transaction.id)
              .then(function(result) {
                successCount++;
                processedCount++;
                updateProgress();
                // Process next transaction in chunk
                setTimeout(function() {
                  processTransactionInChunk(txIndex + 1);
                }, 50); // Small delay between transactions
              })
              .catch(function(error) {
                errorCount++;
                processedCount++;
                const errorInfo = {
                  success: false,
                  transactionId: transaction.id,
                  error: error.message || String(error)
                };
                errors.push(errorInfo);
                console.error(`Error applying rules to transaction ${transaction.id}:`, error);
                updateProgress();
                // Continue with next transaction even if there's an error
                setTimeout(function() {
                  processTransactionInChunk(txIndex + 1);
                }, 50);
              });
          }

          // Start processing transactions in this chunk
          processTransactionInChunk(0);
        }

        // Start processing from the first chunk
        processChunk(0);
      }


      // Initialize Bank Rules Tab
      var bankRulesTab = document.getElementById('tab-bank-rules');
      if (bankRulesTab) {
        // Safety: remove any date inputs that might still be cached in this tab
        bankRulesTab.querySelectorAll('input[type="date"]').forEach(function(el) {
          el.remove();
        });
        // Load accounts when pharmacy changes
        function loadAccountsForRules(pharmacyId) {
          if (!pharmacyId) {
            bankRulesState.accounts = [];
            return;
          }
          AccountsService.getAccounts({ is_active: true })
            .then(function(accounts) {
              // Ensure accounts is an array
              const accountsArray = Array.isArray(accounts) ? accounts : (accounts.accounts || accounts.items || []);
              bankRulesState.accounts = accountsArray;
              console.log(`Loaded ${bankRulesState.accounts.length} accounts for bank rules`);
            })
            .catch(function(error) {
              console.error('Error loading accounts:', error);
              bankRulesState.accounts = [];
            });
        }

        // Event listeners
        document.getElementById('bank-rules-new-btn')?.addEventListener('click', function() {
          if (selectedPharmacyId) {
            openBankRuleModal();
          } else {
            showStyledAlert('Please select a pharmacy first', 'warning', 'Warning');
          }
        });

        document.getElementById('bank-rules-refresh-btn')?.addEventListener('click', function() {
          if (selectedPharmacyId) {
            loadBankRules(selectedPharmacyId);
          }
        });

        document.getElementById('bank-rules-search')?.addEventListener('input', renderBankRulesTable);
        document.getElementById('bank-rules-type-filter')?.addEventListener('change', renderBankRulesTable);
        document.getElementById('bank-rules-show-inactive')?.addEventListener('change', renderBankRulesTable);

        document.getElementById('bank-rule-add-condition')?.addEventListener('click', function() {
          addConditionRow();
        });

        document.getElementById('bank-rule-add-split')?.addEventListener('click', function() {
          addAllocationRow();
        });

        document.getElementById('bank-rule-form')?.addEventListener('submit', function(e) {
          e.preventDefault();
          saveBankRule();
        });

        document.getElementById('bank-rule-cancel')?.addEventListener('click', closeBankRuleModal);

        document.getElementById('bank-rule-modal-close')?.addEventListener('click', closeBankRuleModal);

        // Close modal on overlay click
        document.getElementById('bank-rule-modal')?.addEventListener('click', function(e) {
          if (e.target.id === 'bank-rule-modal') {
            closeBankRuleModal();
          }
        });

        document.getElementById('bank-rule-deactivate')?.addEventListener('click', function() {
          const ruleId = document.getElementById('bank-rule-id').value;
          if (ruleId && confirm('Are you sure you want to deactivate this rule?')) {
            toggleBankRuleActive(parseInt(ruleId), false);
            closeBankRuleModal();
          }
        });

        // Update button state based on pharmacy selection
        function updateBankRulesUI() {
          const newBtn = document.getElementById('bank-rules-new-btn');
          if (newBtn) {
            newBtn.disabled = !selectedPharmacyId;
          }

          if (selectedPharmacyId && !bankRulesTab.hidden) {
            loadAccountsForRules(selectedPharmacyId);
            loadBankRules(selectedPharmacyId);
          }
        }

        // Listen for pharmacy selection changes
        if (window.phSidebarEl) {
          window.phSidebarEl.addEventListener('change', updateBankRulesUI);
        }

        // Initial load
        updateBankRulesUI();
      }

      // Initialize Unmatched Transactions Tab
      var unmatchedTab = document.getElementById('tab-unmatched-transactions');
      if (unmatchedTab) {
        // Load accounts when pharmacy changes
        function loadAccountsForUnmatched(pharmacyId) {
          // Load active accounts (no longer requires pharmacyId)
          AccountsService.getAccounts({ is_active: true })
            .then(function(accounts) {
              unmatchedState.accounts = accounts;
            })
            .catch(function(error) {
              console.error('Error loading accounts:', error);
              unmatchedState.accounts = [];
            });
        }

        // Event listeners
        document.getElementById('unmatched-apply-rules-btn')?.addEventListener('click', applyRules);
        document.getElementById('unmatched-manual-classify-all-btn')?.addEventListener('click', manualClassifyAll);
        document.getElementById('unmatched-refresh-btn')?.addEventListener('click', function() {
          if (selectedPharmacyId) {
            loadReconciliationSummary(selectedPharmacyId);
            loadUnmatchedTransactions(selectedPharmacyId);
          }
        });
        
        // "Go To Unmatched Transactions" button - scrolls to the table section
        document.getElementById('reconciliation-goto-unmatched-btn')?.addEventListener('click', function() {
          const unmatchedTable = document.getElementById('unmatched-transactions-table');
          if (unmatchedTable) {
            unmatchedTable.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        });

        document.getElementById('manual-classify-form')?.addEventListener('submit', function(e) {
          e.preventDefault();
          saveManualClassify();
        });

        document.getElementById('manual-classify-cancel')?.addEventListener('click', closeManualClassifyModal);

        document.getElementById('manual-classify-close')?.addEventListener('click', closeManualClassifyModal);

        // Close modal on overlay click
        const modalElement = document.getElementById('manual-classify-modal');
        const modalContent = modalElement?.querySelector('.modal-content');
        
        if (modalElement) {
          modalElement.addEventListener('click', function(e) {
            // Only close if clicking directly on the modal overlay, not on its children
            if (e.target === modalElement) {
              closeManualClassifyModal();
            }
          });
        }
        
        // Prevent modal from closing when clicking inside modal content
        if (modalContent) {
          modalContent.addEventListener('click', function(e) {
            e.stopPropagation();
          });
        }

        // updateUnmatchedUI is now defined earlier in the scope

        // Listen for pharmacy selection changes
        if (window.phSidebarEl) {
          window.phSidebarEl.addEventListener('change', updateUnmatchedUI);
        }

        // Initial load
        updateUnmatchedUI();
      }

      // Make functions globally available
      window.editBankRule = openBankRuleModal;
      window.toggleBankRuleActive = toggleBankRuleActive;
      window.closeBankRuleModal = closeBankRuleModal;
      window.saveBankRule = saveBankRule;
      window.addConditionRow = addConditionRow;
      window.openManualClassify = openManualClassify;
      window.closeManualClassifyModal = closeManualClassifyModal;
      window.saveManualClassify = saveManualClassify;
      window.applyRulesToTransaction = applyRulesToTransaction;
      window.quickClassify = quickClassify;
      window.openAccountSelectionModal = openAccountSelectionModal;
      window.closeAccountSelectionModal = closeAccountSelectionModal;
      window.selectAccount = selectAccount;
      window.manualClassifyAll = manualClassifyAll;

      // Account search input handler - attach when modal opens
      function setupAccountSearchHandler() {
        const searchInput = document.getElementById('account-search-input');
        if (searchInput) {
          // Remove existing listeners by cloning and replacing
          const newSearchInput = searchInput.cloneNode(true);
          searchInput.parentNode.replaceChild(newSearchInput, searchInput);
          
          // Add event listener
          newSearchInput.addEventListener('input', function(e) {
            const searchValue = e.target.value || '';
            renderAccountSelectionList(searchValue);
          });
          
          // Also handle keyup for better responsiveness
          newSearchInput.addEventListener('keyup', function(e) {
            const searchValue = e.target.value || '';
            renderAccountSelectionList(searchValue);
          });
        }
      }

      // Close modal on escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          const accountModal = document.getElementById('account-selection-modal');
          if (accountModal && accountModal.style.display !== 'none') {
            closeAccountSelectionModal();
          }
        }
      });
    })();
  </script>

  <!-- Chart of Accounts Modals -->
  <div class="modal" id="coa-add-modal" style="display: none;" onclick="if (event.target === this) { this.style.display = 'none'; }">
    <div class="modal-content" onclick="event.stopPropagation();">
      <div class="modal-header">
        <h2>Add New Account</h2>
        <button class="modal-close" id="coa-add-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="coa-add-form">
          <div class="form-group">
            <label for="coa-add-code">Code *</label>
            <input type="text" id="coa-add-code" name="code" required />
          </div>
          <div class="form-group">
            <label for="coa-add-name">Name *</label>
            <input type="text" id="coa-add-name" name="name" required />
          </div>
          <div class="form-group">
            <label for="coa-add-type">Type *</label>
            <select id="coa-add-type" name="type" required>
              <option value="">Select Type</option>
              <option value="ASSET">Asset</option>
              <option value="LIABILITY">Liability</option>
              <option value="EQUITY">Equity</option>
              <option value="INCOME">Income</option>
              <option value="COGS">Cost of Goods Sold</option>
              <option value="EXPENSE">Expense</option>
              <option value="FINANCE_COST">Finance Cost</option>
              <option value="OTHER_INCOME">Other Income</option>
              <option value="TAX">Tax</option>
            </select>
          </div>
          <div class="form-group">
            <label for="coa-add-category">Category</label>
            <input type="text" id="coa-add-category" name="category" />
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="coa-add-cancel">Cancel</button>
            <button type="submit" class="btn btn-primary">Create Account</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal" id="coa-edit-modal" style="display: none;" onclick="if (event.target === this) { this.style.display = 'none'; }">
    <div class="modal-content" onclick="event.stopPropagation();">
      <div class="modal-header">
        <h2>Edit Account</h2>
        <button class="modal-close" id="coa-edit-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="coa-edit-form">
          <input type="hidden" id="coa-edit-id" />
          <div class="form-group">
            <label for="coa-edit-code">Code *</label>
            <input type="text" id="coa-edit-code" name="code" required />
          </div>
          <div class="form-group">
            <label for="coa-edit-name">Name *</label>
            <input type="text" id="coa-edit-name" name="name" required />
          </div>
          <div class="form-group">
            <label for="coa-edit-type">Type *</label>
            <select id="coa-edit-type" name="type" required>
              <option value="">Select Type</option>
              <option value="Income">Income</option>
              <option value="Expense">Expense</option>
              <option value="Asset">Asset</option>
              <option value="Liability">Liability</option>
              <option value="Equity">Equity</option>
            </select>
          </div>
          <div class="form-group">
            <label for="coa-edit-category">Category</label>
            <input type="text" id="coa-edit-category" name="category" />
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="coa-edit-cancel">Cancel</button>
            <button type="submit" class="btn btn-primary">Update Account</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bank Accounts Modals -->
  <div class="modal" id="bank-account-add-modal" style="display: none;" onclick="if (event.target === this) { this.style.display = 'none'; if (document.getElementById('bank-account-add-form')) document.getElementById('bank-account-add-form').reset(); }">
    <div class="modal-content" onclick="event.stopPropagation();">
      <div class="modal-header">
        <h2>Add Bank Account</h2>
        <button class="modal-close" id="bank-account-add-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="bank-account-add-form">
          <div class="form-group">
            <label for="bank-account-add-name">Bank Account Name *</label>
            <input type="text" id="bank-account-add-name" name="name" required placeholder="e.g., Main Operating Account" />
          </div>
          <div class="form-group">
            <label for="bank-account-add-bank-name">Bank Name *</label>
            <input type="text" id="bank-account-add-bank-name" name="bank_name" required placeholder="e.g., Standard Bank" />
          </div>
          <div class="form-group">
            <label for="bank-account-add-account-number">Account Number *</label>
            <input type="text" id="bank-account-add-account-number" name="account_number" required placeholder="e.g., 1234567890" />
          </div>
          <div class="form-group">
            <label for="bank-account-add-branch-code">Branch Code</label>
            <input type="text" id="bank-account-add-branch-code" name="branch_code" placeholder="e.g., 051001" />
          </div>
          <div class="form-group">
            <label for="bank-account-add-currency">Currency</label>
            <select id="bank-account-add-currency" name="currency">
              <option value="ZAR" selected>ZAR - South African Rand</option>
              <option value="USD">USD - US Dollar</option>
              <option value="EUR">EUR - Euro</option>
              <option value="GBP">GBP - British Pound</option>
            </select>
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="bank-account-add-cancel">Cancel</button>
            <button type="submit" class="btn btn-primary">Create Bank Account</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal" id="bank-account-edit-modal" style="display: none;" onclick="if (event.target === this) { this.style.display = 'none'; }">
    <div class="modal-content" onclick="event.stopPropagation();">
      <div class="modal-header">
        <h2>Edit Bank Account</h2>
        <button class="modal-close" id="bank-account-edit-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="bank-account-edit-form">
          <input type="hidden" id="bank-account-edit-id" />
          <div class="form-group">
            <label for="bank-account-edit-name">Bank Account Name *</label>
            <input type="text" id="bank-account-edit-name" name="name" required />
          </div>
          <div class="form-group">
            <label for="bank-account-edit-bank-name">Bank Name *</label>
            <input type="text" id="bank-account-edit-bank-name" name="bank_name" required />
          </div>
          <div class="form-group">
            <label for="bank-account-edit-account-number">Account Number *</label>
            <input type="text" id="bank-account-edit-account-number" name="account_number" required />
          </div>
          <div class="form-group">
            <label for="bank-account-edit-branch-code">Branch Code</label>
            <input type="text" id="bank-account-edit-branch-code" name="branch_code" />
          </div>
          <div class="form-group">
            <label for="bank-account-edit-currency">Currency</label>
            <select id="bank-account-edit-currency" name="currency">
              <option value="ZAR">ZAR - South African Rand</option>
              <option value="USD">USD - US Dollar</option>
              <option value="EUR">EUR - Euro</option>
              <option value="GBP">GBP - British Pound</option>
            </select>
          </div>
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="bank-account-edit-is-active" name="is_active" />
              <span>Active</span>
            </label>
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="bank-account-edit-cancel">Cancel</button>
            <button type="submit" class="btn btn-primary">Update Bank Account</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bank Rules Modal -->
  <div class="modal" id="bank-rule-modal" style="display: none;" onclick="if (event.target.id === 'bank-rule-modal') { closeBankRuleModal(); }">
    <div class="modal-content" style="max-width: 95vw; width: 1000px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2 id="bank-rule-modal-title">New Bank Rule</h2>
        <button class="modal-close" id="bank-rule-modal-close" onclick="closeBankRuleModal(); return false;">&times;</button>
      </div>
      <div class="modal-body">
        <form id="bank-rule-form" action="javascript:void(0);" method="post" onsubmit="event.preventDefault(); event.stopPropagation(); saveBankRule(); return false;">
          <input type="hidden" id="bank-rule-id" />
          
          <!-- Basic Details -->
          <div style="margin-bottom: 24px;">
            <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--textMuted);">Basic Details</h3>
            <div class="form-group">
              <label for="bank-rule-name">Rule Name *</label>
              <input type="text" id="bank-rule-name" class="form-control" required />
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div class="form-group">
                <label for="bank-rule-type">Type *</label>
                <select id="bank-rule-type" class="form-control" required>
                  <option value="">Select Type</option>
                  <option value="receive">Receive</option>
                  <option value="spend">Spend</option>
                  <option value="transfer">Transfer</option>
                </select>
              </div>
              <div class="form-group">
                <label for="bank-rule-priority">Priority *</label>
                <input type="number" id="bank-rule-priority" class="form-control" value="10" min="1" required />
                <small style="color: var(--textMuted); font-size: 11px;">Smaller number runs first</small>
              </div>
            </div>
            <div class="form-group">
              <label for="bank-rule-contact">Contact Name (optional)</label>
              <input type="text" id="bank-rule-contact" class="form-control" />
            </div>
          </div>

          <!-- Conditions -->
          <div style="margin-bottom: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 style="font-size: 14px; font-weight: 600; margin: 0; text-transform: uppercase; letter-spacing: 0.5px; color: var(--textMuted);">Conditions</h3>
              <div style="display: flex; align-items: center; gap: 8px;">
                <label style="font-size: 12px; margin: 0;">Match:</label>
                <select id="bank-rule-group-type" class="form-control" style="width: auto; min-width: 120px;">
                  <option value="ALL">ALL of the following</option>
                  <option value="ANY">ANY of the following</option>
                </select>
              </div>
            </div>
            <div id="bank-rule-conditions-list" style="display: flex; flex-direction: column; gap: 12px;">
              <!-- Conditions will be added here dynamically -->
            </div>
            <button type="button" class="btn btn-secondary btn-sm" id="bank-rule-add-condition" style="margin-top: 12px;" onclick="addConditionRow(); return false;">+ Add Condition</button>
          </div>

          <!-- Allocation -->
          <div style="margin-bottom: 24px;">
            <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--textMuted);">Allocate</h3>
            <div class="admin-table-container">
              <table class="admin-table" style="font-size: 12px;">
                <thead>
                  <tr>
                    <th>Account</th>
                    <th style="width: 100px;">Percent (%)</th>
                    <th style="width: 120px;">VAT Code</th>
                    <th style="width: 60px;"></th>
                  </tr>
                </thead>
                <tbody id="bank-rule-allocate-list">
                  <!-- Allocation rows will be added here dynamically -->
                </tbody>
              </table>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
              <button type="button" class="btn btn-secondary btn-sm" id="bank-rule-add-split">+ Add Split</button>
              <div style="font-weight: 600; font-size: 13px;">
                Total: <span id="bank-rule-total-percent">0</span>%
                <span id="bank-rule-percent-error" style="color: var(--statusError); margin-left: 8px; display: none;">Must equal 100%</span>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="bank-rule-cancel" onclick="closeBankRuleModal(); return false;">Cancel</button>
            <button type="button" class="btn btn-danger" id="bank-rule-deactivate" style="display: none;">Deactivate Rule</button>
            <button type="button" class="btn btn-primary" id="bank-rule-submit" onclick="saveBankRule(); return false;">Save Rule</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Progress Bar Modal -->
  <div class="loading-overlay" id="unmatched-progress-modal" style="display: none;">
    <div class="loading-modal">
      <div class="loading-spinner-large"></div>
      <div style="display: flex; flex-direction: column; align-items: center; gap: 16px; width: 100%;">
        <p class="loading-text-modal" id="unmatched-progress-text">Preparing...</p>
        <div style="width: 100%; max-width: 400px;">
          <div style="margin-bottom: 8px;">
            <span id="unmatched-progress-status" style="font-size: 13px; font-weight: 600; color: var(--textPrimary);">Processing transactions... 0%</span>
          </div>
          <div class="unmatched-progress-bar-container">
            <div class="unmatched-progress-bar-fill" id="unmatched-progress-bar-fill"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Account Selection Modal -->
  <div class="modal" id="account-selection-modal" style="display: none;" onclick="if (event.target === this) { closeAccountSelectionModal(); }">
    <div class="modal-content" style="max-width: 600px; width: 95vw;" onclick="event.stopPropagation();">
      <div class="modal-header">
        <h2>Select Account</h2>
        <button class="modal-close" id="account-selection-close" type="button" onclick="closeAccountSelectionModal();">&times;</button>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: 16px;">
          <input 
            type="text" 
            id="account-search-input" 
            class="form-control" 
            placeholder="Search accounts by code, name, or category..."
            autocomplete="off"
            style="font-size: 13px;"
          />
        </div>
        <div id="account-selection-list" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--surfaceBorder); border-radius: 8px; padding: 8px;">
          <!-- Accounts will be populated here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Manual Classification Modal -->
  <div class="modal" id="manual-classify-modal" style="display: none;" onclick="if (event.target === this) { closeManualClassifyModal(); }">
    <div class="modal-content" style="max-width: 600px; width: 95vw;">
      <div class="modal-header">
        <h2>Manual Classification</h2>
        <button class="modal-close" id="manual-classify-close" type="button" onclick="closeManualClassifyModal();">&times;</button>
      </div>
      <div class="modal-body">
        <form id="manual-classify-form" action="javascript:void(0);" method="post" onsubmit="event.preventDefault(); event.stopPropagation(); saveManualClassify(); return false;">
          <input type="hidden" id="manual-classify-line-id" />
          
          <!-- Line Details (Read-only) -->
          <div style="background: var(--bgSecondary); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
            <h4 style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--textMuted); margin-bottom: 12px;">Transaction Details</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 12px;">
              <div>
                <label style="color: var(--textMuted);">Date:</label>
                <div id="manual-classify-date" style="font-weight: 600; margin-top: 4px;"></div>
              </div>
              <div>
                <label style="color: var(--textMuted);">Amount:</label>
                <div id="manual-classify-amount" style="font-weight: 600; margin-top: 4px;"></div>
              </div>
              <div style="grid-column: 1 / -1;">
                <label style="color: var(--textMuted);">Description:</label>
                <div id="manual-classify-description" style="font-weight: 600; margin-top: 4px; word-break: break-word;"></div>
              </div>
              <div style="grid-column: 1 / -1;">
                <label style="color: var(--textMuted);">Reference:</label>
                <div id="manual-classify-reference" style="font-weight: 600; margin-top: 4px;"></div>
              </div>
            </div>
          </div>

          <!-- Classification Inputs -->
          <div class="form-group">
            <label for="manual-classify-account">Account *</label>
            <select id="manual-classify-account" class="form-control" required>
              <option value="">Select Account</option>
              <!-- Accounts will be populated dynamically -->
            </select>
          </div>
          <div class="form-group">
            <label for="manual-classify-description-input">Description</label>
            <input type="text" id="manual-classify-description-input" class="form-control" />
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="manual-classify-cancel" onclick="closeManualClassifyModal();">Cancel</button>
            <button type="button" class="btn btn-primary" id="manual-classify-submit" onclick="saveManualClassify();">Save & Classify</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Initialize form handlers after modals are in DOM -->
  <script>
    (function() {
      'use strict';
      
      // Bank Account Add Form Handler
      var bankAccountAddForm = document.getElementById('bank-account-add-form');
      if (bankAccountAddForm) {
        console.log('Bank account add form found, attaching handler');
        
        bankAccountAddForm.onsubmit = function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          console.log('Bank account form onsubmit triggered');
          
          if (!window.selectedPharmacyId) {
            window.showStyledAlert('Please select a pharmacy from the top selector first', 'warning', 'Warning');
            return false;
          }
          
          var formData = new FormData(bankAccountAddForm);
          var submitBtn = bankAccountAddForm.querySelector('button[type="submit"]');
          
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';
          }
          
          var accountData = {
            pharmacy_id: window.selectedPharmacyId,
            name: formData.get('name'),
            bank_name: formData.get('bank_name'),
            account_number: formData.get('account_number'),
            branch_code: formData.get('branch_code') || null,
            currency: formData.get('currency') || 'ZAR',
            is_active: true
          };
          
          console.log('Creating bank account with data:', accountData);
          
          window.BankAccountsService.createAccount(accountData)
            .then(function(result) {
              console.log('Bank account created successfully:', result);
              
              // Close the add modal
              var modal = document.getElementById('bank-account-add-modal');
              if (modal) modal.style.display = 'none';
              bankAccountAddForm.reset();
              
              // Show success modal
              window.showStyledAlert('Bank account created successfully!', 'success', 'Success')
                .then(function() {
                  // After user closes the success modal, reload the accounts
                  if (window.loadBankAccounts && window.selectedPharmacyId) {
                    window.loadBankAccounts(window.selectedPharmacyId);
                  }
                });
            })
            .catch(function(error) {
              console.error('Error creating bank account:', error);
              window.showStyledAlert(error.message || 'Failed to create bank account', 'error', 'Error Creating Bank Account');
            })
            .finally(function() {
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Bank Account';
              }
            });
          
          return false;
        };
      } else {
        console.error('Bank account add form not found!');
      }
      
      // Bank Account Edit Form Handler
      var bankAccountEditForm = document.getElementById('bank-account-edit-form');
      if (bankAccountEditForm) {
        console.log('Bank account edit form found, attaching handler');
        
        bankAccountEditForm.onsubmit = function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          var accountId = parseInt(document.getElementById('bank-account-edit-id').value);
          var formData = new FormData(bankAccountEditForm);
          var isActive = document.getElementById('bank-account-edit-is-active').checked;
          var submitBtn = bankAccountEditForm.querySelector('button[type="submit"]');
          
          // Find the account in state
          var account = null;
          if (window.bankAccountsState && window.bankAccountsState.accounts) {
            account = window.bankAccountsState.accounts.find(function(a) {
              return (a.id || a.bank_account_id) === accountId;
            });
          }
          
          // Check if we're deactivating the account
          if (account && account.is_active && !isActive) {
            var confirmed = confirm('Are you sure you want to deactivate bank account "' + account.name + '"? This will prevent new imports from using this account, but existing data remains.');
            if (!confirmed) return false;
          }
          
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Updating...';
          }
          
          var updates = {
            name: formData.get('name'),
            bank_name: formData.get('bank_name'),
            account_number: formData.get('account_number'),
            branch_code: formData.get('branch_code') || null,
            currency: formData.get('currency') || 'ZAR',
            is_active: isActive
          };
          
          window.BankAccountsService.updateAccount(accountId, updates)
            .then(function() {
              var modal = document.getElementById('bank-account-edit-modal');
              if (modal) modal.style.display = 'none';
              
              window.showStyledAlert('Bank account updated successfully', 'success', 'Success')
                .then(function() {
                  if (window.loadBankAccounts && window.selectedPharmacyId) {
                    window.loadBankAccounts(window.selectedPharmacyId);
                  }
                });
            })
            .catch(function(error) {
              window.showStyledAlert(error.message || 'Failed to update bank account', 'error', 'Error Updating Bank Account');
            })
            .finally(function() {
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Update Bank Account';
              }
            });
          
          return false;
        };
      }
      
      // Cancel button handlers
      var bankAccountAddCancel = document.getElementById('bank-account-add-cancel');
      if (bankAccountAddCancel) {
        bankAccountAddCancel.onclick = function() {
          var modal = document.getElementById('bank-account-add-modal');
          if (modal) modal.style.display = 'none';
          if (bankAccountAddForm) bankAccountAddForm.reset();
        };
      }
      
      var bankAccountEditCancel = document.getElementById('bank-account-edit-cancel');
      if (bankAccountEditCancel) {
        bankAccountEditCancel.onclick = function() {
          var modal = document.getElementById('bank-account-edit-modal');
          if (modal) modal.style.display = 'none';
        };
      }
      
      // Close button handlers
      var bankAccountAddClose = document.getElementById('bank-account-add-close');
      if (bankAccountAddClose) {
        bankAccountAddClose.onclick = function() {
          var modal = document.getElementById('bank-account-add-modal');
          if (modal) modal.style.display = 'none';
          if (bankAccountAddForm) bankAccountAddForm.reset();
        };
      }
      
      var bankAccountEditClose = document.getElementById('bank-account-edit-close');
      if (bankAccountEditClose) {
        bankAccountEditClose.onclick = function() {
          var modal = document.getElementById('bank-account-edit-modal');
          if (modal) modal.style.display = 'none';
        };
      }

      // --- COA Modals & Forms (re-bind after modals exist) ---
      var coaAddFormLate = document.getElementById('coa-add-form');
      if (coaAddFormLate) {
        // Ensure only one submit handler
        coaAddFormLate.addEventListener('submit', function handleCOAAddSubmit(e) {
          e.preventDefault();
          e.stopPropagation();

          // Check if COAService is available
          if (!window.COAService || !window.COAService.createAccount) {
            console.error('COAService.createAccount is not available', { windowCOA: window.COAService });
            showStyledAlert('Unable to create account right now. Please reload and try again.', 'error', 'Error Creating Account');
            return false;
          }

          const formData = new FormData(coaAddFormLate);
          const accountData = {
            code: formData.get('code'),
            name: formData.get('name'),
            type: (formData.get('type') || '').toUpperCase(),
            category: formData.get('category'),
            parent_account_id: null,
            is_active: true,
            display_order: parseInt(formData.get('code'), 10) || 0,
            notes: null
          };

          console.log('Account data object:', accountData);
          console.log('JSON stringified:', JSON.stringify(accountData, null, 2));

          const submitBtn = coaAddFormLate.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';
          }

          window.COAService.createAccount(accountData)
            .then(function() {
              showStyledAlert('Account created successfully', 'success', 'Success');
              document.getElementById('coa-add-modal').style.display = 'none';
              coaAddFormLate.reset();
              loadCOAAccounts();
            })
            .catch(function(error) {
              console.error('Error creating account:', error);
              showStyledAlert(error.message || 'Failed to create account', 'error', 'Error Creating Account');
            })
            .finally(function() {
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Account';
              }
            });

          return false;
        });
      }

      var coaEditFormLate = document.getElementById('coa-edit-form');
      if (coaEditFormLate) {
        coaEditFormLate.addEventListener('submit', function(e) {
          e.preventDefault();
          e.stopPropagation();

          const accountId = parseInt(document.getElementById('coa-edit-id').value);
          const formData = new FormData(coaEditFormLate);

          const updates = {
            code: formData.get('code'),
            name: formData.get('name'),
            type: formData.get('type'),
            category: formData.get('category')
          };

          COAService.updateAccount(accountId, updates)
            .then(function() {
              showStyledAlert('Account updated successfully', 'success', 'Success');
              document.getElementById('coa-edit-modal').style.display = 'none';
              loadCOAAccounts();
            })
            .catch(function(error) {
              showStyledAlert(error.message, 'error', 'Error Updating Account');
            });
        });
      }

      // COA modal close/cancel bindings (ensure buttons work)
      var coaAddModalLate = document.getElementById('coa-add-modal');
      if (coaAddModalLate) {
        document.getElementById('coa-add-close')?.addEventListener('click', function() {
          coaAddModalLate.style.display = 'none';
        });
        document.getElementById('coa-add-cancel')?.addEventListener('click', function() {
          coaAddModalLate.style.display = 'none';
        });
        coaAddModalLate.addEventListener('click', function(e) {
          if (e.target === coaAddModalLate) {
            coaAddModalLate.style.display = 'none';
          }
        });
      }

      var coaEditModalLate = document.getElementById('coa-edit-modal');
      if (coaEditModalLate) {
        document.getElementById('coa-edit-close')?.addEventListener('click', function() {
          coaEditModalLate.style.display = 'none';
        });
        document.getElementById('coa-edit-cancel')?.addEventListener('click', function() {
          coaEditModalLate.style.display = 'none';
        });
        coaEditModalLate.addEventListener('click', function(e) {
          if (e.target === coaEditModalLate) {
            coaEditModalLate.style.display = 'none';
          }
        });
      }
      
      console.log('Bank account form handlers initialized');
    })();
  </script>
</body>
</html>